@rendermode InteractiveServer
@inject IJSRuntime JSRuntime
@inject CampsiteBooking.Models.Repositories.ICampsiteRepository CampsiteRepository
@using System.Text.Json
@using CampsiteBooking.Models.Repositories

<MudPaper Elevation="4" Class="mt-8" Square="true">
    <MudContainer MaxWidth="MaxWidth.ExtraLarge">
        <!-- Campsite Locations Map -->
        <MudGrid Class="py-6">
            <MudItem xs="12">
                <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-2">
                    Our Campsite Locations
                </MudText>
                <MudText Typo="Typo.body1" Align="Align.Center" Class="mb-4 mud-text-secondary">
                    Explore our 8 beautiful campsites across Denmark
                </MudText>
                <div id="map" style="width: 100%; height: 400px; border-radius: 8px; overflow: hidden;"></div>
            </MudItem>
        </MudGrid>

        <MudDivider Class="my-4" />

        <MudGrid Class="py-6">
            <!-- About Section -->
            <MudItem xs="12" sm="6" md="3">
                <MudText Typo="Typo.h6" Class="mb-3">Campsite Booking</MudText>
                <MudText Typo="Typo.body2" Class="mb-2">
                    Denmark's premier camping network offering unforgettable outdoor experiences.
                </MudText>
                <MudText Typo="Typo.body2" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-1" />
                    Copenhagen, Denmark
                </MudText>
                <MudStack Spacing="1">
                    <MudLink Href="https://datacvr.virk.dk/enhed/virksomhed/11223344" Target="_blank" Typo="Typo.body2" Color="Color.Inherit">
                        CVR: 11 22 33 44
                    </MudLink>
                    <MudText Typo="Typo.body2">
                        <strong>Work with us</strong>
                    </MudText>
                    <MudLink Href="mailto:carrier@campsitebooking.dk" Typo="Typo.body2" Color="Color.Inherit">
                        carrier@campsitebooking.dk
                    </MudLink>
                    <MudText Typo="Typo.body2">
                        <strong>Inqueries</strong>
                    </MudText>
                    <MudLink Href="mailto:contact@campsitebooking.dk" Typo="Typo.body2" Color="Color.Inherit">
                        Contact us at contact@campsitebooking.dk
                    </MudLink>
                </MudStack>
            </MudItem>

            <!-- Quick Links -->
            <MudItem xs="12" sm="6" md="3">
                <MudText Typo="Typo.h6" Class="mb-3">Quick Links</MudText>
                <MudStack Spacing="2">
                    <MudLink Href="/" Color="Color.Inherit">Search Campsites</MudLink>
                    <MudLink Href="/information" Color="Color.Inherit">Information & Activities</MudLink>
                    <MudLink Href="/bookings" Color="Color.Inherit">My Bookings</MudLink>
                    <MudLink Href="/my-account" Color="Color.Inherit">My Account</MudLink>
                </MudStack>
            </MudItem>

            <!-- Legal -->
            <MudItem xs="12" sm="6" md="3">
                <MudText Typo="Typo.h6" Class="mb-3">Legal</MudText>
                <MudStack Spacing="2">
                    <MudLink Href="/privacy-policy" Color="Color.Inherit">Privacy Policy</MudLink>
                    <MudLink Href="/cookie-policy" Color="Color.Inherit">Cookie Policy</MudLink>
                    <MudLink Href="#" Color="Color.Inherit" OnClick="@(() => ShowCookieSettings())">Cookie Settings</MudLink>
                    <MudLink Href="#" Color="Color.Inherit">Terms & Conditions</MudLink>
                </MudStack>
            </MudItem>

            <!-- Admin Portal -->
            <MudItem xs="12" sm="6" md="3">
                <MudText Typo="Typo.h6" Class="mb-3">Admin</MudText>
                <MudStack Spacing="2">
                    <MudLink Href="/admin/dashboard" Color="Color.Inherit">Admin Portal</MudLink>
                    <MudLink Href="/admin/campsites" Color="Color.Inherit">Manage Campsites</MudLink>
                    <MudLink Href="/admin/bookings" Color="Color.Inherit">Manage Bookings</MudLink>
                    <MudLink Href="/admin/users" Color="Color.Inherit">Manage Users</MudLink>
                    <MudLink Href="/admin/information" Color="Color.Inherit">Information & Newsletter</MudLink>
                </MudStack>
            </MudItem>
        </MudGrid>

        <MudDivider Class="my-4" />

        <!-- Bottom Bar -->
        <MudGrid Class="pb-4">
            <MudItem xs="12" md="6" Class="d-flex align-center">
                <MudText Typo="Typo.body2">
                    © @DateTime.Now.Year Campsite Booking. All rights reserved.
                </MudText>
            </MudItem>
            <MudItem xs="12" md="6" Class="d-flex align-center justify-end">
                <MudStack Row="true" Spacing="3">
                    <MudIconButton Icon="@Icons.Custom.Brands.Facebook" Color="Color.Inherit" Size="Size.Small" />
                    <MudIconButton Icon="@Icons.Custom.Brands.Instagram" Color="Color.Inherit" Size="Size.Small" />
                    <MudIconButton Icon="@Icons.Custom.Brands.X" Color="Color.Inherit" Size="Size.Small" />
                    <MudIconButton Icon="@Icons.Custom.Brands.LinkedIn" Color="Color.Inherit" Size="Size.Small" />
                </MudStack>
            </MudItem>
        </MudGrid>
    </MudContainer>
</MudPaper>

@code {
    private bool _mapInitialized = false;
    private List<CampsiteMapData> _campsites = new();

    private class CampsiteMapData
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Region { get; set; } = "";
        public string Description { get; set; } = "";
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public int AvailableSpots { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Fetch campsite data directly from repository
            var campsites = await CampsiteRepository.GetAllAsync();

            if (campsites != null && campsites.Any())
            {
                _campsites = campsites.Select(c => new CampsiteMapData
                {
                    Id = c.Id.Value,
                    Name = c.Name ?? "Unknown",
                    Region = c.Region ?? "Denmark",
                    Description = c.Description ?? "Beautiful campsite location",
                    Latitude = c.Latitude != 0 ? c.Latitude : 56.2639,
                    Longitude = c.Longitude != 0 ? c.Longitude : 10.4515,
                    AvailableSpots = 30 // TODO: Calculate from actual accommodation availability
                }).ToList();

                Console.WriteLine($"✅ Loaded {_campsites.Count} campsites for map");
                foreach (var c in _campsites)
                {
                    Console.WriteLine($"  - {c.Name}: {c.Description}");
                }
            }
            else
            {
                Console.WriteLine("⚠️ No campsites returned from repository, using fallback data");
                _campsites = GetFallbackCampsites();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error fetching campsites: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            // Use fallback data if API fails
            _campsites = GetFallbackCampsites();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_mapInitialized && _campsites.Any())
        {
            try
            {
                // Pass campsite data to JavaScript
                var campsitesJson = JsonSerializer.Serialize(_campsites);

                await JSRuntime.InvokeVoidAsync("eval", $@"
                    window.campsitesData = {campsitesJson};
                    (function() {{
                        function checkGoogleMaps() {{
                            if (typeof google !== 'undefined' && google.maps) {{
                                initMapWithData(window.campsitesData);
                            }} else {{
                                setTimeout(checkGoogleMaps, 100);
                            }}
                        }}
                        checkGoogleMaps();
                    }})();
                ");
                _mapInitialized = true;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing map: {ex.Message}");
            }
        }
    }

    private List<CampsiteMapData> GetFallbackCampsites()
    {
        return new List<CampsiteMapData>
        {
            new() { Id = 1, Name = "Copenhagen Beach Camp", Region = "Zealand", Description = "Beautiful beachside camping near Copenhagen", Latitude = 55.6761, Longitude = 12.5683, AvailableSpots = 45 },
            new() { Id = 2, Name = "Skagen North Point", Region = "North Jutland", Description = "Denmark's northernmost campsite with stunning views", Latitude = 57.7209, Longitude = 10.5882, AvailableSpots = 32 },
            new() { Id = 3, Name = "Aarhus Forest Retreat", Region = "East Jutland", Description = "Peaceful forest camping near Aarhus city", Latitude = 56.1629, Longitude = 10.2039, AvailableSpots = 28 },
            new() { Id = 4, Name = "Odense Family Camp", Region = "Funen", Description = "Family-friendly campsite on Funen island", Latitude = 55.4038, Longitude = 10.4024, AvailableSpots = 52 },
            new() { Id = 5, Name = "Bornholm Island Camp", Region = "Bornholm", Description = "Scenic island camping with rocky coastline", Latitude = 55.1367, Longitude = 14.9155, AvailableSpots = 18 }
        };
    }

    private void ShowCookieSettings()
    {
        // This would open a cookie settings dialog
        // For now, just a placeholder
    }
}

