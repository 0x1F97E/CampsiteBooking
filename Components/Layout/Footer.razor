@rendermode InteractiveServer
@inject IJSRuntime JSRuntime
@inject CampsiteBooking.Models.Repositories.ICampsiteRepository CampsiteRepository
@using System.Text.Json
@using CampsiteBooking.Models.Repositories

<MudPaper Elevation="4" Class="mt-8" Square="true">
    <MudContainer MaxWidth="MaxWidth.ExtraLarge">
        <MudGrid Class="py-6">
            <!-- About Section -->
            <MudItem xs="12" sm="6" md="3">
                <MudText Typo="Typo.h6" Class="mb-2">Campsite Booking</MudText>
                <MudText Typo="Typo.body2" Class="mb-1" Style="font-size: 0.875rem;">
                    Denmark's premier camping network offering unforgettable outdoor experiences.
                </MudText>
                <MudText Typo="Typo.body2" Class="mb-1" Style="font-size: 0.875rem;">
                    <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-1" />
                    Copenhagen, Denmark
                </MudText>
                <MudStack Spacing="0">
                    <MudLink Href="https://datacvr.virk.dk/enhed/virksomhed/11223344" Target="_blank" Typo="Typo.body2" Color="Color.Inherit" Style="font-size: 0.875rem;">
                        CVR: 11 22 33 44
                    </MudLink>
                    <MudText Typo="Typo.body2" Class="mt-1" Style="font-size: 0.875rem;">
                        <strong>Work with us</strong>
                    </MudText>
                    <MudLink Href="mailto:carrier@campsitebooking.dk" Typo="Typo.body2" Color="Color.Inherit" Style="font-size: 0.875rem;">
                        carrier@campsitebooking.dk
                    </MudLink>
                    <MudText Typo="Typo.body2" Class="mt-1" Style="font-size: 0.875rem;">
                        <strong>Inqueries</strong>
                    </MudText>
                    <MudLink Href="mailto:contact@campsitebooking.dk" Typo="Typo.body2" Color="Color.Inherit" Style="font-size: 0.875rem;">
                        Contact us at contact@campsitebooking.dk
                    </MudLink>
                </MudStack>
            </MudItem>

            <!-- Quick Links -->
            <MudItem xs="12" sm="6" md="3">
                <MudText Typo="Typo.h6" Class="mb-2">Quick Links</MudText>
                <MudStack Spacing="1">
                    <MudLink Href="/" Color="Color.Inherit" Style="font-size: 0.875rem;">Search Campsites</MudLink>
                    <MudLink Href="/information" Color="Color.Inherit" Style="font-size: 0.875rem;">Information & Activities</MudLink>
                    <MudLink Href="/bookings" Color="Color.Inherit" Style="font-size: 0.875rem;">My Bookings</MudLink>
                    <MudLink Href="/my-account" Color="Color.Inherit" Style="font-size: 0.875rem;">My Account</MudLink>
                </MudStack>
            </MudItem>

            <!-- Legal -->
            <MudItem xs="12" sm="6" md="3">
                <MudText Typo="Typo.h6" Class="mb-2">Legal</MudText>
                <MudStack Spacing="1">
                    <MudLink Href="/privacy-policy" Color="Color.Inherit" Style="font-size: 0.875rem;">Privacy Policy</MudLink>
                    <MudLink Href="/cookie-policy" Color="Color.Inherit" Style="font-size: 0.875rem;">Cookie Policy</MudLink>
                    <MudLink Href="#" Color="Color.Inherit" OnClick="@(() => ShowCookieSettings())" Style="font-size: 0.875rem;">Cookie Settings</MudLink>
                    <MudLink Href="#" Color="Color.Inherit" Style="font-size: 0.875rem;">Terms & Conditions</MudLink>
                </MudStack>
            </MudItem>

            <!-- Campsite Locations Map -->
            <MudItem xs="12" sm="6" md="3">
                <MudText Typo="Typo.h6" Class="mb-2">Our Campsite Locations</MudText>
                <MudText Typo="Typo.body2" Class="mb-2 mud-text-secondary" Style="font-size: 0.875rem;">
                    Explore our 8 beautiful campsites across Denmark
                </MudText>
                <div id="map" style="width: 100%; height: 250px; border-radius: 8px; overflow: hidden;"></div>
            </MudItem>
        </MudGrid>

        <MudDivider Class="my-4" />

        <!-- Bottom Bar -->
        <MudGrid Class="pb-4">
            <MudItem xs="12" md="6" Class="d-flex align-center">
                <MudText Typo="Typo.body2">
                    © @DateTime.Now.Year Campsite Booking. All rights reserved.
                </MudText>
            </MudItem>
            <MudItem xs="12" md="6" Class="d-flex align-center justify-end">
                <MudStack Row="true" Spacing="3">
                    <MudIconButton Icon="@Icons.Custom.Brands.Facebook"
                                   Color="Color.Inherit"
                                   Size="Size.Small"
                                   Href="https://www.facebook.com/campsitebooking"
                                   Target="_blank"
                                   Title="Follow us on Facebook" />
                    <MudIconButton Icon="@Icons.Custom.Brands.Instagram"
                                   Color="Color.Inherit"
                                   Size="Size.Small"
                                   Href="https://www.instagram.com/campsitebooking"
                                   Target="_blank"
                                   Title="Follow us on Instagram" />
                    <MudIconButton Icon="@Icons.Custom.Brands.X"
                                   Color="Color.Inherit"
                                   Size="Size.Small"
                                   Href="https://twitter.com/campsitebooking"
                                   Target="_blank"
                                   Title="Follow us on X (Twitter)" />
                    <MudIconButton Icon="@Icons.Custom.Brands.LinkedIn"
                                   Color="Color.Inherit"
                                   Size="Size.Small"
                                   Href="https://www.linkedin.com/company/campsitebooking"
                                   Target="_blank"
                                   Title="Follow us on LinkedIn" />
                    <MudIconButton Icon="@Icons.Material.Filled.Star"
                                   Color="Color.Inherit"
                                   Size="Size.Small"
                                   Href="https://www.trustpilot.com/review/campsitebooking.dk"
                                   Target="_blank"
                                   Title="Read our reviews on Trustpilot" />
                </MudStack>
            </MudItem>
        </MudGrid>
    </MudContainer>
</MudPaper>

@code {
    private bool _mapInitialized = false;
    private List<CampsiteMapData> _campsites = new();

    private class CampsiteMapData
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Region { get; set; } = "";
        public string Description { get; set; } = "";
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public int AvailableSpots { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Fetch campsite data directly from repository
            var campsites = await CampsiteRepository.GetAllAsync();

            if (campsites != null && campsites.Any())
            {
                _campsites = campsites.Select(c => new CampsiteMapData
                {
                    Id = c.Id.Value,
                    Name = c.Name ?? "Unknown",
                    Region = c.Region ?? "Denmark",
                    Description = c.Description ?? "Beautiful campsite location",
                    Latitude = c.Latitude != 0 ? c.Latitude : 56.2639,
                    Longitude = c.Longitude != 0 ? c.Longitude : 10.4515,
                    AvailableSpots = 30 // TODO: Calculate from actual accommodation availability
                }).ToList();

                Console.WriteLine($"✅ Loaded {_campsites.Count} campsites for map");
                foreach (var c in _campsites)
                {
                    Console.WriteLine($"  - {c.Name}: {c.Description}");
                }
            }
            else
            {
                Console.WriteLine("⚠️ No campsites returned from repository");
                _campsites = new List<CampsiteMapData>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error fetching campsites: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            _campsites = new List<CampsiteMapData>();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_mapInitialized && _campsites.Any())
        {
            try
            {
                // Pass campsite data to JavaScript
                var campsitesJson = JsonSerializer.Serialize(_campsites);

                await JSRuntime.InvokeVoidAsync("eval", $@"
                    window.campsitesData = {campsitesJson};
                    (function() {{
                        function checkGoogleMaps() {{
                            if (typeof google !== 'undefined' && google.maps) {{
                                initMapWithData(window.campsitesData);
                            }} else {{
                                setTimeout(checkGoogleMaps, 100);
                            }}
                        }}
                        checkGoogleMaps();
                    }})();
                ");
                _mapInitialized = true;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing map: {ex.Message}");
            }
        }
    }

    private void ShowCookieSettings()
    {
        // This would open a cookie settings dialog
        // For now, just a placeholder
    }
}

