@inherits LayoutComponentBase
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject HttpClient HttpClient
@inject IJSRuntime JSRuntime
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@implements IDisposable

<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleDrawer" />
        <img src="favicon.png" alt="Tent" style="width: 32px; height: 32px; margin-right: 12px; vertical-align: middle; filter: brightness(0) invert(1);" />
        <MudText Typo="Typo.h5" Style="color: white;">Campsite Booking</MudText>
        <MudSpacer />
        <LanguageSelector />

        @if (_isAuthenticated)
        {
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Inherit"
                       StartIcon="@Icons.Material.Filled.Logout"
                       OnClick="HandleLogout"
                       Class="ml-3">
                Logout
            </MudButton>
        }
        else
        {
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Inherit"
                       StartIcon="@Icons.Material.Filled.Login"
                       Href="/login"
                       Class="ml-3">
                Login
            </MudButton>
        }
    </MudAppBar>

    <MudDrawer @bind-Open="@_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
        <NavMenu />
    </MudDrawer>

    <MudMainContent Style="background-color: transparent;">
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
            @Body
        </MudContainer>
        <Footer />
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;
    private bool _isAuthenticated = false;
    private bool _isAdmin = false;
    private bool _isStaff = false;
    private string _userName = "";

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to navigation events to check authentication on every page change
        Navigation.LocationChanged += OnLocationChanged;

        // Subscribe to authentication state changes
        AuthenticationStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;

        await CheckAuthentication();
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        // Re-check authentication whenever navigation occurs
        await CheckAuthentication();
        StateHasChanged();
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        // Re-check authentication when auth state changes
        await CheckAuthentication();
        StateHasChanged();
    }

    private async Task CheckAuthentication()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user?.Identity?.IsAuthenticated == true)
            {
                _isAuthenticated = true;
                _userName = user.FindFirst(ClaimTypes.Name)?.Value ?? "User";

                // Check user role
                var role = user.FindFirst(ClaimTypes.Role)?.Value;
                _isAdmin = role == "Admin";
                _isStaff = role == "Staff";

                Console.WriteLine($"✅ MainLayout: User authenticated - {_userName}, Role: {role}");
            }
            else
            {
                _isAuthenticated = false;
                _isAdmin = false;
                _isStaff = false;
                _userName = "";

                Console.WriteLine($"⚠️ MainLayout: User not authenticated");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error checking authentication in MainLayout: {ex.Message}");
            _isAuthenticated = false;
            _isAdmin = false;
            _isStaff = false;
        }
    }

    private async Task HandleLogout()
    {
        try
        {
            // Call the logout API endpoint using JavaScript interop
            // This ensures the browser's cookie is properly cleared
            var result = await JSRuntime.InvokeAsync<LogoutResult>("authHelper.logout");

            if (result?.Success == true)
            {
                _isAuthenticated = false;
                _userName = "";

                Console.WriteLine("✅ User logged out successfully");
                Snackbar.Add("You have been logged out successfully.", Severity.Success);
                Navigation.NavigateTo("/login", forceLoad: true);
            }
            else
            {
                Console.WriteLine($"❌ Logout failed: {result?.Error}");
                Snackbar.Add("Error during logout. Please try again.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error during logout: {ex.Message}");
            Snackbar.Add("Error during logout. Please try again.", Severity.Error);
        }
    }

    // DTO for logout result
    private class LogoutResult
    {
        public bool Success { get; set; }
        public string? Error { get; set; }
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    public void Dispose()
    {
        // Unsubscribe from navigation events
        Navigation.LocationChanged -= OnLocationChanged;
        AuthenticationStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
    }
}
