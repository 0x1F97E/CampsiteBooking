@page "/information"
@rendermode InteractiveServer
@using CampsiteBooking.Data
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<CampsiteBookingDbContext> DbContextFactory

<PageTitle>Information & Activities - Campsite Booking</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h3" Class="mb-4">Campsite Information & Activities</MudText>

    <!-- Hero Section -->
    <MudPaper Elevation="2" Class="pa-6 mb-4">
        <MudText Typo="Typo.h5" Class="mb-3">Welcome to Denmark's Premier Camping Network</MudText>
        <MudText Typo="Typo.body1" Class="mb-2">
            Discover the beauty of Denmark through our carefully selected campsites. From coastal retreats to forest hideaways,
            we offer the perfect base for your outdoor adventure.
        </MudText>
    </MudPaper>

    <!-- Campsite Selector -->
    <MudPaper Elevation="3" Class="pa-4 mb-6">
        <MudText Typo="Typo.h6" GutterBottom="true">
            <MudIcon Icon="@Icons.Material.Filled.Search" Class="mr-2" />
            Explore a Specific Campsite
        </MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
            Select a campsite to view its events calendar and photo gallery
        </MudText>
        <MudGrid>
            <MudItem xs="12" md="8">
                <MudSelect T="int"
                          Value="_selectedCampsiteId"
                          ValueChanged="OnCampsiteChanged"
                          Label="Select Campsite"
                          Variant="Variant.Outlined"
                          Placeholder="All Campsites (Random Photos)"
                          Clearable="true"
                          OnClearButtonClick="ClearCampsiteSelection">
                    @foreach (var campsite in _campsites)
                    {
                        <MudSelectItem T="int" Value="@campsite.Id">
                            @campsite.Name - @campsite.Region
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="4" Class="d-flex align-center">
                @if (_selectedCampsiteId > 0)
                {
                    <MudChip T="string" Icon="@Icons.Material.Filled.LocationOn" Color="Color.Primary">
                        @GetSelectedCampsiteName()
                    </MudChip>
                }
                else
                {
                    <MudChip T="string" Icon="@Icons.Material.Filled.Public" Color="Color.Default">
                        Showing All Campsites
                    </MudChip>
                }
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Events Calendar Section -->
    @if (_selectedCampsiteId > 0)
    {
        <MudPaper Elevation="3" Class="pa-4 mb-6">
            <MudText Typo="Typo.h5" GutterBottom="true">
                <MudIcon Icon="@Icons.Material.Filled.Event" Class="mr-2" />
                Events Calendar - @GetSelectedCampsiteName()
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                Upcoming events and activities at this campsite
            </MudText>

            @if (GetCampsiteEvents().Any())
            {
                <MudTimeline TimelineOrientation="TimelineOrientation.Vertical" TimelinePosition="TimelinePosition.Start">
                    @foreach (var evt in GetCampsiteEvents())
                    {
                        <MudTimelineItem Color="@GetEventColor(evt.Category)" Size="Size.Small">
                            <ItemOpposite>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    @evt.EventDate.ToString("MMM dd")
                                </MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @evt.EventTime
                                </MudText>
                            </ItemOpposite>
                            <ItemContent>
                                <MudCard Elevation="2" Class="mb-2">
                                    <MudCardContent>
                                        <div class="d-flex justify-space-between align-center mb-2">
                                            <MudText Typo="Typo.h6">@evt.Name</MudText>
                                            <MudChip T="string" Size="Size.Small" Icon="@GetCategoryIcon(evt.Category)" Color="@GetEventColor(evt.Category)">
                                                @evt.Category
                                            </MudChip>
                                        </div>
                                        <MudText Typo="Typo.body2" Class="mb-2">@evt.Description</MudText>
                                        <MudDivider Class="my-2" />
                                        <div class="d-flex justify-space-between align-center">
                                            <div>
                                                @if (evt.MaxCapacity > 0)
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                        <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" />
                                                        @evt.RegisteredCount / @evt.MaxCapacity registered
                                                    </MudText>
                                                }
                                                else
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                        <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" />
                                                        @evt.RegisteredCount registered (Unlimited)
                                                    </MudText>
                                                }
                                            </div>
                                            <MudChip T="string" Size="Size.Small" Color="@(evt.Status == "Full" ? Color.Error : Color.Success)">
                                                @evt.Status
                                            </MudChip>
                                        </div>
                                    </MudCardContent>
                                </MudCard>
                            </ItemContent>
                        </MudTimelineItem>
                    }
                </MudTimeline>
            }
            else
            {
                <MudAlert Severity="Severity.Info">
                    No upcoming events scheduled for this campsite at the moment.
                </MudAlert>
            }
        </MudPaper>
    }

    <!-- Photo Gallery Section -->
    <MudPaper Elevation="3" Class="pa-4 mb-6">
        <MudText Typo="Typo.h5" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.PhotoLibrary" Class="mr-2" />
            @if (_selectedCampsiteId > 0)
            {
                <text>Photo Gallery - @GetSelectedCampsiteName()</text>
            }
            else
            {
                <text>Photo Gallery - All Campsites</text>
            }
        </MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
            @if (_selectedCampsiteId > 0)
            {
                <text>Explore photos from this campsite</text>
            }
            else
            {
                <text>Random photos from our campsite network</text>
            }
        </MudText>

        <MudGrid Spacing="3">
            @foreach (var photo in GetCampsitePhotos())
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard Elevation="2">
                        <MudCardMedia Image="@photo.ImageUrl" Height="200" />
                        <MudCardContent>
                            <MudText Typo="Typo.body2"><strong>@photo.Title</strong></MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@photo.CampsiteName</MudText>
                            @if (!string.IsNullOrEmpty(photo.Description))
                            {
                                <MudText Typo="Typo.caption" Class="mt-1">@photo.Description</MudText>
                            }
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    </MudPaper>

    <!-- About Section -->
    <MudGrid Class="mb-4">
        <MudItem xs="12" md="6">
            <MudPaper Elevation="2" Class="pa-4" Style="height: 100%;">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
                    About Our Campsites
                </MudText>
                <MudText Typo="Typo.body2" Class="mb-2">
                    Our network includes over 50 premium campsites across Denmark, each offering unique experiences and amenities.
                </MudText>
                <MudList T="string" Dense="true">
                    <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle">Family-friendly facilities</MudListItem>
                    <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle">Modern sanitary facilities</MudListItem>
                    <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle">Electric hookups available</MudListItem>
                    <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle">WiFi connectivity</MudListItem>
                    <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle">Pet-friendly options</MudListItem>
                </MudList>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudPaper Elevation="2" Class="pa-4" Style="height: 100%;">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Landscape" Class="mr-2" />
                    Locations
                </MudText>
                <MudText Typo="Typo.body2" Class="mb-2">
                    Experience Denmark's diverse landscapes:
                </MudText>
                <MudList T="string" Dense="true">
                    <MudListItem T="string" Icon="@Icons.Material.Filled.BeachAccess">Coastal campsites with beach access</MudListItem>
                    <MudListItem T="string" Icon="@Icons.Material.Filled.Forest">Forest retreats surrounded by nature</MudListItem>
                    <MudListItem T="string" Icon="@Icons.Material.Filled.LocationCity">Near major cities and attractions</MudListItem>
                    <MudListItem T="string" Icon="@Icons.Material.Filled.Park">National park locations</MudListItem>
                    <MudListItem T="string" Icon="@Icons.Material.Filled.Water">Lakeside camping spots</MudListItem>
                </MudList>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private int _selectedCampsiteId = 0;
    private List<CampsiteDto> _campsites = new();
    private List<EventDto> _events = new();
    private List<PhotoDto> _photos = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        Console.WriteLine("\n" + new string('=', 80));
        Console.WriteLine("ðŸ“° USER INFORMATION PAGE - Loading data from database...");
        Console.WriteLine(new string('=', 80));

        // Load events and photos from database using DbContextFactory
        await using var context = await DbContextFactory.CreateDbContextAsync();

        // Load campsites from database
        var dbCampsites = await context.Campsites.ToListAsync();
        _campsites = dbCampsites.Select(c => new CampsiteDto
        {
            Id = c.Id?.Value ?? 0,
            Name = c.Name ?? "",
            Region = c.Region ?? ""
        }).ToList();

        Console.WriteLine($"   âœ… Loaded {_campsites.Count} campsites for Information page");

        Console.WriteLine($"   ðŸ” Querying Events table...");
        var dbEvents = await context.Events.ToListAsync();
        Console.WriteLine($"   ðŸ“Š Raw query returned {dbEvents.Count} events from database");

        if (dbEvents.Count > 0)
        {
            Console.WriteLine($"   ðŸ“‹ Event details:");
            foreach (var evt in dbEvents)
            {
                Console.WriteLine($"      - Event ID: {evt.EventId}, Title: {evt.Title}, CampsiteId: {evt.CampsiteId?.Value ?? 0}");
            }
        }

        _events = dbEvents
            .Where(e => e.CampsiteId != null)
            .Select(e => new EventDto
            {
                Id = e.EventId,
                CampsiteId = e.CampsiteId.Value,
                Name = e.Title ?? string.Empty,
                Description = e.Description ?? string.Empty,
                CampsiteName = GetCampsiteNameById(e.CampsiteId.Value),
                EventDate = e.EventDate,
                EventTime = e.EventDate.ToString("h:mm tt"),
                Category = "Event", // Default category since Event model doesn't have category
                MaxCapacity = e.MaxParticipants,
                RegisteredCount = e.CurrentParticipants,
                Status = e.IsActive ? (e.IsFull() ? "Full" : "Open") : "Closed"
            }).ToList();

        Console.WriteLine($"   âœ… Loaded {_events.Count} events for Information page");

        // Load photos from database - Include both "Information" and "General" categories
        var dbPhotos = await context.Photos.ToListAsync();
        _photos = dbPhotos
            .Where(p => p.CampsiteId != null && (p.Category == "Information" || p.Category == "General"))
            .Select(p => new PhotoDto
            {
                Id = p.PhotoId,
                CampsiteId = p.CampsiteId.Value,
                CampsiteName = GetCampsiteNameById(p.CampsiteId.Value),
                Title = p.Caption ?? string.Empty,
                Description = p.AltText ?? string.Empty,
                ImageUrl = p.Url ?? string.Empty
            }).ToList();
        Console.WriteLine($"   âœ… Loaded {_photos.Count} photos for Information page");

        if (_events.Any())
        {
            Console.WriteLine($"\n   ðŸ“‹ Events by campsite:");
            var eventsByCampsite = _events.GroupBy(e => e.CampsiteName).ToList();
            foreach (var group in eventsByCampsite)
            {
                Console.WriteLine($"      - {group.Key}: {group.Count()} events");
            }
        }
        else
        {
            Console.WriteLine($"\n   âš ï¸  NO EVENTS FOUND! Events should be seeded in the database.");
        }

        Console.WriteLine(new string('=', 80) + "\n");
    }

    private void OnCampsiteChanged(int newValue)
    {
        _selectedCampsiteId = newValue;
        StateHasChanged();
    }

    private void ClearCampsiteSelection()
    {
        _selectedCampsiteId = 0;
        StateHasChanged();
    }

    private string GetSelectedCampsiteName()
    {
        var campsite = _campsites.FirstOrDefault(c => c.Id == _selectedCampsiteId);
        return campsite?.Name ?? "All Campsites";
    }

    private string GetCampsiteNameById(int campsiteId)
    {
        if (campsiteId == 0)
            return "All Campsites";

        var campsite = _campsites.FirstOrDefault(c => c.Id == campsiteId);
        return campsite?.Name ?? $"Campsite {campsiteId}";
    }

    private List<EventDto> GetCampsiteEvents()
    {
        if (_selectedCampsiteId == 0)
            return new List<EventDto>();

        return _events
            .Where(e => e.CampsiteId == _selectedCampsiteId)
            .OrderBy(e => e.EventDate)
            .ThenBy(e => e.EventTime)
            .ToList();
    }

    private List<PhotoDto> GetCampsitePhotos()
    {
        if (_selectedCampsiteId == 0)
        {
            // Return all photos for "All Campsites" (CampsiteId = 0)
            return _photos
                .Where(p => p.CampsiteId == 0)
                .ToList();
        }

        // Return photos for the selected campsite
        return _photos
            .Where(p => p.CampsiteId == _selectedCampsiteId)
            .ToList();
    }

    private Color GetEventColor(string category)
    {
        return category switch
        {
            "Sports" => Color.Primary,
            "Kids" => Color.Secondary,
            "Entertainment" => Color.Tertiary,
            "Nature" => Color.Success,
            "Wellness" => Color.Info,
            "Culture" => Color.Warning,
            _ => Color.Default
        };
    }

    private string GetCategoryIcon(string category)
    {
        return category switch
        {
            "Sports" => Icons.Material.Filled.SportsBaseball,
            "Kids" => Icons.Material.Filled.ChildCare,
            "Entertainment" => Icons.Material.Filled.Celebration,
            "Nature" => Icons.Material.Filled.Nature,
            "Wellness" => Icons.Material.Filled.SelfImprovement,
            "Culture" => Icons.Material.Filled.Museum,
            _ => Icons.Material.Filled.Event
        };
    }

    private class CampsiteDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Region { get; set; } = string.Empty;
    }

    private class EventDto
    {
        public int Id { get; set; }
        public int CampsiteId { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string CampsiteName { get; set; } = string.Empty;
        public DateTime EventDate { get; set; }
        public string EventTime { get; set; } = string.Empty;
        public string Category { get; set; } = string.Empty;
        public int MaxCapacity { get; set; }
        public int RegisteredCount { get; set; }
        public string Status { get; set; } = string.Empty;
    }

    private class PhotoDto
    {
        public int Id { get; set; }
        public int CampsiteId { get; set; }
        public string CampsiteName { get; set; } = string.Empty;
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string ImageUrl { get; set; } = string.Empty;
    }
}
