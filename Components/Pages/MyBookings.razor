@page "/bookings"
@rendermode InteractiveServer
@attribute [Authorize]
@inject IDialogService DialogService
@inject IDbContextFactory<CampsiteBookingDbContext> DbContextFactory
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider
@using CampsiteBooking.Data
@using CampsiteBooking.Models
@using CampsiteBooking.Models.ValueObjects
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims

<PageTitle>My Bookings - Campsite Booking</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">My Bookings</MudText>
    
    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Class="mt-4">
        <MudTabPanel Text="Upcoming" Icon="@Icons.Material.Filled.EventAvailable">
            @if (_upcomingBookings.Any())
            {
                <MudGrid Class="mt-2">
                    @foreach (var booking in _upcomingBookings)
                    {
                        <MudItem xs="12">
                            <MudCard Elevation="3">
                                <MudCardContent>
                                    <MudGrid Spacing="3">
                                        <MudItem xs="12" md="3">
                                            <div style="width: 100%; height: 200px; overflow: hidden; border-radius: 4px;">
                                                <img src="@booking.AccommodationImageUrl"
                                                     alt="@booking.AccommodationName"
                                                     style="width: 100%; height: 100%; object-fit: cover;" />
                                            </div>
                                        </MudItem>
                                        <MudItem xs="12" md="6">
                                            <MudText Typo="Typo.h6">@booking.AccommodationName</MudText>
                                            <MudChip T="string" Size="Size.Small" Color="Color.Info">@booking.AccommodationType</MudChip>
                                            <MudText Typo="Typo.body2" Class="mt-2">
                                                <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" />
                                                Check-in: @booking.CheckInDate.ToString("MMM dd, yyyy")
                                            </MudText>
                                            <MudText Typo="Typo.body2">
                                                <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" />
                                                Check-out: @booking.CheckOutDate.ToString("MMM dd, yyyy")
                                            </MudText>
                                            <MudText Typo="Typo.body2">
                                                <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" />
                                                Guests: @booking.NumberOfGuests
                                            </MudText>

                                            @if (booking.PeripheralPurchases.Any())
                                            {
                                                <MudText Typo="Typo.subtitle2" Class="mt-3 mb-1">Add-ons:</MudText>
                                                @foreach (var purchase in booking.PeripheralPurchases)
                                                {
                                                    <MudText Typo="Typo.body2" Class="ml-2">
                                                        ‚Ä¢ @purchase.Name - $@purchase.Price.ToString("N2")
                                                    </MudText>
                                                }
                                            }

                                            <MudText Typo="Typo.caption" Class="mt-2 mud-text-secondary">
                                                Booking ID: @booking.Id
                                            </MudText>
                                        </MudItem>
                                        <MudItem xs="12" md="3" Class="d-flex flex-column justify-space-between align-end">
                                            <div>
                                                <MudChip T="string" Color="Color.Success" Size="Size.Small">@booking.Status</MudChip>

                                                <MudPaper Elevation="0" Class="mt-3 pa-2" Style="background-color: var(--mud-palette-background-grey);">
                                                    <MudText Typo="Typo.body2" Class="mb-1">
                                                        <b>Cost Breakdown:</b>
                                                    </MudText>
                                                    <MudText Typo="Typo.body2">
                                                        Base: $@booking.BasePrice.ToString("N2")
                                                    </MudText>
                                                    @if (booking.PeripheralPurchases.Any())
                                                    {
                                                        <MudText Typo="Typo.body2">
                                                            Add-ons: $@booking.PeripheralPurchases.Sum(p => p.Price).ToString("N2")
                                                        </MudText>
                                                    }
                                                    <MudDivider Class="my-1" />
                                                    <MudText Typo="Typo.h6" Color="Color.Primary">
                                                        Total: $@booking.TotalPrice.ToString("N2")
                                                    </MudText>
                                                </MudPaper>
                                            </div>
                                            <MudStack Row="true" Spacing="1" Class="mt-2">
                                                <MudButton Variant="Variant.Outlined"
                                                          Color="Color.Primary"
                                                          Size="Size.Small"
                                                          Href="@($"/booking-details/{booking.Id}")">
                                                    View
                                                </MudButton>
                                                <MudButton Variant="Variant.Outlined"
                                                          Color="Color.Error"
                                                          Size="Size.Small"
                                                          OnClick="@(() => CancelBooking(booking.Id))">
                                                    Cancel
                                                </MudButton>
                                            </MudStack>
                                        </MudItem>
                                    </MudGrid>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Class="mt-4">
                    You have no upcoming bookings. <MudLink Href="/search">Search for accommodations</MudLink>
                </MudAlert>
            }
        </MudTabPanel>
        
        <MudTabPanel Text="Past" Icon="@Icons.Material.Filled.History">
            @if (_pastBookings.Any())
            {
                <MudGrid Class="mt-2">
                    @foreach (var booking in _pastBookings)
                    {
                        <MudItem xs="12">
                            <MudCard Elevation="2" Class="mud-theme-transparent">
                                <MudCardContent>
                                    <MudGrid Spacing="3">
                                        <MudItem xs="12" md="3">
                                            <div style="width: 100%; height: 200px; overflow: hidden; border-radius: 4px;">
                                                <img src="@booking.AccommodationImageUrl"
                                                     alt="@booking.AccommodationName"
                                                     style="width: 100%; height: 100%; object-fit: cover;" />
                                            </div>
                                        </MudItem>
                                        <MudItem xs="12" md="6">
                                            <MudText Typo="Typo.h6">@booking.AccommodationName</MudText>
                                            <MudChip T="string" Size="Size.Small" Color="Color.Info">@booking.AccommodationType</MudChip>
                                            <MudText Typo="Typo.body2" Class="mt-2">
                                                <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" />
                                                @booking.CheckInDate.ToString("MMM dd, yyyy") - @booking.CheckOutDate.ToString("MMM dd, yyyy")
                                            </MudText>

                                            @if (booking.PeripheralPurchases.Any())
                                            {
                                                <MudText Typo="Typo.subtitle2" Class="mt-3 mb-1">Add-ons:</MudText>
                                                @foreach (var purchase in booking.PeripheralPurchases)
                                                {
                                                    <MudText Typo="Typo.body2" Class="ml-2">
                                                        ‚Ä¢ @purchase.Name - $@purchase.Price.ToString("N2")
                                                    </MudText>
                                                }
                                            }

                                            <MudText Typo="Typo.caption" Class="mt-2 mud-text-secondary">
                                                Booking ID: @booking.Id
                                            </MudText>
                                        </MudItem>
                                        <MudItem xs="12" md="3" Class="d-flex flex-column justify-space-between align-end">
                                            <div>
                                                <MudChip T="string" Color="Color.Default" Size="Size.Small">@booking.Status</MudChip>

                                                <MudPaper Elevation="0" Class="mt-3 pa-2" Style="background-color: var(--mud-palette-background-grey);">
                                                    <MudText Typo="Typo.body2" Class="mb-1">
                                                        <b>Cost Breakdown:</b>
                                                    </MudText>
                                                    <MudText Typo="Typo.body2">
                                                        Base: $@booking.BasePrice.ToString("N2")
                                                    </MudText>
                                                    @if (booking.PeripheralPurchases.Any())
                                                    {
                                                        <MudText Typo="Typo.body2">
                                                            Add-ons: $@booking.PeripheralPurchases.Sum(p => p.Price).ToString("N2")
                                                        </MudText>
                                                    }
                                                    <MudDivider Class="my-1" />
                                                    <MudText Typo="Typo.h6">
                                                        Total: $@booking.TotalPrice.ToString("N2")
                                                    </MudText>
                                                </MudPaper>
                                            </div>
                                            <MudButton Variant="Variant.Outlined"
                                                      Color="Color.Primary"
                                                      Size="Size.Small"
                                                      Href="@($"/booking-details/{booking.Id}")"
                                                      Class="mt-2">
                                                View Details
                                            </MudButton>
                                        </MudItem>
                                    </MudGrid>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Class="mt-4">
                    You have no past bookings.
                </MudAlert>
            }
        </MudTabPanel>
        
        <MudTabPanel Text="Cancelled" Icon="@Icons.Material.Filled.Cancel">
            @if (_cancelledBookings.Any())
            {
                <MudGrid Class="mt-2">
                    @foreach (var booking in _cancelledBookings)
                    {
                        <MudItem xs="12">
                            <MudCard Elevation="1">
                                <MudCardContent>
                                    <MudGrid>
                                        <MudItem xs="12" md="9">
                                            <MudText Typo="Typo.h6">@booking.AccommodationName</MudText>
                                            <MudText Typo="Typo.body2">
                                                @booking.CheckInDate.ToString("MMM dd, yyyy") - @booking.CheckOutDate.ToString("MMM dd, yyyy")
                                            </MudText>
                                        </MudItem>
                                        <MudItem xs="12" md="3" Class="d-flex flex-column align-end">
                                            <MudChip T="string" Color="Color.Error" Size="Size.Small">Cancelled</MudChip>
                                        </MudItem>
                                    </MudGrid>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Class="mt-4">
                    You have no cancelled bookings.
                </MudAlert>
            }
        </MudTabPanel>
    </MudTabs>
</MudContainer>

@code {
    private List<BookingDto> _upcomingBookings = new();
    private List<BookingDto> _pastBookings = new();
    private List<BookingDto> _cancelledBookings = new();
    private int _currentUserId = 0;

    protected override async Task OnInitializedAsync()
    {
        // Get current user ID from authentication claims
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user?.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier);
            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
            {
                _currentUserId = userId;
                Console.WriteLine($"‚úÖ MyBookings: User authenticated - UserId = {_currentUserId}");
                await LoadBookings();
            }
            else
            {
                Console.WriteLine("‚ùå MyBookings: User ID claim not found");
            }
        }
        else
        {
            Console.WriteLine("‚ö†Ô∏è MyBookings: User not authenticated");
        }
    }

    private async Task LoadBookings()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // SECURITY: Only load bookings for the current authenticated user
            var currentGuestId = GuestId.Create(_currentUserId);
            var dbBookings = await context.Bookings
                .Where(b => EF.Property<GuestId>(b, "_guestId") == currentGuestId)
                .ToListAsync();

            Console.WriteLine($"üîí SECURITY: Loading bookings only for user {_currentUserId} - Found {dbBookings.Count} bookings");

            // Load all related entities
            // Convert GuestId to UserId for querying (Guest inherits from User)
            var userIds = dbBookings.Select(b => UserId.Create(b.GuestId.Value)).Distinct().ToList();
            var guests = await context.Users.OfType<Guest>()
                .Where(g => userIds.Contains(g.Id))
                .ToListAsync();

            var accommodationTypeIds = dbBookings.Select(b => b.AccommodationTypeId).Distinct().ToList();
            var accommodationTypes = await context.AccommodationTypes
                .Where(at => accommodationTypeIds.Contains(at.Id))
                .ToListAsync();

            var campsiteIds = accommodationTypes.Select(at => at.CampsiteId).Distinct().ToList();
            var campsites = await context.Campsites
                .Where(c => campsiteIds.Contains(c.Id))
                .ToListAsync();

            Console.WriteLine($"üìä Loaded {dbBookings.Count} bookings from database for My Bookings page");

            // Convert to DTOs
            var allBookings = new List<BookingDto>();

            foreach (var booking in dbBookings)
            {
                // Get related entities
                var guest = guests.FirstOrDefault(g => g.Id == booking.GuestId);
                var accommodationType = accommodationTypes.FirstOrDefault(at => at.Id == booking.AccommodationTypeId);
                var campsite = accommodationType != null
                    ? campsites.FirstOrDefault(c => c.Id == accommodationType.CampsiteId)
                    : null;

                // Calculate total price (base price + peripheral purchases)
                var basePrice = booking.TotalPrice?.Amount ?? 0m;
                var peripheralTotal = 0m; // TODO: Load peripheral purchases from database if stored

                allBookings.Add(new BookingDto
                {
                    Id = booking.Id?.Value.ToString() ?? "0",
                    AccommodationName = $"{accommodationType?.Type ?? "Unknown"} at {campsite?.Name ?? "Unknown Campsite"}",
                    AccommodationType = accommodationType?.Type ?? "Unknown",
                    AccommodationImageUrl = accommodationType?.ImageUrl ?? "https://images.unsplash.com/photo-1478131143081-80f7f84ca84d?w=400",
                    CheckInDate = booking.Period?.StartDate ?? DateTime.Today,
                    CheckOutDate = booking.Period?.EndDate ?? DateTime.Today,
                    NumberOfGuests = booking.NumberOfAdults + booking.NumberOfChildren,
                    BasePrice = basePrice,
                    PeripheralPurchases = new List<PeripheralPurchaseDto>(), // TODO: Load from database
                    TotalPrice = basePrice + peripheralTotal,
                    Status = booking.Status.ToString()
                });
            }

            // Filter bookings by status and date
            _upcomingBookings = allBookings
                .Where(b => (b.Status == "Confirmed" || b.Status == "Pending") && b.CheckInDate >= DateTime.Today)
                .OrderBy(b => b.CheckInDate)
                .ToList();

            _pastBookings = allBookings
                .Where(b => b.Status == "Completed" || (b.CheckOutDate < DateTime.Today && b.Status != "Cancelled"))
                .OrderByDescending(b => b.CheckOutDate)
                .ToList();

            _cancelledBookings = allBookings
                .Where(b => b.Status == "Cancelled")
                .OrderByDescending(b => b.CheckInDate)
                .ToList();

            Console.WriteLine($"‚úÖ Upcoming: {_upcomingBookings.Count}, Past: {_pastBookings.Count}, Cancelled: {_cancelledBookings.Count}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error loading bookings: {ex.Message}");
            Snackbar.Add($"Error loading bookings: {ex.Message}", Severity.Error);
            _upcomingBookings = new List<BookingDto>();
            _pastBookings = new List<BookingDto>();
            _cancelledBookings = new List<BookingDto>();
        }
    }

    private async Task CancelBooking(string bookingId)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirm Cancellation",
            "Are you sure you want to cancel this booking? This action cannot be undone.",
            yesText:"Cancel Booking", cancelText:"Keep Booking");

        if (result == true)
        {
            try
            {
                using var context = await DbContextFactory.CreateDbContextAsync();

                // Parse booking ID
                if (!int.TryParse(bookingId, out int id))
                {
                    Snackbar.Add("Invalid booking ID", Severity.Error);
                    return;
                }

                // Find the booking in the database
                var bookingIdValue = BookingId.Create(id);
                var currentGuestId = GuestId.Create(_currentUserId);
                var booking = await context.Bookings
                    .FirstOrDefaultAsync(b => b.Id == bookingIdValue);

                if (booking != null)
                {
                    // SECURITY: Verify the booking belongs to the current user
                    if (booking.GuestId != currentGuestId)
                    {
                        Console.WriteLine($"üö® SECURITY VIOLATION: User {_currentUserId} attempted to cancel booking {id} owned by user {booking.GuestId.Value}");
                        Snackbar.Add("You can only cancel your own bookings", Severity.Error);
                        return;
                    }

                    // Update booking status to Cancelled
                    booking.Cancel();
                    await context.SaveChangesAsync();

                    Console.WriteLine($"‚úÖ User {_currentUserId} cancelled their booking {id}");
                    Snackbar.Add("Booking cancelled successfully", Severity.Success);

                    // Reload bookings to reflect the change
                    await LoadBookings();
                }
                else
                {
                    Snackbar.Add("Booking not found", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå Error cancelling booking: {ex.Message}");
                Snackbar.Add($"Error cancelling booking: {ex.Message}", Severity.Error);
            }
        }
    }

    public class BookingDto
    {
        public string Id { get; set; } = string.Empty;
        public string AccommodationName { get; set; } = string.Empty;
        public string AccommodationType { get; set; } = string.Empty;
        public string AccommodationImageUrl { get; set; } = string.Empty;
        public DateTime CheckInDate { get; set; }
        public DateTime CheckOutDate { get; set; }
        public int NumberOfGuests { get; set; }
        public decimal BasePrice { get; set; }
        public List<PeripheralPurchaseDto> PeripheralPurchases { get; set; } = new();
        public decimal TotalPrice { get; set; }
        public string Status { get; set; } = string.Empty;
    }

    public class PeripheralPurchaseDto
    {
        public string Name { get; set; } = string.Empty;
        public decimal Price { get; set; }
    }
}

