@page "/bookings"
@rendermode InteractiveServer
@inject IDialogService DialogService

<PageTitle>My Bookings - Campsite Booking</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">My Bookings</MudText>
    
    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Class="mt-4">
        <MudTabPanel Text="Upcoming" Icon="@Icons.Material.Filled.EventAvailable">
            @if (_upcomingBookings.Any())
            {
                <MudGrid Class="mt-2">
                    @foreach (var booking in _upcomingBookings)
                    {
                        <MudItem xs="12">
                            <MudCard Elevation="3">
                                <MudCardContent>
                                    <MudGrid Spacing="3">
                                        <MudItem xs="12" md="3">
                                            <div style="width: 100%; height: 200px; overflow: hidden; border-radius: 4px;">
                                                <img src="@booking.AccommodationImageUrl"
                                                     alt="@booking.AccommodationName"
                                                     style="width: 100%; height: 100%; object-fit: cover;" />
                                            </div>
                                        </MudItem>
                                        <MudItem xs="12" md="6">
                                            <MudText Typo="Typo.h6">@booking.AccommodationName</MudText>
                                            <MudChip T="string" Size="Size.Small" Color="Color.Info">@booking.AccommodationType</MudChip>
                                            <MudText Typo="Typo.body2" Class="mt-2">
                                                <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" />
                                                Check-in: @booking.CheckInDate.ToString("MMM dd, yyyy")
                                            </MudText>
                                            <MudText Typo="Typo.body2">
                                                <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" />
                                                Check-out: @booking.CheckOutDate.ToString("MMM dd, yyyy")
                                            </MudText>
                                            <MudText Typo="Typo.body2">
                                                <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" />
                                                Guests: @booking.NumberOfGuests
                                            </MudText>

                                            @if (booking.PeripheralPurchases.Any())
                                            {
                                                <MudText Typo="Typo.subtitle2" Class="mt-3 mb-1">Add-ons:</MudText>
                                                @foreach (var purchase in booking.PeripheralPurchases)
                                                {
                                                    <MudText Typo="Typo.body2" Class="ml-2">
                                                        • @purchase.Name - $@purchase.Price.ToString("N2")
                                                    </MudText>
                                                }
                                            }

                                            <MudText Typo="Typo.caption" Class="mt-2 mud-text-secondary">
                                                Booking ID: @booking.Id
                                            </MudText>
                                        </MudItem>
                                        <MudItem xs="12" md="3" Class="d-flex flex-column justify-space-between align-end">
                                            <div>
                                                <MudChip T="string" Color="Color.Success" Size="Size.Small">@booking.Status</MudChip>

                                                <MudPaper Elevation="0" Class="mt-3 pa-2" Style="background-color: var(--mud-palette-background-grey);">
                                                    <MudText Typo="Typo.body2" Class="mb-1">
                                                        <b>Cost Breakdown:</b>
                                                    </MudText>
                                                    <MudText Typo="Typo.body2">
                                                        Base: $@booking.BasePrice.ToString("N2")
                                                    </MudText>
                                                    @if (booking.PeripheralPurchases.Any())
                                                    {
                                                        <MudText Typo="Typo.body2">
                                                            Add-ons: $@booking.PeripheralPurchases.Sum(p => p.Price).ToString("N2")
                                                        </MudText>
                                                    }
                                                    <MudDivider Class="my-1" />
                                                    <MudText Typo="Typo.h6" Color="Color.Primary">
                                                        Total: $@booking.TotalPrice.ToString("N2")
                                                    </MudText>
                                                </MudPaper>
                                            </div>
                                            <MudStack Row="true" Spacing="1" Class="mt-2">
                                                <MudButton Variant="Variant.Outlined"
                                                          Color="Color.Primary"
                                                          Size="Size.Small"
                                                          Href="@($"/booking-details/{booking.Id}")">
                                                    View
                                                </MudButton>
                                                <MudButton Variant="Variant.Outlined"
                                                          Color="Color.Error"
                                                          Size="Size.Small"
                                                          OnClick="@(() => CancelBooking(booking.Id))">
                                                    Cancel
                                                </MudButton>
                                            </MudStack>
                                        </MudItem>
                                    </MudGrid>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Class="mt-4">
                    You have no upcoming bookings. <MudLink Href="/search">Search for accommodations</MudLink>
                </MudAlert>
            }
        </MudTabPanel>
        
        <MudTabPanel Text="Past" Icon="@Icons.Material.Filled.History">
            @if (_pastBookings.Any())
            {
                <MudGrid Class="mt-2">
                    @foreach (var booking in _pastBookings)
                    {
                        <MudItem xs="12">
                            <MudCard Elevation="2" Class="mud-theme-transparent">
                                <MudCardContent>
                                    <MudGrid Spacing="3">
                                        <MudItem xs="12" md="3">
                                            <div style="width: 100%; height: 200px; overflow: hidden; border-radius: 4px;">
                                                <img src="@booking.AccommodationImageUrl"
                                                     alt="@booking.AccommodationName"
                                                     style="width: 100%; height: 100%; object-fit: cover;" />
                                            </div>
                                        </MudItem>
                                        <MudItem xs="12" md="6">
                                            <MudText Typo="Typo.h6">@booking.AccommodationName</MudText>
                                            <MudChip T="string" Size="Size.Small" Color="Color.Info">@booking.AccommodationType</MudChip>
                                            <MudText Typo="Typo.body2" Class="mt-2">
                                                <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" />
                                                @booking.CheckInDate.ToString("MMM dd, yyyy") - @booking.CheckOutDate.ToString("MMM dd, yyyy")
                                            </MudText>

                                            @if (booking.PeripheralPurchases.Any())
                                            {
                                                <MudText Typo="Typo.subtitle2" Class="mt-3 mb-1">Add-ons:</MudText>
                                                @foreach (var purchase in booking.PeripheralPurchases)
                                                {
                                                    <MudText Typo="Typo.body2" Class="ml-2">
                                                        • @purchase.Name - $@purchase.Price.ToString("N2")
                                                    </MudText>
                                                }
                                            }

                                            <MudText Typo="Typo.caption" Class="mt-2 mud-text-secondary">
                                                Booking ID: @booking.Id
                                            </MudText>
                                        </MudItem>
                                        <MudItem xs="12" md="3" Class="d-flex flex-column justify-space-between align-end">
                                            <div>
                                                <MudChip T="string" Color="Color.Default" Size="Size.Small">@booking.Status</MudChip>

                                                <MudPaper Elevation="0" Class="mt-3 pa-2" Style="background-color: var(--mud-palette-background-grey);">
                                                    <MudText Typo="Typo.body2" Class="mb-1">
                                                        <b>Cost Breakdown:</b>
                                                    </MudText>
                                                    <MudText Typo="Typo.body2">
                                                        Base: $@booking.BasePrice.ToString("N2")
                                                    </MudText>
                                                    @if (booking.PeripheralPurchases.Any())
                                                    {
                                                        <MudText Typo="Typo.body2">
                                                            Add-ons: $@booking.PeripheralPurchases.Sum(p => p.Price).ToString("N2")
                                                        </MudText>
                                                    }
                                                    <MudDivider Class="my-1" />
                                                    <MudText Typo="Typo.h6">
                                                        Total: $@booking.TotalPrice.ToString("N2")
                                                    </MudText>
                                                </MudPaper>
                                            </div>
                                            <MudButton Variant="Variant.Outlined"
                                                      Color="Color.Primary"
                                                      Size="Size.Small"
                                                      Href="@($"/booking-details/{booking.Id}")"
                                                      Class="mt-2">
                                                View Details
                                            </MudButton>
                                        </MudItem>
                                    </MudGrid>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Class="mt-4">
                    You have no past bookings.
                </MudAlert>
            }
        </MudTabPanel>
        
        <MudTabPanel Text="Cancelled" Icon="@Icons.Material.Filled.Cancel">
            @if (_cancelledBookings.Any())
            {
                <MudGrid Class="mt-2">
                    @foreach (var booking in _cancelledBookings)
                    {
                        <MudItem xs="12">
                            <MudCard Elevation="1">
                                <MudCardContent>
                                    <MudGrid>
                                        <MudItem xs="12" md="9">
                                            <MudText Typo="Typo.h6">@booking.AccommodationName</MudText>
                                            <MudText Typo="Typo.body2">
                                                @booking.CheckInDate.ToString("MMM dd, yyyy") - @booking.CheckOutDate.ToString("MMM dd, yyyy")
                                            </MudText>
                                        </MudItem>
                                        <MudItem xs="12" md="3" Class="d-flex flex-column align-end">
                                            <MudChip T="string" Color="Color.Error" Size="Size.Small">Cancelled</MudChip>
                                        </MudItem>
                                    </MudGrid>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Class="mt-4">
                    You have no cancelled bookings.
                </MudAlert>
            }
        </MudTabPanel>
    </MudTabs>
</MudContainer>

@code {
    private List<BookingDto> _upcomingBookings = new();
    private List<BookingDto> _pastBookings = new();
    private List<BookingDto> _cancelledBookings = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadBookings();
    }

    private async Task LoadBookings()
    {
        await Task.Delay(300); // Simulate API call

        // Mock data - will be replaced with actual API call
        var allBookings = new List<BookingDto>
        {
            new BookingDto
            {
                Id = "BK001",
                AccommodationName = "Lakeside Cabin",
                AccommodationType = "Cabin",
                AccommodationImageUrl = "https://images.unsplash.com/photo-1587061949409-02df41d5e562?w=400",
                CheckInDate = DateTime.Today.AddDays(7),
                CheckOutDate = DateTime.Today.AddDays(10),
                NumberOfGuests = 4,
                BasePrice = 300,
                PeripheralPurchases = new List<PeripheralPurchaseDto>
                {
                    new() { Name = "Cleaning Service", Price = 50 },
                    new() { Name = "Kayak Rental", Price = 35 },
                    new() { Name = "Bike Rental", Price = 20 }
                },
                TotalPrice = 405,
                Status = "Confirmed"
            },
            new BookingDto
            {
                Id = "BK002",
                AccommodationName = "Mountain View Cabin",
                AccommodationType = "Cabin",
                AccommodationImageUrl = "https://images.unsplash.com/photo-1542718610-a1d656d1884c?w=400",
                CheckInDate = DateTime.Today.AddDays(21),
                CheckOutDate = DateTime.Today.AddDays(23),
                NumberOfGuests = 2,
                BasePrice = 240,
                PeripheralPurchases = new List<PeripheralPurchaseDto>
                {
                    new() { Name = "Cleaning Service", Price = 50 },
                    new() { Name = "Morning Yoga", Price = 18 }
                },
                TotalPrice = 308,
                Status = "Confirmed"
            },
            new BookingDto
            {
                Id = "BK003",
                AccommodationName = "Forest Tent Site",
                AccommodationType = "Tent Site",
                AccommodationImageUrl = "https://images.unsplash.com/photo-1478131143081-80f7f84ca84d?w=400",
                CheckInDate = DateTime.Today.AddDays(-10),
                CheckOutDate = DateTime.Today.AddDays(-8),
                NumberOfGuests = 2,
                BasePrice = 60,
                PeripheralPurchases = new List<PeripheralPurchaseDto>
                {
                    new() { Name = "Tent Rental", Price = 30 }
                },
                TotalPrice = 90,
                Status = "Completed"
            },
            new BookingDto
            {
                Id = "BK004",
                AccommodationName = "Luxury Glamping",
                AccommodationType = "Glamping",
                AccommodationImageUrl = "https://images.unsplash.com/photo-1504280390367-361c6d9f38f4?w=400",
                CheckInDate = DateTime.Today.AddDays(-30),
                CheckOutDate = DateTime.Today.AddDays(-28),
                NumberOfGuests = 2,
                BasePrice = 340,
                PeripheralPurchases = new List<PeripheralPurchaseDto>
                {
                    new() { Name = "Premium Cleaning", Price = 75 },
                    new() { Name = "Welcome Package", Price = 40 },
                    new() { Name = "Restaurant Brunch (Daily)", Price = 60 }
                },
                TotalPrice = 515,
                Status = "Completed"
            },
        };

        _upcomingBookings = allBookings.Where(b => b.Status == "Confirmed" && b.CheckInDate >= DateTime.Today).ToList();
        _pastBookings = allBookings.Where(b => b.Status == "Completed").ToList();
        _cancelledBookings = allBookings.Where(b => b.Status == "Cancelled").ToList();
    }

    private async Task CancelBooking(string bookingId)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirm Cancellation",
            "Are you sure you want to cancel this booking? This action cannot be undone.",
            yesText:"Cancel Booking", cancelText:"Keep Booking");

        if (result == true)
        {
            // TODO: Call API to cancel booking
            await Task.Delay(300);

            var booking = _upcomingBookings.FirstOrDefault(b => b.Id == bookingId);
            if (booking != null)
            {
                booking.Status = "Cancelled";
                _upcomingBookings.Remove(booking);
                _cancelledBookings.Add(booking);
            }
        }
    }

    public class BookingDto
    {
        public string Id { get; set; } = string.Empty;
        public string AccommodationName { get; set; } = string.Empty;
        public string AccommodationType { get; set; } = string.Empty;
        public string AccommodationImageUrl { get; set; } = string.Empty;
        public DateTime CheckInDate { get; set; }
        public DateTime CheckOutDate { get; set; }
        public int NumberOfGuests { get; set; }
        public decimal BasePrice { get; set; }
        public List<PeripheralPurchaseDto> PeripheralPurchases { get; set; } = new();
        public decimal TotalPrice { get; set; }
        public string Status { get; set; } = string.Empty;
    }

    public class PeripheralPurchaseDto
    {
        public string Name { get; set; } = string.Empty;
        public decimal Price { get; set; }
    }
}

