@page "/booking"
@page "/booking/{CampsiteIdParam:int}"
@rendermode InteractiveServer
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject IDbContextFactory<CampsiteBookingDbContext> DbContextFactory
@inject ISnackbar Snackbar
@inject MockPaymentService StripeService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IKafkaProducer KafkaProducer
@inject IPricingService PricingService
@using CampsiteBooking.Data
@using CampsiteBooking.Models
@using CampsiteBooking.Models.ValueObjects
@using CampsiteBooking.Models.DomainEvents
@using CampsiteBooking.Services
@using CampsiteBooking.Infrastructure.Kafka
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.WebUtilities
@using System.Security.Claims

<PageTitle>Book Accommodation - Campsite Booking</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Complete Your Booking</MudText>

    @if (_isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
        <MudText Typo="Typo.body1" Align="Align.Center" Class="my-8">Loading booking information...</MudText>
    }
    else if (_accommodation != null)
    {
        <MudGrid>
            <MudItem xs="12" md="5">
                <MudCard Elevation="3">
                    <ImageSlideshow GalleryImages="@_accommodation.GalleryImages"
                                    FallbackImageUrl="@_accommodation.ImageUrl"
                                    AutoPlay="true"
                                    ShowControls="true"
                                    Height="250" />
                    <MudCardContent>
                        <MudText Typo="Typo.h6">@_accommodation.Name</MudText>
                        <MudStack Row="true" Spacing="1" Class="mb-2">
                            <MudChip T="string" Size="Size.Small" Color="Color.Info">@_accommodation.Type</MudChip>
                            <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Icon="@Icons.Material.Filled.LocationOn">@_accommodation.CampsiteName</MudChip>
                        </MudStack>
                        <MudText Typo="Typo.body2" Class="mt-2">@_accommodation.Description</MudText>

                        @if (_accommodation.Amenities.Any())
                        {
                            <MudStack Row="true" Spacing="1" Class="mt-2" Wrap="Wrap.Wrap">
                                @foreach (var amenity in _accommodation.Amenities)
                                {
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Icon="@GetAmenityIcon(amenity)">
                                        @amenity
                                    </MudChip>
                                }
                            </MudStack>
                        }

                        <MudDivider Class="my-3" />

                        <MudStack Spacing="2">
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.body2">Base price per night:</MudText>
                                <MudText Typo="Typo.body1"><b>$@_accommodation.PricePerNight.ToString("N2")</b></MudText>
                            </MudStack>
                            @if (_selectedSpot != null && _selectedSpot.PriceModifier != 1.0m)
                            {
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText Typo="Typo.body2">Spot modifier (@_selectedSpot.SpotId):</MudText>
                                    <MudText Typo="Typo.body1" Color="Color.Warning"><b>√ó@_selectedSpot.PriceModifier.ToString("N2")</b></MudText>
                                </MudStack>
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText Typo="Typo.body2">Adjusted price per night:</MudText>
                                    <MudText Typo="Typo.body1" Color="Color.Primary"><b>$@_spotPrice.ToString("N2")</b></MudText>
                                </MudStack>
                            }
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.body2">Number of nights:</MudText>
                                <MudText Typo="Typo.body1"><b>@_numberOfNights</b></MudText>
                            </MudStack>
                            @if (_pricingBreakdown != null && _pricingBreakdown.AverageMultiplier != 1.0m)
                            {
                                <!-- Seasonal pricing information -->
                                @if (_pricingBreakdown.SpansMultipleSeasons)
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Info" Class="mb-1">
                                        <MudIcon Icon="@Icons.Material.Filled.DateRange" Size="Size.Small" Style="vertical-align: middle;" />
                                        Multiple seasons apply to this booking:
                                    </MudText>
                                    @foreach (var seasonGroup in _pricingBreakdown.NightlyBreakdown.GroupBy(n => n.SeasonName))
                                    {
                                        var nights = seasonGroup.Count();
                                        var multiplier = seasonGroup.First().SeasonalMultiplier;
                                        var seasonTotal = seasonGroup.Sum(n => n.Price);
                                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                                            <MudText Typo="Typo.body2" Color="Color.Info">@seasonGroup.Key (@nights nights √ó@multiplier.ToString("F2")):</MudText>
                                            <MudText Typo="Typo.body1" Color="Color.Info"><b>$@seasonTotal.ToString("N2")</b></MudText>
                                        </MudStack>
                                    }
                                }
                                else
                                {
                                    var seasonName = _pricingBreakdown.NightlyBreakdown.FirstOrDefault()?.SeasonName ?? "Seasonal";
                                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                                        <MudText Typo="Typo.body2" Color="Color.Info">@seasonName multiplier:</MudText>
                                        <MudText Typo="Typo.body1" Color="Color.Info"><b>√ó@_pricingBreakdown.AverageMultiplier.ToString("F2")</b></MudText>
                                    </MudStack>
                                }
                            }
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.body2">Accommodation subtotal:</MudText>
                                <MudText Typo="Typo.body1"><b>$@_accommodationSubtotal.ToString("N2")</b></MudText>
                            </MudStack>
                            @if (_selectedServices.Any())
                            {
                                <MudDivider Class="my-2" />
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-1">Additional Services:</MudText>
                                @foreach (var service in _selectedServices)
                                {
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                            <MudIconButton Icon="@Icons.Material.Filled.Close"
                                                           Size="Size.Small"
                                                           Color="Color.Error"
                                                           Title="Remove service"
                                                           OnClick="@(() => RemovePeripheralPurchase(service))" />
                                            <MudText Typo="Typo.body2">@service.Name:</MudText>
                                        </MudStack>
                                        <MudText Typo="Typo.body1" Color="Color.Info"><b>$@service.Price.ToString("N2")</b></MudText>
                                    </MudStack>
                                }
                            }

                            <MudDivider Class="my-2" />

                            <!-- Discount Code Section -->
                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.End">
                                <MudTextField @bind-Value="_discountCode"
                                             Label="Discount Code"
                                             Variant="Variant.Outlined"
                                             Placeholder="Enter code"
                                             Dense="true"
                                             Style="flex: 1;" />
                                <MudButton Variant="Variant.Filled"
                                          Color="@(_discountApplied ? Color.Success : Color.Primary)"
                                          OnClick="ApplyDiscount"
                                          Disabled="@(string.IsNullOrWhiteSpace(_discountCode) || _discountApplied)"
                                          Size="Size.Small">
                                    @(_discountApplied ? "Applied" : "Apply")
                                </MudButton>
                            </MudStack>

                            @if (_discountApplied && _discountAmount > 0)
                            {
                                <MudAlert Severity="Severity.Success" Dense="true" Class="mt-2">
                                    Discount "@_appliedDiscountCode" applied: @_discountPercentage% off!
                                </MudAlert>
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText Typo="Typo.body2">Subtotal:</MudText>
                                    <MudText Typo="Typo.body1"><b>$@_subtotalPrice.ToString("N2")</b></MudText>
                                </MudStack>
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText Typo="Typo.body2" Color="Color.Success">Discount (@_discountPercentage%):</MudText>
                                    <MudText Typo="Typo.body1" Color="Color.Success"><b>-$@_discountAmount.ToString("N2")</b></MudText>
                                </MudStack>
                            }
                            @if (!string.IsNullOrWhiteSpace(_discountError))
                            {
                                <MudAlert Severity="Severity.Error" Dense="true" Class="mt-2" CloseIcon="@Icons.Material.Filled.Close" CloseIconClicked="@(() => _discountError = string.Empty)">
                                    @_discountError
                                </MudAlert>
                            }

                            <MudDivider />
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.h6">Total:</MudText>
                                <MudText Typo="Typo.h6" Color="Color.Primary">$@_totalPrice.ToString("N2")</MudText>
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" md="7">
                <MudPaper Elevation="3" Class="pa-4">
                    <MudForm @ref="_form" @bind-IsValid="@_formValid">
                        <MudText Typo="Typo.h6" GutterBottom="true">Booking Details</MudText>
                        
                        <MudDateRangePicker Label="Check-in / Check-out"
                                           DateRange="_dateRange"
                                           DateRangeChanged="OnDateRangeChanged"
                                           MinDate="DateTime.Today"
                                           Required="true"
                                           RequiredError="Please select dates"
                                           Editable="true" />
                        
                        <MudNumericField @bind-Value="_numberOfGuests"
                                        Label="Number of Guests"
                                        Variant="Variant.Outlined"
                                        Min="1"
                                        Max="@_accommodation.Capacity"
                                        Required="true"
                                        Class="mt-3" />

                        <MudSelect T="CampingSpot"
                                  Value="_selectedSpot"
                                  ValueChanged="OnSpotSelectedAsync"
                                  Label="Select Camping Spot"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  RequiredError="Please select a camping spot"
                                  Class="mt-3"
                                  AnchorOrigin="Origin.BottomCenter">
                            @foreach (var spot in _campingSpots.Where(s => s.Status == "Available"))
                            {
                                <MudSelectItem T="CampingSpot" Value="@spot">
                                    @spot.SpotId - @spot.Type
                                    @if (spot.PriceModifier > 1.0m)
                                    {
                                        <text> (Premium +@(((spot.PriceModifier - 1) * 100).ToString("0"))%)</text>
                                    }
                                </MudSelectItem>
                            }
                        </MudSelect>

                        <MudDivider Class="my-4" />

                        <MudText Typo="Typo.h6" GutterBottom="true">Guest Information</MudText>

                        @if (_isAuthenticated)
                        {
                            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-3">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.AccountCircle" Size="Size.Small" />
                                    <MudText Typo="Typo.body2">
                                        Using your account information. To update, visit <MudLink Href="/my-account" Color="Color.Primary">My Account</MudLink>.
                                    </MudText>
                                </MudStack>
                            </MudAlert>
                        }

                        <MudTextField @bind-Value="_guestName"
                                     Label="Full Name"
                                     Variant="Variant.Outlined"
                                     Required="true"
                                     RequiredError="Name is required"
                                     ReadOnly="_isAuthenticated"
                                     Disabled="_isAuthenticated" />

                        <MudTextField @bind-Value="_guestEmail"
                                     Label="Email"
                                     Variant="Variant.Outlined"
                                     InputType="InputType.Email"
                                     Required="true"
                                     RequiredError="Email is required"
                                     Class="mt-3"
                                     ReadOnly="_isAuthenticated"
                                     Disabled="_isAuthenticated" />

                        <MudTextField @bind-Value="_guestPhone"
                                     Label="Phone Number"
                                     Variant="Variant.Outlined"
                                     InputType="InputType.Telephone"
                                     Required="true"
                                     RequiredError="Phone is required"
                                     Class="mt-3"
                                     ReadOnly="_isAuthenticated"
                                     Disabled="_isAuthenticated" />

                        @if (_isAuthenticated && !string.IsNullOrWhiteSpace(_guestCountry))
                        {
                            <MudTextField @bind-Value="_guestCountry"
                                         Label="Country"
                                         Variant="Variant.Outlined"
                                         Class="mt-3"
                                         ReadOnly="true"
                                         Disabled="true" />
                        }

                        <MudTextField @bind-Value="_specialRequests"
                                     Label="Special Requests (Optional)"
                                     Variant="Variant.Outlined"
                                     Lines="3"
                                     Class="mt-3" />
                        
                        <MudStack Row="true" Class="mt-4" Spacing="2">
                            <MudButton Variant="Variant.Outlined"
                                      Color="Color.Default"
                                      OnClick="Cancel">
                                Cancel
                            </MudButton>
                            <MudButton Variant="Variant.Filled"
                                      Color="Color.Primary"
                                      Disabled="@(!_formValid || _selectedSpot == null)"
                                      OnClick="ShowPaymentDialog"
                                      FullWidth="true">
                                Proceed to Payment
                            </MudButton>
                        </MudStack>

                        @if (_selectedSpot == null)
                        {
                            <MudAlert Severity="Severity.Warning" Class="mt-3">
                                Please select a camping spot to continue.
                            </MudAlert>
                        }
                    </MudForm>
                </MudPaper>
            </MudItem>

            <MudItem xs="12">
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" GutterBottom="true">Additional Services</MudText>
                    <MudText Typo="Typo.body2" Class="mb-3">
                        Optional services to enhance your stay.
                    </MudText>

                    @if (_accommodationPeripheralPurchases.Any())
                    {
                        <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.HomeWork" Size="Size.Small" Class="mr-1" />
                            Accommodation Services
                        </MudText>
                        @foreach (var service in _accommodationPeripheralPurchases)
                        {
                            <MudCheckBox @bind-Value="@service.IsSelected"
                                         Color="Color.Primary"
                                         Dense="true"
                                         Class="mb-2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@GetCategoryIcon(service.Category)" Size="Size.Small" Class="mr-1" />
                                    <MudText Typo="Typo.body1">@service.Name (+$@service.Price.ToString("N2"))</MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Class="ml-2" Color="Color.Secondary">
                                    @service.Description
                                </MudText>
                            </MudCheckBox>
                        }
                    }

                    @if (_campsitePeripheralPurchases.Any())
                    {
                        <MudDivider Class="my-3" />
                        <MudText Typo="Typo.subtitle2" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.LocalActivity" Size="Size.Small" Class="mr-1" />
                            Campsite Activities & Services
                        </MudText>
                        @foreach (var service in _campsitePeripheralPurchases)
                        {
                            <MudCheckBox @bind-Value="@service.IsSelected"
                                         Color="Color.Primary"
                                         Dense="true"
                                         Class="mb-2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@GetCategoryIcon(service.Category)" Size="Size.Small" Class="mr-1" />
                                    <MudText Typo="Typo.body1">@service.Name (+$@service.Price.ToString("N2"))</MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Class="ml-2" Color="Color.Secondary">
                                    @service.Description
                                </MudText>
                            </MudCheckBox>
                        }
                    }

                    @if (!_accommodationPeripheralPurchases.Any() && !_campsitePeripheralPurchases.Any())
                    {
                        <MudAlert Severity="Severity.Info" Dense="true">
                            No additional services available for this accommodation.
                        </MudAlert>
                    }
                </MudPaper>
            </MudItem>

            <MudItem xs="12">
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" GutterBottom="true">
                        @(_campsite?.Name ?? "Campsite") - Accommodation Spots
                    </MudText>
                    <MudText Typo="Typo.body2" Class="mb-3">
                        Interactive satellite map showing all accommodation spots at this campsite.
                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text">Green = Available</MudChip>
                        <MudChip T="string" Size="Size.Small" Color="Color.Error" Variant="Variant.Text">Red = Occupied</MudChip>
                    </MudText>

                    <div style="height: 500px; width: 100%; border-radius: 8px; overflow: hidden;">
                        <div id="booking-map" style="width: 100%; height: 100%; border-radius: 8px; z-index: 1;"></div>
                    </div>
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
    else if (!_isLoading)
    {
        <MudAlert Severity="Severity.Error" Class="my-4">
            <MudText Typo="Typo.h6">Accommodation Not Found</MudText>
            <MudText Typo="Typo.body2">The requested accommodation could not be loaded. Please try again or select a different accommodation.</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/search" Class="mt-2">
                Back to Search
            </MudButton>
        </MudAlert>
    }
</MudContainer>

<!-- Mock Credit Card Payment Dialog -->
@if (_showPaymentDialog)
{
    <MudOverlay Visible="true" DarkBackground="true" Absolute="false" ZIndex="9999">
        <MudPaper Elevation="8" Class="pa-6" Style="max-width: 600px; width: 90vw; max-height: 90vh; overflow-y: auto;">
            <!-- Dialog Title -->
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-4">
                <MudIcon Icon="@Icons.Material.Filled.CreditCard" Color="Color.Primary" Size="Size.Large" />
                <MudText Typo="Typo.h5">Payment Information</MudText>
                <MudSpacer />
                <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="ClosePaymentDialog" />
            </MudStack>

            <!-- Info Alert -->
            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-4">
                <MudText Typo="Typo.body2">
                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                    This is a demo payment form. No actual payment will be processed.
                </MudText>
            </MudAlert>

            <!-- Payment Form -->
            <MudForm @ref="_paymentForm" @bind-IsValid="_paymentFormValid">
                <MudStack Spacing="3">
                    <!-- Card Number -->
                    <MudTextField @bind-Value="_cardNumber"
                                 Label="Card Number"
                                 Variant="Variant.Outlined"
                                 Placeholder="4242 4242 4242 4242"
                                 Required="true"
                                 RequiredError="Card number is required"
                                 Validation="@(new Func<string, string>(ValidateCardNumber))"
                                 Immediate="true"
                                 MaxLength="19"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.CreditCard"
                                 OnKeyUp="FormatCardNumber" />

                    <!-- Cardholder Name -->
                    <MudTextField @bind-Value="_cardholderName"
                                 Label="Cardholder Name"
                                 Variant="Variant.Outlined"
                                 Placeholder="JOHN DOE"
                                 Required="true"
                                 RequiredError="Cardholder name is required"
                                 Validation="@(new Func<string, string>(ValidateCardholderName))"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.Person" />

                    <!-- Expiration Date and CVV -->
                    <MudGrid Spacing="2">
                        <MudItem xs="6">
                            <MudTextField @bind-Value="_expirationDate"
                                         Label="Expiration Date"
                                         Variant="Variant.Outlined"
                                         Placeholder="MM/YY"
                                         Required="true"
                                         RequiredError="Expiration date is required"
                                         Validation="@(new Func<string, string>(ValidateExpirationDate))"
                                         Immediate="true"
                                         MaxLength="5"
                                         OnKeyUp="FormatExpirationDate" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudTextField @bind-Value="_cvv"
                                         Label="CVV"
                                         Variant="Variant.Outlined"
                                         Placeholder="123"
                                         Required="true"
                                         RequiredError="CVV is required"
                                         Validation="@(new Func<string, string>(ValidateCVV))"
                                         InputType="InputType.Password"
                                         MaxLength="4"
                                         Adornment="Adornment.Start"
                                         AdornmentIcon="@Icons.Material.Filled.Lock" />
                        </MudItem>
                    </MudGrid>

                    <!-- Payment Summary -->
                    <MudDivider Class="my-2" />
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.body2">Campsite:</MudText>
                        <MudText Typo="Typo.body2"><b>@_accommodation?.CampsiteName</b></MudText>
                    </MudStack>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.body2">Accommodation:</MudText>
                        <MudText Typo="Typo.body2"><b>@_accommodation?.Type</b></MudText>
                    </MudStack>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.body2">Dates:</MudText>
                        <MudText Typo="Typo.body2"><b>@_dateRange?.Start?.ToString("MMM dd") - @_dateRange?.End?.ToString("MMM dd, yyyy")</b></MudText>
                    </MudStack>
                    <MudDivider />
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.h6">Total Amount:</MudText>
                        <MudText Typo="Typo.h5" Color="Color.Primary"><b>$@_totalPrice.ToString("N2")</b></MudText>
                    </MudStack>
                </MudStack>
            </MudForm>

            <!-- Dialog Actions -->
            <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2" Class="mt-6">
                <MudButton OnClick="ClosePaymentDialog" Variant="Variant.Outlined" Color="Color.Default">
                    Cancel
                </MudButton>
                <MudButton OnClick="ProcessPayment"
                           Variant="Variant.Filled"
                           Color="Color.Primary"
                           Disabled="@(!_paymentFormValid || _isProcessingPayment)"
                           StartIcon="@Icons.Material.Filled.Lock">
                    @if (_isProcessingPayment)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <text>Processing...</text>
                    }
                    else
                    {
                        <text>Pay $@_totalPrice.ToString("N2")</text>
                    }
                </MudButton>
            </MudStack>
        </MudPaper>
    </MudOverlay>
}

@code {
    [Parameter]
    public int? CampsiteIdParam { get; set; }

    private int _campsiteId;
    private int? _accommodationId; // Specific accommodation type ID to load
    private CampsiteDto? _campsite;

    private MudForm? _form;
    private bool _formValid;
    private AccommodationDto? _accommodation;
    private MudBlazor.DateRange? _dateRange = new MudBlazor.DateRange(DateTime.Today.AddDays(1), DateTime.Today.AddDays(3));
    private int _numberOfGuests = 2;
    private string _guestName = string.Empty;
    private string _guestEmail = string.Empty;
    private string _guestPhone = string.Empty;
    private string _guestCountry = string.Empty;
    private string _specialRequests = string.Empty;

    // Authentication state
    private bool _isAuthenticated = false;
    private int _currentUserId = 0;

    // Loading state
    private bool _isLoading = true;

    private List<CampingSpot> _campingSpots = new();
    private CampingSpot? _selectedSpot = null;
    private List<PeripheralPurchaseDto> _accommodationPeripheralPurchases = new();
    private List<PeripheralPurchaseDto> _campsitePeripheralPurchases = new();
    private string _campsiteMapUrl = string.Empty;

    // Base coordinates - will be set based on selected campsite
    private double _baseLat = 55.6761;
    private double _baseLng = 12.5683;

    // Discount code fields
    private string _discountCode = string.Empty;
    private bool _discountApplied = false;
    private string _appliedDiscountCode = string.Empty;
    private int _discountPercentage = 0;
    private string _discountError = string.Empty;

    // Seasonal pricing breakdown
    private PricingBreakdown? _pricingBreakdown = null;
    private bool _isCalculatingPrice = false;

    // Payment dialog fields
    private bool _showPaymentDialog = false;
    private MudForm? _paymentForm;
    private bool _paymentFormValid = false;
    private bool _isProcessingPayment = false;
    private string _cardNumber = string.Empty;
    private string _cardholderName = string.Empty;
    private string _expirationDate = string.Empty;
    private string _cvv = string.Empty;

    private int _numberOfNights => _dateRange?.End != null && _dateRange?.Start != null
        ? (_dateRange.End.Value - _dateRange.Start.Value).Days
        : 0;

    private decimal _spotPrice => _selectedSpot != null && _accommodation != null
        ? _accommodation.PricePerNight * _selectedSpot.PriceModifier
        : (_accommodation?.PricePerNight ?? 0);

    // Accommodation subtotal with seasonal multipliers applied
    private decimal _accommodationSubtotal => _pricingBreakdown?.TotalPrice ?? (_spotPrice * _numberOfNights);

    private List<PeripheralPurchaseDto> _selectedServices =>
        _accommodationPeripheralPurchases.Where(s => s.IsSelected)
            .Concat(_campsitePeripheralPurchases.Where(s => s.IsSelected))
            .ToList();

    private decimal _servicesTotal => _selectedServices.Sum(s => s.Price);

    private decimal _subtotalPrice => _accommodationSubtotal + _servicesTotal;

    private decimal _discountAmount => _discountApplied ? (_subtotalPrice * _discountPercentage / 100m) : 0;

    private decimal _totalPrice => _subtotalPrice - _discountAmount;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _isLoading = true;

            // Check authentication and load user data first
            await CheckAuthenticationAndLoadUserData();

            // Check if campsiteId comes from route parameter (old format: /booking/1)
            if (CampsiteIdParam.HasValue)
            {
                _campsiteId = CampsiteIdParam.Value;
            }
            else
            {
                // Get campsiteId from query parameter (new format: /booking?campsiteId=1)
                var uri = new Uri(Navigation.Uri);
                var queryParams = QueryHelpers.ParseQuery(uri.Query);

                if (queryParams.TryGetValue("campsiteId", out var campsiteIdStr) && int.TryParse(campsiteIdStr, out var campsiteId))
                {
                    _campsiteId = campsiteId;
                }
                else
                {
                    _campsiteId = 1; // Default to first campsite
                }

                // Get accommodationId from query parameter (new format: /booking?campsiteId=1&accommodationId=4)
                if (queryParams.TryGetValue("accommodationId", out var accommodationIdStr) && int.TryParse(accommodationIdStr, out var accommodationId))
                {
                    _accommodationId = accommodationId;
                    Console.WriteLine($"üìã Booking page: Received accommodationId={_accommodationId} from URL");
                }
            }

            // Load campsite data from database
            await LoadCampsiteData();

            // Load accommodation data from database
            await LoadAccommodationData();

            // Load camping spots for this campsite (with availability based on selected dates)
            await LoadCampingSpotsAsync();

            // Load peripheral purchases (purchase options from database)
            await LoadPeripheralPurchasesAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error initializing booking page: {ex.Message}");
            Snackbar.Add("Error loading booking page. Please try again.", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Wait for Google Maps API and scripts to load
                await Task.Delay(1000);

                // Check if function exists and retry if needed
                for (int i = 0; i < 10; i++)
                {
                    try
                    {
                        await UpdateBookingMapAsync();
                        break; // Success, exit loop
                    }
                    catch (Exception)
                    {
                        if (i < 9) // Not the last attempt
                        {
                            await Task.Delay(500);
                        }
                        else
                        {
                            throw; // Re-throw on last attempt
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing booking map: {ex.Message}");
            }
        }
    }

    private async Task UpdateBookingMapAsync()
    {
        if (_campsite != null && _campingSpots.Any())
        {
            var spotsJson = System.Text.Json.JsonSerializer.Serialize(_campingSpots);

            // Call the global JavaScript function
            await JSRuntime.InvokeVoidAsync("initializeBookingMap",
                _campsite.Latitude,
                _campsite.Longitude,
                _campsite.Name,
                spotsJson);
        }
    }

    private async Task CheckAuthenticationAndLoadUserData()
    {
        try
        {
            // Get authentication state from the AuthenticationStateProvider
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user?.Identity?.IsAuthenticated == true)
            {
                // Get user ID from claims
                var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier);
                if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
                {
                    _currentUserId = userId;
                    _isAuthenticated = true;

                    Console.WriteLine($"‚úÖ Booking: User authenticated - UserId = {_currentUserId}, Name = {user.FindFirst(ClaimTypes.Name)?.Value}");

                    // Load user data from database to populate guest information fields
                    await LoadUserDataFromDatabase(userId);
                }
                else
                {
                    _isAuthenticated = false;
                    Console.WriteLine("‚ö†Ô∏è Booking: User ID claim not found or invalid");
                }
            }
            else
            {
                _isAuthenticated = false;
                Console.WriteLine("‚ö†Ô∏è Booking: User not authenticated - guest information must be entered manually");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error checking authentication: {ex.Message}");
            _isAuthenticated = false;
        }
    }

    private async Task LoadUserDataFromDatabase(int userId)
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load user from database
            var userIdValue = UserId.Create(userId);
            var user = await context.Users
                .FirstOrDefaultAsync(u => u.Id == userIdValue);

            if (user != null)
            {
                // Auto-populate guest information fields from user account
                _guestName = $"{user.FirstName} {user.LastName}";
                _guestEmail = user.Email.Value;
                _guestPhone = user.Phone ?? string.Empty;
                _guestCountry = user.Country ?? string.Empty;

                Console.WriteLine($"‚úÖ Auto-populated guest information for {_guestName}");
            }
            else
            {
                Console.WriteLine($"‚ö†Ô∏è User not found in database: {userId}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error loading user data: {ex.Message}");
        }
    }

    private string GetAmenityIcon(string amenityName)
    {
        return amenityName.ToLower() switch
        {
            var name when name.Contains("pool") => Icons.Material.Filled.Pool,
            var name when name.Contains("dog") || name.Contains("pet") => Icons.Material.Filled.Pets,
            var name when name.Contains("wifi") => Icons.Material.Filled.Wifi,
            var name when name.Contains("beach") => Icons.Material.Filled.BeachAccess,
            var name when name.Contains("electric") => Icons.Material.Filled.ElectricBolt,
            var name when name.Contains("water") => Icons.Material.Filled.Water,
            var name when name.Contains("playground") || name.Contains("child") => Icons.Material.Filled.ChildFriendly,
            var name when name.Contains("restaurant") || name.Contains("food") => Icons.Material.Filled.Restaurant,
            var name when name.Contains("fire") => Icons.Material.Filled.LocalFireDepartment,
            var name when name.Contains("picnic") || name.Contains("table") => Icons.Material.Filled.TableRestaurant,
            var name when name.Contains("rv") || name.Contains("campingvan") => Icons.Material.Filled.RvHookup,
            _ => Icons.Material.Filled.CheckCircle
        };
    }

    private async Task LoadCampsiteData()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load campsite from database
            var campsiteId = CampsiteId.Create(_campsiteId);
            var campsite = await context.Campsites
                .FirstOrDefaultAsync(c => c.Id == campsiteId);

            if (campsite != null)
            {
                _campsite = new CampsiteDto
                {
                    Id = campsite.Id?.Value ?? 0,
                    Name = campsite.Name ?? "",
                    City = campsite.City ?? "",
                    Latitude = campsite.Latitude,
                    Longitude = campsite.Longitude,
                    Description = campsite.Description ?? ""
                };

                _baseLat = campsite.Latitude;
                _baseLng = campsite.Longitude;

                Console.WriteLine($"‚úÖ Loaded campsite: {_campsite.Name}");
            }
            else
            {
                Console.WriteLine($"‚ùå Campsite not found: {_campsiteId}");
                // Load first campsite as default
                var firstCampsite = await context.Campsites.FirstOrDefaultAsync();
                if (firstCampsite != null)
                {
                    _campsite = new CampsiteDto
                    {
                        Id = firstCampsite.Id?.Value ?? 0,
                        Name = firstCampsite.Name ?? "",
                        City = firstCampsite.City ?? "",
                        Latitude = firstCampsite.Latitude,
                        Longitude = firstCampsite.Longitude,
                        Description = firstCampsite.Description ?? ""
                    };
                    _baseLat = firstCampsite.Latitude;
                    _baseLng = firstCampsite.Longitude;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error loading campsite data: {ex.Message}");
        }
    }

    private async Task LoadAccommodationData()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            AccommodationType? accommodationType = null;

            // If accommodationId is provided, load that specific accommodation type
            if (_accommodationId.HasValue)
            {
                // Load all accommodation types for this campsite and filter in memory
                // (EF Core cannot translate value object comparisons in LINQ)
                var campsiteId = CampsiteId.Create(_campsiteId);
                var allAccommodationTypes = await context.AccommodationTypes
                    .Where(at => EF.Property<CampsiteId>(at, "_campsiteId") == campsiteId)
                    .ToListAsync();

                accommodationType = allAccommodationTypes
                    .FirstOrDefault(at => at.Id.Value == _accommodationId.Value);

                if (accommodationType != null)
                {
                    Console.WriteLine($"‚úÖ Found specific accommodation type: ID={_accommodationId}, Type={accommodationType.Type}");
                }
                else
                {
                    Console.WriteLine($"‚ö†Ô∏è Accommodation type with ID {_accommodationId} not found, falling back to first available");
                    // Fall back to first accommodation type
                    accommodationType = allAccommodationTypes.FirstOrDefault();
                }
            }

            // If no specific accommodation was found or requested, load first accommodation type for this campsite
            if (accommodationType == null)
            {
                var campsiteId = CampsiteId.Create(_campsiteId);
                accommodationType = await context.AccommodationTypes
                    .Where(at => EF.Property<CampsiteId>(at, "_campsiteId") == campsiteId)
                    .FirstOrDefaultAsync();
            }

            if (accommodationType != null)
            {
                // Load all photos first (client-side evaluation needed due to EF mapping)
                var allPhotos = await context.Photos.ToListAsync();

                // Filter for this accommodation type in memory
                var accommodationGalleryImages = allPhotos
                    .Where(p => p.AccommodationTypeId != null && p.AccommodationTypeId.Value == accommodationType.Id?.Value)
                    .OrderBy(p => p.DisplayOrder)
                    .Select(p => p.Url)
                    .ToList();

                // Use first gallery image as main image if no ImageUrl is set
                var mainImageUrl = !string.IsNullOrWhiteSpace(accommodationType.ImageUrl)
                    ? accommodationType.ImageUrl
                    : (accommodationGalleryImages.FirstOrDefault() ?? "https://images.unsplash.com/photo-1587061949409-02df41d5e562?w=400");

                // Load amenities from the accommodation type
                var accommodationAmenities = accommodationType.GetAmenitiesList();

                _accommodation = new AccommodationDto
                {
                    Id = accommodationType.Id?.Value ?? 0,
                    Name = $"{accommodationType.Type} at {_campsite?.Name ?? "Campsite"}",
                    Type = accommodationType.Type ?? "Mixed",
                    Description = accommodationType.Description ?? "Various accommodation types available",
                    Capacity = accommodationType.MaxCapacity,
                    PricePerNight = accommodationType.BasePrice?.Amount ?? 100m,
                    ImageUrl = mainImageUrl,
                    CampsiteId = _campsiteId,
                    CampsiteName = _campsite?.Name ?? "Campsite",
                    GalleryImages = accommodationGalleryImages,
                    Amenities = accommodationAmenities
                };

                Console.WriteLine($"‚úÖ Loaded accommodation: {_accommodation.Name} with {accommodationGalleryImages.Count} gallery images and {accommodationAmenities.Count} amenities");
            }
            else
            {
                // Fallback to generic accommodation
                _accommodation = new AccommodationDto
                {
                    Id = _campsiteId,
                    Name = _campsite?.Name ?? "Campsite Accommodation",
                    Type = "Mixed",
                    Description = _campsite?.Description ?? "Various accommodation types available",
                    Capacity = 6,
                    PricePerNight = 100,
                    ImageUrl = "https://images.unsplash.com/photo-1587061949409-02df41d5e562?w=400",
                    CampsiteId = _campsiteId,
                    CampsiteName = _campsite?.Name ?? "Campsite",
                    GalleryImages = new List<string>(),
                    Amenities = new List<string>()
                };
                Console.WriteLine($"‚ö†Ô∏è No accommodation types found for campsite {_campsiteId}, using fallback");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error loading accommodation data: {ex.Message}");
        }
    }

    private async Task LoadCampingSpotsAsync()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load the accommodation type to get configuration
            AccommodationType? accommodationType = null;

            if (_accommodationId.HasValue)
            {
                var campsiteId = CampsiteId.Create(_campsiteId);
                var allAccommodationTypes = await context.AccommodationTypes
                    .Where(at => EF.Property<CampsiteId>(at, "_campsiteId") == campsiteId)
                    .ToListAsync();

                accommodationType = allAccommodationTypes
                    .FirstOrDefault(at => at.Id.Value == _accommodationId.Value);
            }

            if (accommodationType == null)
            {
                Console.WriteLine("‚ö†Ô∏è No accommodation type found for loading spots");
                _campingSpots = new List<CampingSpot>();
                return;
            }

            var amenities = accommodationType.GetAmenitiesList();
            var accommodationTypeIdValue = _accommodationId!.Value;

            // Load AccommodationSpots from database using raw SQL to avoid value converter issues
            // The EF Core value converter for AccommodationTypeId causes issues with LINQ queries
            var dbSpots = await context.AccommodationSpots
                .FromSqlRaw("SELECT * FROM AccommodationSpots WHERE AccommodationTypeId = {0}", accommodationTypeIdValue)
                .ToListAsync();

            Console.WriteLine($"üìç Found {dbSpots.Count} spots in database for accommodation type {_accommodationId}");

            // If no spots exist in the database, generate them dynamically (fallback)
            if (dbSpots.Count == 0)
            {
                Console.WriteLine("‚ö†Ô∏è No spots in database, generating dynamically");
                _campingSpots = GenerateDynamicSpots(accommodationType, amenities);
                return;
            }

            // Get the selected date range for availability checking
            DateTime startDate = _dateRange?.Start ?? DateTime.Today.AddDays(1);
            DateTime endDate = _dateRange?.End ?? DateTime.Today.AddDays(3);

            // Find all spot IDs that have overlapping bookings (Confirmed or Pending)
            // Load all bookings and filter in memory to avoid EF Core translation issues with value objects
            var allBookings = await context.Bookings.ToListAsync();
            var bookedSpotIds = allBookings
                .Where(b => b.AccommodationSpotId != null)
                .Where(b => b.Status == BookingStatus.Confirmed || b.Status == BookingStatus.Pending)
                .Where(b => b.Period.StartDate < endDate && b.Period.EndDate > startDate)
                .Select(b => b.AccommodationSpotId!.Value)
                .Distinct()
                .ToList();

            Console.WriteLine($"üìÖ Found {bookedSpotIds.Count} booked spots for date range {startDate:d} - {endDate:d} (checked {allBookings.Count} total bookings)");

            // Convert database spots to CampingSpot DTOs with availability status
            // Filter out spots that are under maintenance - they should not appear in the booking dropdown
            var spots = new List<CampingSpot>();
            foreach (var dbSpot in dbSpots)
            {
                // Check both IsUnderMaintenance flag and SpotStatus.Maintenance enum
                bool isUnderMaintenance = dbSpot.IsUnderMaintenance || dbSpot.Status == SpotStatus.Maintenance;

                // Skip spots under maintenance - they should not be available for booking
                if (isUnderMaintenance)
                {
                    Console.WriteLine($"‚ö†Ô∏è Skipping spot {dbSpot.SpotIdentifier} - under maintenance");
                    continue;
                }

                bool isBooked = bookedSpotIds.Contains(dbSpot.Id.Value);

                spots.Add(new CampingSpot
                {
                    DatabaseId = dbSpot.Id.Value,
                    SpotId = dbSpot.SpotIdentifier,
                    CampsiteId = dbSpot.CampsiteId.Value,
                    CampsiteName = dbSpot.CampsiteName,
                    Latitude = dbSpot.Latitude,
                    Longitude = dbSpot.Longitude,
                    Type = dbSpot.Type,
                    Amenities = amenities,
                    Status = isBooked ? "Occupied" : "Available",
                    PriceModifier = dbSpot.PriceModifier
                });
            }

            _campingSpots = spots;
            _selectedSpot = null; // Reset selection when spots are reloaded
            Console.WriteLine($"‚úÖ Loaded {spots.Count} camping spots ({spots.Count(s => s.Status == "Available")} available) for {accommodationType.Type}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error loading camping spots: {ex.Message}");
            _campingSpots = new List<CampingSpot>();
        }
    }

    private List<CampingSpot> GenerateDynamicSpots(AccommodationType accommodationType, List<string> amenities)
    {
        var spots = new List<CampingSpot>();
        var availableUnits = accommodationType.AvailableUnits;
        var unitNamingPrefix = accommodationType.UnitNamingPrefix ?? "";
        var unitNamingPattern = accommodationType.UnitNamingPattern ?? "Numbers";

        for (int i = 0; i < availableUnits; i++)
        {
            string spotName = unitNamingPattern switch
            {
                "Letters" => $"{(char)('A' + i)}",
                "Numbers" => $"{i + 1}",
                "PrefixNumbers" => $"{unitNamingPrefix}{i + 1}",
                _ => $"{i + 1}"
            };

            int row = i / 5;
            int col = i % 5;

            spots.Add(new CampingSpot
            {
                DatabaseId = 0, // No database record
                SpotId = spotName,
                CampsiteId = _campsiteId,
                CampsiteName = _campsite?.Name ?? "",
                Latitude = _baseLat + (row * 0.0005),
                Longitude = _baseLng + (col * 0.0008),
                Type = accommodationType.Type,
                Amenities = amenities,
                Status = "Available", // All dynamically generated spots are available
                PriceModifier = 1.0m
            });
        }

        return spots;
    }

    private async Task OnDateRangeChanged(MudBlazor.DateRange? newDateRange)
    {
        _dateRange = newDateRange;

        // Reload spots with new availability based on selected dates
        if (_accommodationId.HasValue && newDateRange?.Start != null && newDateRange?.End != null)
        {
            Console.WriteLine($"üìÖ Date range changed to {newDateRange.Start:d} - {newDateRange.End:d}, reloading spots...");
            await LoadCampingSpotsAsync();

            // Recalculate pricing with seasonal multipliers
            await RecalculateSeasonalPricingAsync();
            StateHasChanged();
        }
    }

    private async Task OnSpotSelectedAsync(CampingSpot? spot)
    {
        _selectedSpot = spot;

        // Recalculate pricing with seasonal multipliers when spot changes
        await RecalculateSeasonalPricingAsync();
        StateHasChanged();
    }

    /// <summary>
    /// Recalculates pricing using database-driven seasonal multipliers
    /// </summary>
    private async Task RecalculateSeasonalPricingAsync()
    {
        // Clear previous breakdown
        _pricingBreakdown = null;

        if (_accommodation == null || _dateRange?.Start == null || _dateRange?.End == null || _numberOfNights <= 0)
        {
            return;
        }

        try
        {
            _isCalculatingPrice = true;

            var spotModifier = _selectedSpot?.PriceModifier ?? 1.0m;

            _pricingBreakdown = await PricingService.CalculatePriceAsync(
                _accommodation.CampsiteId,
                _accommodation.Id,
                _accommodation.PricePerNight,
                _dateRange.Start.Value,
                _dateRange.End.Value,
                spotModifier);

            if (_pricingBreakdown.SpansMultipleSeasons)
            {
                Console.WriteLine($"üí∞ Booking spans multiple seasons. Breakdown:");
                foreach (var seasonGroup in _pricingBreakdown.NightlyBreakdown.GroupBy(n => n.SeasonName))
                {
                    var nights = seasonGroup.Count();
                    var multiplier = seasonGroup.First().SeasonalMultiplier;
                    Console.WriteLine($"   - {seasonGroup.Key}: {nights} nights √ó {multiplier:F2}x");
                }
            }
            else
            {
                var seasonName = _pricingBreakdown.NightlyBreakdown.FirstOrDefault()?.SeasonName ?? "Regular";
                Console.WriteLine($"üí∞ Pricing calculated: {_numberOfNights} nights in {seasonName} season, multiplier: {_pricingBreakdown.AverageMultiplier:F2}x, total: ${_pricingBreakdown.TotalPrice:N2}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error calculating seasonal pricing: {ex.Message}");
            // Fall back to non-seasonal pricing (already handled by _accommodationSubtotal property)
        }
        finally
        {
            _isCalculatingPrice = false;
        }
    }

    private async Task LoadPeripheralPurchasesAsync()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            var campsiteId = CampsiteId.Create(_campsiteId);

            // Load all active purchase options for this campsite
            var purchaseOptions = await context.PurchaseOptions
                .Where(p => p.CampsiteId == campsiteId && p.IsActive)
                .ToListAsync();

            Console.WriteLine($"üì¶ Loaded {purchaseOptions.Count} purchase options for campsite {_campsiteId}");

            // Filter for accommodation-specific options (where AccommodationTypeId matches the selected accommodation)
            if (_accommodationId.HasValue)
            {
                var accommodationTypeId = AccommodationTypeId.Create(_accommodationId.Value);
                _accommodationPeripheralPurchases = purchaseOptions
                    .Where(p => p.AccommodationTypeId != null && p.AccommodationTypeId == accommodationTypeId)
                    .Select(p => new PeripheralPurchaseDto
                    {
                        Id = p.Id?.Value ?? 0,
                        Name = p.Name,
                        Description = p.Description,
                        Price = p.Price?.Amount ?? 0,
                        Category = p.Category,
                        IsActive = p.IsActive,
                        IsSelected = false
                    })
                    .ToList();

                Console.WriteLine($"   üè† Found {_accommodationPeripheralPurchases.Count} accommodation-specific options for accommodation type {_accommodationId}");
            }
            else
            {
                _accommodationPeripheralPurchases = new List<PeripheralPurchaseDto>();
            }

            // Filter for campsite-level options (where AccommodationTypeId is NULL)
            _campsitePeripheralPurchases = purchaseOptions
                .Where(p => p.AccommodationTypeId == null)
                .Select(p => new PeripheralPurchaseDto
                {
                    Id = p.Id?.Value ?? 0,
                    Name = p.Name,
                    Description = p.Description,
                    Price = p.Price?.Amount ?? 0,
                    Category = p.Category,
                    IsActive = p.IsActive,
                    IsSelected = false
                })
                .ToList();

            Console.WriteLine($"   üèïÔ∏è Found {_campsitePeripheralPurchases.Count} campsite-level options");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error loading purchase options: {ex.Message}");
            _accommodationPeripheralPurchases = new List<PeripheralPurchaseDto>();
            _campsitePeripheralPurchases = new List<PeripheralPurchaseDto>();
        }
    }

    private string GetCategoryIcon(string? category)
    {
        return category?.ToLowerInvariant() switch
        {
            "activity" => Icons.Material.Filled.DirectionsRun,
            "service" => Icons.Material.Filled.RoomService,
            "equipment" => Icons.Material.Filled.Build,
            "food & beverage" or "food" => Icons.Material.Filled.Restaurant,
            "other" => Icons.Material.Filled.MoreHoriz,
            _ => Icons.Material.Filled.ShoppingCart
        };
    }

    private void RemovePeripheralPurchase(PeripheralPurchaseDto service)
    {
        // Deselect the service - this will remove it from the booking summary
        service.IsSelected = false;
        StateHasChanged();
    }

    private async Task ApplyDiscount()
    {
        _discountError = string.Empty;

        try
        {
            // Create a fresh DbContext for each discount lookup to ensure we get the latest data
            await using var context = await DbContextFactory.CreateDbContextAsync();

            // Validate discount code against the database
            var codeToCheck = _discountCode.Trim().ToUpper();
            Console.WriteLine($"üîç ApplyDiscount: Looking for code '{codeToCheck}'");

            // Use AsNoTracking() to ensure fresh data from database (no caching)
            // Query directly using EF.Property for the backing field
            var allDiscounts = await context.Discounts
                .AsNoTracking()
                .ToListAsync();

            Console.WriteLine($"üìä ApplyDiscount: Found {allDiscounts.Count} discounts in database (fresh query):");
            foreach (var d in allDiscounts)
            {
                Console.WriteLine($"   - ID: {d.Id?.Value}, Code: '{d.Code}', IsActive: {d.IsActive}, ValidFrom: {d.ValidFrom}, ValidUntil: {d.ValidUntil}");
            }

            var discount = allDiscounts.FirstOrDefault(d => d.Code.Equals(codeToCheck, StringComparison.OrdinalIgnoreCase));

            if (discount == null)
            {
                Console.WriteLine($"‚ùå ApplyDiscount: No discount found with code '{codeToCheck}'");
                _discountError = "Invalid discount code. Please check and try again.";
                _discountApplied = false;
                _appliedDiscountCode = string.Empty;
                _discountPercentage = 0;
                return;
            }

            Console.WriteLine($"‚úÖ ApplyDiscount: Found discount '{discount.Code}' (ID: {discount.DiscountId})");

            // Check if discount is valid (active, within date range, usage limits)
            var checkDate = DateTime.UtcNow;
            Console.WriteLine($"üîç ApplyDiscount: Validating discount...");
            Console.WriteLine($"   - Current date (UTC): {checkDate}");
            Console.WriteLine($"   - IsActive: {discount.IsActive}");
            Console.WriteLine($"   - ValidFrom: {discount.ValidFrom} (Current >= ValidFrom: {checkDate.Date >= discount.ValidFrom.Date})");
            Console.WriteLine($"   - ValidUntil: {discount.ValidUntil} (Current <= ValidUntil: {checkDate.Date <= discount.ValidUntil.Date})");
            Console.WriteLine($"   - IsValid() result: {discount.IsValid(checkDate)}");

            if (!discount.IsValid(checkDate))
            {
                Console.WriteLine($"‚ùå ApplyDiscount: Discount '{discount.Code}' is NOT valid - expired or inactive");
                _discountError = "This discount code has expired or is no longer available.";
                _discountApplied = false;
                _appliedDiscountCode = string.Empty;
                _discountPercentage = 0;
                return;
            }

            Console.WriteLine($"‚úÖ ApplyDiscount: Discount '{discount.Code}' is valid!");

            // Check minimum booking amount if applicable
            if (discount.MinimumBookingAmount > 0 && _subtotalPrice < discount.MinimumBookingAmount)
            {
                _discountError = $"Minimum booking amount of ${discount.MinimumBookingAmount:N2} required for this discount.";
                _discountApplied = false;
                _appliedDiscountCode = string.Empty;
                _discountPercentage = 0;
                return;
            }

            // Apply the discount
            _discountApplied = true;
            _appliedDiscountCode = discount.Code;

            // For percentage discounts, use the value directly
            // For fixed discounts, calculate the equivalent percentage based on subtotal
            if (discount.Type == "Percentage")
            {
                _discountPercentage = (int)discount.Value;
            }
            else // Fixed amount
            {
                // Convert fixed amount to percentage of current subtotal
                if (_subtotalPrice > 0)
                {
                    _discountPercentage = (int)Math.Min(100, (discount.Value / _subtotalPrice) * 100);
                }
                else
                {
                    _discountPercentage = 0;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error applying discount: {ex.Message}");
            _discountError = "An error occurred while validating the discount code.";
            _discountApplied = false;
            _appliedDiscountCode = string.Empty;
            _discountPercentage = 0;
        }
    }

    private async Task SubmitBooking()
    {
        try
        {
            // Check if user is logged in (use authenticated user ID if available)
            int currentUserId = _currentUserId;

            // Fallback to localStorage if not authenticated via AuthenticationStateProvider
            if (currentUserId == 0)
            {
                var currentUserIdStr = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "currentUserId");
                if (string.IsNullOrEmpty(currentUserIdStr) || !int.TryParse(currentUserIdStr, out currentUserId))
                {
                    Snackbar.Add("Please log in to complete your booking", Severity.Error);
                    Navigation.NavigateTo("/login");
                    return;
                }
            }

            // Validate form
            if (_accommodation == null || _selectedSpot == null || _dateRange == null || _dateRange.Start == null || _dateRange.End == null)
            {
                Snackbar.Add("Please fill in all required fields", Severity.Error);
                return;
            }

            // Create booking in database
            using var context = await DbContextFactory.CreateDbContextAsync();

            var guestId = GuestId.Create(currentUserId);
            var campsiteId = CampsiteId.Create(_accommodation.CampsiteId);
            var accommodationTypeId = AccommodationTypeId.Create(_accommodation.Id);
            var period = CampsiteBooking.Models.ValueObjects.DateRange.Create(_dateRange.Start.Value, _dateRange.End.Value);
            var basePrice = Money.Create(_accommodation.PricePerNight, "DKK");

            // Validate spot availability before creating booking (prevent double-booking)
            if (_selectedSpot.DatabaseId > 0)
            {
                var spotIdValue = _selectedSpot.DatabaseId;

                // Load all bookings into memory and filter in C# to avoid EF Core translation issues with value objects
                var allBookings = await context.Bookings.ToListAsync();
                var hasOverlap = allBookings
                    .Where(b => b.AccommodationSpotId != null && b.AccommodationSpotId.Value == spotIdValue)
                    .Where(b => b.Status == BookingStatus.Confirmed || b.Status == BookingStatus.Pending)
                    .Any(b => b.Period.StartDate < period.EndDate && b.Period.EndDate > period.StartDate);

                if (hasOverlap)
                {
                    Snackbar.Add("Sorry, this spot has already been booked for the selected dates. Please select a different spot or dates.", Severity.Warning);
                    // Refresh the spot list to show updated availability
                    await LoadCampingSpotsAsync();
                    StateHasChanged();
                    return;
                }
            }

            var booking = CampsiteBooking.Models.Booking.Create(
                guestId,
                campsiteId,
                accommodationTypeId,
                period,
                basePrice,
                _numberOfGuests, // numberOfAdults
                0, // numberOfChildren
                _specialRequests ?? string.Empty
            );

            // Assign the selected accommodation spot to the booking
            if (_selectedSpot.DatabaseId > 0)
            {
                var spotId = AccommodationSpotId.Create(_selectedSpot.DatabaseId);
                booking.AssignAccommodationSpot(spotId);
                Console.WriteLine($"üìç Assigned spot {_selectedSpot.SpotId} (ID: {_selectedSpot.DatabaseId}) to booking");
            }

            // Update total price with seasonal multipliers and discounts
            var totalPriceWithSeasonalMultipliers = Money.Create(_totalPrice, "DKK");
            booking.UpdateTotalPrice(totalPriceWithSeasonalMultipliers);
            Console.WriteLine($"üí∞ Updated booking total price to ${_totalPrice:N2} (includes seasonal multipliers and discounts)");

            // Save booking to database
            await context.Bookings.AddAsync(booking);
            await context.SaveChangesAsync();

            var bookingId = booking.Id?.Value ?? 0;
            Console.WriteLine($"‚úÖ Created booking {bookingId} for user {currentUserId}");

            // Save selected peripheral purchases (add-ons)
            if (_selectedServices.Any())
            {
                var bookingIdValue = BookingId.Create(bookingId);
                foreach (var service in _selectedServices)
                {
                    var peripheralPurchase = PeripheralPurchase.Create(
                        bookingIdValue,
                        service.Name,
                        service.Description,
                        1, // quantity
                        Money.Create(service.Price, "DKK")
                    );

                    await context.PeripheralPurchases.AddAsync(peripheralPurchase);
                    Console.WriteLine($"‚úÖ Added peripheral purchase '{service.Name}' (${service.Price:N2}) to booking {bookingId}");
                }
                await context.SaveChangesAsync();
                Console.WriteLine($"‚úÖ Saved {_selectedServices.Count} peripheral purchases for booking {bookingId}");
            }

            // Publish BookingCreatedEvent to Kafka for email/SMS notifications
            try
            {
                var domainEvents = booking.GetDomainEvents();
                foreach (var domainEvent in domainEvents)
                {
                    await KafkaProducer.PublishAsync(domainEvent);
                    Console.WriteLine($"‚úÖ Published {domainEvent.GetType().Name} to Kafka for booking {bookingId}");
                }
                booking.ClearDomainEvents();
            }
            catch (Exception kafkaEx)
            {
                // Log Kafka error but don't fail the booking
                Console.WriteLine($"‚ö†Ô∏è Failed to publish Kafka event for booking {bookingId}: {kafkaEx.Message}");
            }

            // Create Stripe Checkout Session
            var checkoutUrl = await StripeService.CreateCheckoutSessionAsync(
                bookingId,
                _accommodation.CampsiteName,
                _accommodation.Type,
                _totalPrice,
                "DKK"
            );

            Console.WriteLine($"‚úÖ Created Stripe Checkout Session for booking {bookingId}");

            // Redirect to Stripe Checkout
            Navigation.NavigateTo(checkoutUrl, forceLoad: true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error creating booking: {ex.Message}");
            Snackbar.Add($"Error creating booking: {ex.Message}", Severity.Error);
        }
    }

    // Show payment dialog instead of directly submitting booking
    private void ShowPaymentDialog()
    {
        // Validate booking form first
        if (_accommodation == null || _selectedSpot == null || _dateRange == null || _dateRange.Start == null || _dateRange.End == null)
        {
            Snackbar.Add("Please fill in all required fields", Severity.Error);
            return;
        }

        // Pre-populate payment form fields with test values for easy testing
        // Using Stripe's standard test card number
        _cardNumber = "4242 4242 4242 4242";
        _cardholderName = "JOHN DOE";
        _expirationDate = "12/30";
        _cvv = "123";
        _paymentFormValid = false;

        // Show the payment dialog
        _showPaymentDialog = true;
    }

    private void ClosePaymentDialog()
    {
        _showPaymentDialog = false;
        _isProcessingPayment = false;
    }

    private async Task ProcessPayment()
    {
        if (!_paymentFormValid)
        {
            Snackbar.Add("Please fill in all payment fields correctly", Severity.Error);
            return;
        }

        _isProcessingPayment = true;
        StateHasChanged();

        // Simulate payment processing delay for realism
        await Task.Delay(1500);

        // Close the payment dialog
        _showPaymentDialog = false;

        // Proceed with the actual booking submission
        await SubmitBooking();

        _isProcessingPayment = false;
    }

    // Credit card validation methods
    private string ValidateCardNumber(string cardNumber)
    {
        if (string.IsNullOrWhiteSpace(cardNumber))
            return "Card number is required";

        var digitsOnly = new string(cardNumber.Where(char.IsDigit).ToArray());

        if (digitsOnly.Length < 13 || digitsOnly.Length > 19)
            return "Card number must be between 13 and 19 digits";

        // Luhn algorithm validation (basic credit card validation)
        if (!IsValidLuhn(digitsOnly))
            return "Invalid card number";

        return null;
    }

    private string ValidateCardholderName(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return "Cardholder name is required";

        if (name.Length < 3)
            return "Name must be at least 3 characters";

        if (!name.All(c => char.IsLetter(c) || char.IsWhiteSpace(c)))
            return "Name can only contain letters and spaces";

        return null;
    }

    private string ValidateExpirationDate(string expDate)
    {
        if (string.IsNullOrWhiteSpace(expDate))
            return "Expiration date is required";

        if (!System.Text.RegularExpressions.Regex.IsMatch(expDate, @"^\d{2}/\d{2}$"))
            return "Format must be MM/YY";

        var parts = expDate.Split('/');
        if (parts.Length != 2)
            return "Invalid format";

        if (!int.TryParse(parts[0], out int month) || !int.TryParse(parts[1], out int year))
            return "Invalid date";

        if (month < 1 || month > 12)
            return "Invalid month";

        // Check if card is expired
        var currentYear = DateTime.Now.Year % 100;
        var currentMonth = DateTime.Now.Month;

        if (year < currentYear || (year == currentYear && month < currentMonth))
            return "Card is expired";

        return null;
    }

    private string ValidateCVV(string cvv)
    {
        if (string.IsNullOrWhiteSpace(cvv))
            return "CVV is required";

        if (!cvv.All(char.IsDigit))
            return "CVV must contain only digits";

        if (cvv.Length < 3 || cvv.Length > 4)
            return "CVV must be 3 or 4 digits";

        return null;
    }

    // Luhn algorithm for credit card validation
    private bool IsValidLuhn(string cardNumber)
    {
        int sum = 0;
        bool alternate = false;

        for (int i = cardNumber.Length - 1; i >= 0; i--)
        {
            int digit = cardNumber[i] - '0';

            if (alternate)
            {
                digit *= 2;
                if (digit > 9)
                    digit -= 9;
            }

            sum += digit;
            alternate = !alternate;
        }

        return sum % 10 == 0;
    }

    // Format card number with spaces (XXXX XXXX XXXX XXXX)
    private void FormatCardNumber(KeyboardEventArgs e)
    {
        var digitsOnly = new string(_cardNumber.Where(char.IsDigit).ToArray());

        if (digitsOnly.Length > 0)
        {
            var formatted = string.Join(" ", Enumerable.Range(0, (digitsOnly.Length + 3) / 4)
                .Select(i => digitsOnly.Substring(i * 4, Math.Min(4, digitsOnly.Length - i * 4))));
            _cardNumber = formatted;
        }
    }

    // Format expiration date (MM/YY)
    private void FormatExpirationDate(KeyboardEventArgs e)
    {
        var digitsOnly = new string(_expirationDate.Where(char.IsDigit).ToArray());

        if (digitsOnly.Length >= 2)
        {
            _expirationDate = digitsOnly.Substring(0, 2) + "/" + digitsOnly.Substring(2, Math.Min(2, digitsOnly.Length - 2));
        }
        else
        {
            _expirationDate = digitsOnly;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/search");
    }

    public class AccommodationDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public int Capacity { get; set; }
        public decimal PricePerNight { get; set; }
        public string ImageUrl { get; set; } = string.Empty;
        public int CampsiteId { get; set; }
        public string CampsiteName { get; set; } = string.Empty;
        public List<string> GalleryImages { get; set; } = new(); // Images from Photos table
        public List<string> Amenities { get; set; } = new(); // Amenities from AccommodationType
    }

    public class PeripheralPurchaseDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public decimal Price { get; set; }
        public string Category { get; set; } = string.Empty;
        public bool IsActive { get; set; } = true;
        public bool IsSelected { get; set; } = false;
    }

    public class CampsiteDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string City { get; set; } = string.Empty;
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public string Description { get; set; } = string.Empty;
    }
}

