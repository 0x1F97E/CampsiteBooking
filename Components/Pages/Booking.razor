@page "/booking"
@page "/booking/{CampsiteIdParam:int}"
@rendermode InteractiveServer
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@using CampsiteBooking.Models
@using Microsoft.AspNetCore.WebUtilities

<PageTitle>Book Accommodation - Campsite Booking</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Complete Your Booking</MudText>
    
    @if (_accommodation != null)
    {
        <MudGrid>
            <MudItem xs="12" md="5">
                <MudCard Elevation="3">
                    <MudCardMedia Image="@_accommodation.ImageUrl" Height="200" />
                    <MudCardContent>
                        <MudText Typo="Typo.h6">@_accommodation.Name</MudText>
                        <MudChip T="string" Size="Size.Small" Color="Color.Info">@_accommodation.Type</MudChip>
                        <MudText Typo="Typo.body2" Class="mt-2">@_accommodation.Description</MudText>

                        <MudDivider Class="my-3" />

                        <MudStack Spacing="2">
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.body2">Base price per night:</MudText>
                                <MudText Typo="Typo.body1"><b>$@_accommodation.PricePerNight</b></MudText>
                            </MudStack>
                            @if (_selectedSpot != null && _selectedSpot.PriceModifier != 1.0m)
                            {
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText Typo="Typo.body2">Spot modifier (@_selectedSpot.SpotId):</MudText>
                                    <MudText Typo="Typo.body1" Color="Color.Warning"><b>Ã—@_selectedSpot.PriceModifier</b></MudText>
                                </MudStack>
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText Typo="Typo.body2">Adjusted price per night:</MudText>
                                    <MudText Typo="Typo.body1" Color="Color.Primary"><b>$@_spotPrice</b></MudText>
                                </MudStack>
                            }
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.body2">Number of nights:</MudText>
                                <MudText Typo="Typo.body1"><b>@_numberOfNights</b></MudText>
                            </MudStack>
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.body2">Accommodation subtotal:</MudText>
                                <MudText Typo="Typo.body1"><b>$@(_spotPrice * _numberOfNights)</b></MudText>
                            </MudStack>
                            @if (_selectedServices.Any())
                            {
                                <MudDivider Class="my-2" />
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-1">Additional Services:</MudText>
                                @foreach (var service in _selectedServices)
                                {
                                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                                        <MudText Typo="Typo.body2" Class="ml-3">@service.Name:</MudText>
                                        <MudText Typo="Typo.body1" Color="Color.Info"><b>$@service.Price.ToString("N2")</b></MudText>
                                    </MudStack>
                                }
                            }

                            <MudDivider Class="my-2" />

                            <!-- Discount Code Section -->
                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.End">
                                <MudTextField @bind-Value="_discountCode"
                                             Label="Discount Code"
                                             Variant="Variant.Outlined"
                                             Placeholder="Enter code"
                                             Dense="true"
                                             Style="flex: 1;" />
                                <MudButton Variant="Variant.Filled"
                                          Color="@(_discountApplied ? Color.Success : Color.Primary)"
                                          OnClick="ApplyDiscount"
                                          Disabled="@(string.IsNullOrWhiteSpace(_discountCode) || _discountApplied)"
                                          Size="Size.Small">
                                    @(_discountApplied ? "Applied" : "Apply")
                                </MudButton>
                            </MudStack>

                            @if (_discountApplied && _discountAmount > 0)
                            {
                                <MudAlert Severity="Severity.Success" Dense="true" Class="mt-2">
                                    Discount "@_appliedDiscountCode" applied: @_discountPercentage% off!
                                </MudAlert>
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText Typo="Typo.body2">Subtotal:</MudText>
                                    <MudText Typo="Typo.body1"><b>$@_subtotalPrice.ToString("N2")</b></MudText>
                                </MudStack>
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText Typo="Typo.body2" Color="Color.Success">Discount (@_discountPercentage%):</MudText>
                                    <MudText Typo="Typo.body1" Color="Color.Success"><b>-$@_discountAmount.ToString("N2")</b></MudText>
                                </MudStack>
                            }
                            @if (!string.IsNullOrWhiteSpace(_discountError))
                            {
                                <MudAlert Severity="Severity.Error" Dense="true" Class="mt-2" CloseIcon="@Icons.Material.Filled.Close" CloseIconClicked="@(() => _discountError = string.Empty)">
                                    @_discountError
                                </MudAlert>
                            }

                            <MudDivider />
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.h6">Total:</MudText>
                                <MudText Typo="Typo.h6" Color="Color.Primary">$@_totalPrice.ToString("N2")</MudText>
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" md="7">
                <MudPaper Elevation="3" Class="pa-4">
                    <MudForm @ref="_form" @bind-IsValid="@_formValid">
                        <MudText Typo="Typo.h6" GutterBottom="true">Booking Details</MudText>
                        
                        <MudDateRangePicker Label="Check-in / Check-out" 
                                           @bind-DateRange="_dateRange"
                                           MinDate="DateTime.Today"
                                           Required="true"
                                           RequiredError="Please select dates"
                                           Editable="true" />
                        
                        <MudNumericField @bind-Value="_numberOfGuests"
                                        Label="Number of Guests"
                                        Variant="Variant.Outlined"
                                        Min="1"
                                        Max="@_accommodation.Capacity"
                                        Required="true"
                                        Class="mt-3" />

                        <MudSelect T="CampingSpot"
                                  @bind-Value="_selectedSpot"
                                  Label="Select Camping Spot"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  RequiredError="Please select a camping spot"
                                  Class="mt-3"
                                  AnchorOrigin="Origin.BottomCenter">
                            @foreach (var spot in _campingSpots.Where(s => s.Status == "Available"))
                            {
                                <MudSelectItem T="CampingSpot" Value="@spot">
                                    @spot.SpotId - @spot.Type
                                    @if (spot.PriceModifier > 1.0m)
                                    {
                                        <text> (Premium +@(((spot.PriceModifier - 1) * 100).ToString("0"))%)</text>
                                    }
                                </MudSelectItem>
                            }
                        </MudSelect>

                        <MudDivider Class="my-4" />
                        
                        <MudText Typo="Typo.h6" GutterBottom="true">Guest Information</MudText>
                        
                        <MudTextField @bind-Value="_guestName" 
                                     Label="Full Name" 
                                     Variant="Variant.Outlined"
                                     Required="true"
                                     RequiredError="Name is required" />
                        
                        <MudTextField @bind-Value="_guestEmail" 
                                     Label="Email" 
                                     Variant="Variant.Outlined"
                                     InputType="InputType.Email"
                                     Required="true"
                                     RequiredError="Email is required"
                                     Class="mt-3" />
                        
                        <MudTextField @bind-Value="_guestPhone" 
                                     Label="Phone Number" 
                                     Variant="Variant.Outlined"
                                     InputType="InputType.Telephone"
                                     Required="true"
                                     RequiredError="Phone is required"
                                     Class="mt-3" />
                        
                        <MudTextField @bind-Value="_specialRequests" 
                                     Label="Special Requests (Optional)" 
                                     Variant="Variant.Outlined"
                                     Lines="3"
                                     Class="mt-3" />
                        
                        <MudStack Row="true" Class="mt-4" Spacing="2">
                            <MudButton Variant="Variant.Outlined" 
                                      Color="Color.Default"
                                      OnClick="Cancel">
                                Cancel
                            </MudButton>
                            <MudButton Variant="Variant.Filled"
                                      Color="Color.Primary"
                                      Disabled="@(!_formValid || _selectedSpot == null)"
                                      OnClick="SubmitBooking"
                                      FullWidth="true">
                                Confirm Booking
                            </MudButton>
                        </MudStack>

                        @if (_selectedSpot == null)
                        {
                            <MudAlert Severity="Severity.Warning" Class="mt-3">
                                Please select a camping spot to continue.
                            </MudAlert>
                        }
                    </MudForm>
                </MudPaper>
            </MudItem>

            <MudItem xs="12">
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" GutterBottom="true">Additional Services</MudText>
                    <MudText Typo="Typo.body2" Class="mb-3">
                        Optional services to enhance your stay.
                    </MudText>

                    @if (_accommodationPeripheralPurchases.Any())
                    {
                        <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.HomeWork" Size="Size.Small" Class="mr-1" />
                            Accommodation Services
                        </MudText>
                        @foreach (var service in _accommodationPeripheralPurchases)
                        {
                            <MudCheckBox @bind-Value="@service.IsSelected"
                                         Color="Color.Primary"
                                         Dense="true"
                                         Class="mb-2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudText Typo="Typo.body1">@service.Name (+$@service.Price.ToString("N2"))</MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Class="ml-2" Color="Color.Secondary">
                                    @service.Description
                                </MudText>
                            </MudCheckBox>
                        }
                    }

                    @if (_campsitePeripheralPurchases.Any())
                    {
                        <MudDivider Class="my-3" />
                        <MudText Typo="Typo.subtitle2" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.LocalActivity" Size="Size.Small" Class="mr-1" />
                            Campsite Activities & Services
                        </MudText>
                        @foreach (var service in _campsitePeripheralPurchases)
                        {
                            <MudCheckBox @bind-Value="@service.IsSelected"
                                         Color="Color.Primary"
                                         Dense="true"
                                         Class="mb-2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudText Typo="Typo.body1">@service.Name (+$@service.Price.ToString("N2"))</MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Class="ml-2" Color="Color.Secondary">
                                    @service.Description
                                </MudText>
                            </MudCheckBox>
                        }
                    }

                    @if (!_accommodationPeripheralPurchases.Any() && !_campsitePeripheralPurchases.Any())
                    {
                        <MudAlert Severity="Severity.Info" Dense="true">
                            No additional services available for this accommodation.
                        </MudAlert>
                    }
                </MudPaper>
            </MudItem>

            <MudItem xs="12">
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" GutterBottom="true">
                        @(_campsite?.Name ?? "Campsite") - Accommodation Spots
                    </MudText>
                    <MudText Typo="Typo.body2" Class="mb-3">
                        Interactive satellite map showing all accommodation spots at this campsite.
                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text">Green = Available</MudChip>
                        <MudChip T="string" Size="Size.Small" Color="Color.Error" Variant="Variant.Text">Red = Occupied</MudChip>
                    </MudText>

                    <div style="height: 500px; width: 100%; border-radius: 8px; overflow: hidden;">
                        <div id="booking-map" style="width: 100%; height: 100%; border-radius: 8px; z-index: 1;"></div>
                    </div>
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
    else
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
</MudContainer>

@code {
    [Parameter]
    public int? CampsiteIdParam { get; set; }

    private int _campsiteId;
    private CampsiteDto? _campsite;

    private MudForm? _form;
    private bool _formValid;
    private AccommodationDto? _accommodation;
    private DateRange? _dateRange = new DateRange(DateTime.Today.AddDays(1), DateTime.Today.AddDays(3));
    private int _numberOfGuests = 2;
    private string _guestName = string.Empty;
    private string _guestEmail = string.Empty;
    private string _guestPhone = string.Empty;
    private string _specialRequests = string.Empty;

    private List<CampingSpot> _campingSpots = new();
    private CampingSpot? _selectedSpot = null;
    private List<PeripheralPurchaseDto> _accommodationPeripheralPurchases = new();
    private List<PeripheralPurchaseDto> _campsitePeripheralPurchases = new();
    private string _campsiteMapUrl = string.Empty;

    // Base coordinates - will be set based on selected campsite
    private double _baseLat = 55.6761;
    private double _baseLng = 12.5683;

    // Discount code fields
    private string _discountCode = string.Empty;
    private bool _discountApplied = false;
    private string _appliedDiscountCode = string.Empty;
    private int _discountPercentage = 0;
    private string _discountError = string.Empty;

    private int _numberOfNights => _dateRange?.End != null && _dateRange?.Start != null
        ? (_dateRange.End.Value - _dateRange.Start.Value).Days
        : 0;

    private decimal _spotPrice => _selectedSpot != null && _accommodation != null
        ? _accommodation.PricePerNight * _selectedSpot.PriceModifier
        : (_accommodation?.PricePerNight ?? 0);

    private List<PeripheralPurchaseDto> _selectedServices =>
        _accommodationPeripheralPurchases.Where(s => s.IsSelected)
            .Concat(_campsitePeripheralPurchases.Where(s => s.IsSelected))
            .ToList();

    private decimal _servicesTotal => _selectedServices.Sum(s => s.Price);

    private decimal _subtotalPrice => (_spotPrice * _numberOfNights) + _servicesTotal;

    private decimal _discountAmount => _discountApplied ? (_subtotalPrice * _discountPercentage / 100m) : 0;

    private decimal _totalPrice => _subtotalPrice - _discountAmount;

    protected override async Task OnInitializedAsync()
    {
        // Check if campsiteId comes from route parameter (old format: /booking/1)
        if (CampsiteIdParam.HasValue)
        {
            _campsiteId = CampsiteIdParam.Value;
        }
        else
        {
            // Get campsiteId from query parameter (new format: /booking?campsiteId=1)
            var uri = new Uri(Navigation.Uri);
            var queryParams = QueryHelpers.ParseQuery(uri.Query);

            if (queryParams.TryGetValue("campsiteId", out var campsiteIdStr) && int.TryParse(campsiteIdStr, out var campsiteId))
            {
                _campsiteId = campsiteId;
            }
            else
            {
                _campsiteId = 1; // Default to first campsite
            }
        }

        await Task.Delay(300); // Simulate API call

        // Load campsite data based on ID
        LoadCampsiteData();

        // Mock accommodation data - will be replaced with actual API call
        _accommodation = new AccommodationDto
        {
            Id = _campsiteId,
            Name = _campsite?.Name ?? "Campsite Accommodation",
            Type = "Mixed",
            Description = _campsite?.Description ?? "Various accommodation types available",
            Capacity = 6,
            PricePerNight = 100,
            ImageUrl = "https://images.unsplash.com/photo-1587061949409-02df41d5e562?w=400"
        };

        // Load camping spots for this campsite
        LoadCampingSpots();

        // Load peripheral purchases
        LoadPeripheralPurchases();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Wait for Google Maps API and scripts to load
                await Task.Delay(1000);

                // Check if function exists and retry if needed
                for (int i = 0; i < 10; i++)
                {
                    try
                    {
                        await UpdateBookingMapAsync();
                        break; // Success, exit loop
                    }
                    catch (Exception)
                    {
                        if (i < 9) // Not the last attempt
                        {
                            await Task.Delay(500);
                        }
                        else
                        {
                            throw; // Re-throw on last attempt
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing booking map: {ex.Message}");
            }
        }
    }

    private async Task UpdateBookingMapAsync()
    {
        if (_campsite != null && _campingSpots.Any())
        {
            var spotsJson = System.Text.Json.JsonSerializer.Serialize(_campingSpots);

            // Call the global JavaScript function
            await JSRuntime.InvokeVoidAsync("initializeBookingMap",
                _campsite.Latitude,
                _campsite.Longitude,
                _campsite.Name,
                spotsJson);
        }
    }

    private void LoadCampsiteData()
    {
        // Load campsite data based on ID - matches the data from google-map.js
        var campsites = new Dictionary<int, CampsiteDto>
        {
            { 1, new CampsiteDto { Id = 1, Name = "Copenhagen Beach Camp", Region = "Zealand", Latitude = 55.6761, Longitude = 12.5683, Description = "Beachfront camping near Copenhagen" } },
            { 2, new CampsiteDto { Id = 2, Name = "Skagen North Point", Region = "North Jutland", Latitude = 57.7209, Longitude = 10.5882, Description = "Northern tip camping with stunning views" } },
            { 3, new CampsiteDto { Id = 3, Name = "Aarhus Forest Retreat", Region = "East Jutland", Latitude = 56.1629, Longitude = 10.2039, Description = "Peaceful forest camping near Aarhus" } },
            { 4, new CampsiteDto { Id = 4, Name = "Odense Family Camp", Region = "Funen", Latitude = 55.4038, Longitude = 10.4024, Description = "Family-friendly camping in central Denmark" } },
            { 5, new CampsiteDto { Id = 5, Name = "Bornholm Island Camp", Region = "Bornholm", Latitude = 55.1367, Longitude = 14.9155, Description = "Scenic island camping with rocky coastline" } },
            { 6, new CampsiteDto { Id = 6, Name = "Ribe Viking Camp", Region = "Southwest Jutland", Latitude = 55.3282, Longitude = 8.7619, Description = "Historic campsite near Denmark's oldest town" } },
            { 7, new CampsiteDto { Id = 7, Name = "Roskilde Fjord Camp", Region = "Zealand", Latitude = 55.6415, Longitude = 12.0803, Description = "Waterfront camping by the beautiful Roskilde Fjord" } },
            { 8, new CampsiteDto { Id = 8, Name = "Aalborg Limfjord", Region = "North Jutland", Latitude = 57.0488, Longitude = 9.9217, Description = "Camping by the Limfjord with water activities" } }
        };

        if (campsites.TryGetValue(_campsiteId, out var campsite))
        {
            _campsite = campsite;
            _baseLat = campsite.Latitude;
            _baseLng = campsite.Longitude;
        }
        else
        {
            // Default to Copenhagen Beach Camp
            _campsite = campsites[1];
            _baseLat = 55.6761;
            _baseLng = 12.5683;
        }
    }

    private void LoadCampingSpots()
    {
        // Generate sample camping spots based on campsite ID
        // In a real app, this would come from a database

        var spots = new List<CampingSpot>();
        var random = new Random(_campsiteId); // Seed with ID for consistency

        // Section A - Tent pitches (A1-A10) - arranged in 2 rows of 5
        for (int i = 1; i <= 10; i++)
        {
            int row = (i - 1) / 5;
            int col = (i - 1) % 5;

            spots.Add(new CampingSpot
            {
                SpotId = $"A{i}",
                CampsiteId = _campsiteId,
                CampsiteName = _campsite?.Name ?? "",
                Latitude = _baseLat + (row * 0.0005),
                Longitude = _baseLng + (col * 0.0008),
                Type = "Tent",
                Amenities = new List<string> { "Picnic-Table" },
                Status = random.Next(100) < 70 ? "Available" : "Occupied",
                PriceModifier = 1.0m
            });
        }

        // Section B - Caravan pitches (B1-B8) - arranged in 2 rows of 4
        for (int i = 1; i <= 8; i++)
        {
            int row = (i - 1) / 4;
            int col = (i - 1) % 4;

            spots.Add(new CampingSpot
            {
                SpotId = $"B{i}",
                CampsiteId = _campsiteId,
                CampsiteName = _campsite?.Name ?? "",
                Latitude = _baseLat + 0.0012 + (row * 0.0006),
                Longitude = _baseLng + (col * 0.001),
                Type = "Caravan",
                Amenities = new List<string> { "Electric-Hookup", "Water-Access" },
                Status = random.Next(100) < 60 ? "Available" : "Occupied",
                PriceModifier = 1.2m
            });
        }

        // Section C - Cabins (C1-C5) - arranged in a single row
        for (int i = 1; i <= 5; i++)
        {
            spots.Add(new CampingSpot
            {
                SpotId = $"C{i}",
                CampsiteId = _campsiteId,
                CampsiteName = _campsite?.Name ?? "",
                Latitude = _baseLat + 0.0025,
                Longitude = _baseLng + ((i - 1) * 0.0008),
                Type = "Cabin",
                Amenities = new List<string> { "Electric-Hookup", "Water-Access", "WiFi" },
                Status = random.Next(100) < 50 ? "Available" : "Occupied",
                PriceModifier = 1.5m
            });
        }

        // Section D - Premium spots (D1-D3) - arranged near the beach
        for (int i = 1; i <= 3; i++)
        {
            spots.Add(new CampingSpot
            {
                SpotId = $"D{i}",
                CampsiteId = _campsiteId,
                CampsiteName = _campsite?.Name ?? "",
                Latitude = _baseLat - 0.0005,
                Longitude = _baseLng + ((i - 1) * 0.0012),
                Type = "Premium",
                Amenities = new List<string> { "Electric-Hookup", "Water-Access", "WiFi", "Near-Beach" },
                Status = random.Next(100) < 40 ? "Available" : "Occupied",
                PriceModifier = 2.0m
            });
        }

        _campingSpots = spots;
    }

    private void LoadPeripheralPurchases()
    {
        // In a real app, this would come from the database based on accommodation type and campsite
        // For now, using sample data that matches the accommodation type

        // Accommodation-specific peripheral purchases (based on accommodation type)
        if (_accommodation?.Type == "Cabin")
        {
            _accommodationPeripheralPurchases = new List<PeripheralPurchaseDto>
            {
                new() { Id = 101, Name = "Cabin Cleaning", Description = "Professional cleaning service", Price = 50.00m, IsActive = true },
                new() { Id = 102, Name = "Linen Package", Description = "Fresh bed linens and towels", Price = 25.00m, IsActive = true },
                new() { Id = 103, Name = "Firewood Bundle", Description = "Bundle of firewood for fireplace", Price = 15.00m, IsActive = true }
            };
        }
        else if (_accommodation?.Type == "Tent Site")
        {
            _accommodationPeripheralPurchases = new List<PeripheralPurchaseDto>
            {
                new() { Id = 104, Name = "Tent Rental", Description = "4-person tent rental", Price = 30.00m, IsActive = true },
                new() { Id = 105, Name = "Sleeping Bag Rental", Description = "Warm sleeping bag rental", Price = 15.00m, IsActive = true },
                new() { Id = 106, Name = "Camping Chair Set", Description = "Set of 4 camping chairs", Price = 10.00m, IsActive = true }
            };
        }
        else if (_accommodation?.Type == "Glamping")
        {
            _accommodationPeripheralPurchases = new List<PeripheralPurchaseDto>
            {
                new() { Id = 107, Name = "Premium Cleaning", Description = "Luxury cleaning service", Price = 75.00m, IsActive = true },
                new() { Id = 108, Name = "Welcome Package", Description = "Champagne and snacks", Price = 40.00m, IsActive = true },
                new() { Id = 109, Name = "Private Chef", Description = "Personal chef for one meal", Price = 150.00m, IsActive = true }
            };
        }
        else if (_accommodation?.Type == "RV Spot")
        {
            _accommodationPeripheralPurchases = new List<PeripheralPurchaseDto>
            {
                new() { Id = 110, Name = "Electricity Hookup", Description = "30-amp electrical connection", Price = 20.00m, IsActive = true },
                new() { Id = 111, Name = "Water Hookup", Description = "Fresh water connection", Price = 15.00m, IsActive = true },
                new() { Id = 112, Name = "Sewage Disposal", Description = "Sewage disposal service", Price = 25.00m, IsActive = true }
            };
        }

        // Campsite-wide peripheral purchases (available to all accommodation types)
        _campsitePeripheralPurchases = new List<PeripheralPurchaseDto>
        {
            new() { Id = 1, Name = "Beach Volleyball Access", Description = "Access to beach volleyball courts", Price = 15.00m, IsActive = true },
            new() { Id = 2, Name = "Kayak Rental", Description = "Full-day kayak rental", Price = 35.00m, IsActive = true },
            new() { Id = 3, Name = "Lighthouse Tour", Description = "Guided tour of nearby lighthouse", Price = 25.00m, IsActive = true },
            new() { Id = 4, Name = "Bike Rental", Description = "Full-day bike rental", Price = 20.00m, IsActive = true },
            new() { Id = 5, Name = "Morning Yoga", Description = "Beachside yoga session", Price = 18.00m, IsActive = true },
            new() { Id = 6, Name = "Restaurant Brunch (Daily)", Description = "Daily brunch at campsite restaurant", Price = 30.00m, IsActive = true }
        };
    }

    private void ApplyDiscount()
    {
        _discountError = string.Empty;

        // Validate discount code (in real app, this would call an API)
        var validDiscounts = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase)
        {
            { "SUMMER10", 10 },
            { "SUMMER20", 20 },
            { "WELCOME15", 15 },
            { "EARLYBIRD", 25 },
            { "FAMILY10", 10 },
            { "WEEKEND5", 5 }
        };

        if (validDiscounts.TryGetValue(_discountCode.Trim(), out int percentage))
        {
            _discountApplied = true;
            _appliedDiscountCode = _discountCode.Trim().ToUpper();
            _discountPercentage = percentage;
        }
        else
        {
            _discountError = "Invalid discount code. Please check and try again.";
            _discountApplied = false;
            _appliedDiscountCode = string.Empty;
            _discountPercentage = 0;
        }
    }

    private async Task SubmitBooking()
    {
        // TODO: Submit booking to API
        await Task.Delay(500);
        Navigation.NavigateTo("/bookings");
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/search");
    }

    public class AccommodationDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public int Capacity { get; set; }
        public decimal PricePerNight { get; set; }
        public string ImageUrl { get; set; } = string.Empty;
    }

    public class PeripheralPurchaseDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public decimal Price { get; set; }
        public bool IsActive { get; set; } = true;
        public bool IsSelected { get; set; } = false;
    }

    public class CampsiteDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Region { get; set; } = string.Empty;
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public string Description { get; set; } = string.Empty;
    }
}

