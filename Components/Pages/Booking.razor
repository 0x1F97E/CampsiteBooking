@page "/booking"
@page "/booking/{CampsiteIdParam:int}"
@rendermode InteractiveServer
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject IDbContextFactory<CampsiteBookingDbContext> DbContextFactory
@inject ISnackbar Snackbar
@inject StripePaymentService StripeService
@using CampsiteBooking.Data
@using CampsiteBooking.Models
@using CampsiteBooking.Models.ValueObjects
@using CampsiteBooking.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.WebUtilities

<PageTitle>Book Accommodation - Campsite Booking</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Complete Your Booking</MudText>
    
    @if (_accommodation != null)
    {
        <MudGrid>
            <MudItem xs="12" md="5">
                <MudCard Elevation="3">
                    <MudCardMedia Image="@_accommodation.ImageUrl" Height="200" />
                    <MudCardContent>
                        <MudText Typo="Typo.h6">@_accommodation.Name</MudText>
                        <MudChip T="string" Size="Size.Small" Color="Color.Info">@_accommodation.Type</MudChip>
                        <MudText Typo="Typo.body2" Class="mt-2">@_accommodation.Description</MudText>

                        <MudDivider Class="my-3" />

                        <MudStack Spacing="2">
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.body2">Base price per night:</MudText>
                                <MudText Typo="Typo.body1"><b>$@_accommodation.PricePerNight</b></MudText>
                            </MudStack>
                            @if (_selectedSpot != null && _selectedSpot.PriceModifier != 1.0m)
                            {
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText Typo="Typo.body2">Spot modifier (@_selectedSpot.SpotId):</MudText>
                                    <MudText Typo="Typo.body1" Color="Color.Warning"><b>×@_selectedSpot.PriceModifier</b></MudText>
                                </MudStack>
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText Typo="Typo.body2">Adjusted price per night:</MudText>
                                    <MudText Typo="Typo.body1" Color="Color.Primary"><b>$@_spotPrice</b></MudText>
                                </MudStack>
                            }
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.body2">Number of nights:</MudText>
                                <MudText Typo="Typo.body1"><b>@_numberOfNights</b></MudText>
                            </MudStack>
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.body2">Accommodation subtotal:</MudText>
                                <MudText Typo="Typo.body1"><b>$@(_spotPrice * _numberOfNights)</b></MudText>
                            </MudStack>
                            @if (_selectedServices.Any())
                            {
                                <MudDivider Class="my-2" />
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-1">Additional Services:</MudText>
                                @foreach (var service in _selectedServices)
                                {
                                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                                        <MudText Typo="Typo.body2" Class="ml-3">@service.Name:</MudText>
                                        <MudText Typo="Typo.body1" Color="Color.Info"><b>$@service.Price.ToString("N2")</b></MudText>
                                    </MudStack>
                                }
                            }

                            <MudDivider Class="my-2" />

                            <!-- Discount Code Section -->
                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.End">
                                <MudTextField @bind-Value="_discountCode"
                                             Label="Discount Code"
                                             Variant="Variant.Outlined"
                                             Placeholder="Enter code"
                                             Dense="true"
                                             Style="flex: 1;" />
                                <MudButton Variant="Variant.Filled"
                                          Color="@(_discountApplied ? Color.Success : Color.Primary)"
                                          OnClick="ApplyDiscount"
                                          Disabled="@(string.IsNullOrWhiteSpace(_discountCode) || _discountApplied)"
                                          Size="Size.Small">
                                    @(_discountApplied ? "Applied" : "Apply")
                                </MudButton>
                            </MudStack>

                            @if (_discountApplied && _discountAmount > 0)
                            {
                                <MudAlert Severity="Severity.Success" Dense="true" Class="mt-2">
                                    Discount "@_appliedDiscountCode" applied: @_discountPercentage% off!
                                </MudAlert>
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText Typo="Typo.body2">Subtotal:</MudText>
                                    <MudText Typo="Typo.body1"><b>$@_subtotalPrice.ToString("N2")</b></MudText>
                                </MudStack>
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText Typo="Typo.body2" Color="Color.Success">Discount (@_discountPercentage%):</MudText>
                                    <MudText Typo="Typo.body1" Color="Color.Success"><b>-$@_discountAmount.ToString("N2")</b></MudText>
                                </MudStack>
                            }
                            @if (!string.IsNullOrWhiteSpace(_discountError))
                            {
                                <MudAlert Severity="Severity.Error" Dense="true" Class="mt-2" CloseIcon="@Icons.Material.Filled.Close" CloseIconClicked="@(() => _discountError = string.Empty)">
                                    @_discountError
                                </MudAlert>
                            }

                            <MudDivider />
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.h6">Total:</MudText>
                                <MudText Typo="Typo.h6" Color="Color.Primary">$@_totalPrice.ToString("N2")</MudText>
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" md="7">
                <MudPaper Elevation="3" Class="pa-4">
                    <MudForm @ref="_form" @bind-IsValid="@_formValid">
                        <MudText Typo="Typo.h6" GutterBottom="true">Booking Details</MudText>
                        
                        <MudDateRangePicker Label="Check-in / Check-out" 
                                           @bind-DateRange="_dateRange"
                                           MinDate="DateTime.Today"
                                           Required="true"
                                           RequiredError="Please select dates"
                                           Editable="true" />
                        
                        <MudNumericField @bind-Value="_numberOfGuests"
                                        Label="Number of Guests"
                                        Variant="Variant.Outlined"
                                        Min="1"
                                        Max="@_accommodation.Capacity"
                                        Required="true"
                                        Class="mt-3" />

                        <MudSelect T="CampingSpot"
                                  @bind-Value="_selectedSpot"
                                  Label="Select Camping Spot"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  RequiredError="Please select a camping spot"
                                  Class="mt-3"
                                  AnchorOrigin="Origin.BottomCenter">
                            @foreach (var spot in _campingSpots.Where(s => s.Status == "Available"))
                            {
                                <MudSelectItem T="CampingSpot" Value="@spot">
                                    @spot.SpotId - @spot.Type
                                    @if (spot.PriceModifier > 1.0m)
                                    {
                                        <text> (Premium +@(((spot.PriceModifier - 1) * 100).ToString("0"))%)</text>
                                    }
                                </MudSelectItem>
                            }
                        </MudSelect>

                        <MudDivider Class="my-4" />
                        
                        <MudText Typo="Typo.h6" GutterBottom="true">Guest Information</MudText>
                        
                        <MudTextField @bind-Value="_guestName" 
                                     Label="Full Name" 
                                     Variant="Variant.Outlined"
                                     Required="true"
                                     RequiredError="Name is required" />
                        
                        <MudTextField @bind-Value="_guestEmail" 
                                     Label="Email" 
                                     Variant="Variant.Outlined"
                                     InputType="InputType.Email"
                                     Required="true"
                                     RequiredError="Email is required"
                                     Class="mt-3" />
                        
                        <MudTextField @bind-Value="_guestPhone" 
                                     Label="Phone Number" 
                                     Variant="Variant.Outlined"
                                     InputType="InputType.Telephone"
                                     Required="true"
                                     RequiredError="Phone is required"
                                     Class="mt-3" />
                        
                        <MudTextField @bind-Value="_specialRequests" 
                                     Label="Special Requests (Optional)" 
                                     Variant="Variant.Outlined"
                                     Lines="3"
                                     Class="mt-3" />
                        
                        <MudStack Row="true" Class="mt-4" Spacing="2">
                            <MudButton Variant="Variant.Outlined" 
                                      Color="Color.Default"
                                      OnClick="Cancel">
                                Cancel
                            </MudButton>
                            <MudButton Variant="Variant.Filled"
                                      Color="Color.Primary"
                                      Disabled="@(!_formValid || _selectedSpot == null)"
                                      OnClick="SubmitBooking"
                                      FullWidth="true">
                                Confirm Booking
                            </MudButton>
                        </MudStack>

                        @if (_selectedSpot == null)
                        {
                            <MudAlert Severity="Severity.Warning" Class="mt-3">
                                Please select a camping spot to continue.
                            </MudAlert>
                        }
                    </MudForm>
                </MudPaper>
            </MudItem>

            <MudItem xs="12">
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" GutterBottom="true">Additional Services</MudText>
                    <MudText Typo="Typo.body2" Class="mb-3">
                        Optional services to enhance your stay.
                    </MudText>

                    @if (_accommodationPeripheralPurchases.Any())
                    {
                        <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.HomeWork" Size="Size.Small" Class="mr-1" />
                            Accommodation Services
                        </MudText>
                        @foreach (var service in _accommodationPeripheralPurchases)
                        {
                            <MudCheckBox @bind-Value="@service.IsSelected"
                                         Color="Color.Primary"
                                         Dense="true"
                                         Class="mb-2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudText Typo="Typo.body1">@service.Name (+$@service.Price.ToString("N2"))</MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Class="ml-2" Color="Color.Secondary">
                                    @service.Description
                                </MudText>
                            </MudCheckBox>
                        }
                    }

                    @if (_campsitePeripheralPurchases.Any())
                    {
                        <MudDivider Class="my-3" />
                        <MudText Typo="Typo.subtitle2" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.LocalActivity" Size="Size.Small" Class="mr-1" />
                            Campsite Activities & Services
                        </MudText>
                        @foreach (var service in _campsitePeripheralPurchases)
                        {
                            <MudCheckBox @bind-Value="@service.IsSelected"
                                         Color="Color.Primary"
                                         Dense="true"
                                         Class="mb-2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudText Typo="Typo.body1">@service.Name (+$@service.Price.ToString("N2"))</MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Class="ml-2" Color="Color.Secondary">
                                    @service.Description
                                </MudText>
                            </MudCheckBox>
                        }
                    }

                    @if (!_accommodationPeripheralPurchases.Any() && !_campsitePeripheralPurchases.Any())
                    {
                        <MudAlert Severity="Severity.Info" Dense="true">
                            No additional services available for this accommodation.
                        </MudAlert>
                    }
                </MudPaper>
            </MudItem>

            <MudItem xs="12">
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" GutterBottom="true">
                        @(_campsite?.Name ?? "Campsite") - Accommodation Spots
                    </MudText>
                    <MudText Typo="Typo.body2" Class="mb-3">
                        Interactive satellite map showing all accommodation spots at this campsite.
                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text">Green = Available</MudChip>
                        <MudChip T="string" Size="Size.Small" Color="Color.Error" Variant="Variant.Text">Red = Occupied</MudChip>
                    </MudText>

                    <div style="height: 500px; width: 100%; border-radius: 8px; overflow: hidden;">
                        <div id="booking-map" style="width: 100%; height: 100%; border-radius: 8px; z-index: 1;"></div>
                    </div>
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
    else
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
</MudContainer>

@code {
    [Parameter]
    public int? CampsiteIdParam { get; set; }

    private int _campsiteId;
    private CampsiteDto? _campsite;

    private MudForm? _form;
    private bool _formValid;
    private AccommodationDto? _accommodation;
    private MudBlazor.DateRange? _dateRange = new MudBlazor.DateRange(DateTime.Today.AddDays(1), DateTime.Today.AddDays(3));
    private int _numberOfGuests = 2;
    private string _guestName = string.Empty;
    private string _guestEmail = string.Empty;
    private string _guestPhone = string.Empty;
    private string _specialRequests = string.Empty;

    private List<CampingSpot> _campingSpots = new();
    private CampingSpot? _selectedSpot = null;
    private List<PeripheralPurchaseDto> _accommodationPeripheralPurchases = new();
    private List<PeripheralPurchaseDto> _campsitePeripheralPurchases = new();
    private string _campsiteMapUrl = string.Empty;

    // Base coordinates - will be set based on selected campsite
    private double _baseLat = 55.6761;
    private double _baseLng = 12.5683;

    // Discount code fields
    private string _discountCode = string.Empty;
    private bool _discountApplied = false;
    private string _appliedDiscountCode = string.Empty;
    private int _discountPercentage = 0;
    private string _discountError = string.Empty;

    private int _numberOfNights => _dateRange?.End != null && _dateRange?.Start != null
        ? (_dateRange.End.Value - _dateRange.Start.Value).Days
        : 0;

    private decimal _spotPrice => _selectedSpot != null && _accommodation != null
        ? _accommodation.PricePerNight * _selectedSpot.PriceModifier
        : (_accommodation?.PricePerNight ?? 0);

    private List<PeripheralPurchaseDto> _selectedServices =>
        _accommodationPeripheralPurchases.Where(s => s.IsSelected)
            .Concat(_campsitePeripheralPurchases.Where(s => s.IsSelected))
            .ToList();

    private decimal _servicesTotal => _selectedServices.Sum(s => s.Price);

    private decimal _subtotalPrice => (_spotPrice * _numberOfNights) + _servicesTotal;

    private decimal _discountAmount => _discountApplied ? (_subtotalPrice * _discountPercentage / 100m) : 0;

    private decimal _totalPrice => _subtotalPrice - _discountAmount;

    protected override async Task OnInitializedAsync()
    {
        // Check if campsiteId comes from route parameter (old format: /booking/1)
        if (CampsiteIdParam.HasValue)
        {
            _campsiteId = CampsiteIdParam.Value;
        }
        else
        {
            // Get campsiteId from query parameter (new format: /booking?campsiteId=1)
            var uri = new Uri(Navigation.Uri);
            var queryParams = QueryHelpers.ParseQuery(uri.Query);

            if (queryParams.TryGetValue("campsiteId", out var campsiteIdStr) && int.TryParse(campsiteIdStr, out var campsiteId))
            {
                _campsiteId = campsiteId;
            }
            else
            {
                _campsiteId = 1; // Default to first campsite
            }
        }

        // Load campsite data from database
        await LoadCampsiteData();

        // Load accommodation data from database
        await LoadAccommodationData();

        // Load camping spots for this campsite
        LoadCampingSpots();

        // Load peripheral purchases
        LoadPeripheralPurchases();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Wait for Google Maps API and scripts to load
                await Task.Delay(1000);

                // Check if function exists and retry if needed
                for (int i = 0; i < 10; i++)
                {
                    try
                    {
                        await UpdateBookingMapAsync();
                        break; // Success, exit loop
                    }
                    catch (Exception)
                    {
                        if (i < 9) // Not the last attempt
                        {
                            await Task.Delay(500);
                        }
                        else
                        {
                            throw; // Re-throw on last attempt
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing booking map: {ex.Message}");
            }
        }
    }

    private async Task UpdateBookingMapAsync()
    {
        if (_campsite != null && _campingSpots.Any())
        {
            var spotsJson = System.Text.Json.JsonSerializer.Serialize(_campingSpots);

            // Call the global JavaScript function
            await JSRuntime.InvokeVoidAsync("initializeBookingMap",
                _campsite.Latitude,
                _campsite.Longitude,
                _campsite.Name,
                spotsJson);
        }
    }

    private async Task LoadCampsiteData()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load campsite from database
            var campsiteId = CampsiteId.Create(_campsiteId);
            var campsite = await context.Campsites
                .FirstOrDefaultAsync(c => c.Id == campsiteId);

            if (campsite != null)
            {
                _campsite = new CampsiteDto
                {
                    Id = campsite.Id?.Value ?? 0,
                    Name = campsite.Name ?? "",
                    Region = campsite.Region ?? "",
                    Latitude = campsite.Latitude,
                    Longitude = campsite.Longitude,
                    Description = campsite.Description ?? ""
                };

                _baseLat = campsite.Latitude;
                _baseLng = campsite.Longitude;

                Console.WriteLine($"✅ Loaded campsite: {_campsite.Name}");
            }
            else
            {
                Console.WriteLine($"❌ Campsite not found: {_campsiteId}");
                // Load first campsite as default
                var firstCampsite = await context.Campsites.FirstOrDefaultAsync();
                if (firstCampsite != null)
                {
                    _campsite = new CampsiteDto
                    {
                        Id = firstCampsite.Id?.Value ?? 0,
                        Name = firstCampsite.Name ?? "",
                        Region = firstCampsite.Region ?? "",
                        Latitude = firstCampsite.Latitude,
                        Longitude = firstCampsite.Longitude,
                        Description = firstCampsite.Description ?? ""
                    };
                    _baseLat = firstCampsite.Latitude;
                    _baseLng = firstCampsite.Longitude;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error loading campsite data: {ex.Message}");
        }
    }

    private async Task LoadAccommodationData()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load first accommodation type for this campsite
            var campsiteId = CampsiteId.Create(_campsiteId);
            var accommodationType = await context.AccommodationTypes
                .Where(at => at.CampsiteId == campsiteId)
                .FirstOrDefaultAsync();

            if (accommodationType != null)
            {
                _accommodation = new AccommodationDto
                {
                    Id = accommodationType.Id?.Value ?? 0,
                    Name = $"{accommodationType.Type} at {_campsite?.Name ?? "Campsite"}",
                    Type = accommodationType.Type ?? "Mixed",
                    Description = accommodationType.Description ?? "Various accommodation types available",
                    Capacity = accommodationType.MaxCapacity,
                    PricePerNight = accommodationType.BasePrice?.Amount ?? 100m,
                    ImageUrl = accommodationType.ImageUrl ?? "https://images.unsplash.com/photo-1587061949409-02df41d5e562?w=400",
                    CampsiteId = _campsiteId,
                    CampsiteName = _campsite?.Name ?? "Campsite"
                };

                Console.WriteLine($"✅ Loaded accommodation: {_accommodation.Name}");
            }
            else
            {
                // Fallback to generic accommodation
                _accommodation = new AccommodationDto
                {
                    Id = _campsiteId,
                    Name = _campsite?.Name ?? "Campsite Accommodation",
                    Type = "Mixed",
                    Description = _campsite?.Description ?? "Various accommodation types available",
                    Capacity = 6,
                    PricePerNight = 100,
                    ImageUrl = "https://images.unsplash.com/photo-1587061949409-02df41d5e562?w=400",
                    CampsiteId = _campsiteId,
                    CampsiteName = _campsite?.Name ?? "Campsite"
                };
                Console.WriteLine($"⚠️ No accommodation types found for campsite {_campsiteId}, using fallback");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error loading accommodation data: {ex.Message}");
        }
    }

    private void LoadCampingSpots()
    {
        // Generate sample camping spots based on campsite ID
        // In a real app, this would come from a database

        var spots = new List<CampingSpot>();
        var random = new Random(_campsiteId); // Seed with ID for consistency

        // Section A - Tent pitches (A1-A10) - arranged in 2 rows of 5
        for (int i = 1; i <= 10; i++)
        {
            int row = (i - 1) / 5;
            int col = (i - 1) % 5;

            spots.Add(new CampingSpot
            {
                SpotId = $"A{i}",
                CampsiteId = _campsiteId,
                CampsiteName = _campsite?.Name ?? "",
                Latitude = _baseLat + (row * 0.0005),
                Longitude = _baseLng + (col * 0.0008),
                Type = "Tent",
                Amenities = new List<string> { "Picnic-Table" },
                Status = random.Next(100) < 70 ? "Available" : "Occupied",
                PriceModifier = 1.0m
            });
        }

        // Section B - Caravan pitches (B1-B8) - arranged in 2 rows of 4
        for (int i = 1; i <= 8; i++)
        {
            int row = (i - 1) / 4;
            int col = (i - 1) % 4;

            spots.Add(new CampingSpot
            {
                SpotId = $"B{i}",
                CampsiteId = _campsiteId,
                CampsiteName = _campsite?.Name ?? "",
                Latitude = _baseLat + 0.0012 + (row * 0.0006),
                Longitude = _baseLng + (col * 0.001),
                Type = "Caravan",
                Amenities = new List<string> { "Electric-Hookup", "Water-Access" },
                Status = random.Next(100) < 60 ? "Available" : "Occupied",
                PriceModifier = 1.2m
            });
        }

        // Section C - Cabins (C1-C5) - arranged in a single row
        for (int i = 1; i <= 5; i++)
        {
            spots.Add(new CampingSpot
            {
                SpotId = $"C{i}",
                CampsiteId = _campsiteId,
                CampsiteName = _campsite?.Name ?? "",
                Latitude = _baseLat + 0.0025,
                Longitude = _baseLng + ((i - 1) * 0.0008),
                Type = "Cabin",
                Amenities = new List<string> { "Electric-Hookup", "Water-Access", "WiFi" },
                Status = random.Next(100) < 50 ? "Available" : "Occupied",
                PriceModifier = 1.5m
            });
        }

        // Section D - Premium spots (D1-D3) - arranged near the beach
        for (int i = 1; i <= 3; i++)
        {
            spots.Add(new CampingSpot
            {
                SpotId = $"D{i}",
                CampsiteId = _campsiteId,
                CampsiteName = _campsite?.Name ?? "",
                Latitude = _baseLat - 0.0005,
                Longitude = _baseLng + ((i - 1) * 0.0012),
                Type = "Premium",
                Amenities = new List<string> { "Electric-Hookup", "Water-Access", "WiFi", "Near-Beach" },
                Status = random.Next(100) < 40 ? "Available" : "Occupied",
                PriceModifier = 2.0m
            });
        }

        _campingSpots = spots;
    }

    private void LoadPeripheralPurchases()
    {
        // TODO: Load from database when PeripheralPurchases table is created
        // For now, return empty lists (no hardcoded data)
        _accommodationPeripheralPurchases = new List<PeripheralPurchaseDto>();
        _campsitePeripheralPurchases = new List<PeripheralPurchaseDto>();

        Console.WriteLine("⚠️ Peripheral purchases not loaded - database table not yet created");
    }

    private void ApplyDiscount()
    {
        _discountError = string.Empty;

        // Validate discount code (in real app, this would call an API)
        var validDiscounts = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase)
        {
            { "SUMMER10", 10 },
            { "SUMMER20", 20 },
            { "WELCOME15", 15 },
            { "EARLYBIRD", 25 },
            { "FAMILY10", 10 },
            { "WEEKEND5", 5 }
        };

        if (validDiscounts.TryGetValue(_discountCode.Trim(), out int percentage))
        {
            _discountApplied = true;
            _appliedDiscountCode = _discountCode.Trim().ToUpper();
            _discountPercentage = percentage;
        }
        else
        {
            _discountError = "Invalid discount code. Please check and try again.";
            _discountApplied = false;
            _appliedDiscountCode = string.Empty;
            _discountPercentage = 0;
        }
    }

    private async Task SubmitBooking()
    {
        try
        {
            // Check if user is logged in
            var currentUserIdStr = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "currentUserId");
            if (string.IsNullOrEmpty(currentUserIdStr) || !int.TryParse(currentUserIdStr, out var currentUserId))
            {
                Snackbar.Add("Please log in to complete your booking", Severity.Error);
                Navigation.NavigateTo("/login");
                return;
            }

            // Validate form
            if (_accommodation == null || _selectedSpot == null || _dateRange == null || _dateRange.Start == null || _dateRange.End == null)
            {
                Snackbar.Add("Please fill in all required fields", Severity.Error);
                return;
            }

            // Create booking in database
            using var context = await DbContextFactory.CreateDbContextAsync();

            var guestId = GuestId.Create(currentUserId);
            var campsiteId = CampsiteId.Create(_accommodation.CampsiteId);
            var accommodationTypeId = AccommodationTypeId.Create(_accommodation.Id);
            var period = CampsiteBooking.Models.ValueObjects.DateRange.Create(_dateRange.Start.Value, _dateRange.End.Value);
            var basePrice = Money.Create(_accommodation.PricePerNight, "DKK");

            var booking = CampsiteBooking.Models.Booking.Create(
                guestId,
                campsiteId,
                accommodationTypeId,
                period,
                basePrice,
                _numberOfGuests, // numberOfAdults
                0, // numberOfChildren
                _specialRequests ?? string.Empty
            );

            // Save booking to database
            await context.Bookings.AddAsync(booking);
            await context.SaveChangesAsync();

            var bookingId = booking.Id?.Value ?? 0;
            Console.WriteLine($"✅ Created booking {bookingId} for user {currentUserId}");

            // Create Stripe Checkout Session
            var checkoutUrl = await StripeService.CreateCheckoutSessionAsync(
                bookingId,
                _accommodation.CampsiteName,
                _accommodation.Type,
                _totalPrice,
                "DKK"
            );

            Console.WriteLine($"✅ Created Stripe Checkout Session for booking {bookingId}");

            // Redirect to Stripe Checkout
            Navigation.NavigateTo(checkoutUrl, forceLoad: true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error creating booking: {ex.Message}");
            Snackbar.Add($"Error creating booking: {ex.Message}", Severity.Error);
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/search");
    }

    public class AccommodationDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public int Capacity { get; set; }
        public decimal PricePerNight { get; set; }
        public string ImageUrl { get; set; } = string.Empty;
        public int CampsiteId { get; set; }
        public string CampsiteName { get; set; } = string.Empty;
    }

    public class PeripheralPurchaseDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public decimal Price { get; set; }
        public bool IsActive { get; set; } = true;
        public bool IsSelected { get; set; } = false;
    }

    public class CampsiteDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Region { get; set; } = string.Empty;
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public string Description { get; set; } = string.Empty;
    }
}

