@page "/admin/bookings"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin,Staff")]
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IDbContextFactory<CampsiteBooking.Data.CampsiteBookingDbContext> DbContextFactory
@using CampsiteBooking.Data
@using CampsiteBooking.Models
@using CampsiteBooking.Models.ValueObjects
@using CampsiteBooking.Models.Common
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization

<PageTitle>Booking Management - Campsite Booking</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-6">
        <div>
            <MudText Typo="Typo.h3" GutterBottom="true">
                <MudIcon Icon="@Icons.Material.Filled.BookOnline" Class="mr-2" />
                Booking Management
            </MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary">
                View and manage all campsite bookings (@_bookings.Count total)
            </MudText>
        </div>
        <MudStack Row="true" Spacing="2">
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Refresh"
                       OnClick="RefreshBookings"
                       Disabled="@_loading">
                @if (_loading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Loading...</span>
                }
                else
                {
                    <span>Refresh</span>
                }
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.FileDownload">
                Export to CSV
            </MudButton>
        </MudStack>
    </div>

    <!-- Filters -->
    <MudPaper Elevation="3" Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="3">
                <MudTextField @bind-Value="_searchText" Label="Search" Variant="Variant.Outlined" 
                              Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" 
                              Immediate="true" />
            </MudItem>
            <MudItem xs="12" md="3">
                <MudSelect T="string" @bind-Value="_filterStatus" Label="Status" Variant="Variant.Outlined">
                    <MudSelectItem T="string" Value="@("All")">All Status</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Confirmed")">Confirmed</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Pending")">Pending</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Cancelled")">Cancelled</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Completed")">Completed</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudSelect T="string" @bind-Value="_filterCampsite" Label="Campsite" Variant="Variant.Outlined">
                    <MudSelectItem T="string" Value="@("All")">All Campsites</MudSelectItem>
                    @foreach (var campsite in _availableCampsites)
                    {
                        <MudSelectItem T="string" Value="@campsite">@campsite</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudDateRangePicker @bind-DateRange="_dateRange" Label="Date Range" Variant="Variant.Outlined" />
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Bookings Table -->
    <MudPaper Elevation="3">
        <MudTable Items="@GetFilteredBookings()" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" 
                  Dense="true" @bind-SelectedItem="_selectedBooking">
            <HeaderContent>
                <MudTh>Booking ID</MudTh>
                <MudTh>Guest</MudTh>
                <MudTh>Campsite</MudTh>
                <MudTh>Accommodation</MudTh>
                <MudTh>Spot Number</MudTh>
                <MudTh>Check-in</MudTh>
                <MudTh>Check-out</MudTh>
                <MudTh>Guests</MudTh>
                <MudTh>Amount</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Payment</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Booking ID">
                    <MudText Typo="Typo.body2"><strong>#@context.Id</strong></MudText>
                </MudTd>
                <MudTd DataLabel="Guest">
                    <div>
                        <MudText Typo="Typo.body2">@context.GuestName</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@context.GuestEmail</MudText>
                    </div>
                </MudTd>
                <MudTd DataLabel="Campsite">@context.CampsiteName</MudTd>
                <MudTd DataLabel="Accommodation">
                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@context.AccommodationType</MudChip>
                </MudTd>
                <MudTd DataLabel="Spot Number">
                    @if (!string.IsNullOrEmpty(context.SpotNumber))
                    {
                        <MudText Typo="Typo.body2">@context.SpotNumber</MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">-</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Check-in">@context.CheckIn.ToString("MMM dd, yyyy")</MudTd>
                <MudTd DataLabel="Check-out">@context.CheckOut.ToString("MMM dd, yyyy")</MudTd>
                <MudTd DataLabel="Guests">@context.NumberOfGuests</MudTd>
                <MudTd DataLabel="Amount">
                    <MudText Typo="Typo.body2"><strong>$@context.TotalAmount.ToString("N2")</strong></MudText>
                </MudTd>
                <MudTd DataLabel="Status">
                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                        @context.Status
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Payment">
                    @if (!string.IsNullOrEmpty(context.PaymentStatus))
                    {
                        <div>
                            <MudChip T="string" Size="Size.Small" Color="@GetPaymentStatusColor(context.PaymentStatus)">
                                @context.PaymentStatus
                            </MudChip>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@context.PaymentMethod</MudText>
                            @if (!string.IsNullOrEmpty(context.TransactionId))
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@context.TransactionId</MudText>
                            }
                        </div>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">No payment</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small">
                        <MudMenuItem Icon="@Icons.Material.Filled.Visibility" OnAction="@(() => ViewBookingDetails(context))">
                            View Details
                        </MudMenuItem>
                        @if (context.Status == "Pending")
                        {
                            <MudMenuItem Icon="@Icons.Material.Filled.CheckCircle" OnAction="@(() => ConfirmBooking(context))">
                                Confirm
                            </MudMenuItem>
                        }
                        @if (context.Status != "Cancelled" && context.Status != "Completed")
                        {
                            <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnAction="@(() => EditBooking(context))">
                                Edit
                            </MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.Cancel" OnAction="@(() => CancelBooking(context))">
                                Cancel
                            </MudMenuItem>
                        }
                    </MudMenu>
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
            </PagerContent>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    private bool _loading = false;
    private string _searchText = "";
    private string _filterStatus = "All";
    private string _filterCampsite = "All";
    private MudBlazor.DateRange? _dateRange = null;
    private BookingManagementDto? _selectedBooking = null;
    private List<BookingManagementDto> _bookings = new();
    private List<string> _availableCampsites = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadBookings();
    }

    private async Task RefreshBookings()
    {
        Console.WriteLine("üîÑ Admin manually refreshing bookings...");
        await LoadBookings();
        Snackbar.Add($"Refreshed! Found {_bookings.Count} bookings", Severity.Success);
        StateHasChanged();
    }

    private async Task LoadBookings()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            Console.WriteLine("\n" + new string('=', 80));
            Console.WriteLine("üìä ADMIN BOOKINGS MANAGEMENT - Loading bookings from database...");
            Console.WriteLine(new string('=', 80));

            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load all bookings from database
            var bookingEntities = await context.Bookings.ToListAsync();
            Console.WriteLine($"   ‚úÖ Loaded {bookingEntities.Count} bookings from Bookings table");

            // Load all guests to get guest information
            var allGuests = await context.Guests.ToListAsync();
            Console.WriteLine($"   ‚úÖ Loaded {allGuests.Count} guests from Guests table");

            // Load all campsites to get campsite names
            var allCampsites = await context.Campsites.ToListAsync();
            Console.WriteLine($"   ‚úÖ Loaded {allCampsites.Count} campsites from Campsites table");

            // Load all accommodation types to get type names
            var allAccommodationTypes = await context.AccommodationTypes.ToListAsync();
            Console.WriteLine($"   ‚úÖ Loaded {allAccommodationTypes.Count} accommodation types from AccommodationTypes table");

            // Load all accommodation spots to get spot identifiers
            var allAccommodationSpots = await context.AccommodationSpots.ToListAsync();
            Console.WriteLine($"   ‚úÖ Loaded {allAccommodationSpots.Count} accommodation spots from AccommodationSpots table");

            // Load all payments to get payment information
            var allPayments = await context.Payments.ToListAsync();
            Console.WriteLine($"   ‚úÖ Loaded {allPayments.Count} payments from Payments table");

            // Populate available campsites for filter dropdown
            _availableCampsites = allCampsites
                .Where(c => !string.IsNullOrEmpty(c.Name))
                .Select(c => c.Name!)
                .Distinct()
                .OrderBy(name => name)
                .ToList();

            // Convert entities to DTOs with null-safe access
            _bookings = bookingEntities.Select(b =>
            {
                var guest = allGuests.FirstOrDefault(g => g.Id?.Value == b.GuestId?.Value);
                var campsite = allCampsites.FirstOrDefault(c => c.Id?.Value == b.CampsiteId?.Value);
                var accommodationType = allAccommodationTypes.FirstOrDefault(a => a.Id?.Value == b.AccommodationTypeId?.Value);
                var accommodationSpot = b.AccommodationSpotId != null
                    ? allAccommodationSpots.FirstOrDefault(s => s.Id?.Value == b.AccommodationSpotId.Value)
                    : null;
                var payment = allPayments.FirstOrDefault(p => p.BookingId?.Value == b.Id?.Value);

                // Debug logging for spot assignment
                var bookingId = b.Id?.Value ?? 0;
                var guestName = guest != null ? $"{guest.FirstName} {guest.LastName}" : "Unknown";
                if (b.AccommodationSpotId == null)
                {
                    Console.WriteLine($"   ‚ö†Ô∏è Booking #{bookingId} ({guestName}): AccommodationSpotId is NULL - no spot assigned");
                }
                else
                {
                    var spotIdValue = b.AccommodationSpotId.Value;
                    var foundSpot = accommodationSpot != null ? accommodationSpot.SpotIdentifier : "NOT FOUND";
                    Console.WriteLine($"   ‚úÖ Booking #{bookingId} ({guestName}): AccommodationSpotId = {spotIdValue}, SpotIdentifier = {foundSpot}");
                }

                return new BookingManagementDto
                {
                    Id = b.Id?.Value ?? 0,
                    GuestName = guest != null ? $"{guest.FirstName} {guest.LastName}" : "Unknown Guest",
                    GuestEmail = guest?.Email?.Value ?? "unknown@example.com",
                    CampsiteName = campsite?.Name ?? "Unknown Campsite",
                    AccommodationType = accommodationType?.Type ?? "Unknown Type",
                    SpotIdentifier = accommodationSpot?.SpotIdentifier,
                    CheckIn = b.Period?.StartDate ?? DateTime.Now,
                    CheckOut = b.Period?.EndDate ?? DateTime.Now,
                    NumberOfGuests = b.NumberOfAdults + b.NumberOfChildren,
                    TotalAmount = b.TotalPrice?.Amount ?? 0,
                    Status = b.Status.ToString(),

                    // Payment information
                    PaymentMethod = payment?.Method,
                    PaymentStatus = payment?.Status.ToString(),
                    TransactionId = payment?.TransactionId,
                    PaymentDate = payment?.PaymentDate
                };
            }).ToList();

            Console.WriteLine($"   ‚úÖ Converted {_bookings.Count} bookings to DTOs");

            if (_bookings.Any())
            {
                Console.WriteLine($"\n   üìã Recent bookings (last 3):");
                foreach (var booking in _bookings.OrderByDescending(b => b.Id).Take(3))
                {
                    Console.WriteLine($"      - ID: {booking.Id}, Guest: {booking.GuestName}, " +
                                    $"Campsite: {booking.CampsiteName}, Status: {booking.Status}");
                }
            }
            else
            {
                Console.WriteLine($"\n   ‚ö†Ô∏è  NO BOOKINGS FOUND! This could mean:");
                Console.WriteLine($"      1. No bookings have been created yet");
                Console.WriteLine($"      2. Bookings are not being saved to the database");
                Console.WriteLine($"      3. Database connection issue");
            }

            Console.WriteLine(new string('=', 80) + "\n");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error loading bookings: {ex.Message}");
            Console.WriteLine($"   Stack trace: {ex.StackTrace}");
            if (ex.InnerException != null)
            {
                Console.WriteLine($"   Inner exception: {ex.InnerException.Message}");
            }
            Snackbar.Add($"Error loading bookings: {ex.Message}", Severity.Error);
            _bookings = new List<BookingManagementDto>();
            _availableCampsites = new List<string>();
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private IEnumerable<BookingManagementDto> GetFilteredBookings()
    {
        var filtered = _bookings.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(_searchText))
        {
            filtered = filtered.Where(b =>
                b.GuestName.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                b.GuestEmail.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                b.Id.ToString().Contains(_searchText));
        }

        if (_filterStatus != "All")
        {
            filtered = filtered.Where(b => b.Status == _filterStatus);
        }

        if (_filterCampsite != "All")
        {
            filtered = filtered.Where(b => b.CampsiteName == _filterCampsite);
        }

        if (_dateRange?.Start != null && _dateRange?.End != null)
        {
            filtered = filtered.Where(b => b.CheckIn >= _dateRange.Start && b.CheckOut <= _dateRange.End);
        }

        return filtered.OrderByDescending(b => b.Id);
    }

    private Color GetStatusColor(string status) => status switch
    {
        "Confirmed" => Color.Success,
        "Pending" => Color.Warning,
        "Cancelled" => Color.Error,
        "Completed" => Color.Info,
        _ => Color.Default
    };

    private Color GetPaymentStatusColor(string? status) => status switch
    {
        "Completed" => Color.Success,
        "Pending" => Color.Warning,
        "Failed" => Color.Error,
        "Refunded" => Color.Info,
        _ => Color.Default
    };

    private void ViewBookingDetails(BookingManagementDto booking)
    {
        // Navigate to booking details page
        Navigation.NavigateTo($"/booking-details/{booking.Id}");
    }

    private async Task ConfirmBooking(BookingManagementDto booking)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirm Booking",
            $"Confirm booking #{booking.Id} for {booking.GuestName}?",
            yesText: "Confirm", cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                using var context = await DbContextFactory.CreateDbContextAsync();

                var bookingId = BookingId.Create(booking.Id);
                var dbBooking = await context.Bookings.FirstOrDefaultAsync(b => b.Id == bookingId);

                if (dbBooking == null)
                {
                    Snackbar.Add($"Booking #{booking.Id} not found", Severity.Error);
                    return;
                }

                // Use domain method to confirm booking
                dbBooking.Confirm();
                await context.SaveChangesAsync();

                // Update DTO
                booking.Status = "Confirmed";
                StateHasChanged();

                Console.WriteLine($"‚úÖ Booking #{booking.Id} confirmed successfully");
                Snackbar.Add($"Booking #{booking.Id} confirmed successfully", Severity.Success);
            }
            catch (DomainException ex)
            {
                Console.WriteLine($"‚ùå Domain error confirming booking: {ex.Message}");
                Snackbar.Add($"Cannot confirm booking: {ex.Message}", Severity.Error);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå Error confirming booking: {ex.Message}");
                Snackbar.Add($"Error confirming booking: {ex.Message}", Severity.Error);
            }
        }
    }

    private void EditBooking(BookingManagementDto booking)
    {
        // TODO: Open edit dialog for modifying booking details
        Snackbar.Add("Edit booking functionality coming soon", Severity.Info);
    }

    private async Task CancelBooking(BookingManagementDto booking)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Cancel Booking",
            $"Are you sure you want to cancel booking #{booking.Id}? This will notify the guest.",
            yesText: "Cancel Booking", cancelText: "Keep Booking");

        if (result == true)
        {
            try
            {
                using var context = await DbContextFactory.CreateDbContextAsync();

                var bookingId = BookingId.Create(booking.Id);
                var dbBooking = await context.Bookings.FirstOrDefaultAsync(b => b.Id == bookingId);

                if (dbBooking == null)
                {
                    Snackbar.Add($"Booking #{booking.Id} not found", Severity.Error);
                    return;
                }

                // Use domain method to cancel booking
                dbBooking.Cancel();
                await context.SaveChangesAsync();

                // Update DTO
                booking.Status = "Cancelled";
                StateHasChanged();

                Console.WriteLine($"‚úÖ Booking #{booking.Id} cancelled successfully");
                Snackbar.Add($"Booking #{booking.Id} cancelled successfully", Severity.Success);
            }
            catch (DomainException ex)
            {
                Console.WriteLine($"‚ùå Domain error cancelling booking: {ex.Message}");
                Snackbar.Add($"Cannot cancel booking: {ex.Message}", Severity.Error);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå Error cancelling booking: {ex.Message}");
                Snackbar.Add($"Error cancelling booking: {ex.Message}", Severity.Error);
            }
        }
    }

    private class BookingManagementDto
    {
        public int Id { get; set; }
        public string GuestName { get; set; } = string.Empty;
        public string GuestEmail { get; set; } = string.Empty;
        public string CampsiteName { get; set; } = string.Empty;
        public string AccommodationType { get; set; } = string.Empty;
        public string? SpotIdentifier { get; set; }
        public DateTime CheckIn { get; set; }
        public DateTime CheckOut { get; set; }
        public int NumberOfGuests { get; set; }
        public decimal TotalAmount { get; set; }
        public string Status { get; set; } = string.Empty;

        // Payment information
        public string? PaymentMethod { get; set; }
        public string? PaymentStatus { get; set; }
        public string? TransactionId { get; set; }
        public DateTime? PaymentDate { get; set; }

        /// <summary>
        /// Extracts just the number/identifier portion from SpotIdentifier.
        /// For example: "Glamping-1" becomes "1", "Cabin-3" becomes "3".
        /// </summary>
        public string? SpotNumber
        {
            get
            {
                if (string.IsNullOrEmpty(SpotIdentifier))
                    return null;

                // Try to extract just the number part after the last hyphen
                var lastHyphenIndex = SpotIdentifier.LastIndexOf('-');
                if (lastHyphenIndex >= 0 && lastHyphenIndex < SpotIdentifier.Length - 1)
                {
                    return SpotIdentifier.Substring(lastHyphenIndex + 1);
                }

                // If no hyphen, return the full identifier
                return SpotIdentifier;
            }
        }
    }
}

