@page "/admin/pricing"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin,Staff")]
@using CampsiteBooking.Components.Pages.Admin
@using Microsoft.AspNetCore.Authorization
@inherits PricingManagementBase

<PageTitle>Pricing Management - Campsite Booking</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <!-- Header -->
    <div class="mb-6">
        <MudText Typo="Typo.h3" GutterBottom="true">
            <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Class="mr-2" />
            Pricing Management
        </MudText>
        <MudText Typo="Typo.body1" Color="Color.Secondary">
            Configure accommodation base prices, purchase options, seasonal multipliers, and discounts
        </MudText>
    </div>

    <MudGrid>
        <!-- Campsite Selector -->
        <MudItem xs="12">
            <MudPaper Elevation="3" Class="pa-4">
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudSelect T="int"
                                  @bind-Value="_selectedCampsiteId"
                                  Label="Select Campsite"
                                  Variant="Variant.Outlined"
                                  AdornmentIcon="@Icons.Material.Filled.Cabin"
                                  AdornmentColor="Color.Primary">
                            @foreach (var campsite in _campsites)
                            {
                                <MudSelectItem T="int" Value="@campsite.Id">
                                    @campsite.Name (@campsite.City)
                                </MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudAlert Severity="Severity.Info" Dense="true">
                            <strong>@GetSelectedCampsiteName()</strong> -
                            Attractiveness: <MudChip T="string" Size="Size.Small" Color="@GetAttractivenessColor()">@GetSelectedCampsite()?.Attractiveness</MudChip>
                        </MudAlert>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <!-- Accommodation Types & Pricing -->
        <MudItem xs="12" md="6">
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Bed" Class="mr-2" />
                Accommodation Types & Pricing
            </MudText>

            @foreach (var accommodation in GetSelectedCampsitePricing())
            {
                <MudCard Elevation="2" Class="mb-3">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <div class="d-flex align-center justify-space-between">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@GetAccommodationIcon(accommodation.Type)" Class="mr-3" Color="Color.Primary" Size="Size.Large" />
                                    <div>
                                        <MudText Typo="Typo.h6">@accommodation.Type</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @accommodation.AvailableUnits units
                                        </MudText>
                                    </div>
                                </div>
                                <div>
                                    <MudChip T="string" Size="Size.Small" Color="@(accommodation.IsActive ? Color.Success : Color.Default)">
                                        @(accommodation.IsActive ? "Active" : "Inactive")
                                    </MudChip>
                                </div>
                            </div>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <!-- Pricing & Capacity Section -->
                        <MudText Typo="Typo.subtitle2" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Size="Size.Small" Class="mr-1" />
                            Base Pricing & Capacity
                        </MudText>
                        <MudDivider Class="mb-3" />
                        <MudGrid>
                            <MudItem xs="12" sm="6">
                                <MudNumericField @bind-Value="accommodation.Price"
                                                 Label="Price per Night"
                                                 Variant="Variant.Outlined"
                                                 Min="0m"
                                                 Format="N2"
                                                 Adornment="Adornment.Start"
                                                 AdornmentIcon="@Icons.Material.Filled.AttachMoney" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Save"
                                           OnClick="@(() => SaveAccommodationPricing(accommodation))"
                                           FullWidth="true"
                                           Style="height: 56px;">
                                    Save Pricing
                                </MudButton>
                            </MudItem>
                        </MudGrid>

                        <MudDivider Class="my-4" />
                        <MudText Typo="Typo.subtitle2" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Size="Size.Small" Class="mr-1" />
                            Accommodation Peripheral Purchases
                        </MudText>
                        <MudDivider Class="mb-3" />

                        @if (accommodation.AccommodationPeripheralPurchases != null && accommodation.AccommodationPeripheralPurchases.Any())
                        {
                            <MudTable Items="@accommodation.AccommodationPeripheralPurchases" Hover="true" Dense="true" Elevation="0" Class="mb-2">
                                <HeaderContent>
                                    <MudTh>Service</MudTh>
                                    <MudTh>Category</MudTh>
                                    <MudTh>Price</MudTh>
                                    <MudTh>Status</MudTh>
                                    <MudTh>Actions</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Service">
                                        <div class="d-flex align-center">
                                            <MudIcon Icon="@GetCategoryIcon(context.Category)" Size="Size.Small" Class="mr-2" Color="Color.Primary" />
                                            <div>
                                                <MudText Typo="Typo.body2"><strong>@context.Name</strong></MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Description</MudText>
                                            </div>
                                        </div>
                                    </MudTd>
                                    <MudTd DataLabel="Category">
                                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">
                                            @context.Category
                                        </MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Price">
                                        <MudText Typo="Typo.body2" Color="Color.Success">
                                            <strong>$@context.Price.ToString("N2")</strong>
                                        </MudText>
                                    </MudTd>
                                    <MudTd DataLabel="Status">
                                        <MudChip T="string" Size="Size.Small" Color="@(context.IsActive ? Color.Success : Color.Default)">
                                            @(context.IsActive ? "Active" : "Inactive")
                                        </MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Actions">
                                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                      Color="Color.Primary"
                                                      Size="Size.Small"
                                                      Title="Edit purchase option"
                                                      OnClick="@(() => EditAccommodationPeripheralPurchase(accommodation, context))" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                      Color="Color.Error"
                                                      Size="Size.Small"
                                                      Title="Delete purchase option"
                                                      OnClick="@(() => DeleteAccommodationPeripheralPurchase(accommodation, context))" />
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-2">
                                No peripheral purchases configured for this accommodation type.
                            </MudAlert>
                        }

                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Primary"
                                   Size="Size.Small"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   OnClick="@(() => AddAccommodationPeripheralPurchase(accommodation))">
                            Add Purchase
                        </MudButton>
                    </MudCardContent>
                </MudCard>
            }
        </MudItem>

        <!-- Campsite Peripheral Purchases -->
        <MudItem xs="12" md="6">
            <MudCard Elevation="3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Campsite Peripheral Purchases</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            Manage activities and services for @GetSelectedCampsiteName()
                        </MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" StartIcon="@Icons.Material.Filled.Add" OnClick="AddPeripheralPurchase">
                            Add Purchase
                        </MudButton>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudTable Items="@GetSelectedCampsitePeripheralPurchases()" Hover="true" Dense="true" Elevation="0">
                        <HeaderContent>
                            <MudTh>Activity/Service</MudTh>
                            <MudTh>Category</MudTh>
                            <MudTh>Price</MudTh>
                            <MudTh>Status</MudTh>
                            <MudTh>Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Activity/Service">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@GetCategoryIcon(context.Category)" Class="mr-3" Color="Color.Primary" />
                                    <div>
                                        <MudText><strong>@context.Name</strong></MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Description</MudText>
                                    </div>
                                </div>
                            </MudTd>
                            <MudTd DataLabel="Category">
                                <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">
                                    @context.Category
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="Price">
                                <MudText Typo="Typo.body1" Color="Color.Success">
                                    <strong>$@context.Price.ToString("N2")</strong>
                                </MudText>
                            </MudTd>
                            <MudTd DataLabel="Status">
                                <MudChip T="string" Size="Size.Small" Color="@(context.IsActive ? Color.Success : Color.Default)">
                                    @(context.IsActive ? "Active" : "Inactive")
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="Actions">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                              Color="Color.Primary"
                                              Size="Size.Small"
                                              Title="Edit purchase option"
                                              OnClick="@(() => EditPeripheralPurchase(context))" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                              Color="Color.Error"
                                              Size="Size.Small"
                                              Title="Delete purchase option"
                                              OnClick="@(() => DeletePeripheralPurchase(context))" />
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Seasonal Multipliers -->
        <MudItem xs="12" md="6">
            <MudCard Elevation="3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Seasonal Multipliers</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            Applies to all campsites
                        </MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                      Color="Color.Primary"
                                      OnClick="EditSeasonalPricing" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudList T="string" Dense="true">
                        @foreach (var season in _seasonalMultipliers)
                        {
                            <MudListItem T="string">
                                <div class="d-flex justify-space-between align-center" style="width: 100%;">
                                    <div>
                                        <MudText><strong>@season.Name</strong></MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@season.DateRange</MudText>
                                    </div>
                                    <MudChip T="string" Color="@GetSeasonColor(season.Name)">
                                        @season.Multiplier.ToString("P0")
                                    </MudChip>
                                </div>
                            </MudListItem>
                            <MudDivider />
                        }
                    </MudList>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Accommodation Summary Statistics -->
        <MudItem xs="12" md="6">
            <MudCard Elevation="3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Accommodation Summary</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            Overview for @GetSelectedCampsiteName()
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudGrid>
                        <MudItem xs="6">
                            <MudPaper Elevation="0" Class="pa-3 text-center" Style="background-color: #f5f5f5;">
                                <MudText Typo="Typo.h4" Color="Color.Primary">@GetTotalUnits()</MudText>
                                <MudText Typo="Typo.caption">Total Units</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="6">
                            <MudPaper Elevation="0" Class="pa-3 text-center" Style="background-color: #f5f5f5;">
                                <MudText Typo="Typo.h4" Color="Color.Success">@GetTotalCapacity()</MudText>
                                <MudText Typo="Typo.caption">Total Guest Capacity</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="6">
                            <MudPaper Elevation="0" Class="pa-3 text-center" Style="background-color: #f5f5f5;">
                                <MudText Typo="Typo.h4" Color="Color.Info">@GetAccommodationTypeCount()</MudText>
                                <MudText Typo="Typo.caption">Accommodation Types</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="6">
                            <MudPaper Elevation="0" Class="pa-3 text-center" Style="background-color: #f5f5f5;">
                                <MudText Typo="Typo.h4" Color="Color.Warning">$@GetAveragePrice().ToString("N0")</MudText>
                                <MudText Typo="Typo.caption">Avg. Price/Night</MudText>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Campsite Comparison Table -->
        <MudItem xs="12">
            <MudCard Elevation="3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Campsite Pricing Comparison</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            Compare base prices across all campsites - more attractive campsites have higher prices
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudTable Items="@_campsites" Hover="true" Dense="true" Elevation="0">
                        <HeaderContent>
                            <MudTh>Campsite</MudTh>
                            <MudTh>Region</MudTh>
                            <MudTh>Attractiveness</MudTh>
                            <MudTh>Cabin</MudTh>
                            <MudTh>Tent Site</MudTh>
                            <MudTh>Glamping</MudTh>
                            <MudTh>RV Spot</MudTh>
                            <MudTh>Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Campsite">
                                <MudText Typo="Typo.body2"><strong>@context.Name</strong></MudText>
                            </MudTd>
                            <MudTd DataLabel="City">
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@context.City</MudChip>
                            </MudTd>
                            <MudTd DataLabel="Attractiveness">
                                <MudChip T="string" Size="Size.Small" Color="@GetAttractivenessColor(context.Attractiveness)">
                                    @context.Attractiveness
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="Cabin">
                                <MudText Typo="Typo.body2" Color="Color.Success">
                                    $@context.Pricing.FirstOrDefault(p => p.Type == "Cabin")?.Price.ToString("N2")
                                </MudText>
                            </MudTd>
                            <MudTd DataLabel="Tent Site">
                                <MudText Typo="Typo.body2" Color="Color.Success">
                                    $@context.Pricing.FirstOrDefault(p => p.Type == "Tent Site")?.Price.ToString("N2")
                                </MudText>
                            </MudTd>
                            <MudTd DataLabel="Glamping">
                                <MudText Typo="Typo.body2" Color="Color.Success">
                                    $@context.Pricing.FirstOrDefault(p => p.Type == "Glamping")?.Price.ToString("N2")
                                </MudText>
                            </MudTd>
                            <MudTd DataLabel="RV Spot">
                                <MudText Typo="Typo.body2" Color="Color.Success">
                                    $@context.Pricing.FirstOrDefault(p => p.Type == "RV Spot")?.Price.ToString("N2")
                                </MudText>
                            </MudTd>
                            <MudTd DataLabel="Actions">
                                <MudButton Size="Size.Small"
                                          Variant="Variant.Outlined"
                                          Color="Color.Primary"
                                          OnClick="@(() => SelectCampsite(context.Id))">
                                    Edit Pricing
                                </MudButton>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Active Discounts -->
        <MudItem xs="12">
            <MudCard Elevation="3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Active Discounts & Promotions</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            Discount codes apply to all campsites
                        </MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="AddDiscount">
                            Add Discount
                        </MudButton>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudTable Items="@_discounts" Hover="true" Dense="true" Elevation="0">
                        <HeaderContent>
                            <MudTh>Code</MudTh>
                            <MudTh>Description</MudTh>
                            <MudTh>Type</MudTh>
                            <MudTh>Value</MudTh>
                            <MudTh>Valid From</MudTh>
                            <MudTh>Valid Until</MudTh>
                            <MudTh>Uses</MudTh>
                            <MudTh>Status</MudTh>
                            <MudTh>Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Code">
                                <MudText Typo="Typo.body2"><strong>@context.Code</strong></MudText>
                            </MudTd>
                            <MudTd DataLabel="Description">@context.Description</MudTd>
                            <MudTd DataLabel="Type">
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@context.Type</MudChip>
                            </MudTd>
                            <MudTd DataLabel="Value">
                                @if (context.Type == "Percentage")
                                {
                                    <MudText>@context.Value%</MudText>
                                }
                                else
                                {
                                    <MudText>$@context.Value</MudText>
                                }
                            </MudTd>
                            <MudTd DataLabel="Valid From">@context.ValidFrom.ToString("MMM dd, yyyy")</MudTd>
                            <MudTd DataLabel="Valid Until">@context.ValidUntil.ToString("MMM dd, yyyy")</MudTd>
                            <MudTd DataLabel="Uses">@context.UsedCount / @(context.MaxUses == 0 ? "∞" : context.MaxUses.ToString())</MudTd>
                            <MudTd DataLabel="Status">
                                <MudChip T="string" Size="Size.Small" Color="@(context.IsActive ? Color.Success : Color.Default)">
                                    @(context.IsActive ? "Active" : "Inactive")
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="Actions">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="@(() => EditDiscount(context))" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => DeleteDiscount(context))" />
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Pricing Calculator Preview -->
        <MudItem xs="12">
            <MudCard Elevation="3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Pricing Calculator Preview</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            Calculate estimated price for @GetSelectedCampsiteName()
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudGrid>
                        <MudItem xs="12" md="3">
                            <MudSelect T="string" @bind-Value="_previewAccommodationType" Label="Accommodation Type" Variant="Variant.Outlined">
                                <MudSelectItem T="string" Value="@("Cabin")">Cabin</MudSelectItem>
                                <MudSelectItem T="string" Value="@("Tent Site")">Tent Site</MudSelectItem>
                                <MudSelectItem T="string" Value="@("Glamping")">Glamping</MudSelectItem>
                                <MudSelectItem T="string" Value="@("RV Spot")">RV Spot</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" md="3">
                            <MudSelect T="string" @bind-Value="_previewSeason" Label="Season" Variant="Variant.Outlined">
                                <MudSelectItem T="string" Value="@("High Season")">High Season</MudSelectItem>
                                <MudSelectItem T="string" Value="@("Medium Season")">Medium Season</MudSelectItem>
                                <MudSelectItem T="string" Value="@("Low Season")">Low Season</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" md="3">
                            <MudNumericField @bind-Value="_previewNights" Label="Number of Nights" Variant="Variant.Outlined" Min="1" />
                        </MudItem>
                        <MudItem xs="12" md="3">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" OnClick="CalculatePreview">
                                Calculate
                            </MudButton>
                        </MudItem>
                        <MudItem xs="12">
                            <MudAlert Severity="Severity.Info" Dense="true">
                                <MudText Typo="Typo.body1">
                                    <strong>Estimated Total:</strong> $@_previewTotal.ToString("N2")
                                </MudText>
                                <MudText Typo="Typo.caption">
                                    Base: $@_previewBase.ToString("N2") × @_previewMultiplier.ToString("P0") × @_previewNights nights
                                </MudText>
                            </MudAlert>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>
