@page "/admin/campsites"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin,Staff")]
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IDbContextFactory<CampsiteBooking.Data.CampsiteBookingDbContext> DbContextFactory
@using CampsiteBooking.Data
@using CampsiteBooking.Models
@using CampsiteBooking.Models.ValueObjects
@using CampsiteBooking.Models.DTOs
@using CampsiteBooking.Models.Common
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization

<PageTitle>Campsite Management - Campsite Booking</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <!-- Header -->
    <div class="d-flex justify-space-between align-center mb-6">
        <div>
            <MudText Typo="Typo.h3" GutterBottom="true">
                <MudIcon Icon="@Icons.Material.Filled.Terrain" Class="mr-2" />
                Campsite Management
            </MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary">
                Manage campsites and their accommodation types
            </MudText>
        </div>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Add"
                   OnClick="OpenAddCampsiteDialog">
            Add New Campsite
        </MudButton>
    </div>

    <!-- Campsite Search/Selector -->
    <MudPaper Elevation="3" Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="8">
                <MudAutocomplete T="CampsiteManagementDto"
                                 Value="_selectedCampsite"
                                 Label="Search Campsite"
                                 Variant="Variant.Outlined"
                                 SearchFunc="@SearchCampsites"
                                 ToStringFunc="@(c => c?.Name ?? "")"
                                 ValueChanged="@OnCampsiteSelected"
                                 Clearable="true"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.Search"
                                 Immediate="true"
                                 ResetValueOnEmptyText="true"
                                 CoerceText="false"
                                 CoerceValue="false">
                    <ItemTemplate Context="campsite">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Landscape" Class="mr-2" Color="Color.Primary" Size="Size.Small" />
                            <div>
                                <MudText Typo="Typo.body2"><strong>@campsite.Name</strong></MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@campsite.City - @campsite.Description</MudText>
                            </div>
                        </div>
                    </ItemTemplate>
                </MudAutocomplete>
            </MudItem>
            <MudItem xs="12" md="4" Class="d-flex align-center justify-space-between">
                <div>
                    @if (_selectedCampsite != null)
                    {
                        <MudChip T="string" Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success">
                            Selected: @_selectedCampsite.Name
                        </MudChip>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                            No campsite selected
                        </MudText>
                    }
                </div>
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Info"
                           Size="Size.Small"
                           OnClick="QueryDatabaseState"
                           StartIcon="@Icons.Material.Filled.BugReport">
                    Debug DB
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Campsite Details Section -->
    @if (_selectedCampsite != null)
    {
        <MudPaper Elevation="3" Class="pa-4 mb-4">
            <div class="d-flex justify-space-between align-center mb-4">
                <MudText Typo="Typo.h5">
                    <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
                    Campsite Details
                </MudText>
            </div>

            <MudGrid>
                <!-- Description Section -->
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle1" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Small" Class="mr-1" />
                        Description
                    </MudText>
                    <MudTextField @bind-Value="_selectedCampsite.Description"
                                  Label="Campsite Description"
                                  Variant="Variant.Outlined"
                                  Lines="4"
                                  Placeholder="Enter a detailed description of the campsite..."
                                  HelperText="Provide information about the campsite location, features, and attractions" />
                </MudItem>

                <!-- Location Coordinates Section -->
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle1" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-1" />
                        Latitude
                    </MudText>
                    <MudNumericField @bind-Value="_selectedCampsite.Latitude"
                                     Label="Latitude"
                                     Variant="Variant.Outlined"
                                     Min="-90"
                                     Max="90"
                                     Step="0.0001"
                                     Placeholder="e.g., 55.6761"
                                     HelperText="Latitude coordinate (-90 to 90)" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle1" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-1" />
                        Longitude
                    </MudText>
                    <MudNumericField @bind-Value="_selectedCampsite.Longitude"
                                     Label="Longitude"
                                     Variant="Variant.Outlined"
                                     Min="-180"
                                     Max="180"
                                     Step="0.0001"
                                     Placeholder="e.g., 12.5683"
                                     HelperText="Longitude coordinate (-180 to 180)" />
                </MudItem>

                <!-- Main Image Section -->
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle1" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Image" Size="Size.Small" Class="mr-1" />
                        Main Image
                    </MudText>
                    <MudTextField @bind-Value="_selectedCampsite.MapImageUrl"
                                  Label="Main Image URL"
                                  Variant="Variant.Outlined"
                                  Placeholder="https://example.com/campsite-image.jpg"
                                  HelperText="URL for the main campsite image" />
                    @if (!string.IsNullOrWhiteSpace(_selectedCampsite.MapImageUrl))
                    {
                        <MudImage Src="@_selectedCampsite.MapImageUrl"
                                  Alt="Campsite Main Image"
                                  Class="mt-2 rounded"
                                  ObjectFit="ObjectFit.Cover"
                                  Height="200"
                                  Style="width: 100%;" />
                    }
                </MudItem>

                <!-- Gallery Images Section -->
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle1" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.PhotoLibrary" Size="Size.Small" Class="mr-1" />
                        Image Gallery
                    </MudText>
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.PhotoLibrary"
                               FullWidth="true"
                               OnClick="@(() => OpenCampsiteGalleryDialog(_selectedCampsite))">
                        Manage Photo Gallery (@(_selectedCampsite.GalleryImages?.Count ?? 0) images)
                    </MudButton>
                </MudItem>

                <!-- Active Status Section -->
                <MudItem xs="12">
                    <MudDivider Class="my-4" />
                    <MudText Typo="Typo.subtitle1" Class="mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.ToggleOn" Size="Size.Small" Class="mr-1" />
                        Campsite Status
                    </MudText>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudPaper Elevation="1" Class="pa-4" Style="@($"background-color: {(_selectedCampsite.IsActive ? "#e8f5e9" : "#fff3e0")};")">
                        <div class="d-flex align-center justify-space-between">
                            <div>
                                <MudText Typo="Typo.subtitle1">
                                    <MudIcon Icon="@(_selectedCampsite.IsActive ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)"
                                             Color="@(_selectedCampsite.IsActive ? Color.Success : Color.Warning)"
                                             Size="Size.Small" Class="mr-1" />
                                    @(_selectedCampsite.IsActive ? "Active" : "Inactive (Off Season)")
                                </MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @(_selectedCampsite.IsActive
                                        ? "Campsite is visible in search results and available for booking"
                                        : "Campsite is hidden from search and shown as 'Off Season' on information page")
                                </MudText>
                            </div>
                            <MudSwitch @bind-Value="_selectedCampsite.IsActive"
                                       Color="Color.Success"
                                       UnCheckedColor="Color.Warning"
                                       Label="@(_selectedCampsite.IsActive ? "Active" : "Inactive")" />
                        </div>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" md="6">
                    @if (!_selectedCampsite.IsActive)
                    {
                        <MudPaper Elevation="1" Class="pa-4" Style="background-color: #e3f2fd;">
                            <MudText Typo="Typo.subtitle2" Class="mb-2">
                                <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Size="Size.Small" Class="mr-1" />
                                Season Opening Date
                            </MudText>
                            <MudDatePicker @bind-Date="_selectedCampsite.SeasonOpeningDate"
                                           Label="Expected Opening Date"
                                           Variant="Variant.Outlined"
                                           Placeholder="Select opening date"
                                           MinDate="DateTime.Today"
                                           HelperText="When will this campsite open for the new season?" />
                        </MudPaper>
                    }
                    else
                    {
                        <MudPaper Elevation="1" Class="pa-4" Style="background-color: #f5f5f5;">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                                Season opening date is only applicable when the campsite is set to inactive/off-season.
                            </MudText>
                        </MudPaper>
                    }
                </MudItem>

                <!-- Save Button -->
                <MudItem xs="12" Class="d-flex justify-end">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Success"
                               StartIcon="@Icons.Material.Filled.Save"
                               OnClick="@(() => SaveCampsiteDetails(_selectedCampsite))">
                        Save Campsite Details
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>
    }

    <!-- Accommodation Types Tree View -->
    @if (_selectedCampsite != null)
    {
        <MudPaper Elevation="3" Class="pa-4">
            <div class="d-flex justify-space-between align-center mb-4">
                <MudText Typo="Typo.h5">
                    <MudIcon Icon="@Icons.Material.Filled.Cabin" Class="mr-2" />
                    Accommodation Types - @_selectedCampsite.Name
                </MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                           OnClick="OpenAddAccommodationTypeDialog">
                    Add Accommodation Type
                </MudButton>
            </div>

            @if (_loading)
            {
                <div class="d-flex justify-center pa-8">
                    <MudProgressCircular Indeterminate="true" />
                </div>
            }
            else if (!_accommodationTypes.Any())
            {
                <MudAlert Severity="Severity.Info" Class="my-4">
                    No accommodation types found for this campsite. Click "Add Accommodation Type" to create one.
                </MudAlert>
            }
            else
            {
                <!-- Grid of Accommodation Type Cards -->
                <MudGrid>
                    @foreach (var accType in _accommodationTypes.OrderBy(a => a.Type))
                    {
                        <MudItem xs="12">
                            <MudCard Elevation="2" Class="mb-3">
                                <!-- Card Header -->
                                <MudCardHeader>
                                    <CardHeaderContent>
                                        <div class="d-flex align-center justify-space-between" style="width: 100%;">
                                            <div class="d-flex align-center">
                                                <MudIcon Icon="@GetAccommodationIcon(accType)" Class="mr-3" Color="Color.Primary" Size="Size.Large" />
                                                <div>
                                                    <MudText Typo="Typo.h5">@accType.Type</MudText>
                                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                        @accType.Spots.Count spots ‚Ä¢ Max @accType.MaxCapacity guests ‚Ä¢ @accType.PricePerNight.ToString("C") per night
                                                    </MudText>
                                                </div>
                                            </div>
                                            <div class="d-flex align-center gap-2">
                                                <MudTooltip Text="@(accType.IsActive ? "Click to deactivate - will hide from search results" : "Click to activate - will show in search results")">
                                                    <MudSwitch @bind-Value="accType.IsActive"
                                                               Color="Color.Success"
                                                               UnCheckedColor="Color.Default"
                                                               Size="Size.Small"
                                                               Label="@(accType.IsActive ? "Active" : "Inactive")"
                                                               LabelPosition="LabelPosition.Start" />
                                                </MudTooltip>
                                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                                               OnClick="@(() => DeleteAccommodationType(accType))" />
                                            </div>
                                        </div>
                                    </CardHeaderContent>
                                </MudCardHeader>

                                <!-- Card Content -->
                                <MudCardContent>
                                    <MudGrid>
                                            <!-- Description Section -->
                                            <MudItem xs="12">
                                                <MudText Typo="Typo.subtitle1" Class="mb-2">
                                                    <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Small" Class="mr-1" />
                                                    Description
                                                </MudText>
                                                <MudTextField @bind-Value="accType.Description"
                                                              Label="Description"
                                                              Variant="Variant.Outlined"
                                                              Lines="3"
                                                              FullWidth="true" />
                                            </MudItem>

                                            <!-- Icon Selection -->
                                            <MudItem xs="12">
                                                <MudText Typo="Typo.subtitle1" Class="mb-2">
                                                    <MudIcon Icon="@Icons.Material.Filled.EmojiSymbols" Size="Size.Small" Class="mr-1" />
                                                    Icon
                                                </MudText>
                                                <MudGrid>
                                                    <MudItem xs="12" sm="6">
                                                        <MudSelect T="string" @bind-Value="accType.Icon"
                                                                   Label="Select Icon"
                                                                   Variant="Variant.Outlined"
                                                                   Clearable="true"
                                                                   HelperText="Choose an icon to represent this accommodation type">
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.Cabin">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.Cabin" Class="mr-2" />
                                                                    <span>Cabin</span>
                                                                </div>
                                                            </MudSelectItem>
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.Landscape">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.Landscape" Class="mr-2" />
                                                                    <span>Tent / Landscape</span>
                                                                </div>
                                                            </MudSelectItem>
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.RvHookup">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.RvHookup" Class="mr-2" />
                                                                    <span>RV / Caravan</span>
                                                                </div>
                                                            </MudSelectItem>
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.NightShelter">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.NightShelter" Class="mr-2" />
                                                                    <span>Glamping / Shelter</span>
                                                                </div>
                                                            </MudSelectItem>
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.Home">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.Home" Class="mr-2" />
                                                                    <span>Home / House</span>
                                                                </div>
                                                            </MudSelectItem>
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.Cottage">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.Cottage" Class="mr-2" />
                                                                    <span>Cottage</span>
                                                                </div>
                                                            </MudSelectItem>
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.House">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.House" Class="mr-2" />
                                                                    <span>House</span>
                                                                </div>
                                                            </MudSelectItem>
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.Villa">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.Villa" Class="mr-2" />
                                                                    <span>Villa</span>
                                                                </div>
                                                            </MudSelectItem>
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.Apartment">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.Apartment" Class="mr-2" />
                                                                    <span>Apartment</span>
                                                                </div>
                                                            </MudSelectItem>
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.Bungalow">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.Bungalow" Class="mr-2" />
                                                                    <span>Bungalow</span>
                                                                </div>
                                                            </MudSelectItem>
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.Houseboat">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.Houseboat" Class="mr-2" />
                                                                    <span>Houseboat</span>
                                                                </div>
                                                            </MudSelectItem>
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.Park">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.Park" Class="mr-2" />
                                                                    <span>Park</span>
                                                                </div>
                                                            </MudSelectItem>
                                                        </MudSelect>
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6" Class="d-flex align-center">
                                                        <MudAlert Severity="Severity.Info" Dense="true" Class="flex-grow-1">
                                                            Current icon: <MudIcon Icon="@GetAccommodationIcon(accType)" Class="ml-2" />
                                                        </MudAlert>
                                                    </MudItem>
                                                </MudGrid>
                                            </MudItem>

                                            <!-- Spots Management -->
                                            <MudItem xs="12">
                                                <div class="d-flex justify-space-between align-center mb-2">
                                                    <MudText Typo="Typo.subtitle1">
                                                        <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-1" />
                                                        Accommodation Spots (@accType.Spots.Count)
                                                    </MudText>
                                                    <MudButton Variant="Variant.Filled"
                                                               Color="Color.Primary"
                                                               Size="Size.Small"
                                                               StartIcon="@Icons.Material.Filled.Add"
                                                               OnClick="@(() => AddSpot(accType))">
                                                        Add Spot
                                                    </MudButton>
                                                </div>

                                                @if (accType.Spots.Any())
                                                {
                                                    <MudPaper Elevation="0" Class="pa-3" Style="background-color: #f5f5f5; max-height: 400px; overflow-y: auto;">
                                                        <MudGrid Spacing="2">
                                                            @foreach (var spot in accType.Spots.OrderBy(s => int.TryParse(s.SpotNumber, out var num) ? num : 0))
                                                            {
                                                                <MudItem xs="12" sm="6" md="4">
                                                                    <MudPaper Elevation="2" Class="pa-3">
                                                                        <div class="d-flex justify-space-between align-center mb-2">
                                                                            <MudText Typo="Typo.subtitle2">
                                                                                <MudIcon Icon="@Icons.Material.Filled.Place" Size="Size.Small" Color="Color.Primary" />
                                                                                Spot #@spot.SpotNumber
                                                                            </MudText>
                                                                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                                                           Size="Size.Small"
                                                                                           Color="Color.Error"
                                                                                           OnClick="@(() => RemoveSpot(accType, spot))" />
                                                                        </div>
                                                                        <MudNumericField @bind-Value="spot.Latitude"
                                                                                         Label="Latitude"
                                                                                         Variant="Variant.Outlined"
                                                                                         Margin="Margin.Dense"
                                                                                         Min="-90"
                                                                                         Max="90"
                                                                                         Step="0.0001"
                                                                                         Format="F4" />
                                                                        <MudNumericField @bind-Value="spot.Longitude"
                                                                                         Label="Longitude"
                                                                                         Variant="Variant.Outlined"
                                                                                         Margin="Margin.Dense"
                                                                                         Min="-180"
                                                                                         Max="180"
                                                                                         Step="0.0001"
                                                                                         Format="F4"
                                                                                         Class="mt-2" />
                                                                        <MudSelect @bind-Value="spot.Status"
                                                                                   Label="Status"
                                                                                   Variant="Variant.Outlined"
                                                                                   Margin="Margin.Dense"
                                                                                   Class="mt-2">
                                                                            <MudSelectItem Value="@("Available")">Available</MudSelectItem>
                                                                            <MudSelectItem Value="@("Occupied")">Occupied</MudSelectItem>
                                                                            <MudSelectItem Value="@("Maintenance")">Maintenance</MudSelectItem>
                                                                        </MudSelect>
                                                                    </MudPaper>
                                                                </MudItem>
                                                            }
                                                        </MudGrid>
                                                    </MudPaper>
                                                }
                                                else
                                                {
                                                    <MudAlert Severity="Severity.Info" Dense="true">
                                                        No spots added yet. Click "Add Spot" to create the first spot.
                                                    </MudAlert>
                                                }
                                            </MudItem>

                                            <!-- Pricing & Capacity -->
                                            <MudItem xs="12">
                                                <MudText Typo="Typo.subtitle1" Class="mb-2">
                                                    <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Size="Size.Small" Class="mr-1" />
                                                    Pricing & Capacity
                                                </MudText>
                                                <MudGrid>
                                                    <MudItem xs="12" sm="4">
                                                        <MudNumericField @bind-Value="accType.PricePerNight"
                                                                         Label="Price per Night"
                                                                         Variant="Variant.Outlined"
                                                                         Min="0"
                                                                         Format="C2" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="4">
                                                        <MudNumericField @bind-Value="accType.MaxCapacity"
                                                                         Label="Max Guests"
                                                                         Variant="Variant.Outlined"
                                                                         Min="1" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="4">
                                                        <MudNumericField T="decimal?" @bind-Value="accType.AreaSquareMeters"
                                                                         Label="Area (m¬≤)"
                                                                         Variant="Variant.Outlined"
                                                                         Min="0m"
                                                                         Step="0.1m"
                                                                         Format="N1"
                                                                         Clearable="true"
                                                                         HelperText="Optional - size in square meters" />
                                                    </MudItem>
                                                </MudGrid>
                                            </MudItem>

                                            <!-- Pictures Section -->
                                            <MudItem xs="12">
                                                <MudText Typo="Typo.subtitle1" Class="mb-2">
                                                    <MudIcon Icon="@Icons.Material.Filled.Image" Size="Size.Small" Class="mr-1" />
                                                    Pictures
                                                </MudText>
                                                <MudGrid>
                                                    <MudItem xs="12">
                                                        <MudTextField @bind-Value="accType.ImageUrl"
                                                                      Label="Main Image URL"
                                                                      Variant="Variant.Outlined"
                                                                      FullWidth="true" />
                                                    </MudItem>
                                                    @if (!string.IsNullOrWhiteSpace(accType.ImageUrl))
                                                    {
                                                        <MudItem xs="12">
                                                            <MudImage Src="@accType.ImageUrl" Alt="@accType.Type"
                                                                      Height="200" ObjectFit="ObjectFit.Cover" Class="rounded" />
                                                        </MudItem>
                                                    }
                                                    <MudItem xs="12">
                                                        <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                                                                   StartIcon="@Icons.Material.Filled.AddPhotoAlternate"
                                                                   OnClick="@(() => ManageGallery(accType))">
                                                            Manage Photo Gallery (@accType.GalleryImages.Count images)
                                                        </MudButton>
                                                    </MudItem>
                                                </MudGrid>
                                            </MudItem>

                                            <!-- Amenities Section -->
                                            <MudItem xs="12">
                                                <MudText Typo="Typo.subtitle1" Class="mb-2">
                                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Class="mr-1" />
                                                    Amenities
                                                </MudText>
                                                <MudGrid>
                                                    @foreach (var amenity in _availableAmenities)
                                                    {
                                                        <MudItem xs="12" sm="6" md="4">
                                                            <MudCheckBox Value="@GetAmenityValue(accType, amenity.Name)"
                                                                         Label="@amenity.DisplayName"
                                                                         ValueChanged="@((bool val) => UpdateAmenity(accType, amenity.Name, val))" />
                                                        </MudItem>
                                                    }
                                                </MudGrid>
                                            </MudItem>

                                            <!-- Save Button -->
                                            <MudItem xs="12">
                                                <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                                           StartIcon="@Icons.Material.Filled.Save"
                                                           OnClick="@(() => SaveAccommodationType(accType))">
                                                    Save Changes
                                                </MudButton>
                                            </MudItem>
                                        </MudGrid>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>
            }
        </MudPaper>
    }
</MudContainer>

@code {
    private CampsiteManagementDto? _selectedCampsite;
    private List<CampsiteManagementDto> _campsites = new();
    private List<AccommodationTypeDto> _accommodationTypes = new();
    private List<AmenityLookup> _availableAmenities = new();
    private bool _loading = false;

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("üîµ OnInitializedAsync called");
        await LoadCampsites();
        await LoadAvailableAmenities();
        Console.WriteLine($"üîµ Loaded {_campsites.Count} campsites");

        // Debug: Query database to see what's actually stored
        await QueryDatabaseState();

        // Auto-select the first campsite to show data immediately
        if (_campsites.Any())
        {
            _selectedCampsite = _campsites.First();
            Console.WriteLine($"üîµ Auto-selected campsite: {_selectedCampsite.Name} (ID: {_selectedCampsite.Id})");
            await LoadAccommodationTypes(_selectedCampsite.Id);
        }
        else
        {
            Console.WriteLine("üî¥ No campsites found to auto-select");
        }
    }

    private async Task QueryDatabaseState()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            var allAccommodationTypes = await context.AccommodationTypes
                .OrderBy(a => a.CampsiteId.Value)
                .ThenBy(a => a.Type)
                .ToListAsync();

            Console.WriteLine($"\nüìä ========== DATABASE STATE - ALL ACCOMMODATION TYPES ==========");
            Console.WriteLine($"   Total: {allAccommodationTypes.Count} accommodation types");
            Console.WriteLine();

            var groupedByCampsite = allAccommodationTypes.GroupBy(a => a.CampsiteId.Value);
            foreach (var group in groupedByCampsite)
            {
                Console.WriteLine($"   üèïÔ∏è  Campsite ID: {group.Key}");
                foreach (var accType in group)
                {
                    var amenities = accType.GetAmenitiesList();
                    Console.WriteLine($"      - {accType.Type} (ID: {accType.Id.Value})");
                    Console.WriteLine($"        Amenities ({amenities.Count}): [{string.Join(", ", amenities)}]");
                    if (amenities.Count == 0)
                    {
                        Console.WriteLine($"        ‚ö†Ô∏è  NO AMENITIES!");
                    }
                }
                Console.WriteLine();
            }
            Console.WriteLine($"üìä ========== END DATABASE STATE ==========\n");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error querying database state: {ex.Message}");
        }
    }

    private async Task LoadCampsites()
    {
        _loading = true;

        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            var campsites = await context.Campsites.ToListAsync();

            _campsites = campsites.Select(c => new CampsiteManagementDto
            {
                Id = c.Id.Value,
                Name = c.Name ?? "Unknown",
                StreetAddress = c.StreetAddress ?? "",
                City = c.City ?? "",
                PostalCode = c.PostalCode ?? "",
                Description = c.Description ?? "",
                Attractiveness = c.Attractiveness ?? "",
                PhoneNumber = c.PhoneNumber ?? "",
                Email = c.Email?.Value,
                WebsiteUrl = c.WebsiteUrl ?? "",
                TotalSpots = 0, // TODO: Calculate from accommodation spots
                AvailableSpots = 0, // TODO: Calculate from bookings
                Latitude = c.Latitude,
                Longitude = c.Longitude,
                AccommodationTypes = new List<string>(), // TODO: Load from accommodation types
                Amenities = new List<string>(), // TODO: Parse from campsite amenities
                IsActive = c.IsActive,
                SeasonOpeningDate = c.SeasonOpeningDate,
                MapImageUrl = "", // TODO: Get from campsite photos
                GalleryImages = new List<string>(), // TODO: Load from campsite photos
                InactivePeriods = new List<InactivePeriodDto>()
            }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading campsites: {ex.Message}");
            _campsites = new List<CampsiteManagementDto>();
        }
        finally
        {
            _loading = false;
        }

        _loading = false;
    }

    private async Task LoadAvailableAmenities()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            _availableAmenities = await context.AmenityLookups
                .Where(a => a.IsActive)
                .OrderBy(a => a.SortOrder)
                .ToListAsync();

            Console.WriteLine($"‚úÖ Loaded {_availableAmenities.Count} available amenities from lookup table");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error loading amenities: {ex.Message}");
            _availableAmenities = new List<AmenityLookup>();
        }
    }

    private async Task<IEnumerable<CampsiteManagementDto>> SearchCampsites(string value, CancellationToken token)
    {
        await Task.Delay(100, token); // Simulate API delay

        if (string.IsNullOrWhiteSpace(value))
            return _campsites;

        return _campsites.Where(c =>
            c.Name.Contains(value, StringComparison.OrdinalIgnoreCase) ||
            c.City.Contains(value, StringComparison.OrdinalIgnoreCase) ||
            c.Description.Contains(value, StringComparison.OrdinalIgnoreCase));
    }

    private async Task LoadAccommodationTypes(int campsiteId)
    {
        _loading = true;
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load ALL accommodation types from database first (client-side evaluation)
            var allEntities = await context.AccommodationTypes.ToListAsync();

            Console.WriteLine($"üìä Loaded {allEntities.Count} total accommodation types from database");

            // Filter by campsite ID in memory (since CampsiteId is a private field)
            var entities = allEntities.Where(a => a.CampsiteId?.Value == campsiteId).ToList();

            Console.WriteLine($"üìä Found {entities.Count} accommodation types for campsite {campsiteId}");

            // Convert entities to DTOs with null-safe access
            _accommodationTypes = entities.Select(e => new AccommodationTypeDto
            {
                Id = e.Id?.Value ?? 0,
                CampsiteId = e.CampsiteId?.Value ?? 0,
                Type = e.Type ?? "",
                Description = e.Description ?? "",
                MaxCapacity = e.MaxCapacity,
                PricePerNight = e.BasePrice?.Amount ?? 0m,
                ImageUrl = e.ImageUrl ?? "",
                Icon = "", // Default icon, can be customized later
                Amenities = e.GetAmenitiesList(), // Load from database
                Spots = new List<AccommodationSpotDto>(), // TODO: Load spots from database
                GalleryImages = new List<string>(),
                IsActive = e.IsActive,
                AvailableUnits = e.AvailableUnits,
                UnitNamingPrefix = e.UnitNamingPrefix ?? "",
                UnitNamingPattern = e.UnitNamingPattern ?? "Numbers",
                AreaSquareMeters = e.AreaSquareMeters
            }).ToList();

            Console.WriteLine($"‚úÖ Loaded {_accommodationTypes.Count} accommodation types for campsite {campsiteId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error loading accommodation types: {ex.Message}");
            Console.WriteLine($"   Stack trace: {ex.StackTrace}");
            if (ex.InnerException != null)
            {
                Console.WriteLine($"   Inner exception: {ex.InnerException.Message}");
            }
            Snackbar.Add($"Error loading accommodation types: {ex.Message}", Severity.Error);
            _accommodationTypes = new List<AccommodationTypeDto>();
        }
        finally
        {
            _loading = false;
        }
    }

    private async void OnCampsiteSelected(CampsiteManagementDto? campsite)
    {
        _selectedCampsite = campsite;
        if (campsite != null)
        {
            await LoadAccommodationTypes(campsite.Id);
        }
        else
        {
            _accommodationTypes.Clear();
        }
        StateHasChanged();
    }

    private async Task SaveCampsiteDetails(CampsiteManagementDto campsite)
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            var campsiteId = CampsiteId.Create(campsite.Id);
            var dbCampsite = await context.Campsites.FirstOrDefaultAsync(c => c.Id == campsiteId);

            if (dbCampsite == null)
            {
                Snackbar.Add($"Campsite not found", Severity.Error);
                return;
            }

            // Parse email if provided
            Email? email = null;
            if (!string.IsNullOrWhiteSpace(campsite.Email))
            {
                try
                {
                    email = Email.Create(campsite.Email);
                }
                catch
                {
                    Snackbar.Add("Invalid email format", Severity.Error);
                    return;
                }
            }

            // Use domain method to update campsite information
            dbCampsite.UpdateInformation(
                campsite.Name,
                campsite.StreetAddress,
                campsite.City,
                campsite.PostalCode,
                campsite.Description,
                campsite.Attractiveness,
                campsite.PhoneNumber ?? string.Empty,
                email,
                campsite.WebsiteUrl ?? string.Empty
            );

            // Update active status and season opening date
            dbCampsite.SetActiveStatus(campsite.IsActive, campsite.SeasonOpeningDate);

            await context.SaveChangesAsync();

            Console.WriteLine($"‚úÖ Campsite '{campsite.Name}' updated successfully");
            Snackbar.Add($"Campsite details for '{campsite.Name}' saved successfully!", Severity.Success);
        }
        catch (DomainException ex)
        {
            Console.WriteLine($"‚ùå Domain error saving campsite: {ex.Message}");
            Snackbar.Add($"Cannot save campsite: {ex.Message}", Severity.Error);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error saving campsite: {ex.Message}");
            Snackbar.Add($"Error saving campsite: {ex.Message}", Severity.Error);
        }
    }

    private async Task OpenCampsiteGalleryDialog(CampsiteManagementDto campsite)
    {
        var parameters = new DialogParameters
        {
            ["Title"] = $"Photo Gallery - {campsite.Name}",
            ["GalleryImages"] = campsite.GalleryImages ?? new List<string>()
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<ManageGalleryDialog>("Manage Photo Gallery", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is List<string> updatedGallery)
        {
            campsite.GalleryImages = updatedGallery;
            Snackbar.Add("Photo gallery updated successfully!", Severity.Success);
            StateHasChanged();
        }
    }

    private async Task OpenAddCampsiteDialog()
    {
        try
        {
            var parameters = new DialogParameters
            {
                ["Campsite"] = new CampsiteFormDto
                {
                    Attractiveness = "Medium",
                    IsActive = true,
                    EstablishedYear = DateTime.Now.Year
                },
                ["IsEdit"] = false
            };

            var options = new DialogOptions
            {
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                CloseButton = true
            };

            var dialog = await DialogService.ShowAsync<AddCampsiteDialog>("Add New Campsite", parameters, options);
            var result = await dialog.Result;

            if (!result.Canceled && result.Data is CampsiteFormDto newCampsite)
            {
                // Save to database
                await SaveCampsiteToDatabase(newCampsite);

                // Reload campsites list
                await LoadCampsites();

                // Auto-select the newly created campsite
                var createdCampsite = _campsites.FirstOrDefault(c => c.Name == newCampsite.Name);
                if (createdCampsite != null)
                {
                    _selectedCampsite = createdCampsite;
                    await LoadAccommodationTypes(createdCampsite.Id);
                }

                Snackbar.Add($"Campsite '{newCampsite.Name}' created successfully!", Severity.Success);
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error adding campsite: {ex.Message}");
            Snackbar.Add($"Error adding campsite: {ex.Message}", Severity.Error);
        }
    }

    private async Task SaveCampsiteToDatabase(CampsiteFormDto dto)
    {
        try
        {
            Console.WriteLine($"üíæ Saving campsite to database:");
            Console.WriteLine($"   - Name: {dto.Name}");
            Console.WriteLine($"   - Address: {dto.StreetAddress}, {dto.City} {dto.PostalCode}");
            Console.WriteLine($"   - Latitude: {dto.Latitude}");
            Console.WriteLine($"   - Longitude: {dto.Longitude}");

            using var context = await DbContextFactory.CreateDbContextAsync();

            // Parse email if provided
            Email? email = null;
            if (!string.IsNullOrWhiteSpace(dto.Email))
            {
                try
                {
                    email = Email.Create(dto.Email);
                }
                catch
                {
                    throw new ArgumentException("Invalid email format");
                }
            }

            // Create the campsite using the domain factory method
            var campsite = Campsite.Create(
                name: dto.Name,
                streetAddress: dto.StreetAddress,
                city: dto.City,
                postalCode: dto.PostalCode,
                latitude: dto.Latitude,
                longitude: dto.Longitude,
                establishedYear: dto.EstablishedYear,
                description: dto.Description,
                attractiveness: dto.Attractiveness,
                phoneNumber: dto.PhoneNumber ?? string.Empty,
                email: email,
                websiteUrl: dto.WebsiteUrl ?? string.Empty
            );

            // Set active status
            if (!dto.IsActive)
            {
                campsite.Deactivate();
            }

            context.Campsites.Add(campsite);
            await context.SaveChangesAsync();

            // Update DTO with the generated ID
            dto.Id = campsite.Id.Value;

            Console.WriteLine($"‚úÖ Successfully saved campsite with ID: {dto.Id}");
        }
        catch (DomainException ex)
        {
            Console.WriteLine($"‚ùå Domain error saving campsite: {ex.Message}");
            throw;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error saving campsite: {ex.Message}");
            throw;
        }
    }

    private async Task OpenAddAccommodationTypeDialog()
    {
        try
        {
            var parameters = new DialogParameters
            {
                ["CampsiteName"] = _selectedCampsite!.Name,
                ["AccommodationType"] = new AccommodationTypeDto { CampsiteId = _selectedCampsite.Id },
                ["IsEdit"] = false
            };

            var options = new DialogOptions
            {
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                CloseButton = true
            };

            var dialog = await DialogService.ShowAsync<CampsiteAccommodationDialog>("Add Accommodation Type", parameters, options);
            var result = await dialog.Result;

            if (!result.Canceled && result.Data is AccommodationTypeDto newAccType)
            {
                // Save to database
                await SaveAccommodationTypeToDatabase(newAccType);

                // Reload accommodation types from database to get the latest data
                await LoadAccommodationTypes(_selectedCampsite!.Id);

                Snackbar.Add($"Accommodation type '{newAccType.Type}' added successfully!", Severity.Success);
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error adding accommodation type: {ex.Message}", Severity.Error);
        }
    }

    private async Task SaveAccommodationTypeToDatabase(AccommodationTypeDto dto)
    {
        try
        {
            Console.WriteLine($"üíæ Saving accommodation type to database:");
            Console.WriteLine($"   - Type: {dto.Type}");
            Console.WriteLine($"   - CampsiteId: {dto.CampsiteId}");
            Console.WriteLine($"   - MaxCapacity: {dto.MaxCapacity}");
            Console.WriteLine($"   - PricePerNight: {dto.PricePerNight}");
            Console.WriteLine($"   - AvailableUnits: {dto.AvailableUnits}");

            if (dto.CampsiteId <= 0)
            {
                throw new ArgumentException($"Invalid campsite ID: {dto.CampsiteId}");
            }

            using var context = await DbContextFactory.CreateDbContextAsync();

            // Create the entity using the factory method
            var entity = AccommodationType.Create(
                CampsiteId.Create(dto.CampsiteId),
                dto.Type,
                dto.MaxCapacity,
                Money.Create(dto.PricePerNight, "DKK"),
                dto.AvailableUnits,
                dto.Description,
                dto.ImageUrl
            );

            // Set amenities if provided
            if (dto.Amenities != null && dto.Amenities.Any())
            {
                entity.UpdateAmenities(dto.Amenities);
            }

            // Set unit naming configuration
            entity.UpdateUnitNaming(dto.UnitNamingPrefix, dto.UnitNamingPattern);

            // Set area in square meters if provided
            if (dto.AreaSquareMeters.HasValue)
            {
                entity.UpdateAreaSquareMeters(dto.AreaSquareMeters);
            }

            context.AccommodationTypes.Add(entity);

            // CRITICAL FIX: Explicitly mark the private fields as modified for new entities
            // This ensures EF Core tracks these fields properly
            if (dto.Amenities != null && dto.Amenities.Any())
            {
                context.Entry(entity).Property("_amenities").IsModified = true;
            }
            context.Entry(entity).Property("_unitNamingPrefix").IsModified = true;
            context.Entry(entity).Property("_unitNamingPattern").IsModified = true;
            if (dto.AreaSquareMeters.HasValue)
            {
                context.Entry(entity).Property("_areaSquareMeters").IsModified = true;
            }

            await context.SaveChangesAsync();

            // Update the DTO with the generated ID
            dto.Id = entity.Id.Value;

            Console.WriteLine($"‚úÖ Successfully saved accommodation type with ID: {dto.Id}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error saving to database: {ex.Message}");
            Console.WriteLine($"   Stack trace: {ex.StackTrace}");
            throw;
        }
    }

    private List<AccommodationSpotDto> GenerateSpots(AccommodationTypeDto accType)
    {
        var spots = new List<AccommodationSpotDto>();
        var baseLatitude = _selectedCampsite?.Latitude ?? 55.6761;
        var baseLongitude = _selectedCampsite?.Longitude ?? 12.5683;

        for (int i = 0; i < accType.AvailableUnits; i++)
        {
            string spotName = accType.UnitNamingPattern switch
            {
                "Letters" => $"{(char)('A' + i)}",
                "Numbers" => $"{i + 1}",
                "PrefixNumbers" => $"{accType.UnitNamingPrefix}{i + 1}",
                _ => $"{i + 1}"
            };

            spots.Add(new AccommodationSpotDto
            {
                Id = i + 1,
                Name = spotName,
                IsAvailable = true,
                Latitude = baseLatitude + (i * 0.0001),
                Longitude = baseLongitude + (i * 0.0001)
            });
        }

        return spots;
    }

    private async Task SaveAccommodationType(AccommodationTypeDto accType)
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            var accommodationTypeId = AccommodationTypeId.Create(accType.Id);
            var dbAccommodationType = await context.AccommodationTypes
                .FirstOrDefaultAsync(a => a.Id == accommodationTypeId);

            if (dbAccommodationType == null)
            {
                Snackbar.Add($"Accommodation type not found", Severity.Error);
                return;
            }

            Console.WriteLine($"üîç SaveAccommodationType - Before update:");
            Console.WriteLine($"   DTO Amenities: [{string.Join(", ", accType.Amenities)}]");
            Console.WriteLine($"   DB Amenities: [{string.Join(", ", dbAccommodationType.GetAmenitiesList())}]");

            // Update information using domain method
            dbAccommodationType.UpdateInformation(accType.Description, accType.ImageUrl);

            // IMPORTANT: Also update amenities from the DTO
            dbAccommodationType.UpdateAmenities(accType.Amenities);

            // Update unit naming configuration
            dbAccommodationType.UpdateUnitNaming(accType.UnitNamingPrefix, accType.UnitNamingPattern);

            // Update area in square meters (optional field)
            dbAccommodationType.UpdateAreaSquareMeters(accType.AreaSquareMeters);

            // Update active status - handle the exception for already active/inactive
            if (accType.IsActive && !dbAccommodationType.IsActive)
            {
                dbAccommodationType.Activate();
            }
            else if (!accType.IsActive && dbAccommodationType.IsActive)
            {
                dbAccommodationType.Deactivate();
            }

            // CRITICAL FIX: Explicitly mark the private fields as modified
            // EF Core doesn't automatically detect changes to private fields
            context.Entry(dbAccommodationType).Property("_amenities").IsModified = true;
            context.Entry(dbAccommodationType).Property("_unitNamingPrefix").IsModified = true;
            context.Entry(dbAccommodationType).Property("_unitNamingPattern").IsModified = true;
            context.Entry(dbAccommodationType).Property("_areaSquareMeters").IsModified = true;
            context.Entry(dbAccommodationType).Property("_isActive").IsModified = true;

            await context.SaveChangesAsync();

            Console.WriteLine($"üîç SaveAccommodationType - After update:");
            Console.WriteLine($"   DB Amenities: [{string.Join(", ", dbAccommodationType.GetAmenitiesList())}]");
            Console.WriteLine($"‚úÖ Accommodation type '{accType.Type}' updated successfully");
            Snackbar.Add($"Changes to '{accType.Type}' saved successfully!", Severity.Success);

            // Reload accommodation types to ensure UI is in sync with database
            if (_selectedCampsite != null)
            {
                await LoadAccommodationTypes(_selectedCampsite.Id);
            }
        }
        catch (DomainException ex)
        {
            Console.WriteLine($"‚ùå Domain error saving accommodation type: {ex.Message}");
            Snackbar.Add($"Cannot save accommodation type: {ex.Message}", Severity.Error);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error saving accommodation type: {ex.Message}");
            Snackbar.Add($"Error saving accommodation type: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteAccommodationType(AccommodationTypeDto accType)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirm Delete",
            $"Are you sure you want to delete the accommodation type '{accType.Type}'? This action cannot be undone.",
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                using var context = await DbContextFactory.CreateDbContextAsync();

                var accommodationTypeId = AccommodationTypeId.Create(accType.Id);
                var dbAccommodationType = await context.AccommodationTypes
                    .FirstOrDefaultAsync(a => a.Id == accommodationTypeId);

                if (dbAccommodationType == null)
                {
                    Snackbar.Add($"Accommodation type not found", Severity.Error);
                    return;
                }

                // Remove from database
                context.AccommodationTypes.Remove(dbAccommodationType);
                await context.SaveChangesAsync();

                // Remove from in-memory list
                _accommodationTypes.Remove(accType);

                Console.WriteLine($"‚úÖ Accommodation type '{accType.Type}' deleted successfully");
                Snackbar.Add($"Accommodation type '{accType.Type}' deleted successfully!", Severity.Success);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå Error deleting accommodation type: {ex.Message}");
                Snackbar.Add($"Error deleting accommodation type: {ex.Message}", Severity.Error);
            }
        }
    }

    private void ManageGallery(AccommodationTypeDto accType)
    {
        // This would open a dialog to manage the photo gallery
        Snackbar.Add("Photo gallery management coming soon!", Severity.Info);
    }

    private bool GetAmenityValue(AccommodationTypeDto accType, string amenity)
    {
        return accType.Amenities.Contains(amenity);
    }

    private async Task UpdateAmenity(AccommodationTypeDto accType, string amenity, bool value)
    {
        try
        {
            // Update the DTO
            if (value && !accType.Amenities.Contains(amenity))
            {
                accType.Amenities.Add(amenity);
            }
            else if (!value && accType.Amenities.Contains(amenity))
            {
                accType.Amenities.Remove(amenity);
            }

            // Save to database
            using var context = await DbContextFactory.CreateDbContextAsync();

            var accommodationTypeId = AccommodationTypeId.Create(accType.Id);
            var entity = await context.AccommodationTypes.FirstOrDefaultAsync(a => a.Id == accommodationTypeId);

            if (entity == null)
            {
                Console.WriteLine($"‚ùå AccommodationType with ID {accType.Id} not found");
                Snackbar.Add("Error: Accommodation type not found", Severity.Error);
                return;
            }

            Console.WriteLine($"üîç Before UpdateAmenities - DB Amenities: [{string.Join(", ", entity.GetAmenitiesList())}]");
            Console.WriteLine($"üîç DTO Amenities to save: [{string.Join(", ", accType.Amenities)}]");

            // Update amenities using domain method
            entity.UpdateAmenities(accType.Amenities);

            Console.WriteLine($"üîç After UpdateAmenities - DB Amenities: [{string.Join(", ", entity.GetAmenitiesList())}]");

            // CRITICAL FIX: Explicitly mark the _amenities field as modified
            // EF Core doesn't automatically detect changes to private fields
            context.Entry(entity).Property("_amenities").IsModified = true;

            Console.WriteLine($"üîç Marked _amenities as modified, saving changes...");

            await context.SaveChangesAsync();

            Console.WriteLine($"‚úÖ Updated amenities for {accType.Type}: {string.Join(", ", accType.Amenities)}");
            Snackbar.Add($"Amenity '{amenity}' {(value ? "added" : "removed")} successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error updating amenity: {ex.Message}");
            Snackbar.Add($"Error updating amenity: {ex.Message}", Severity.Error);
        }
    }

    private void AddSpot(AccommodationTypeDto accType)
    {
        // Get the next spot number
        var nextNumber = 1;
        if (accType.Spots.Any())
        {
            var maxNumber = accType.Spots
                .Select(s => int.TryParse(s.SpotNumber, out var num) ? num : 0)
                .Max();
            nextNumber = maxNumber + 1;
        }

        // Use campsite coordinates as default, with small offset for each spot
        var baseLatitude = _selectedCampsite?.Latitude ?? 56.2639;
        var baseLongitude = _selectedCampsite?.Longitude ?? 10.4515;

        // Add small offset to spread spots around the campsite (0.0001 degrees ‚âà 11 meters)
        var offset = (nextNumber - 1) * 0.0001;

        var newSpot = new AccommodationSpotDto
        {
            Id = 0, // Will be assigned by backend
            SpotNumber = nextNumber.ToString(),
            Latitude = baseLatitude + offset,
            Longitude = baseLongitude + offset,
            Status = "Available"
        };

        accType.Spots.Add(newSpot);
        Snackbar.Add($"Spot #{nextNumber} added to {accType.Type}", Severity.Success);
        StateHasChanged();
    }

    private async Task RemoveSpot(AccommodationTypeDto accType, AccommodationSpotDto spot)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirm Delete",
            $"Are you sure you want to remove Spot #{spot.SpotNumber}? This action cannot be undone.",
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                using var context = await DbContextFactory.CreateDbContextAsync();

                var accommodationSpotId = AccommodationSpotId.Create(spot.Id);
                var dbSpot = await context.AccommodationSpots
                    .FirstOrDefaultAsync(s => s.Id == accommodationSpotId);

                if (dbSpot != null)
                {
                    // Remove from database
                    context.AccommodationSpots.Remove(dbSpot);
                    await context.SaveChangesAsync();
                    Console.WriteLine($"‚úÖ Spot #{spot.SpotNumber} deleted from database");
                }

                // Remove from in-memory list
                accType.Spots.Remove(spot);
                Snackbar.Add($"Spot #{spot.SpotNumber} removed from {accType.Type}", Severity.Success);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå Error removing spot: {ex.Message}");
                Snackbar.Add($"Error removing spot: {ex.Message}", Severity.Error);
            }
        }
    }

    private List<AccommodationSpotDto> GenerateSampleSpots(int count, double baseLatitude, double baseLongitude, double baseOffset)
    {
        var spots = new List<AccommodationSpotDto>();
        for (int i = 1; i <= count; i++)
        {
            // Create a grid-like pattern for spots
            var row = (i - 1) / 5; // 5 spots per row
            var col = (i - 1) % 5;

            spots.Add(new AccommodationSpotDto
            {
                Id = i,
                SpotNumber = i.ToString(),
                Latitude = baseLatitude + baseOffset + (row * 0.0001),
                Longitude = baseLongitude + baseOffset + (col * 0.0001),
                Status = "Available"
            });
        }
        return spots;
    }



    private string GetAccommodationIcon(AccommodationTypeDto accType)
    {
        // Use custom icon if set, otherwise fall back to type-based icon
        if (!string.IsNullOrEmpty(accType.Icon))
            return accType.Icon;

        return accType.Type.ToLower() switch
        {
            "cabin" => Icons.Material.Filled.Cabin,
            "tent site" or "tent" => Icons.Material.Filled.Landscape,
            "rv spot" or "rv" or "caravan" => Icons.Material.Filled.RvHookup,
            "glamping" => Icons.Material.Filled.NightShelter,
            _ => Icons.Material.Filled.Home
        };
    }



    // DTOs
    private class CampsiteManagementDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string StreetAddress { get; set; } = string.Empty;
        public string City { get; set; } = string.Empty;
        public string PostalCode { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string Attractiveness { get; set; } = string.Empty;
        public string? PhoneNumber { get; set; }
        public string? Email { get; set; }
        public string? WebsiteUrl { get; set; }
        public int TotalSpots { get; set; }
        public int AvailableSpots { get; set; }
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public List<string> AccommodationTypes { get; set; } = new();
        public List<string> Amenities { get; set; } = new();
        public bool IsActive { get; set; }
        public DateTime? SeasonOpeningDate { get; set; }
        public string MapImageUrl { get; set; } = string.Empty;
        public List<string> GalleryImages { get; set; } = new();
        public List<InactivePeriodDto> InactivePeriods { get; set; } = new();
    }

    private class InactivePeriodDto
    {
        public int Id { get; set; }
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public string Reason { get; set; } = string.Empty;
        public string Type { get; set; } = "EntireCampsite"; // "EntireCampsite" or "SpecificSpots"
        public List<string> AffectedSpotIds { get; set; } = new();
    }
}
