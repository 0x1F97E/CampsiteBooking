@page "/admin/campsites"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin,Staff")]
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IDbContextFactory<CampsiteBooking.Data.CampsiteBookingDbContext> DbContextFactory
@inject AuthenticationStateProvider AuthenticationStateProvider
@using CampsiteBooking.Data
@using CampsiteBooking.Models
@using CampsiteBooking.Models.ValueObjects
@using CampsiteBooking.Models.DTOs
@using CampsiteBooking.Models.Common
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims

<PageTitle>Campsite Management - Campsite Booking</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <!-- Header -->
    <div class="d-flex justify-space-between align-center mb-6">
        <div>
            <MudText Typo="Typo.h3" GutterBottom="true">
                <MudIcon Icon="@Icons.Material.Filled.Terrain" Class="mr-2" />
                Campsite Management
            </MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary">
                Manage campsites and their accommodation types@(_isAdmin ? "" : " (Read-only)")
            </MudText>
        </div>
        @if (_isAdmin)
        {
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="OpenAddCampsiteDialog">
                Add New Campsite
            </MudButton>
        }
    </div>

    <!-- Campsite Search/Filter Bar -->
    <MudPaper Elevation="3" Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="_searchText"
                              Label="Search Campsites"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Immediate="true"
                              Clearable="true"
                              Placeholder="Filter by name, city, or description..." />
            </MudItem>
            <MudItem xs="12" md="6" Class="d-flex align-center justify-end gap-2">
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.UnfoldMore"
                           OnClick="ExpandAllCampsites">
                    Expand All
                </MudButton>
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Secondary"
                           Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.UnfoldLess"
                           OnClick="CollapseAllCampsites">
                    Collapse All
                </MudButton>
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Info"
                           Size="Size.Small"
                           OnClick="QueryDatabaseState"
                           StartIcon="@Icons.Material.Filled.BugReport">
                    Debug DB
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Collapsible Campsite Panels -->
    <MudExpansionPanels MultiExpansion="true" @ref="_expansionPanels">
        @foreach (var campsite in FilteredCampsites)
        {
            <MudExpansionPanel @key="campsite.Id" IsExpanded="@IsCampsiteExpanded(campsite.Id)" IsExpandedChanged="@((bool expanded) => SetCampsiteExpanded(campsite.Id, expanded))">
                <TitleContent>
                    <div class="d-flex align-center justify-space-between" style="width: 100%;">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Terrain" Class="mr-3" Color="Color.Primary" />
                            <div>
                                <MudText Typo="Typo.h6">@campsite.Name</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    <MudIcon Icon="@Icons.Material.Filled.LocationCity" Size="Size.Small" Class="mr-1" />
                                    @campsite.City
                                </MudText>
                            </div>
                        </div>
                        <div class="d-flex align-center gap-2" @onclick:stopPropagation="true">
                            <MudChip T="string" Size="Size.Small"
                                     Color="@(campsite.IsActive ? Color.Success : Color.Warning)"
                                     Icon="@(campsite.IsActive ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)">
                                @(campsite.IsActive ? "Active" : "Off Season")
                            </MudChip>
                            @if (_isAdmin)
                            {
                                <MudTooltip Text="Edit Campsite">
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                   Size="Size.Small"
                                                   Color="Color.Primary"
                                                   OnClick="@(() => OpenEditCampsiteDialog(campsite))" />
                                </MudTooltip>
                                <MudTooltip Text="Delete Campsite">
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                   Size="Size.Small"
                                                   Color="Color.Error"
                                                   OnClick="@(() => DeleteCampsite(campsite))" />
                                </MudTooltip>
                            }
                        </div>
                    </div>
                </TitleContent>
                <ChildContent>
                    <!-- Expanded Campsite Details -->
                    <MudGrid Class="pa-2">
                        <!-- Description Section -->
                        <MudItem xs="12">
                            <MudText Typo="Typo.subtitle1" Class="mb-2">
                                <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Small" Class="mr-1" />
                                Description
                            </MudText>
                            <MudTextField @bind-Value="campsite.Description"
                                          Label="Campsite Description"
                                          Variant="Variant.Outlined"
                                          Lines="3"
                                          ReadOnly="@(!_isAdmin)"
                                          Placeholder="Enter a detailed description of the campsite..." />
                        </MudItem>

                        <!-- Contact Information -->
                        <MudItem xs="12">
                            <MudDivider Class="my-2" />
                            <MudText Typo="Typo.subtitle1" Class="mb-2">
                                <MudIcon Icon="@Icons.Material.Filled.ContactPhone" Size="Size.Small" Class="mr-1" />
                                Contact Information
                            </MudText>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField Value="@campsite.Email"
                                          Label="Email"
                                          Variant="Variant.Outlined"
                                          ReadOnly="true"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Email" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField Value="@campsite.PhoneNumber"
                                          Label="Phone"
                                          Variant="Variant.Outlined"
                                          ReadOnly="true"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Phone" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField Value="@campsite.WebsiteUrl"
                                          Label="Website"
                                          Variant="Variant.Outlined"
                                          ReadOnly="true"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Language" />
                        </MudItem>

                        <!-- Address Details -->
                        <MudItem xs="12">
                            <MudDivider Class="my-2" />
                            <MudText Typo="Typo.subtitle1" Class="mb-2">
                                <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-1" />
                                Address Details
                            </MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField Value="@campsite.StreetAddress"
                                          Label="Street Address"
                                          Variant="Variant.Outlined"
                                          ReadOnly="true" />
                        </MudItem>
                        <MudItem xs="12" md="3">
                            <MudTextField Value="@campsite.City"
                                          Label="City"
                                          Variant="Variant.Outlined"
                                          ReadOnly="true" />
                        </MudItem>
                        <MudItem xs="12" md="3">
                            <MudTextField Value="@campsite.PostalCode"
                                          Label="Postal Code"
                                          Variant="Variant.Outlined"
                                          ReadOnly="true" />
                        </MudItem>

                        <!-- Coordinates -->
                        <MudItem xs="12" md="6">
                            <MudNumericField @bind-Value="campsite.Latitude"
                                             Label="Latitude"
                                             Variant="Variant.Outlined"
                                             Min="-90"
                                             Max="90"
                                             Step="0.0001"
                                             ReadOnly="@(!_isAdmin)"
                                             Format="F4" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudNumericField @bind-Value="campsite.Longitude"
                                             Label="Longitude"
                                             Variant="Variant.Outlined"
                                             Min="-180"
                                             Max="180"
                                             Step="0.0001"
                                             ReadOnly="@(!_isAdmin)"
                                             Format="F4" />
                        </MudItem>

                        <!-- Additional Details -->
                        <MudItem xs="12">
                            <MudDivider Class="my-2" />
                            <MudText Typo="Typo.subtitle1" Class="mb-2">
                                <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                                Additional Details
                            </MudText>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField Value="@campsite.Attractiveness"
                                          Label="Attractiveness"
                                          Variant="Variant.Outlined"
                                          ReadOnly="true" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField Value="@(campsite.SeasonOpeningDate?.ToString("dd MMM yyyy") ?? "Not set")"
                                          Label="Season Opening Date"
                                          Variant="Variant.Outlined"
                                          ReadOnly="true" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudPaper Elevation="1" Class="pa-3" Style="@($"background-color: {(campsite.IsActive ? "#e8f5e9" : "#fff3e0")};")">
                                <div class="d-flex align-center justify-space-between">
                                    <MudText Typo="Typo.body2">
                                        <MudIcon Icon="@(campsite.IsActive ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)"
                                                 Color="@(campsite.IsActive ? Color.Success : Color.Warning)"
                                                 Size="Size.Small" Class="mr-1" />
                                        @(campsite.IsActive ? "Active" : "Off Season")
                                    </MudText>
                                    @if (_isAdmin)
                                    {
                                        <MudSwitch @bind-Value="campsite.IsActive"
                                                   Color="Color.Success"
                                                   UnCheckedColor="Color.Warning"
                                                   Size="Size.Small" />
                                    }
                                </div>
                            </MudPaper>
                        </MudItem>

                        <!-- Gallery and Actions -->
                        <MudItem xs="12">
                            <MudDivider Class="my-2" />
                        </MudItem>
                        <MudItem xs="12" Class="d-flex gap-2 flex-wrap">
                            @if (_isAdmin)
                            {
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.PhotoLibrary"
                                           OnClick="@(() => OpenCampsiteGalleryDialog(campsite))">
                                    Photo Gallery (@(campsite.GalleryImages?.Count ?? 0))
                                </MudButton>
                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Success"
                                           StartIcon="@Icons.Material.Filled.Save"
                                           OnClick="@(() => SaveCampsiteDetails(campsite))">
                                    Save Changes
                                </MudButton>
                            }
                        </MudItem>

                        <!-- Nested Accommodation Types Section -->
                        <MudItem xs="12">
                            <MudDivider Class="my-3" />
                            <MudExpansionPanels MultiExpansion="true">
                                <MudExpansionPanel IsExpanded="@IsAccommodationSectionExpanded(campsite.Id)"
                                                   IsExpandedChanged="@((bool expanded) => SetAccommodationSectionExpanded(campsite.Id, expanded))">
                                    <TitleContent>
                                        <div class="d-flex align-center justify-space-between" style="width: 100%;">
                                            <div class="d-flex align-center">
                                                <MudIcon Icon="@Icons.Material.Filled.Cabin" Class="mr-2" Color="Color.Info" />
                                                <MudText Typo="Typo.subtitle1">
                                                    Accommodation Types (@GetAccommodationTypesForCampsite(campsite.Id).Count)
                                                </MudText>
                                            </div>
                                            @if (_isAdmin)
                                            {
                                                <div @onclick:stopPropagation="true">
                                                    <MudButton Variant="Variant.Filled"
                                                               Color="Color.Primary"
                                                               Size="Size.Small"
                                                               StartIcon="@Icons.Material.Filled.Add"
                                                               OnClick="@(() => OpenAddAccommodationTypeDialogForCampsite(campsite.Id))">
                                                        Add Type
                                                    </MudButton>
                                                </div>
                                            }
                                        </div>
                                    </TitleContent>
                                    <ChildContent>
                                        @{
                                            var accommodationTypes = GetAccommodationTypesForCampsite(campsite.Id);
                                        }
                                        @if (!accommodationTypes.Any())
                                        {
                                            <MudAlert Severity="Severity.Info" Class="my-2">
                                                No accommodation types defined for this campsite.
                                                @if (_isAdmin)
                                                {
                                                    <span> Click "Add Type" to create one.</span>
                                                }
                                            </MudAlert>
                                        }
                                        else
                                        {
                                            <MudExpansionPanels MultiExpansion="true" Class="mt-2">
                                                @foreach (var accType in accommodationTypes)
                                                {
                                                    <MudExpansionPanel @key="accType.Id"
                                                                       IsExpanded="@IsAccommodationTypeExpanded(accType.Id)"
                                                                       IsExpandedChanged="@((bool expanded) => SetAccommodationTypeExpanded(accType.Id, expanded))">
                                                        <TitleContent>
                                                            <div class="d-flex align-center justify-space-between" style="width: 100%;">
                                                                <div class="d-flex align-center gap-3">
                                                                    <MudIcon Icon="@Icons.Material.Filled.Hotel" Size="Size.Small" />
                                                                    <MudText Typo="Typo.body1"><strong>@accType.Type</strong></MudText>
                                                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary">
                                                                        @accType.PricePerNight.ToString("C") / night
                                                                    </MudChip>
                                                                    <MudChip T="string" Size="Size.Small" Color="Color.Secondary">
                                                                        Max @accType.MaxCapacity guests
                                                                    </MudChip>
                                                                    <MudChip T="string" Size="Size.Small" Color="Color.Info">
                                                                        @accType.Spots.Count units
                                                                    </MudChip>
                                                                </div>
                                                                <div class="d-flex align-center gap-2" @onclick:stopPropagation="true">
                                                                    <MudSwitch T="bool" @bind-Value="accType.IsActive"
                                                                               Color="Color.Success"
                                                                               Label="@(accType.IsActive ? "Active" : "Inactive")"
                                                                               Disabled="@(!_isAdmin)" />
                                                                    @if (_isAdmin)
                                                                    {
                                                                        <MudTooltip Text="Delete Accommodation Type">
                                                                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                                                           Size="Size.Small"
                                                                                           Color="Color.Error"
                                                                                           OnClick="@(() => DeleteAccommodationType(accType))" />
                                                                        </MudTooltip>
                                                                    }
                                                                </div>
                                                            </div>
                                                        </TitleContent>
                                                        <ChildContent>
                                                            <!-- Accommodation Type Details -->
                                                            <MudGrid Class="pa-2">
                                                                <!-- Basic Info -->
                                                                <MudItem xs="12" md="6">
                                                                    <MudTextField @bind-Value="accType.Type"
                                                                                  Label="Type Name"
                                                                                  Variant="Variant.Outlined"
                                                                                  ReadOnly="@(!_isAdmin)" />
                                                                </MudItem>
                                                                <MudItem xs="12" md="6">
                                                                    <MudNumericField @bind-Value="accType.PricePerNight"
                                                                                     Label="Price per Night (DKK)"
                                                                                     Variant="Variant.Outlined"
                                                                                     Min="0"
                                                                                     ReadOnly="@(!_isAdmin)" />
                                                                </MudItem>
                                                                <MudItem xs="12">
                                                                    <MudTextField @bind-Value="accType.Description"
                                                                                  Label="Description"
                                                                                  Variant="Variant.Outlined"
                                                                                  Lines="2"
                                                                                  ReadOnly="@(!_isAdmin)" />
                                                                </MudItem>
                                                                <MudItem xs="6" md="3">
                                                                    <MudNumericField @bind-Value="accType.MaxCapacity"
                                                                                     Label="Max Capacity"
                                                                                     Variant="Variant.Outlined"
                                                                                     Min="1"
                                                                                     ReadOnly="@(!_isAdmin)" />
                                                                </MudItem>
                                                                <MudItem xs="6" md="3">
                                                                    <MudNumericField @bind-Value="accType.AvailableUnits"
                                                                                     Label="Available Units"
                                                                                     Variant="Variant.Outlined"
                                                                                     Min="0"
                                                                                     ReadOnly="@(!_isAdmin)" />
                                                                </MudItem>
                                                                <MudItem xs="6" md="3">
                                                                    <MudNumericField @bind-Value="accType.AreaSquareMeters"
                                                                                     Label="Area (mÂ²)"
                                                                                     Variant="Variant.Outlined"
                                                                                     Min="0"
                                                                                     ReadOnly="@(!_isAdmin)" />
                                                                </MudItem>
                                                                <MudItem xs="6" md="3">
                                                                    <MudTextField @bind-Value="accType.UnitNamingPrefix"
                                                                                  Label="Unit Prefix"
                                                                                  Variant="Variant.Outlined"
                                                                                  Placeholder="e.g., Cabin, Tent"
                                                                                  ReadOnly="@(!_isAdmin)" />
                                                                </MudItem>

                                                                <!-- Spots Section -->
                                                                <MudItem xs="12">
                                                                    <MudDivider Class="my-2" />
                                                                    <div class="d-flex justify-space-between align-center mb-2">
                                                                        <MudText Typo="Typo.subtitle1">
                                                                            <MudIcon Icon="@Icons.Material.Filled.Place" Size="Size.Small" Class="mr-1" />
                                                                            Spots/Units (@accType.Spots.Count)
                                                                        </MudText>
                                                                        @if (_isAdmin)
                                                                        {
                                                                            <MudButton Variant="Variant.Outlined"
                                                                                       Color="Color.Primary"
                                                                                       Size="Size.Small"
                                                                                       StartIcon="@Icons.Material.Filled.Add"
                                                                                       OnClick="@(() => AddSpotForCampsite(accType, campsite))">
                                                                                Add Spot
                                                                            </MudButton>
                                                                        }
                                                                    </div>
                                                                    @if (accType.Spots.Any())
                                                                    {
                                                                        <MudGrid>
                                                                            @foreach (var spot in accType.Spots)
                                                                            {
                                                                                <MudItem xs="12" sm="6" md="4">
                                                                                    <MudCard Outlined="true" Class="pa-2">
                                                                                        <div class="d-flex justify-space-between align-center">
                                                                                            <MudText Typo="Typo.body2">
                                                                                                <strong>@spot.SpotNumber</strong>
                                                                                            </MudText>
                                                                                            <div class="d-flex align-center gap-1">
                                                                                                <MudSwitch T="bool" @bind-Value="spot.IsUnderMaintenance"
                                                                                                           Color="Color.Warning"
                                                                                                           Size="Size.Small"
                                                                                                           Label="@(spot.IsUnderMaintenance ? "Maintenance" : "")"
                                                                                                           Disabled="@(!_isAdmin)" />
                                                                                                @if (_isAdmin)
                                                                                                {
                                                                                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                                                                                   Size="Size.Small"
                                                                                                                   Color="Color.Error"
                                                                                                                   OnClick="@(() => RemoveSpotFromType(accType, spot))" />
                                                                                                }
                                                                                            </div>
                                                                                        </div>
                                                                                        <div class="d-flex gap-2 mt-2">
                                                                                            <MudNumericField T="double" @bind-Value="spot.Latitude"
                                                                                                             Label="Lat"
                                                                                                             Variant="Variant.Outlined"
                                                                                                             Margin="Margin.Dense"
                                                                                                             Min="-90"
                                                                                                             Max="90"
                                                                                                             Step="0.00001"
                                                                                                             Format="F5"
                                                                                                             ReadOnly="@(!_isAdmin)"
                                                                                                             Style="flex: 1;" />
                                                                                            <MudNumericField T="double" @bind-Value="spot.Longitude"
                                                                                                             Label="Lng"
                                                                                                             Variant="Variant.Outlined"
                                                                                                             Margin="Margin.Dense"
                                                                                                             Min="-180"
                                                                                                             Max="180"
                                                                                                             Step="0.00001"
                                                                                                             Format="F5"
                                                                                                             ReadOnly="@(!_isAdmin)"
                                                                                                             Style="flex: 1;" />
                                                                                        </div>
                                                                                    </MudCard>
                                                                                </MudItem>
                                                                            }
                                                                        </MudGrid>
                                                                    }
                                                                    else
                                                                    {
                                                                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                                            No spots defined yet.
                                                                        </MudText>
                                                                    }
                                                                </MudItem>

                                                                <!-- Amenities Section -->
                                                                <MudItem xs="12">
                                                                    <MudDivider Class="my-2" />
                                                                    <MudText Typo="Typo.subtitle1" Class="mb-2">
                                                                        <MudIcon Icon="@Icons.Material.Filled.Star" Size="Size.Small" Class="mr-1" />
                                                                        Amenities
                                                                    </MudText>
                                                                    <MudSelect T="string" Label="Select Amenities"
                                                                               MultiSelection="true"
                                                                               SelectedValues="@(accType.Amenities)"
                                                                               SelectedValuesChanged="@((IEnumerable<string> values) => UpdateAmenitiesForType(accType, values))"
                                                                               Variant="Variant.Outlined"
                                                                               Disabled="@(!_isAdmin)">
                                                                        @foreach (var amenity in _availableAmenities)
                                                                        {
                                                                            <MudSelectItem T="string" Value="@amenity.Name">
                                                                                <MudIcon Icon="@(string.IsNullOrEmpty(amenity.IconClass) ? Icons.Material.Filled.CheckCircle : amenity.IconClass)" Size="Size.Small" Class="mr-2" />
                                                                                @amenity.DisplayName
                                                                            </MudSelectItem>
                                                                        }
                                                                    </MudSelect>
                                                                </MudItem>

                                                                <!-- Photo Gallery -->
                                                                <MudItem xs="12">
                                                                    <MudDivider Class="my-2" />
                                                                    <div class="d-flex justify-space-between align-center mb-2">
                                                                        <MudText Typo="Typo.subtitle1">
                                                                            <MudIcon Icon="@Icons.Material.Filled.PhotoLibrary" Size="Size.Small" Class="mr-1" />
                                                                            Photos (@accType.GalleryImages.Count)
                                                                        </MudText>
                                                                        @if (_isAdmin)
                                                                        {
                                                                            <MudButton Variant="Variant.Outlined"
                                                                                       Color="Color.Primary"
                                                                                       Size="Size.Small"
                                                                                       StartIcon="@Icons.Material.Filled.PhotoLibrary"
                                                                                       OnClick="@(() => ManageGallery(accType))">
                                                                                Manage Photos
                                                                            </MudButton>
                                                                        }
                                                                    </div>
                                                                    @if (accType.GalleryImages.Any())
                                                                    {
                                                                        <div class="d-flex gap-2 flex-wrap">
                                                                            @foreach (var image in accType.GalleryImages.Take(4))
                                                                            {
                                                                                <MudImage Src="@image"
                                                                                          Width="80"
                                                                                          Height="60"
                                                                                          ObjectFit="ObjectFit.Cover"
                                                                                          Class="rounded" />
                                                                            }
                                                                            @if (accType.GalleryImages.Count > 4)
                                                                            {
                                                                                <MudChip T="string" Size="Size.Small">
                                                                                    +@(accType.GalleryImages.Count - 4) more
                                                                                </MudChip>
                                                                            }
                                                                        </div>
                                                                    }
                                                                </MudItem>

                                                                <!-- Save Button -->
                                                                @if (_isAdmin)
                                                                {
                                                                    <MudItem xs="12">
                                                                        <MudButton Variant="Variant.Filled"
                                                                                   Color="Color.Primary"
                                                                                   StartIcon="@Icons.Material.Filled.Save"
                                                                                   OnClick="@(() => SaveAccommodationTypeForCampsite(accType, campsite.Id))">
                                                                            Save Changes
                                                                        </MudButton>
                                                                    </MudItem>
                                                                }
                                                            </MudGrid>
                                                        </ChildContent>
                                                    </MudExpansionPanel>
                                                }
                                            </MudExpansionPanels>
                                        }
                                    </ChildContent>
                                </MudExpansionPanel>
                            </MudExpansionPanels>
                        </MudItem>
                    </MudGrid>
                </ChildContent>
            </MudExpansionPanel>
        }
    </MudExpansionPanels>

    @if (!FilteredCampsites.Any())
    {
        <MudAlert Severity="Severity.Info" Class="mt-4">
            @if (_campsites.Any())
            {
                <span>No campsites match your search criteria. Try a different search term.</span>
            }
            else
            {
                <span>No campsites found.@(_isAdmin ? " Click \"Add New Campsite\" to create one." : "")</span>
            }
        </MudAlert>
    }
</MudContainer>

@code {
    private CampsiteManagementDto? _selectedCampsite;
    private List<CampsiteManagementDto> _campsites = new();
    private Dictionary<int, List<AccommodationTypeDto>> _accommodationTypesByCampsite = new();
    private List<AmenityLookup> _availableAmenities = new();
    private bool _loading = false;
    private bool _isAdmin = false;
    private string _searchText = "";
    private HashSet<int> _expandedCampsites = new();
    private HashSet<int> _expandedAccommodationSections = new(); // Track which campsites have expanded accommodation sections
    private HashSet<int> _expandedAccommodationTypes = new(); // Track which accommodation types are expanded
    private MudExpansionPanels? _expansionPanels;

    // Filtered campsites based on search text
    private IEnumerable<CampsiteManagementDto> FilteredCampsites => string.IsNullOrWhiteSpace(_searchText)
        ? _campsites
        : _campsites.Where(c =>
            c.Name.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
            c.City.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
            (c.Description?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false));

    private bool IsCampsiteExpanded(int campsiteId) => _expandedCampsites.Contains(campsiteId);

    private void SetCampsiteExpanded(int campsiteId, bool expanded)
    {
        if (expanded)
            _expandedCampsites.Add(campsiteId);
        else
            _expandedCampsites.Remove(campsiteId);
    }

    private bool IsAccommodationSectionExpanded(int campsiteId) => _expandedAccommodationSections.Contains(campsiteId);

    private void SetAccommodationSectionExpanded(int campsiteId, bool expanded)
    {
        if (expanded)
            _expandedAccommodationSections.Add(campsiteId);
        else
            _expandedAccommodationSections.Remove(campsiteId);
    }

    private bool IsAccommodationTypeExpanded(int accTypeId) => _expandedAccommodationTypes.Contains(accTypeId);

    private void SetAccommodationTypeExpanded(int accTypeId, bool expanded)
    {
        if (expanded)
            _expandedAccommodationTypes.Add(accTypeId);
        else
            _expandedAccommodationTypes.Remove(accTypeId);
    }

    private List<AccommodationTypeDto> GetAccommodationTypesForCampsite(int campsiteId)
    {
        return _accommodationTypesByCampsite.TryGetValue(campsiteId, out var types) ? types : new List<AccommodationTypeDto>();
    }

    private void ExpandAllCampsites()
    {
        _expandedCampsites = _campsites.Select(c => c.Id).ToHashSet();
        StateHasChanged();
    }

    private void CollapseAllCampsites()
    {
        _expandedCampsites.Clear();
        _expandedAccommodationSections.Clear();
        _expandedAccommodationTypes.Clear();
        StateHasChanged();
    }

    private async Task SelectCampsiteForAccommodations(CampsiteManagementDto campsite)
    {
        _selectedCampsite = campsite;
        await LoadAccommodationTypes(campsite.Id);
        StateHasChanged();
    }

    private async Task OpenEditCampsiteDialog(CampsiteManagementDto campsite)
    {
        // Convert CampsiteManagementDto to CampsiteFormDto for the dialog
        var campsiteForm = new CampsiteFormDto
        {
            Id = campsite.Id,
            Name = campsite.Name,
            StreetAddress = campsite.StreetAddress,
            City = campsite.City,
            PostalCode = campsite.PostalCode,
            Description = campsite.Description,
            Attractiveness = campsite.Attractiveness,
            PhoneNumber = campsite.PhoneNumber,
            Email = campsite.Email,
            WebsiteUrl = campsite.WebsiteUrl,
            Latitude = campsite.Latitude,
            Longitude = campsite.Longitude,
            IsActive = campsite.IsActive,
            SeasonOpeningDate = campsite.SeasonOpeningDate
        };

        var parameters = new DialogParameters<AddCampsiteDialog>
        {
            { x => x.Campsite, campsiteForm },
            { x => x.IsEdit, true }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<AddCampsiteDialog>("Edit Campsite", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadCampsites();
            StateHasChanged();
        }
    }

    private async Task DeleteCampsite(CampsiteManagementDto campsite)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Confirm Delete",
            $"Are you sure you want to delete the campsite \"{campsite.Name}\"? This action cannot be undone and will also delete all associated accommodation types.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            try
            {
                using var context = await DbContextFactory.CreateDbContextAsync();
                var campsiteId = CampsiteId.Create(campsite.Id);
                var entity = await context.Campsites.FirstOrDefaultAsync(c => c.Id == campsiteId);
                if (entity != null)
                {
                    context.Campsites.Remove(entity);
                    await context.SaveChangesAsync();
                    await LoadCampsites();

                    if (_selectedCampsite?.Id == campsite.Id)
                    {
                        _selectedCampsite = null;
                    }

                    // Remove accommodation types for deleted campsite
                    _accommodationTypesByCampsite.Remove(campsite.Id);

                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting campsite: {ex.Message}");
                await DialogService.ShowMessageBox("Error", $"Failed to delete campsite: {ex.Message}");
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // Check if user is Admin
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        _isAdmin = user.IsInRole("Admin");

        Console.WriteLine("ðµ OnInitializedAsync called");
        await LoadCampsites();
        await LoadAvailableAmenities();
        await LoadAllAccommodationTypes(); // Load all accommodation types upfront
        Console.WriteLine($"ðµ Loaded {_campsites.Count} campsites with {_accommodationTypesByCampsite.Values.Sum(v => v.Count)} accommodation types");

        // Debug: Query database to see what's actually stored
        await QueryDatabaseState();
    }

    private async Task QueryDatabaseState()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            var allAccommodationTypes = await context.AccommodationTypes
                .OrderBy(a => a.CampsiteId.Value)
                .ThenBy(a => a.Type)
                .ToListAsync();

            Console.WriteLine($"\nð ========== DATABASE STATE - ALL ACCOMMODATION TYPES ==========");
            Console.WriteLine($"   Total: {allAccommodationTypes.Count} accommodation types");
            Console.WriteLine();

            var groupedByCampsite = allAccommodationTypes.GroupBy(a => a.CampsiteId.Value);
            foreach (var group in groupedByCampsite)
            {
                Console.WriteLine($"   ðï¸  Campsite ID: {group.Key}");
                foreach (var accType in group)
                {
                    var amenities = accType.GetAmenitiesList();
                    Console.WriteLine($"      - {accType.Type} (ID: {accType.Id.Value})");
                    Console.WriteLine($"        Amenities ({amenities.Count}): [{string.Join(", ", amenities)}]");
                    if (amenities.Count == 0)
                    {
                        Console.WriteLine($"        â ï¸  NO AMENITIES!");
                    }
                }
                Console.WriteLine();
            }
            Console.WriteLine($"ð ========== END DATABASE STATE ==========\n");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"â Error querying database state: {ex.Message}");
        }
    }

    private async Task LoadCampsites()
    {
        _loading = true;

        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            var campsites = await context.Campsites.ToListAsync();

            _campsites = campsites.Select(c => new CampsiteManagementDto
            {
                Id = c.Id.Value,
                Name = c.Name ?? "Unknown",
                StreetAddress = c.StreetAddress ?? "",
                City = c.City ?? "",
                PostalCode = c.PostalCode ?? "",
                Description = c.Description ?? "",
                Attractiveness = c.Attractiveness ?? "",
                PhoneNumber = c.PhoneNumber ?? "",
                Email = c.Email?.Value,
                WebsiteUrl = c.WebsiteUrl ?? "",
                TotalSpots = 0, // TODO: Calculate from accommodation spots
                AvailableSpots = 0, // TODO: Calculate from bookings
                Latitude = c.Latitude,
                Longitude = c.Longitude,
                AccommodationTypes = new List<string>(), // TODO: Load from accommodation types
                Amenities = new List<string>(), // TODO: Parse from campsite amenities
                IsActive = c.IsActive,
                SeasonOpeningDate = c.SeasonOpeningDate,
                MapImageUrl = "", // TODO: Get from campsite photos
                GalleryImages = new List<string>(), // TODO: Load from campsite photos
                InactivePeriods = new List<InactivePeriodDto>()
            }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading campsites: {ex.Message}");
            _campsites = new List<CampsiteManagementDto>();
        }
        finally
        {
            _loading = false;
        }

        _loading = false;
    }

    private async Task LoadAvailableAmenities()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            _availableAmenities = await context.AmenityLookups
                .Where(a => a.IsActive)
                .OrderBy(a => a.SortOrder)
                .ToListAsync();

            Console.WriteLine($"â Loaded {_availableAmenities.Count} available amenities from lookup table");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"â Error loading amenities: {ex.Message}");
            _availableAmenities = new List<AmenityLookup>();
        }
    }

    private async Task LoadAllAccommodationTypes()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load ALL accommodation types, spots, and photos upfront
            var allEntities = await context.AccommodationTypes.ToListAsync();
            var allSpots = await context.AccommodationSpots.ToListAsync();
            var allPhotos = await context.Photos.ToListAsync();

            Console.WriteLine($"ð LoadAllAccommodationTypes: Loaded {allEntities.Count} types, {allSpots.Count} spots, {allPhotos.Count} photos");

            // Group by campsite and convert to DTOs
            _accommodationTypesByCampsite.Clear();

            foreach (var campsite in _campsites)
            {
                var entities = allEntities.Where(a => a.CampsiteId?.Value == campsite.Id).ToList();

                var types = entities.Select(e => {
                    var typeSpots = allSpots
                        .Where(s => s.AccommodationTypeId?.Value == e.Id?.Value)
                        .Select(s => new AccommodationSpotDto
                        {
                            Id = s.Id?.Value ?? 0,
                            SpotNumber = s.SpotIdentifier,
                            Latitude = s.Latitude,
                            Longitude = s.Longitude,
                            IsUnderMaintenance = s.IsUnderMaintenance
                        })
                        .ToList();

                    var galleryImages = allPhotos
                        .Where(p => p.AccommodationTypeId?.Value == e.Id?.Value)
                        .OrderBy(p => p.DisplayOrder)
                        .Select(p => p.Url)
                        .ToList();

                    var mainImageUrl = !string.IsNullOrWhiteSpace(e.ImageUrl)
                        ? e.ImageUrl
                        : (galleryImages.FirstOrDefault() ?? "");

                    return new AccommodationTypeDto
                    {
                        Id = e.Id?.Value ?? 0,
                        CampsiteId = e.CampsiteId?.Value ?? 0,
                        Type = e.Type ?? "",
                        Description = e.Description ?? "",
                        MaxCapacity = e.MaxCapacity,
                        PricePerNight = e.BasePrice?.Amount ?? 0m,
                        ImageUrl = mainImageUrl,
                        Icon = "",
                        Amenities = e.GetAmenitiesList(),
                        Spots = typeSpots,
                        GalleryImages = galleryImages,
                        IsActive = e.IsActive,
                        AvailableUnits = e.AvailableUnits,
                        UnitNamingPrefix = e.UnitNamingPrefix ?? "",
                        UnitNamingPattern = e.UnitNamingPattern ?? "Numbers",
                        AreaSquareMeters = e.AreaSquareMeters
                    };
                }).ToList();

                _accommodationTypesByCampsite[campsite.Id] = types;
                Console.WriteLine($"   ðï¸ Campsite {campsite.Id} ({campsite.Name}): {types.Count} accommodation types");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"â Error loading all accommodation types: {ex.Message}");
            _accommodationTypesByCampsite.Clear();
        }
    }

    private async Task RefreshAccommodationTypesForCampsite(int campsiteId)
    {
        // Reload accommodation types for a specific campsite after changes
        await LoadAllAccommodationTypes();
        StateHasChanged();
    }

    private async Task<IEnumerable<CampsiteManagementDto>> SearchCampsites(string value, CancellationToken token)
    {
        await Task.Delay(100, token); // Simulate API delay

        if (string.IsNullOrWhiteSpace(value))
            return _campsites;

        return _campsites.Where(c =>
            c.Name.Contains(value, StringComparison.OrdinalIgnoreCase) ||
            c.City.Contains(value, StringComparison.OrdinalIgnoreCase) ||
            c.Description.Contains(value, StringComparison.OrdinalIgnoreCase));
    }

    private async Task LoadAccommodationTypes(int campsiteId)
    {
        _loading = true;
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load ALL accommodation types from database first (client-side evaluation)
            var allEntities = await context.AccommodationTypes.ToListAsync();

            Console.WriteLine($"ð Loaded {allEntities.Count} total accommodation types from database");

            // Filter by campsite ID in memory (since CampsiteId is a private field)
            var entities = allEntities.Where(a => a.CampsiteId?.Value == campsiteId).ToList();

            Console.WriteLine($"ð Found {entities.Count} accommodation types for campsite {campsiteId}");

            // Load all accommodation spots for this campsite
            var allSpots = await context.AccommodationSpots.ToListAsync();
            Console.WriteLine($"ð Loaded {allSpots.Count} total accommodation spots from database");
            foreach (var spot in allSpots.Take(10))
            {
                Console.WriteLine($"   - Spot '{spot.SpotIdentifier}' (Id={spot.Id?.Value}): AccTypeId={spot.AccommodationTypeId?.Value}, IsUnderMaintenance={spot.IsUnderMaintenance}");
            }
            if (allSpots.Count > 10)
            {
                Console.WriteLine($"   ... and {allSpots.Count - 10} more spots");
            }

            // Load all photos for accommodation types
            var allPhotos = await context.Photos.ToListAsync();
            Console.WriteLine($"ð Loaded {allPhotos.Count} total photos from database");

            // Convert entities to DTOs with null-safe access
            var types = entities.Select(e => {
                // Get spots for this accommodation type
                var typeSpots = allSpots
                    .Where(s => s.AccommodationTypeId?.Value == e.Id?.Value)
                    .Select(s => {
                        var dto = new AccommodationSpotDto
                        {
                            Id = s.Id?.Value ?? 0,
                            SpotNumber = s.SpotIdentifier,
                            Latitude = s.Latitude,
                            Longitude = s.Longitude,
                            IsUnderMaintenance = s.IsUnderMaintenance
                        };
                        Console.WriteLine($"      ð§ Created DTO for '{dto.SpotNumber}': IsUnderMaintenance={dto.IsUnderMaintenance} (from entity: {s.IsUnderMaintenance})");
                        return dto;
                    })
                    .ToList();

                // Get gallery images for this accommodation type
                var galleryImages = allPhotos
                    .Where(p => p.AccommodationTypeId?.Value == e.Id?.Value)
                    .OrderBy(p => p.DisplayOrder)
                    .Select(p => p.Url)
                    .ToList();

                Console.WriteLine($"   ð¦ {e.Type}: {typeSpots.Count} spots loaded, maintenance count: {typeSpots.Count(s => s.IsUnderMaintenance)}, {galleryImages.Count} gallery images");

                // Use first gallery image as the main image if no ImageUrl is set
                var mainImageUrl = !string.IsNullOrWhiteSpace(e.ImageUrl)
                    ? e.ImageUrl
                    : (galleryImages.FirstOrDefault() ?? "");

                return new AccommodationTypeDto
                {
                    Id = e.Id?.Value ?? 0,
                    CampsiteId = e.CampsiteId?.Value ?? 0,
                    Type = e.Type ?? "",
                    Description = e.Description ?? "",
                    MaxCapacity = e.MaxCapacity,
                    PricePerNight = e.BasePrice?.Amount ?? 0m,
                    ImageUrl = mainImageUrl,
                    Icon = "", // Default icon, can be customized later
                    Amenities = e.GetAmenitiesList(), // Load from database
                    Spots = typeSpots,
                    GalleryImages = galleryImages,
                    IsActive = e.IsActive,
                    AvailableUnits = e.AvailableUnits,
                    UnitNamingPrefix = e.UnitNamingPrefix ?? "",
                    UnitNamingPattern = e.UnitNamingPattern ?? "Numbers",
                    AreaSquareMeters = e.AreaSquareMeters
                };
            }).ToList();

            _accommodationTypesByCampsite[campsiteId] = types;
            Console.WriteLine($"â Loaded {types.Count} accommodation types for campsite {campsiteId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"â Error loading accommodation types: {ex.Message}");
            Console.WriteLine($"   Stack trace: {ex.StackTrace}");
            if (ex.InnerException != null)
            {
                Console.WriteLine($"   Inner exception: {ex.InnerException.Message}");
            }
            Snackbar.Add($"Error loading accommodation types: {ex.Message}", Severity.Error);
            _accommodationTypesByCampsite[campsiteId] = new List<AccommodationTypeDto>();
        }
        finally
        {
            _loading = false;
        }
    }

    private async void OnCampsiteSelected(CampsiteManagementDto? campsite)
    {
        _selectedCampsite = campsite;
        if (campsite != null)
        {
            await LoadAccommodationTypes(campsite.Id);
        }
        StateHasChanged();
    }

    private async Task SaveCampsiteDetails(CampsiteManagementDto campsite)
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            var campsiteId = CampsiteId.Create(campsite.Id);
            var dbCampsite = await context.Campsites.FirstOrDefaultAsync(c => c.Id == campsiteId);

            if (dbCampsite == null)
            {
                Snackbar.Add($"Campsite not found", Severity.Error);
                return;
            }

            // Parse email if provided
            Email? email = null;
            if (!string.IsNullOrWhiteSpace(campsite.Email))
            {
                try
                {
                    email = Email.Create(campsite.Email);
                }
                catch
                {
                    Snackbar.Add("Invalid email format", Severity.Error);
                    return;
                }
            }

            // Use domain method to update campsite information
            dbCampsite.UpdateInformation(
                campsite.Name,
                campsite.StreetAddress,
                campsite.City,
                campsite.PostalCode,
                campsite.Description,
                campsite.Attractiveness,
                campsite.PhoneNumber ?? string.Empty,
                email,
                campsite.WebsiteUrl ?? string.Empty
            );

            // Update active status and season opening date
            dbCampsite.SetActiveStatus(campsite.IsActive, campsite.SeasonOpeningDate);

            await context.SaveChangesAsync();

            Console.WriteLine($"â Campsite '{campsite.Name}' updated successfully");
            Snackbar.Add($"Campsite details for '{campsite.Name}' saved successfully!", Severity.Success);
        }
        catch (DomainException ex)
        {
            Console.WriteLine($"â Domain error saving campsite: {ex.Message}");
            Snackbar.Add($"Cannot save campsite: {ex.Message}", Severity.Error);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"â Error saving campsite: {ex.Message}");
            Snackbar.Add($"Error saving campsite: {ex.Message}", Severity.Error);
        }
    }

    private async Task OpenCampsiteGalleryDialog(CampsiteManagementDto campsite)
    {
        var parameters = new DialogParameters
        {
            ["Title"] = $"Photo Gallery - {campsite.Name}",
            ["GalleryImages"] = campsite.GalleryImages ?? new List<string>()
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<ManageGalleryDialog>("Manage Photo Gallery", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is List<string> updatedGallery)
        {
            campsite.GalleryImages = updatedGallery;
            Snackbar.Add("Photo gallery updated successfully!", Severity.Success);
            StateHasChanged();
        }
    }

    private async Task OpenAddCampsiteDialog()
    {
        try
        {
            var parameters = new DialogParameters
            {
                ["Campsite"] = new CampsiteFormDto
                {
                    Attractiveness = "Medium",
                    IsActive = true,
                    EstablishedYear = DateTime.Now.Year
                },
                ["IsEdit"] = false
            };

            var options = new DialogOptions
            {
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                CloseButton = true
            };

            var dialog = await DialogService.ShowAsync<AddCampsiteDialog>("Add New Campsite", parameters, options);
            var result = await dialog.Result;

            if (!result.Canceled && result.Data is CampsiteFormDto newCampsite)
            {
                // Save to database
                await SaveCampsiteToDatabase(newCampsite);

                // Reload campsites list
                await LoadCampsites();

                // Auto-select the newly created campsite
                var createdCampsite = _campsites.FirstOrDefault(c => c.Name == newCampsite.Name);
                if (createdCampsite != null)
                {
                    _selectedCampsite = createdCampsite;
                    await LoadAccommodationTypes(createdCampsite.Id);
                }

                Snackbar.Add($"Campsite '{newCampsite.Name}' created successfully!", Severity.Success);
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"â Error adding campsite: {ex.Message}");
            Snackbar.Add($"Error adding campsite: {ex.Message}", Severity.Error);
        }
    }

    private async Task SaveCampsiteToDatabase(CampsiteFormDto dto)
    {
        try
        {
            Console.WriteLine($"ð¾ Saving campsite to database:");
            Console.WriteLine($"   - Name: {dto.Name}");
            Console.WriteLine($"   - Address: {dto.StreetAddress}, {dto.City} {dto.PostalCode}");
            Console.WriteLine($"   - Latitude: {dto.Latitude}");
            Console.WriteLine($"   - Longitude: {dto.Longitude}");

            using var context = await DbContextFactory.CreateDbContextAsync();

            // Parse email if provided
            Email? email = null;
            if (!string.IsNullOrWhiteSpace(dto.Email))
            {
                try
                {
                    email = Email.Create(dto.Email);
                }
                catch
                {
                    throw new ArgumentException("Invalid email format");
                }
            }

            // Create the campsite using the domain factory method
            var campsite = Campsite.Create(
                name: dto.Name,
                streetAddress: dto.StreetAddress,
                city: dto.City,
                postalCode: dto.PostalCode,
                latitude: dto.Latitude,
                longitude: dto.Longitude,
                establishedYear: dto.EstablishedYear,
                description: dto.Description,
                attractiveness: dto.Attractiveness,
                phoneNumber: dto.PhoneNumber ?? string.Empty,
                email: email,
                websiteUrl: dto.WebsiteUrl ?? string.Empty
            );

            // Set active status
            if (!dto.IsActive)
            {
                campsite.Deactivate();
            }

            context.Campsites.Add(campsite);
            await context.SaveChangesAsync();

            // Update DTO with the generated ID
            dto.Id = campsite.Id.Value;

            Console.WriteLine($"â Successfully saved campsite with ID: {dto.Id}");
        }
        catch (DomainException ex)
        {
            Console.WriteLine($"â Domain error saving campsite: {ex.Message}");
            throw;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"â Error saving campsite: {ex.Message}");
            throw;
        }
    }

    private async Task OpenAddAccommodationTypeDialog()
    {
        try
        {
            var parameters = new DialogParameters
            {
                ["CampsiteName"] = _selectedCampsite!.Name,
                ["AccommodationType"] = new AccommodationTypeDto { CampsiteId = _selectedCampsite.Id },
                ["IsEdit"] = false
            };

            var options = new DialogOptions
            {
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                CloseButton = true
            };

            var dialog = await DialogService.ShowAsync<CampsiteAccommodationDialog>("Add Accommodation Type", parameters, options);
            var result = await dialog.Result;

            if (!result.Canceled && result.Data is AccommodationTypeDto newAccType)
            {
                // Save to database
                await SaveAccommodationTypeToDatabase(newAccType);

                // Reload accommodation types from database to get the latest data
                await LoadAccommodationTypes(_selectedCampsite!.Id);

                Snackbar.Add($"Accommodation type '{newAccType.Type}' added successfully!", Severity.Success);
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error adding accommodation type: {ex.Message}", Severity.Error);
        }
    }

    private async Task OpenAddAccommodationTypeDialogForCampsite(int campsiteId)
    {
        try
        {
            var campsite = _campsites.FirstOrDefault(c => c.Id == campsiteId);
            if (campsite == null) return;

            var parameters = new DialogParameters
            {
                ["CampsiteName"] = campsite.Name,
                ["AccommodationType"] = new AccommodationTypeDto { CampsiteId = campsiteId },
                ["IsEdit"] = false
            };

            var options = new DialogOptions
            {
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                CloseButton = true
            };

            var dialog = await DialogService.ShowAsync<CampsiteAccommodationDialog>("Add Accommodation Type", parameters, options);
            var result = await dialog.Result;

            if (!result.Canceled && result.Data is AccommodationTypeDto newAccType)
            {
                // Save to database
                await SaveAccommodationTypeToDatabase(newAccType);

                // Reload accommodation types
                await LoadAllAccommodationTypes();

                Snackbar.Add($"Accommodation type '{newAccType.Type}' added successfully!", Severity.Success);
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error adding accommodation type: {ex.Message}", Severity.Error);
        }
    }

    private async Task SaveAccommodationTypeForCampsite(AccommodationTypeDto accType, int campsiteId)
    {
        try
        {
            await SaveAccommodationType(accType);
            await LoadAllAccommodationTypes();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving accommodation type: {ex.Message}", Severity.Error);
        }
    }

    private void AddSpotForCampsite(AccommodationTypeDto accType, CampsiteManagementDto campsite)
    {
        // Use campsite coordinates as default for new spots
        var nextSpotNumber = accType.Spots.Count + 1;
        var prefix = string.IsNullOrWhiteSpace(accType.UnitNamingPrefix) ? "" : accType.UnitNamingPrefix + " ";

        accType.Spots.Add(new AccommodationSpotDto
        {
            SpotNumber = $"{prefix}{nextSpotNumber}",
            Latitude = campsite.Latitude,
            Longitude = campsite.Longitude,
            IsUnderMaintenance = false
        });

        StateHasChanged();
    }

    private IEnumerable<string> GetAmenitiesBindingForType(AccommodationTypeDto accType)
    {
        return accType.Amenities ?? new List<string>();
    }

    private void UpdateAmenitiesForType(AccommodationTypeDto accType, IEnumerable<string> values)
    {
        accType.Amenities = values.ToList();
    }

    private void RemoveSpotFromType(AccommodationTypeDto accType, AccommodationSpotDto spot)
    {
        accType.Spots.Remove(spot);
        StateHasChanged();
    }

    private async Task SaveAccommodationTypeToDatabase(AccommodationTypeDto dto)
    {
        try
        {
            Console.WriteLine($"ð¾ Saving accommodation type to database:");
            Console.WriteLine($"   - Type: {dto.Type}");
            Console.WriteLine($"   - CampsiteId: {dto.CampsiteId}");
            Console.WriteLine($"   - MaxCapacity: {dto.MaxCapacity}");
            Console.WriteLine($"   - PricePerNight: {dto.PricePerNight}");
            Console.WriteLine($"   - AvailableUnits: {dto.AvailableUnits}");

            if (dto.CampsiteId <= 0)
            {
                throw new ArgumentException($"Invalid campsite ID: {dto.CampsiteId}");
            }

            using var context = await DbContextFactory.CreateDbContextAsync();

            // Create the entity using the factory method
            var entity = AccommodationType.Create(
                CampsiteId.Create(dto.CampsiteId),
                dto.Type,
                dto.MaxCapacity,
                Money.Create(dto.PricePerNight, "DKK"),
                dto.AvailableUnits,
                dto.Description,
                dto.ImageUrl
            );

            // Set amenities if provided
            if (dto.Amenities != null && dto.Amenities.Any())
            {
                entity.UpdateAmenities(dto.Amenities);
            }

            // Set unit naming configuration
            entity.UpdateUnitNaming(dto.UnitNamingPrefix, dto.UnitNamingPattern);

            // Set area in square meters if provided
            if (dto.AreaSquareMeters.HasValue)
            {
                entity.UpdateAreaSquareMeters(dto.AreaSquareMeters);
            }

            context.AccommodationTypes.Add(entity);

            // CRITICAL FIX: Explicitly mark the private fields as modified for new entities
            // This ensures EF Core tracks these fields properly
            if (dto.Amenities != null && dto.Amenities.Any())
            {
                context.Entry(entity).Property("_amenities").IsModified = true;
            }
            context.Entry(entity).Property("_unitNamingPrefix").IsModified = true;
            context.Entry(entity).Property("_unitNamingPattern").IsModified = true;
            if (dto.AreaSquareMeters.HasValue)
            {
                context.Entry(entity).Property("_areaSquareMeters").IsModified = true;
            }

            await context.SaveChangesAsync();

            // Update the DTO with the generated ID
            dto.Id = entity.Id.Value;

            Console.WriteLine($"â Successfully saved accommodation type with ID: {dto.Id}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"â Error saving to database: {ex.Message}");
            Console.WriteLine($"   Stack trace: {ex.StackTrace}");
            throw;
        }
    }

    private List<AccommodationSpotDto> GenerateSpots(AccommodationTypeDto accType)
    {
        var spots = new List<AccommodationSpotDto>();
        var baseLatitude = _selectedCampsite?.Latitude ?? 55.6761;
        var baseLongitude = _selectedCampsite?.Longitude ?? 12.5683;

        for (int i = 0; i < accType.AvailableUnits; i++)
        {
            string spotName = accType.UnitNamingPattern switch
            {
                "Letters" => $"{(char)('A' + i)}",
                "Numbers" => $"{i + 1}",
                "PrefixNumbers" => $"{accType.UnitNamingPrefix}{i + 1}",
                _ => $"{i + 1}"
            };

            spots.Add(new AccommodationSpotDto
            {
                Id = i + 1,
                Name = spotName,
                IsAvailable = true,
                Latitude = baseLatitude + (i * 0.0001),
                Longitude = baseLongitude + (i * 0.0001)
            });
        }

        return spots;
    }

    private async Task SaveAccommodationType(AccommodationTypeDto accType)
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            var accommodationTypeId = AccommodationTypeId.Create(accType.Id);
            var dbAccommodationType = await context.AccommodationTypes
                .FirstOrDefaultAsync(a => a.Id == accommodationTypeId);

            if (dbAccommodationType == null)
            {
                Snackbar.Add($"Accommodation type not found", Severity.Error);
                return;
            }

            Console.WriteLine($"ð SaveAccommodationType - Before update:");
            Console.WriteLine($"   DTO Amenities: [{string.Join(", ", accType.Amenities)}]");
            Console.WriteLine($"   DB Amenities: [{string.Join(", ", dbAccommodationType.GetAmenitiesList())}]");

            // Update information using domain method
            dbAccommodationType.UpdateInformation(accType.Description, accType.ImageUrl);

            // IMPORTANT: Also update amenities from the DTO
            dbAccommodationType.UpdateAmenities(accType.Amenities);

            // Update unit naming configuration
            dbAccommodationType.UpdateUnitNaming(accType.UnitNamingPrefix, accType.UnitNamingPattern);

            // Update max capacity (configuration property)
            dbAccommodationType.UpdateMaxCapacity(accType.MaxCapacity);

            // Update area in square meters (optional field)
            dbAccommodationType.UpdateAreaSquareMeters(accType.AreaSquareMeters);

            // Update active status - handle the exception for already active/inactive
            if (accType.IsActive && !dbAccommodationType.IsActive)
            {
                dbAccommodationType.Activate();
            }
            else if (!accType.IsActive && dbAccommodationType.IsActive)
            {
                dbAccommodationType.Deactivate();
            }

            // CRITICAL FIX: Explicitly mark the private fields as modified
            // EF Core doesn't automatically detect changes to private fields
            context.Entry(dbAccommodationType).Property("_amenities").IsModified = true;
            context.Entry(dbAccommodationType).Property("_unitNamingPrefix").IsModified = true;
            context.Entry(dbAccommodationType).Property("_unitNamingPattern").IsModified = true;
            context.Entry(dbAccommodationType).Property("_maxCapacity").IsModified = true;
            context.Entry(dbAccommodationType).Property("_areaSquareMeters").IsModified = true;
            context.Entry(dbAccommodationType).Property("_isActive").IsModified = true;

            // Save spots with their maintenance status
            Console.WriteLine($"ð§ Saving {accType.Spots.Count} spots for {accType.Type}:");
            foreach (var spotDto in accType.Spots)
            {
                Console.WriteLine($"   - Spot '{spotDto.SpotNumber}' (Id={spotDto.Id}): IsUnderMaintenance={spotDto.IsUnderMaintenance}");
                if (spotDto.Id > 0)
                {
                    // Update existing spot
                    var spotId = AccommodationSpotId.Create(spotDto.Id);
                    var dbSpot = await context.AccommodationSpots.FirstOrDefaultAsync(s => s.Id == spotId);
                    if (dbSpot != null)
                    {
                        Console.WriteLine($"     Found in DB: Current IsUnderMaintenance={dbSpot.IsUnderMaintenance}");
                        dbSpot.SetMaintenanceStatus(spotDto.IsUnderMaintenance);
                        Console.WriteLine($"     After SetMaintenanceStatus: IsUnderMaintenance={dbSpot.IsUnderMaintenance}");
                        context.Entry(dbSpot).Property("_isUnderMaintenance").IsModified = true;
                        context.Entry(dbSpot).Property("_latitude").IsModified = true;
                        context.Entry(dbSpot).Property("_longitude").IsModified = true;
                    }
                    else
                    {
                        Console.WriteLine($"     â ï¸ Spot not found in database!");
                    }
                }
                else
                {
                    // Create new spot
                    Console.WriteLine($"     Creating new spot in database");
                    var newSpot = AccommodationSpot.Create(
                        spotDto.SpotNumber,
                        CampsiteId.Create(accType.CampsiteId),
                        _selectedCampsite?.Name ?? "",
                        accommodationTypeId,
                        accType.Type,
                        spotDto.Latitude,
                        spotDto.Longitude
                    );
                    newSpot.SetMaintenanceStatus(spotDto.IsUnderMaintenance);
                    context.AccommodationSpots.Add(newSpot);
                }
            }

            Console.WriteLine($"ð¾ Calling SaveChangesAsync...");
            var savedCount = await context.SaveChangesAsync();
            Console.WriteLine($"â SaveChangesAsync completed - {savedCount} entities saved");

            Console.WriteLine($"ð SaveAccommodationType - After update:");
            Console.WriteLine($"   DB Amenities: [{string.Join(", ", dbAccommodationType.GetAmenitiesList())}]");
            Console.WriteLine($"â Accommodation type '{accType.Type}' updated successfully");
            Snackbar.Add($"Changes to '{accType.Type}' saved successfully!", Severity.Success);

            // Reload accommodation types to ensure UI is in sync with database
            if (_selectedCampsite != null)
            {
                await LoadAccommodationTypes(_selectedCampsite.Id);
            }
        }
        catch (DomainException ex)
        {
            Console.WriteLine($"â Domain error saving accommodation type: {ex.Message}");
            Snackbar.Add($"Cannot save accommodation type: {ex.Message}", Severity.Error);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"â Error saving accommodation type: {ex.Message}");
            Snackbar.Add($"Error saving accommodation type: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteAccommodationType(AccommodationTypeDto accType)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirm Delete",
            $"Are you sure you want to delete the accommodation type '{accType.Type}'? This action cannot be undone.",
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                using var context = await DbContextFactory.CreateDbContextAsync();

                var accommodationTypeId = AccommodationTypeId.Create(accType.Id);
                var dbAccommodationType = await context.AccommodationTypes
                    .FirstOrDefaultAsync(a => a.Id == accommodationTypeId);

                if (dbAccommodationType == null)
                {
                    Snackbar.Add($"Accommodation type not found", Severity.Error);
                    return;
                }

                // Remove from database
                context.AccommodationTypes.Remove(dbAccommodationType);
                await context.SaveChangesAsync();

                // Remove from in-memory list
                if (_accommodationTypesByCampsite.TryGetValue(accType.CampsiteId, out var types))
                {
                    types.Remove(accType);
                }

                Console.WriteLine($"â Accommodation type '{accType.Type}' deleted successfully");
                Snackbar.Add($"Accommodation type '{accType.Type}' deleted successfully!", Severity.Success);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"â Error deleting accommodation type: {ex.Message}");
                Snackbar.Add($"Error deleting accommodation type: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ManageGallery(AccommodationTypeDto accType)
    {
        var parameters = new DialogParameters
        {
            ["Title"] = $"Photo Gallery - {accType.Type}",
            ["GalleryImages"] = accType.GalleryImages ?? new List<string>()
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<ManageGalleryDialog>("Manage Photo Gallery", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is List<string> updatedGallery)
        {
            try
            {
                var accommodationTypeIdValue = accType.Id;
                var campsiteIdValue = accType.CampsiteId;
                var now = DateTime.UtcNow;

                // Use a single context but with raw SQL for all operations to avoid tracking issues
                await using var context = await DbContextFactory.CreateDbContextAsync();

                // Step 1: Delete existing photos using raw SQL
                await context.Database.ExecuteSqlRawAsync(
                    "DELETE FROM Photos WHERE AccommodationTypeId = {0}",
                    accommodationTypeIdValue);

                // Step 2: Get the maximum existing photo ID using ADO.NET directly
                var connection = context.Database.GetDbConnection();
                await connection.OpenAsync();
                int nextPhotoId = 1;
                try
                {
                    using var command = connection.CreateCommand();
                    command.CommandText = "SELECT COALESCE(MAX(Id), 0) FROM Photos";
                    var maxIdResult = await command.ExecuteScalarAsync();
                    nextPhotoId = (maxIdResult != null && maxIdResult != DBNull.Value)
                        ? Convert.ToInt32(maxIdResult) + 1
                        : 1;
                }
                finally
                {
                    await connection.CloseAsync();
                }

                // Step 3: Insert new photos using raw SQL to avoid entity tracking conflicts
                // Include both Id and PhotoId columns since they're both required
                for (int i = 0; i < updatedGallery.Count; i++)
                {
                    var url = updatedGallery[i];
                    var caption = accType.Type;
                    var altText = $"{accType.Type} photo {i + 1}";
                    var displayOrder = i;
                    var isPrimary = i == 0;
                    var category = "Gallery";
                    var photoId = nextPhotoId + i;

                    await context.Database.ExecuteSqlRawAsync(
                        @"INSERT INTO Photos (Id, PhotoId, CampsiteId, AccommodationTypeId, Url, Caption, AltText, DisplayOrder, IsPrimary, UploadedDate, UpdatedDate, Category)
                          VALUES ({0}, {1}, {2}, {3}, {4}, {5}, {6}, {7}, {8}, {9}, {10}, {11})",
                        photoId, photoId, campsiteIdValue, accommodationTypeIdValue, url, caption, altText, displayOrder, isPrimary, now, now, category);
                }

                // Step 4: Update the accommodation type's ImageUrl
                var newImageUrl = updatedGallery.FirstOrDefault() ?? "";
                await context.Database.ExecuteSqlRawAsync(
                    "UPDATE AccommodationTypes SET ImageUrl = {0} WHERE Id = {1}",
                    newImageUrl, accommodationTypeIdValue);

                // Update the DTO
                accType.GalleryImages = updatedGallery;
                accType.ImageUrl = newImageUrl;

                Snackbar.Add("Photo gallery updated successfully!", Severity.Success);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"â Error saving photo gallery: {ex.Message}");
                Snackbar.Add($"Error saving photo gallery: {ex.Message}", Severity.Error);
            }
        }
    }

    private bool GetAmenityValue(AccommodationTypeDto accType, string amenity)
    {
        return accType.Amenities.Contains(amenity);
    }

    private async Task UpdateAmenity(AccommodationTypeDto accType, string amenity, bool value)
    {
        try
        {
            // Update the DTO
            if (value && !accType.Amenities.Contains(amenity))
            {
                accType.Amenities.Add(amenity);
            }
            else if (!value && accType.Amenities.Contains(amenity))
            {
                accType.Amenities.Remove(amenity);
            }

            // Save to database
            using var context = await DbContextFactory.CreateDbContextAsync();

            var accommodationTypeId = AccommodationTypeId.Create(accType.Id);
            var entity = await context.AccommodationTypes.FirstOrDefaultAsync(a => a.Id == accommodationTypeId);

            if (entity == null)
            {
                Console.WriteLine($"â AccommodationType with ID {accType.Id} not found");
                Snackbar.Add("Error: Accommodation type not found", Severity.Error);
                return;
            }

            Console.WriteLine($"ð Before UpdateAmenities - DB Amenities: [{string.Join(", ", entity.GetAmenitiesList())}]");
            Console.WriteLine($"ð DTO Amenities to save: [{string.Join(", ", accType.Amenities)}]");

            // Update amenities using domain method
            entity.UpdateAmenities(accType.Amenities);

            Console.WriteLine($"ð After UpdateAmenities - DB Amenities: [{string.Join(", ", entity.GetAmenitiesList())}]");

            // CRITICAL FIX: Explicitly mark the _amenities field as modified
            // EF Core doesn't automatically detect changes to private fields
            context.Entry(entity).Property("_amenities").IsModified = true;

            Console.WriteLine($"ð Marked _amenities as modified, saving changes...");

            await context.SaveChangesAsync();

            Console.WriteLine($"â Updated amenities for {accType.Type}: {string.Join(", ", accType.Amenities)}");
            Snackbar.Add($"Amenity '{amenity}' {(value ? "added" : "removed")} successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"â Error updating amenity: {ex.Message}");
            Snackbar.Add($"Error updating amenity: {ex.Message}", Severity.Error);
        }
    }

    private void AddSpot(AccommodationTypeDto accType)
    {
        // Get the next spot number
        var nextNumber = 1;
        if (accType.Spots.Any())
        {
            var maxNumber = accType.Spots
                .Select(s => int.TryParse(s.SpotNumber, out var num) ? num : 0)
                .Max();
            nextNumber = maxNumber + 1;
        }

        // Use campsite coordinates as default, with small offset for each spot
        var baseLatitude = _selectedCampsite?.Latitude ?? 56.2639;
        var baseLongitude = _selectedCampsite?.Longitude ?? 10.4515;

        // Add small offset to spread spots around the campsite (0.0001 degrees â 11 meters)
        var offset = (nextNumber - 1) * 0.0001;

        var newSpot = new AccommodationSpotDto
        {
            Id = 0, // Will be assigned by backend
            SpotNumber = nextNumber.ToString(),
            Latitude = baseLatitude + offset,
            Longitude = baseLongitude + offset,
            IsUnderMaintenance = false
        };

        accType.Spots.Add(newSpot);
        Snackbar.Add($"Spot #{nextNumber} added to {accType.Type}", Severity.Success);
        StateHasChanged();
    }

    private async Task RemoveSpot(AccommodationTypeDto accType, AccommodationSpotDto spot)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirm Delete",
            $"Are you sure you want to remove Spot #{spot.SpotNumber}? This action cannot be undone.",
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                using var context = await DbContextFactory.CreateDbContextAsync();

                var accommodationSpotId = AccommodationSpotId.Create(spot.Id);
                var dbSpot = await context.AccommodationSpots
                    .FirstOrDefaultAsync(s => s.Id == accommodationSpotId);

                if (dbSpot != null)
                {
                    // Remove from database
                    context.AccommodationSpots.Remove(dbSpot);
                    await context.SaveChangesAsync();
                    Console.WriteLine($"â Spot #{spot.SpotNumber} deleted from database");
                }

                // Remove from in-memory list
                accType.Spots.Remove(spot);
                Snackbar.Add($"Spot #{spot.SpotNumber} removed from {accType.Type}", Severity.Success);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"â Error removing spot: {ex.Message}");
                Snackbar.Add($"Error removing spot: {ex.Message}", Severity.Error);
            }
        }
    }

    private List<AccommodationSpotDto> GenerateSampleSpots(int count, double baseLatitude, double baseLongitude, double baseOffset)
    {
        var spots = new List<AccommodationSpotDto>();
        for (int i = 1; i <= count; i++)
        {
            // Create a grid-like pattern for spots
            var row = (i - 1) / 5; // 5 spots per row
            var col = (i - 1) % 5;

            spots.Add(new AccommodationSpotDto
            {
                Id = i,
                SpotNumber = i.ToString(),
                Latitude = baseLatitude + baseOffset + (row * 0.0001),
                Longitude = baseLongitude + baseOffset + (col * 0.0001),
                IsUnderMaintenance = false
            });
        }
        return spots;
    }



    private string GetAccommodationIcon(AccommodationTypeDto accType)
    {
        // Use custom icon if set, otherwise fall back to type-based icon
        if (!string.IsNullOrEmpty(accType.Icon))
            return accType.Icon;

        return accType.Type.ToLower() switch
        {
            "cabin" => Icons.Material.Filled.Cabin,
            "tent site" or "tent" => Icons.Material.Filled.Landscape,
            "rv spot" or "rv" or "caravan" => Icons.Material.Filled.RvHookup,
            "glamping" => Icons.Material.Filled.NightShelter,
            _ => Icons.Material.Filled.Home
        };
    }



    // DTOs
    private class CampsiteManagementDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string StreetAddress { get; set; } = string.Empty;
        public string City { get; set; } = string.Empty;
        public string PostalCode { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string Attractiveness { get; set; } = string.Empty;
        public string? PhoneNumber { get; set; }
        public string? Email { get; set; }
        public string? WebsiteUrl { get; set; }
        public int TotalSpots { get; set; }
        public int AvailableSpots { get; set; }
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public List<string> AccommodationTypes { get; set; } = new();
        public List<string> Amenities { get; set; } = new();
        public bool IsActive { get; set; }
        public DateTime? SeasonOpeningDate { get; set; }
        public string MapImageUrl { get; set; } = string.Empty;
        public List<string> GalleryImages { get; set; } = new();
        public List<InactivePeriodDto> InactivePeriods { get; set; } = new();
    }

    private class InactivePeriodDto
    {
        public int Id { get; set; }
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public string Reason { get; set; } = string.Empty;
        public string Type { get; set; } = "EntireCampsite"; // "EntireCampsite" or "SpecificSpots"
        public List<string> AffectedSpotIds { get; set; } = new();
    }
}
