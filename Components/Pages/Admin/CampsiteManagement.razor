@page "/admin/campsites"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin,Staff")]
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IDbContextFactory<CampsiteBooking.Data.CampsiteBookingDbContext> DbContextFactory
@using CampsiteBooking.Data
@using CampsiteBooking.Models
@using CampsiteBooking.Models.ValueObjects
@using CampsiteBooking.Models.DTOs
@using CampsiteBooking.Models.Common
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization

<PageTitle>Campsite Management - Campsite Booking</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <!-- Header -->
    <div class="mb-6">
        <MudText Typo="Typo.h3" GutterBottom="true">
            <MudIcon Icon="@Icons.Material.Filled.Terrain" Class="mr-2" />
            Campsite Management
        </MudText>
        <MudText Typo="Typo.body1" Color="Color.Secondary">
            Search for a campsite and manage its accommodation types
        </MudText>
    </div>

    <!-- Campsite Search/Selector -->
    <MudPaper Elevation="3" Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="8">
                <MudAutocomplete T="CampsiteManagementDto"
                                 Value="_selectedCampsite"
                                 Label="Search Campsite"
                                 Variant="Variant.Outlined"
                                 SearchFunc="@SearchCampsites"
                                 ToStringFunc="@(c => c?.Name ?? "")"
                                 ValueChanged="@OnCampsiteSelected"
                                 Clearable="true"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.Search"
                                 Immediate="true"
                                 ResetValueOnEmptyText="true"
                                 CoerceText="false"
                                 CoerceValue="false">
                    <ItemTemplate Context="campsite">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Landscape" Class="mr-2" Color="Color.Primary" Size="Size.Small" />
                            <div>
                                <MudText Typo="Typo.body2"><strong>@campsite.Name</strong></MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@campsite.Region - @campsite.Description</MudText>
                            </div>
                        </div>
                    </ItemTemplate>
                </MudAutocomplete>
            </MudItem>
            <MudItem xs="12" md="4" Class="d-flex align-center">
                @if (_selectedCampsite != null)
                {
                    <MudChip T="string" Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success">
                        Selected: @_selectedCampsite.Name
                    </MudChip>
                }
                else
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                        No campsite selected
                    </MudText>
                }
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Campsite Details Section -->
    @if (_selectedCampsite != null)
    {
        <MudPaper Elevation="3" Class="pa-4 mb-4">
            <div class="d-flex justify-space-between align-center mb-4">
                <MudText Typo="Typo.h5">
                    <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
                    Campsite Details
                </MudText>
            </div>

            <MudGrid>
                <!-- Description Section -->
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle1" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Small" Class="mr-1" />
                        Description
                    </MudText>
                    <MudTextField @bind-Value="_selectedCampsite.Description"
                                  Label="Campsite Description"
                                  Variant="Variant.Outlined"
                                  Lines="4"
                                  Placeholder="Enter a detailed description of the campsite..."
                                  HelperText="Provide information about the campsite location, features, and attractions" />
                </MudItem>

                <!-- Location Coordinates Section -->
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle1" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-1" />
                        Latitude
                    </MudText>
                    <MudNumericField @bind-Value="_selectedCampsite.Latitude"
                                     Label="Latitude"
                                     Variant="Variant.Outlined"
                                     Min="-90"
                                     Max="90"
                                     Step="0.0001"
                                     Placeholder="e.g., 55.6761"
                                     HelperText="Latitude coordinate (-90 to 90)" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle1" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-1" />
                        Longitude
                    </MudText>
                    <MudNumericField @bind-Value="_selectedCampsite.Longitude"
                                     Label="Longitude"
                                     Variant="Variant.Outlined"
                                     Min="-180"
                                     Max="180"
                                     Step="0.0001"
                                     Placeholder="e.g., 12.5683"
                                     HelperText="Longitude coordinate (-180 to 180)" />
                </MudItem>

                <!-- Main Image Section -->
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle1" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Image" Size="Size.Small" Class="mr-1" />
                        Main Image
                    </MudText>
                    <MudTextField @bind-Value="_selectedCampsite.MapImageUrl"
                                  Label="Main Image URL"
                                  Variant="Variant.Outlined"
                                  Placeholder="https://example.com/campsite-image.jpg"
                                  HelperText="URL for the main campsite image" />
                    @if (!string.IsNullOrWhiteSpace(_selectedCampsite.MapImageUrl))
                    {
                        <MudImage Src="@_selectedCampsite.MapImageUrl"
                                  Alt="Campsite Main Image"
                                  Class="mt-2 rounded"
                                  ObjectFit="ObjectFit.Cover"
                                  Height="200"
                                  Style="width: 100%;" />
                    }
                </MudItem>

                <!-- Gallery Images Section -->
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle1" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.PhotoLibrary" Size="Size.Small" Class="mr-1" />
                        Image Gallery
                    </MudText>
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.PhotoLibrary"
                               FullWidth="true"
                               OnClick="@(() => OpenCampsiteGalleryDialog(_selectedCampsite))">
                        Manage Photo Gallery (@(_selectedCampsite.GalleryImages?.Count ?? 0) images)
                    </MudButton>
                </MudItem>

                <!-- Save Button -->
                <MudItem xs="12" Class="d-flex justify-end">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Success"
                               StartIcon="@Icons.Material.Filled.Save"
                               OnClick="@(() => SaveCampsiteDetails(_selectedCampsite))">
                        Save Campsite Details
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>
    }

    <!-- Accommodation Types Tree View -->
    @if (_selectedCampsite != null)
    {
        <MudPaper Elevation="3" Class="pa-4">
            <div class="d-flex justify-space-between align-center mb-4">
                <MudText Typo="Typo.h5">
                    <MudIcon Icon="@Icons.Material.Filled.Cabin" Class="mr-2" />
                    Accommodation Types - @_selectedCampsite.Name
                </MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                           OnClick="OpenAddAccommodationTypeDialog">
                    Add Accommodation Type
                </MudButton>
            </div>

            @if (_loading)
            {
                <div class="d-flex justify-center pa-8">
                    <MudProgressCircular Indeterminate="true" />
                </div>
            }
            else if (!_accommodationTypes.Any())
            {
                <MudAlert Severity="Severity.Info" Class="my-4">
                    No accommodation types found for this campsite. Click "Add Accommodation Type" to create one.
                </MudAlert>
            }
            else
            {
                <!-- Grid of Accommodation Type Cards -->
                <MudGrid>
                    @foreach (var accType in _accommodationTypes.OrderBy(a => a.Type))
                    {
                        <MudItem xs="12">
                            <MudCard Elevation="2" Class="mb-3">
                                <!-- Card Header -->
                                <MudCardHeader>
                                    <CardHeaderContent>
                                        <div class="d-flex align-center justify-space-between" style="width: 100%;">
                                            <div class="d-flex align-center">
                                                <MudIcon Icon="@GetAccommodationIcon(accType)" Class="mr-3" Color="Color.Primary" Size="Size.Large" />
                                                <div>
                                                    <MudText Typo="Typo.h5">@accType.Type</MudText>
                                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                        @accType.Spots.Count spots â€¢ Max @accType.MaxCapacity guests â€¢ @accType.PricePerNight.ToString("C") per night
                                                    </MudText>
                                                </div>
                                            </div>
                                            <div class="d-flex align-center gap-2">
                                                <MudChip T="string" Size="Size.Small" Color="@(accType.IsActive ? Color.Success : Color.Default)">
                                                    @(accType.IsActive ? "Active" : "Inactive")
                                                </MudChip>
                                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                                               OnClick="@(() => DeleteAccommodationType(accType))" />
                                            </div>
                                        </div>
                                    </CardHeaderContent>
                                </MudCardHeader>

                                <!-- Card Content -->
                                <MudCardContent>
                                    <MudGrid>
                                            <!-- Description Section -->
                                            <MudItem xs="12">
                                                <MudText Typo="Typo.subtitle1" Class="mb-2">
                                                    <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Small" Class="mr-1" />
                                                    Description
                                                </MudText>
                                                <MudTextField @bind-Value="accType.Description"
                                                              Label="Description"
                                                              Variant="Variant.Outlined"
                                                              Lines="3"
                                                              FullWidth="true" />
                                            </MudItem>

                                            <!-- Icon Selection -->
                                            <MudItem xs="12">
                                                <MudText Typo="Typo.subtitle1" Class="mb-2">
                                                    <MudIcon Icon="@Icons.Material.Filled.EmojiSymbols" Size="Size.Small" Class="mr-1" />
                                                    Icon
                                                </MudText>
                                                <MudGrid>
                                                    <MudItem xs="12" sm="6">
                                                        <MudSelect T="string" @bind-Value="accType.Icon"
                                                                   Label="Select Icon"
                                                                   Variant="Variant.Outlined"
                                                                   Clearable="true"
                                                                   HelperText="Choose an icon to represent this accommodation type">
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.Cabin">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.Cabin" Class="mr-2" />
                                                                    <span>Cabin</span>
                                                                </div>
                                                            </MudSelectItem>
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.Landscape">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.Landscape" Class="mr-2" />
                                                                    <span>Tent / Landscape</span>
                                                                </div>
                                                            </MudSelectItem>
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.RvHookup">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.RvHookup" Class="mr-2" />
                                                                    <span>RV / Caravan</span>
                                                                </div>
                                                            </MudSelectItem>
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.NightShelter">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.NightShelter" Class="mr-2" />
                                                                    <span>Glamping / Shelter</span>
                                                                </div>
                                                            </MudSelectItem>
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.Home">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.Home" Class="mr-2" />
                                                                    <span>Home / House</span>
                                                                </div>
                                                            </MudSelectItem>
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.Cottage">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.Cottage" Class="mr-2" />
                                                                    <span>Cottage</span>
                                                                </div>
                                                            </MudSelectItem>
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.House">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.House" Class="mr-2" />
                                                                    <span>House</span>
                                                                </div>
                                                            </MudSelectItem>
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.Villa">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.Villa" Class="mr-2" />
                                                                    <span>Villa</span>
                                                                </div>
                                                            </MudSelectItem>
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.Apartment">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.Apartment" Class="mr-2" />
                                                                    <span>Apartment</span>
                                                                </div>
                                                            </MudSelectItem>
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.Bungalow">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.Bungalow" Class="mr-2" />
                                                                    <span>Bungalow</span>
                                                                </div>
                                                            </MudSelectItem>
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.Houseboat">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.Houseboat" Class="mr-2" />
                                                                    <span>Houseboat</span>
                                                                </div>
                                                            </MudSelectItem>
                                                            <MudSelectItem T="string" Value="@Icons.Material.Filled.Park">
                                                                <div class="d-flex align-center">
                                                                    <MudIcon Icon="@Icons.Material.Filled.Park" Class="mr-2" />
                                                                    <span>Park</span>
                                                                </div>
                                                            </MudSelectItem>
                                                        </MudSelect>
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6" Class="d-flex align-center">
                                                        <MudAlert Severity="Severity.Info" Dense="true" Class="flex-grow-1">
                                                            Current icon: <MudIcon Icon="@GetAccommodationIcon(accType)" Class="ml-2" />
                                                        </MudAlert>
                                                    </MudItem>
                                                </MudGrid>
                                            </MudItem>

                                            <!-- Spots Management -->
                                            <MudItem xs="12">
                                                <div class="d-flex justify-space-between align-center mb-2">
                                                    <MudText Typo="Typo.subtitle1">
                                                        <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-1" />
                                                        Accommodation Spots (@accType.Spots.Count)
                                                    </MudText>
                                                    <MudButton Variant="Variant.Filled"
                                                               Color="Color.Primary"
                                                               Size="Size.Small"
                                                               StartIcon="@Icons.Material.Filled.Add"
                                                               OnClick="@(() => AddSpot(accType))">
                                                        Add Spot
                                                    </MudButton>
                                                </div>

                                                @if (accType.Spots.Any())
                                                {
                                                    <MudPaper Elevation="0" Class="pa-3" Style="background-color: #f5f5f5; max-height: 400px; overflow-y: auto;">
                                                        <MudGrid Spacing="2">
                                                            @foreach (var spot in accType.Spots.OrderBy(s => int.TryParse(s.SpotNumber, out var num) ? num : 0))
                                                            {
                                                                <MudItem xs="12" sm="6" md="4">
                                                                    <MudPaper Elevation="2" Class="pa-3">
                                                                        <div class="d-flex justify-space-between align-center mb-2">
                                                                            <MudText Typo="Typo.subtitle2">
                                                                                <MudIcon Icon="@Icons.Material.Filled.Place" Size="Size.Small" Color="Color.Primary" />
                                                                                Spot #@spot.SpotNumber
                                                                            </MudText>
                                                                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                                                           Size="Size.Small"
                                                                                           Color="Color.Error"
                                                                                           OnClick="@(() => RemoveSpot(accType, spot))" />
                                                                        </div>
                                                                        <MudNumericField @bind-Value="spot.Latitude"
                                                                                         Label="Latitude"
                                                                                         Variant="Variant.Outlined"
                                                                                         Margin="Margin.Dense"
                                                                                         Min="-90"
                                                                                         Max="90"
                                                                                         Step="0.0001"
                                                                                         Format="F4" />
                                                                        <MudNumericField @bind-Value="spot.Longitude"
                                                                                         Label="Longitude"
                                                                                         Variant="Variant.Outlined"
                                                                                         Margin="Margin.Dense"
                                                                                         Min="-180"
                                                                                         Max="180"
                                                                                         Step="0.0001"
                                                                                         Format="F4"
                                                                                         Class="mt-2" />
                                                                        <MudSelect @bind-Value="spot.Status"
                                                                                   Label="Status"
                                                                                   Variant="Variant.Outlined"
                                                                                   Margin="Margin.Dense"
                                                                                   Class="mt-2">
                                                                            <MudSelectItem Value="@("Available")">Available</MudSelectItem>
                                                                            <MudSelectItem Value="@("Occupied")">Occupied</MudSelectItem>
                                                                            <MudSelectItem Value="@("Maintenance")">Maintenance</MudSelectItem>
                                                                        </MudSelect>
                                                                    </MudPaper>
                                                                </MudItem>
                                                            }
                                                        </MudGrid>
                                                    </MudPaper>
                                                }
                                                else
                                                {
                                                    <MudAlert Severity="Severity.Info" Dense="true">
                                                        No spots added yet. Click "Add Spot" to create the first spot.
                                                    </MudAlert>
                                                }
                                            </MudItem>

                                            <!-- Pricing & Capacity -->
                                            <MudItem xs="12">
                                                <MudText Typo="Typo.subtitle1" Class="mb-2">
                                                    <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Size="Size.Small" Class="mr-1" />
                                                    Pricing & Capacity
                                                </MudText>
                                                <MudGrid>
                                                    <MudItem xs="12" sm="6">
                                                        <MudNumericField @bind-Value="accType.PricePerNight"
                                                                         Label="Price per Night"
                                                                         Variant="Variant.Outlined"
                                                                         Min="0"
                                                                         Format="C2" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6">
                                                        <MudNumericField @bind-Value="accType.MaxCapacity"
                                                                         Label="Max Guests"
                                                                         Variant="Variant.Outlined"
                                                                         Min="1" />
                                                    </MudItem>
                                                </MudGrid>
                                            </MudItem>

                                            <!-- Pictures Section -->
                                            <MudItem xs="12">
                                                <MudText Typo="Typo.subtitle1" Class="mb-2">
                                                    <MudIcon Icon="@Icons.Material.Filled.Image" Size="Size.Small" Class="mr-1" />
                                                    Pictures
                                                </MudText>
                                                <MudGrid>
                                                    <MudItem xs="12">
                                                        <MudTextField @bind-Value="accType.ImageUrl"
                                                                      Label="Main Image URL"
                                                                      Variant="Variant.Outlined"
                                                                      FullWidth="true" />
                                                    </MudItem>
                                                    @if (!string.IsNullOrWhiteSpace(accType.ImageUrl))
                                                    {
                                                        <MudItem xs="12">
                                                            <MudImage Src="@accType.ImageUrl" Alt="@accType.Type"
                                                                      Height="200" ObjectFit="ObjectFit.Cover" Class="rounded" />
                                                        </MudItem>
                                                    }
                                                    <MudItem xs="12">
                                                        <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                                                                   StartIcon="@Icons.Material.Filled.AddPhotoAlternate"
                                                                   OnClick="@(() => ManageGallery(accType))">
                                                            Manage Photo Gallery (@accType.GalleryImages.Count images)
                                                        </MudButton>
                                                    </MudItem>
                                                </MudGrid>
                                            </MudItem>

                                            <!-- Amenities Section -->
                                            <MudItem xs="12">
                                                <MudText Typo="Typo.subtitle1" Class="mb-2">
                                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Class="mr-1" />
                                                    Amenities
                                                </MudText>
                                                <MudGrid>
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudCheckBox Value="@GetAmenityValue(accType, "WiFi")"
                                                                     Label="WiFi"
                                                                     ValueChanged="@((bool val) => UpdateAmenity(accType, "WiFi", val))" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudCheckBox Value="@GetAmenityValue(accType, "Electric-Hookup")"
                                                                     Label="Electric Hookup"
                                                                     ValueChanged="@((bool val) => UpdateAmenity(accType, "Electric-Hookup", val))" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudCheckBox Value="@GetAmenityValue(accType, "Water-Access")"
                                                                     Label="Water Access"
                                                                     ValueChanged="@((bool val) => UpdateAmenity(accType, "Water-Access", val))" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudCheckBox Value="@GetAmenityValue(accType, "Sewage-Hookup")"
                                                                     Label="Sewage Hookup"
                                                                     ValueChanged="@((bool val) => UpdateAmenity(accType, "Sewage-Hookup", val))" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudCheckBox Value="@GetAmenityValue(accType, "Heating")"
                                                                     Label="Heating"
                                                                     ValueChanged="@((bool val) => UpdateAmenity(accType, "Heating", val))" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudCheckBox Value="@GetAmenityValue(accType, "Air-Conditioning")"
                                                                     Label="Air Conditioning"
                                                                     ValueChanged="@((bool val) => UpdateAmenity(accType, "Air-Conditioning", val))" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudCheckBox Value="@GetAmenityValue(accType, "Fire-Pit")"
                                                                     Label="Fire Pit"
                                                                     ValueChanged="@((bool val) => UpdateAmenity(accType, "Fire-Pit", val))" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudCheckBox Value="@GetAmenityValue(accType, "Picnic-Table")"
                                                                     Label="Picnic Table"
                                                                     ValueChanged="@((bool val) => UpdateAmenity(accType, "Picnic-Table", val))" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudCheckBox Value="@GetAmenityValue(accType, "BBQ-Grill")"
                                                                     Label="BBQ Grill"
                                                                     ValueChanged="@((bool val) => UpdateAmenity(accType, "BBQ-Grill", val))" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudCheckBox Value="@GetAmenityValue(accType, "Pet-Friendly")"
                                                                     Label="Pet Friendly"
                                                                     ValueChanged="@((bool val) => UpdateAmenity(accType, "Pet-Friendly", val))" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudCheckBox Value="@GetAmenityValue(accType, "Kitchen")"
                                                                     Label="Kitchen"
                                                                     ValueChanged="@((bool val) => UpdateAmenity(accType, "Kitchen", val))" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudCheckBox Value="@GetAmenityValue(accType, "Bathroom")"
                                                                     Label="Private Bathroom"
                                                                     ValueChanged="@((bool val) => UpdateAmenity(accType, "Bathroom", val))" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudCheckBox Value="@GetAmenityValue(accType, "Close-To-Playground")"
                                                                     Label="Close to Playground"
                                                                     ValueChanged="@((bool val) => UpdateAmenity(accType, "Close-To-Playground", val))" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudCheckBox Value="@GetAmenityValue(accType, "Senior-Friendly")"
                                                                     Label="Senior Friendly"
                                                                     ValueChanged="@((bool val) => UpdateAmenity(accType, "Senior-Friendly", val))" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudCheckBox Value="@GetAmenityValue(accType, "Handicap-Friendly")"
                                                                     Label="Handicap Friendly"
                                                                     ValueChanged="@((bool val) => UpdateAmenity(accType, "Handicap-Friendly", val))" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudCheckBox Value="@GetAmenityValue(accType, "Oven")"
                                                                     Label="Oven"
                                                                     ValueChanged="@((bool val) => UpdateAmenity(accType, "Oven", val))" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudCheckBox Value="@GetAmenityValue(accType, "Fridge")"
                                                                     Label="Fridge"
                                                                     ValueChanged="@((bool val) => UpdateAmenity(accType, "Fridge", val))" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudCheckBox Value="@GetAmenityValue(accType, "Freezer")"
                                                                     Label="Freezer"
                                                                     ValueChanged="@((bool val) => UpdateAmenity(accType, "Freezer", val))" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudCheckBox Value="@GetAmenityValue(accType, "Deposit-Box")"
                                                                     Label="Deposit Box"
                                                                     ValueChanged="@((bool val) => UpdateAmenity(accType, "Deposit-Box", val))" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudCheckBox Value="@GetAmenityValue(accType, "TV")"
                                                                     Label="TV"
                                                                     ValueChanged="@((bool val) => UpdateAmenity(accType, "TV", val))" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudCheckBox Value="@GetAmenityValue(accType, "Surveilled")"
                                                                     Label="Surveilled"
                                                                     ValueChanged="@((bool val) => UpdateAmenity(accType, "Surveilled", val))" />
                                                    </MudItem>
                                                </MudGrid>
                                            </MudItem>

                                            <!-- Status -->
                                            <MudItem xs="12">
                                                <MudSwitch @bind-Value="accType.IsActive" Color="Color.Success" Label="Active" />
                                            </MudItem>

                                            <!-- Save Button -->
                                            <MudItem xs="12">
                                                <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                                           StartIcon="@Icons.Material.Filled.Save"
                                                           OnClick="@(() => SaveAccommodationType(accType))">
                                                    Save Changes
                                                </MudButton>
                                            </MudItem>
                                        </MudGrid>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>
            }
        </MudPaper>
    }
</MudContainer>

@code {
    private CampsiteManagementDto? _selectedCampsite;
    private List<CampsiteManagementDto> _campsites = new();
    private List<AccommodationTypeDto> _accommodationTypes = new();
    private bool _loading = false;

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("ðŸ”µ OnInitializedAsync called");
        await LoadCampsites();
        Console.WriteLine($"ðŸ”µ Loaded {_campsites.Count} campsites");

        // Auto-select the first campsite to show data immediately
        if (_campsites.Any())
        {
            _selectedCampsite = _campsites.First();
            Console.WriteLine($"ðŸ”µ Auto-selected campsite: {_selectedCampsite.Name} (ID: {_selectedCampsite.Id})");
            await LoadAccommodationTypes(_selectedCampsite.Id);
        }
        else
        {
            Console.WriteLine("ðŸ”´ No campsites found to auto-select");
        }
    }

    private async Task LoadCampsites()
    {
        _loading = true;

        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            var campsites = await context.Campsites.ToListAsync();

            _campsites = campsites.Select(c => new CampsiteManagementDto
            {
                Id = c.Id.Value,
                Name = c.Name ?? "Unknown",
                Region = c.Region ?? "Denmark",
                Description = c.Description ?? "",
                Attractiveness = c.Attractiveness ?? "",
                PhoneNumber = c.PhoneNumber ?? "",
                Email = c.Email?.Value,
                WebsiteUrl = c.WebsiteUrl ?? "",
                TotalSpots = 0, // TODO: Calculate from accommodation spots
                AvailableSpots = 0, // TODO: Calculate from bookings
                Latitude = c.Latitude,
                Longitude = c.Longitude,
                AccommodationTypes = new List<string>(), // TODO: Load from accommodation types
                Amenities = new List<string>(), // TODO: Parse from campsite amenities
                IsActive = c.IsActive,
                MapImageUrl = "", // TODO: Get from campsite photos
                GalleryImages = new List<string>(), // TODO: Load from campsite photos
                InactivePeriods = new List<InactivePeriodDto>()
            }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading campsites: {ex.Message}");
            _campsites = new List<CampsiteManagementDto>();
        }
        finally
        {
            _loading = false;
        }

        _loading = false;
    }

    private async Task<IEnumerable<CampsiteManagementDto>> SearchCampsites(string value, CancellationToken token)
    {
        await Task.Delay(100, token); // Simulate API delay

        if (string.IsNullOrWhiteSpace(value))
            return _campsites;

        return _campsites.Where(c =>
            c.Name.Contains(value, StringComparison.OrdinalIgnoreCase) ||
            c.Region.Contains(value, StringComparison.OrdinalIgnoreCase) ||
            c.Description.Contains(value, StringComparison.OrdinalIgnoreCase));
    }

    private async Task LoadAccommodationTypes(int campsiteId)
    {
        _loading = true;
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load ALL accommodation types from database first (client-side evaluation)
            var allEntities = await context.AccommodationTypes.ToListAsync();

            Console.WriteLine($"ðŸ“Š Loaded {allEntities.Count} total accommodation types from database");

            // Filter by campsite ID in memory (since CampsiteId is a private field)
            var entities = allEntities.Where(a => a.CampsiteId?.Value == campsiteId).ToList();

            Console.WriteLine($"ðŸ“Š Found {entities.Count} accommodation types for campsite {campsiteId}");

            // Convert entities to DTOs with null-safe access
            _accommodationTypes = entities.Select(e => new AccommodationTypeDto
            {
                Id = e.Id?.Value ?? 0,
                CampsiteId = e.CampsiteId?.Value ?? 0,
                Type = e.Type ?? "",
                Description = e.Description ?? "",
                MaxCapacity = e.MaxCapacity,
                PricePerNight = e.BasePrice?.Amount ?? 0m,
                ImageUrl = e.ImageUrl ?? "",
                Icon = "", // Default icon, can be customized later
                Amenities = new List<string>(), // TODO: Load from database if stored
                Spots = new List<AccommodationSpotDto>(), // TODO: Load spots from database
                GalleryImages = new List<string>(),
                IsActive = e.IsActive,
                AvailableUnits = e.AvailableUnits,
                UnitNamingPrefix = "",
                UnitNamingPattern = "Numbers"
            }).ToList();

            Console.WriteLine($"âœ… Loaded {_accommodationTypes.Count} accommodation types for campsite {campsiteId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"âŒ Error loading accommodation types: {ex.Message}");
            Console.WriteLine($"   Stack trace: {ex.StackTrace}");
            if (ex.InnerException != null)
            {
                Console.WriteLine($"   Inner exception: {ex.InnerException.Message}");
            }
            Snackbar.Add($"Error loading accommodation types: {ex.Message}", Severity.Error);
            _accommodationTypes = new List<AccommodationTypeDto>();
        }
        finally
        {
            _loading = false;
        }
    }

    private async void OnCampsiteSelected(CampsiteManagementDto? campsite)
    {
        _selectedCampsite = campsite;
        if (campsite != null)
        {
            await LoadAccommodationTypes(campsite.Id);
        }
        else
        {
            _accommodationTypes.Clear();
        }
        StateHasChanged();
    }

    private async Task SaveCampsiteDetails(CampsiteManagementDto campsite)
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            var campsiteId = CampsiteId.Create(campsite.Id);
            var dbCampsite = await context.Campsites.FirstOrDefaultAsync(c => c.Id == campsiteId);

            if (dbCampsite == null)
            {
                Snackbar.Add($"Campsite not found", Severity.Error);
                return;
            }

            // Parse email if provided
            Email? email = null;
            if (!string.IsNullOrWhiteSpace(campsite.Email))
            {
                try
                {
                    email = Email.Create(campsite.Email);
                }
                catch
                {
                    Snackbar.Add("Invalid email format", Severity.Error);
                    return;
                }
            }

            // Use domain method to update campsite information
            dbCampsite.UpdateInformation(
                campsite.Name,
                campsite.Region,
                campsite.Description,
                campsite.Attractiveness,
                campsite.PhoneNumber ?? string.Empty,
                email,
                campsite.WebsiteUrl ?? string.Empty
            );

            await context.SaveChangesAsync();

            Console.WriteLine($"âœ… Campsite '{campsite.Name}' updated successfully");
            Snackbar.Add($"Campsite details for '{campsite.Name}' saved successfully!", Severity.Success);
        }
        catch (DomainException ex)
        {
            Console.WriteLine($"âŒ Domain error saving campsite: {ex.Message}");
            Snackbar.Add($"Cannot save campsite: {ex.Message}", Severity.Error);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"âŒ Error saving campsite: {ex.Message}");
            Snackbar.Add($"Error saving campsite: {ex.Message}", Severity.Error);
        }
    }

    private async Task OpenCampsiteGalleryDialog(CampsiteManagementDto campsite)
    {
        var parameters = new DialogParameters
        {
            ["Title"] = $"Photo Gallery - {campsite.Name}",
            ["GalleryImages"] = campsite.GalleryImages ?? new List<string>()
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<ManageGalleryDialog>("Manage Photo Gallery", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is List<string> updatedGallery)
        {
            campsite.GalleryImages = updatedGallery;
            Snackbar.Add("Photo gallery updated successfully!", Severity.Success);
            StateHasChanged();
        }
    }

    private async Task OpenAddAccommodationTypeDialog()
    {
        try
        {
            var parameters = new DialogParameters
            {
                ["CampsiteName"] = _selectedCampsite!.Name,
                ["AccommodationType"] = new AccommodationTypeDto { CampsiteId = _selectedCampsite.Id },
                ["IsEdit"] = false
            };

            var options = new DialogOptions
            {
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                CloseButton = true
            };

            var dialog = await DialogService.ShowAsync<CampsiteAccommodationDialog>("Add Accommodation Type", parameters, options);
            var result = await dialog.Result;

            if (!result.Canceled && result.Data is AccommodationTypeDto newAccType)
            {
                // Save to database
                await SaveAccommodationTypeToDatabase(newAccType);

                // Reload accommodation types from database to get the latest data
                await LoadAccommodationTypes(_selectedCampsite!.Id);

                Snackbar.Add($"Accommodation type '{newAccType.Type}' added successfully!", Severity.Success);
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error adding accommodation type: {ex.Message}", Severity.Error);
        }
    }

    private async Task SaveAccommodationTypeToDatabase(AccommodationTypeDto dto)
    {
        try
        {
            Console.WriteLine($"ðŸ’¾ Saving accommodation type to database:");
            Console.WriteLine($"   - Type: {dto.Type}");
            Console.WriteLine($"   - CampsiteId: {dto.CampsiteId}");
            Console.WriteLine($"   - MaxCapacity: {dto.MaxCapacity}");
            Console.WriteLine($"   - PricePerNight: {dto.PricePerNight}");
            Console.WriteLine($"   - AvailableUnits: {dto.AvailableUnits}");

            if (dto.CampsiteId <= 0)
            {
                throw new ArgumentException($"Invalid campsite ID: {dto.CampsiteId}");
            }

            using var context = await DbContextFactory.CreateDbContextAsync();

            // Create the entity using the factory method
            var entity = AccommodationType.Create(
                CampsiteId.Create(dto.CampsiteId),
                dto.Type,
                dto.MaxCapacity,
                Money.Create(dto.PricePerNight, "DKK"),
                dto.AvailableUnits,
                dto.Description,
                dto.ImageUrl
            );

            context.AccommodationTypes.Add(entity);
            await context.SaveChangesAsync();

            // Update the DTO with the generated ID
            dto.Id = entity.Id.Value;

            Console.WriteLine($"âœ… Successfully saved accommodation type with ID: {dto.Id}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"âŒ Error saving to database: {ex.Message}");
            Console.WriteLine($"   Stack trace: {ex.StackTrace}");
            throw;
        }
    }

    private List<AccommodationSpotDto> GenerateSpots(AccommodationTypeDto accType)
    {
        var spots = new List<AccommodationSpotDto>();
        var baseLatitude = _selectedCampsite?.Latitude ?? 55.6761;
        var baseLongitude = _selectedCampsite?.Longitude ?? 12.5683;

        for (int i = 0; i < accType.AvailableUnits; i++)
        {
            string spotName = accType.UnitNamingPattern switch
            {
                "Letters" => $"{(char)('A' + i)}",
                "Numbers" => $"{i + 1}",
                "PrefixNumbers" => $"{accType.UnitNamingPrefix}{i + 1}",
                _ => $"{i + 1}"
            };

            spots.Add(new AccommodationSpotDto
            {
                Id = i + 1,
                Name = spotName,
                IsAvailable = true,
                Latitude = baseLatitude + (i * 0.0001),
                Longitude = baseLongitude + (i * 0.0001)
            });
        }

        return spots;
    }

    private async Task SaveAccommodationType(AccommodationTypeDto accType)
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            var accommodationTypeId = AccommodationTypeId.Create(accType.Id);
            var dbAccommodationType = await context.AccommodationTypes
                .FirstOrDefaultAsync(a => a.Id == accommodationTypeId);

            if (dbAccommodationType == null)
            {
                Snackbar.Add($"Accommodation type not found", Severity.Error);
                return;
            }

            // Update information using domain method
            dbAccommodationType.UpdateInformation(accType.Description, accType.ImageUrl);

            await context.SaveChangesAsync();

            Console.WriteLine($"âœ… Accommodation type '{accType.Type}' updated successfully");
            Snackbar.Add($"Changes to '{accType.Type}' saved successfully!", Severity.Success);
        }
        catch (DomainException ex)
        {
            Console.WriteLine($"âŒ Domain error saving accommodation type: {ex.Message}");
            Snackbar.Add($"Cannot save accommodation type: {ex.Message}", Severity.Error);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"âŒ Error saving accommodation type: {ex.Message}");
            Snackbar.Add($"Error saving accommodation type: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteAccommodationType(AccommodationTypeDto accType)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirm Delete",
            $"Are you sure you want to delete the accommodation type '{accType.Type}'? This action cannot be undone.",
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                using var context = await DbContextFactory.CreateDbContextAsync();

                var accommodationTypeId = AccommodationTypeId.Create(accType.Id);
                var dbAccommodationType = await context.AccommodationTypes
                    .FirstOrDefaultAsync(a => a.Id == accommodationTypeId);

                if (dbAccommodationType == null)
                {
                    Snackbar.Add($"Accommodation type not found", Severity.Error);
                    return;
                }

                // Remove from database
                context.AccommodationTypes.Remove(dbAccommodationType);
                await context.SaveChangesAsync();

                // Remove from in-memory list
                _accommodationTypes.Remove(accType);

                Console.WriteLine($"âœ… Accommodation type '{accType.Type}' deleted successfully");
                Snackbar.Add($"Accommodation type '{accType.Type}' deleted successfully!", Severity.Success);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"âŒ Error deleting accommodation type: {ex.Message}");
                Snackbar.Add($"Error deleting accommodation type: {ex.Message}", Severity.Error);
            }
        }
    }

    private void ManageGallery(AccommodationTypeDto accType)
    {
        // This would open a dialog to manage the photo gallery
        Snackbar.Add("Photo gallery management coming soon!", Severity.Info);
    }

    private bool GetAmenityValue(AccommodationTypeDto accType, string amenity)
    {
        return accType.Amenities.Contains(amenity);
    }

    private void UpdateAmenity(AccommodationTypeDto accType, string amenity, bool value)
    {
        if (value && !accType.Amenities.Contains(amenity))
        {
            accType.Amenities.Add(amenity);
        }
        else if (!value && accType.Amenities.Contains(amenity))
        {
            accType.Amenities.Remove(amenity);
        }
    }

    private void AddSpot(AccommodationTypeDto accType)
    {
        // Get the next spot number
        var nextNumber = 1;
        if (accType.Spots.Any())
        {
            var maxNumber = accType.Spots
                .Select(s => int.TryParse(s.SpotNumber, out var num) ? num : 0)
                .Max();
            nextNumber = maxNumber + 1;
        }

        // Use campsite coordinates as default, with small offset for each spot
        var baseLatitude = _selectedCampsite?.Latitude ?? 56.2639;
        var baseLongitude = _selectedCampsite?.Longitude ?? 10.4515;

        // Add small offset to spread spots around the campsite (0.0001 degrees â‰ˆ 11 meters)
        var offset = (nextNumber - 1) * 0.0001;

        var newSpot = new AccommodationSpotDto
        {
            Id = 0, // Will be assigned by backend
            SpotNumber = nextNumber.ToString(),
            Latitude = baseLatitude + offset,
            Longitude = baseLongitude + offset,
            Status = "Available"
        };

        accType.Spots.Add(newSpot);
        Snackbar.Add($"Spot #{nextNumber} added to {accType.Type}", Severity.Success);
        StateHasChanged();
    }

    private async Task RemoveSpot(AccommodationTypeDto accType, AccommodationSpotDto spot)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirm Delete",
            $"Are you sure you want to remove Spot #{spot.SpotNumber}? This action cannot be undone.",
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                using var context = await DbContextFactory.CreateDbContextAsync();

                var accommodationSpotId = AccommodationSpotId.Create(spot.Id);
                var dbSpot = await context.AccommodationSpots
                    .FirstOrDefaultAsync(s => s.Id == accommodationSpotId);

                if (dbSpot != null)
                {
                    // Remove from database
                    context.AccommodationSpots.Remove(dbSpot);
                    await context.SaveChangesAsync();
                    Console.WriteLine($"âœ… Spot #{spot.SpotNumber} deleted from database");
                }

                // Remove from in-memory list
                accType.Spots.Remove(spot);
                Snackbar.Add($"Spot #{spot.SpotNumber} removed from {accType.Type}", Severity.Success);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"âŒ Error removing spot: {ex.Message}");
                Snackbar.Add($"Error removing spot: {ex.Message}", Severity.Error);
            }
        }
    }

    private List<AccommodationSpotDto> GenerateSampleSpots(int count, double baseLatitude, double baseLongitude, double baseOffset)
    {
        var spots = new List<AccommodationSpotDto>();
        for (int i = 1; i <= count; i++)
        {
            // Create a grid-like pattern for spots
            var row = (i - 1) / 5; // 5 spots per row
            var col = (i - 1) % 5;

            spots.Add(new AccommodationSpotDto
            {
                Id = i,
                SpotNumber = i.ToString(),
                Latitude = baseLatitude + baseOffset + (row * 0.0001),
                Longitude = baseLongitude + baseOffset + (col * 0.0001),
                Status = "Available"
            });
        }
        return spots;
    }



    private string GetAccommodationIcon(AccommodationTypeDto accType)
    {
        // Use custom icon if set, otherwise fall back to type-based icon
        if (!string.IsNullOrEmpty(accType.Icon))
            return accType.Icon;

        return accType.Type.ToLower() switch
        {
            "cabin" => Icons.Material.Filled.Cabin,
            "tent site" or "tent" => Icons.Material.Filled.Landscape,
            "rv spot" or "rv" or "caravan" => Icons.Material.Filled.RvHookup,
            "glamping" => Icons.Material.Filled.NightShelter,
            _ => Icons.Material.Filled.Home
        };
    }



    // DTOs
    private class CampsiteManagementDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Region { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string Attractiveness { get; set; } = string.Empty;
        public string? PhoneNumber { get; set; }
        public string? Email { get; set; }
        public string? WebsiteUrl { get; set; }
        public int TotalSpots { get; set; }
        public int AvailableSpots { get; set; }
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public List<string> AccommodationTypes { get; set; } = new();
        public List<string> Amenities { get; set; } = new();
        public bool IsActive { get; set; }
        public string MapImageUrl { get; set; } = string.Empty;
        public List<string> GalleryImages { get; set; } = new();
        public List<InactivePeriodDto> InactivePeriods { get; set; } = new();
    }

    private class InactivePeriodDto
    {
        public int Id { get; set; }
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public string Reason { get; set; } = string.Empty;
        public string Type { get; set; } = "EntireCampsite"; // "EntireCampsite" or "SpecificSpots"
        public List<string> AffectedSpotIds { get; set; } = new();
    }
}
