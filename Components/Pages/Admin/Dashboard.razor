@page "/admin/dashboard"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin,Staff")]
@inject IDbContextFactory<CampsiteBookingDbContext> DbContextFactory
@inject ISnackbar Snackbar
@using CampsiteBooking.Data
@using CampsiteBooking.Models
@using CampsiteBooking.Models.ValueObjects
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization

<PageTitle>Admin Dashboard - Campsite Booking</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h3" GutterBottom="true">
        <MudIcon Icon="@Icons.Material.Filled.Dashboard" Class="mr-2" />
        Admin Dashboard
    </MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-6">
        Overview of your campsite booking system
    </MudText>

    <!-- Key Metrics Cards -->
    <MudGrid>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="3">
                <MudCardContent>
                    <div class="d-flex justify-space-between align-center">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Total Bookings</MudText>
                            <MudText Typo="Typo.h4">@_totalBookings</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Success">
                                <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Small" />
                                +12% vs last year
                            </MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.BookOnline" Color="Color.Primary" Size="Size.Large" />
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="3">
                <MudCardContent>
                    <div class="d-flex justify-space-between align-center">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Revenue (This Month)</MudText>
                            <MudText Typo="Typo.h4">$@_revenue.ToString("N0")</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Success">
                                <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Small" />
                                +8% vs last year
                            </MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Color="Color.Success" Size="Size.Large" />
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="3">
                <MudCardContent>
                    <div class="d-flex justify-space-between align-center">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Occupancy Rate</MudText>
                            <MudText Typo="Typo.h4">@_occupancyRate%</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Info">
                                <MudIcon Icon="@Icons.Material.Filled.TrendingFlat" Size="Size.Small" />
                                Same as last year
                            </MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.Hotel" Color="Color.Info" Size="Size.Large" />
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="3">
                <MudCardContent>
                    <div class="d-flex justify-space-between align-center">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Active Campsites</MudText>
                            <MudText Typo="Typo.h4">@_activeCampsites</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Default">
                                <MudIcon Icon="@Icons.Material.Filled.Landscape" Size="Size.Small" />
                                Across Denmark
                            </MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.Terrain" Color="Color.Warning" Size="Size.Large" />
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Charts and Recent Activity -->
    <MudGrid Class="mt-6">
        <!-- Booking Trends Chart -->
        <MudItem xs="12" md="8">
            <MudCard Elevation="3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Booking Trends (Last 6 Months)</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (_bookingTrendsData.Any())
                    {
                        <MudChart ChartType="ChartType.Line"
                                  ChartSeries="@_chartSeries"
                                  XAxisLabels="@_xAxisLabels"
                                  Width="100%"
                                  Height="300px"
                                  ChartOptions="@_chartOptions">
                        </MudChart>
                    }
                    else
                    {
                        <div style="height: 300px; display: flex; align-items: center; justify-content: center; background: #f5f5f5; border-radius: 4px;">
                            <MudText Typo="Typo.body1" Color="Color.Secondary">
                                <MudIcon Icon="@Icons.Material.Filled.ShowChart" Class="mr-2" />
                                No booking data available for the last 6 months
                            </MudText>
                        </div>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Quick Stats -->
        <MudItem xs="12" md="4">
            <MudCard Elevation="3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Quick Stats</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudList T="string" Dense="true">
                        <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success">
                            <MudText>Confirmed: <strong>@_confirmedBookings</strong></MudText>
                        </MudListItem>
                        <MudListItem T="string" Icon="@Icons.Material.Filled.Pending" IconColor="Color.Warning">
                            <MudText>Pending: <strong>@_pendingBookings</strong></MudText>
                        </MudListItem>
                        <MudListItem T="string" Icon="@Icons.Material.Filled.Cancel" IconColor="Color.Error">
                            <MudText>Cancelled: <strong>@_cancelledBookings</strong></MudText>
                        </MudListItem>
                        <MudDivider Class="my-2" />
                        <MudListItem T="string" Icon="@Icons.Material.Filled.People" IconColor="Color.Primary">
                            <MudText>Total Users: <strong>@_totalUsers</strong></MudText>
                        </MudListItem>
                        <MudListItem T="string" Icon="@Icons.Material.Filled.PersonAdd" IconColor="Color.Info">
                            <MudText>New This Month: <strong>@_newUsers</strong></MudText>
                        </MudListItem>
                    </MudList>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>



</MudContainer>

@code {
    private bool _isLoading = true;

    // Metrics loaded from database
    private int _totalBookings = 0;
    private decimal _revenue = 0;
    private int _occupancyRate = 0;
    private int _activeCampsites = 0;
    private int _confirmedBookings = 0;
    private int _pendingBookings = 0;
    private int _cancelledBookings = 0;
    private int _totalUsers = 0;
    private int _newUsers = 0;

    // Booking trends chart data
    private List<ChartSeries> _chartSeries = new();
    private string[] _xAxisLabels = Array.Empty<string>();
    private Dictionary<string, int> _bookingTrendsData = new();
    private ChartOptions _chartOptions = new ChartOptions
    {
        YAxisTicks = 10,
        MaxNumYAxisTicks = 10,
        YAxisLines = true,
        XAxisLines = false,
        LineStrokeWidth = 3
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardMetrics();
        await LoadBookingTrends();
        _isLoading = false;
    }

    private async Task LoadDashboardMetrics()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load all bookings
            var allBookings = await context.Bookings.ToListAsync();
            _totalBookings = allBookings.Count;

            // Calculate revenue (sum of all booking amounts)
            _revenue = allBookings.Sum(b => b.TotalPrice?.Amount ?? 0m);

            // Count bookings by status
            _confirmedBookings = allBookings.Count(b => b.Status == BookingStatus.Confirmed);
            _pendingBookings = allBookings.Count(b => b.Status == BookingStatus.Pending);
            _cancelledBookings = allBookings.Count(b => b.Status == BookingStatus.Cancelled);

            // Count active campsites (load all first for client-side evaluation)
            var allCampsites = await context.Campsites.ToListAsync();
            _activeCampsites = allCampsites.Count(c => c.IsActive);

            // Count total users
            _totalUsers = await context.Users.CountAsync();

            // Count new users this month (load all users first for client-side evaluation)
            var startOfMonth = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
            var allUsers = await context.Users.ToListAsync();
            _newUsers = allUsers.Count(u => u.JoinedDate >= startOfMonth);

            // Calculate occupancy rate
            // Total accommodation types * 30 days = total available spot-days
            var totalAccommodationTypes = await context.AccommodationTypes.CountAsync();
            var totalAvailableSpotDays = totalAccommodationTypes * 30;

            // Total booked days this month
            var startOfThisMonth = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
            var endOfThisMonth = startOfThisMonth.AddMonths(1);

            var bookingsThisMonth = allBookings
                .Where(b => b.Period != null &&
                           b.Period.StartDate < endOfThisMonth &&
                           b.Period.EndDate > startOfThisMonth &&
                           (b.Status == BookingStatus.Confirmed || b.Status == BookingStatus.Pending))
                .ToList();

            var totalBookedDays = bookingsThisMonth.Sum(b =>
            {
                var start = b.Period!.StartDate < startOfThisMonth ? startOfThisMonth : b.Period.StartDate;
                var end = b.Period.EndDate > endOfThisMonth ? endOfThisMonth : b.Period.EndDate;
                return (end - start).Days;
            });

            _occupancyRate = totalAvailableSpotDays > 0
                ? (int)((totalBookedDays / (double)totalAvailableSpotDays) * 100)
                : 0;

            Console.WriteLine($"✅ Dashboard metrics loaded:");
            Console.WriteLine($"   Total Bookings: {_totalBookings}");
            Console.WriteLine($"   Revenue: ${_revenue:N2}");
            Console.WriteLine($"   Occupancy Rate: {_occupancyRate}%");
            Console.WriteLine($"   Active Campsites: {_activeCampsites}");
            Console.WriteLine($"   Confirmed: {_confirmedBookings}, Pending: {_pendingBookings}, Cancelled: {_cancelledBookings}");
            Console.WriteLine($"   Total Users: {_totalUsers}, New This Month: {_newUsers}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error loading dashboard metrics: {ex.Message}");
            Snackbar.Add($"Error loading dashboard metrics: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadBookingTrends()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Get bookings from the last 6 months
            var sixMonthsAgo = DateTime.Now.AddMonths(-6);
            var allBookings = await context.Bookings
                .Where(b => b.CreatedDate >= sixMonthsAgo)
                .ToListAsync();

            // Group bookings by month and count them
            _bookingTrendsData = allBookings
                .GroupBy(b => new DateTime(b.CreatedDate.Year, b.CreatedDate.Month, 1))
                .OrderBy(g => g.Key)
                .ToDictionary(
                    g => g.Key.ToString("MMM yyyy"),
                    g => g.Count()
                );

            // Fill in missing months with 0 bookings
            var currentMonth = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
            var filledData = new Dictionary<string, int>();

            for (int i = 5; i >= 0; i--)
            {
                var month = currentMonth.AddMonths(-i);
                var monthKey = month.ToString("MMM yyyy");
                filledData[monthKey] = _bookingTrendsData.ContainsKey(monthKey) ? _bookingTrendsData[monthKey] : 0;
            }

            _bookingTrendsData = filledData;

            // Prepare chart data
            _xAxisLabels = _bookingTrendsData.Keys.ToArray();
            var bookingCounts = _bookingTrendsData.Values.Select(v => (double)v).ToArray();

            _chartSeries = new List<ChartSeries>
            {
                new ChartSeries
                {
                    Name = "Bookings",
                    Data = bookingCounts
                }
            };

            Console.WriteLine($"✅ Booking trends loaded: {_bookingTrendsData.Count} months of data");
            foreach (var kvp in _bookingTrendsData)
            {
                Console.WriteLine($"   {kvp.Key}: {kvp.Value} bookings");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error loading booking trends: {ex.Message}");
            Snackbar.Add($"Error loading booking trends: {ex.Message}", Severity.Error);
        }
    }
}

