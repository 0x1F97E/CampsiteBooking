@page "/admin/dashboard"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin,Staff")]
@inject IDashboardService DashboardService
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@using CampsiteBooking.Services
@using Microsoft.AspNetCore.Authorization
@using ClosedXML.Excel

<PageTitle>Analytics Dashboard - Campsite Booking</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h3" GutterBottom="true">
        <MudIcon Icon="@Icons.Material.Filled.Analytics" Class="mr-2" />
        Analytics Dashboard
    </MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
        View and export campsite booking analytics
    </MudText>

    <!-- Filter Controls -->
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="3">
                <MudSelect T="int" Label="Campsite" MultiSelection="true" @bind-SelectedValues="_selectedCampsiteIds"
                           Variant="Variant.Outlined" Placeholder="All Campsites" Clearable="true">
                    @foreach (var campsite in _availableCampsites)
                    {
                        <MudSelectItem T="int" Value="@campsite.Id">@campsite.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudSelect T="int" Label="Years" MultiSelection="true" @bind-SelectedValues="_selectedYears"
                           Variant="Variant.Outlined" Placeholder="Select years">
                    @foreach (var year in _availableYears)
                    {
                        <MudSelectItem T="int" Value="@year">@year</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudSelect T="string" Label="Season" MultiSelection="true" @bind-SelectedValues="_selectedSeasons"
                           Variant="Variant.Outlined" Placeholder="All Seasons" Clearable="true">
                    @foreach (var season in _availableSeasons)
                    {
                        <MudSelectItem T="string" Value="@season">@season</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="3" Class="d-flex align-center">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Refresh"
                           OnClick="ApplyFilters" Disabled="@_isLoading" FullWidth="true">
                    @if (_isLoading) { <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" /> }
                    Apply
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Metric Tabs -->
    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Class="mb-4" @bind-ActivePanelIndex="_activeTab">
        <MudTabPanel Text="Bookings" Icon="@Icons.Material.Filled.BookOnline" />
        <MudTabPanel Text="Revenue" Icon="@Icons.Material.Filled.AttachMoney" />
        <MudTabPanel Text="Length of Stay" Icon="@Icons.Material.Filled.Schedule" />
        <MudTabPanel Text="Guest Countries" Icon="@Icons.Material.Filled.Public" />
        <MudTabPanel Text="New Users" Icon="@Icons.Material.Filled.PersonAdd" />
    </MudTabs>

    <!-- Chart Display Area -->
    <MudPaper Elevation="2" Class="pa-4">
        <div class="d-flex justify-space-between align-center mb-4">
            <MudText Typo="Typo.h6">@GetCurrentTabTitle()</MudText>
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Download"
                       OnClick="DownloadExcel" Disabled="@_isLoading">
                Download Excel
            </MudButton>
        </div>

        @if (_isLoading)
        {
            <div class="d-flex justify-center pa-8">
                <MudProgressCircular Indeterminate="true" Size="Size.Large" />
            </div>
        }
        else
        {
            @switch (_activeTab)
            {
                case 0: <!-- Bookings -->
                    <MudChart ChartType="ChartType.Bar" ChartSeries="@_bookingChartSeries" XAxisLabels="@_chartXAxisLabels"
                              Width="100%" Height="400px" ChartOptions="@_chartOptions" />
                    <MudText Typo="Typo.body2" Class="mt-2" Color="Color.Secondary">
                        Total: @_bookingStats?.TotalBookings.ToString("N0") bookings
                    </MudText>
                    break;
                case 1: <!-- Revenue -->
                    <MudChart ChartType="ChartType.Bar" ChartSeries="@_revenueChartSeries" XAxisLabels="@_chartXAxisLabels"
                              Width="100%" Height="400px" ChartOptions="@_chartOptions" />
                    <MudText Typo="Typo.body2" Class="mt-2" Color="Color.Secondary">
                        Total: @_revenueStats?.TotalRevenue.ToString("C0")
                    </MudText>
                    break;
                case 2: <!-- Length of Stay -->
                    <MudChart ChartType="ChartType.Bar" ChartSeries="@_lengthOfStayChartSeries" XAxisLabels="@_lengthOfStayXAxisLabels"
                              Width="100%" Height="400px" ChartOptions="@_chartOptions" />
                    <MudText Typo="Typo.body2" Class="mt-2" Color="Color.Secondary">
                        Average: @(_lengthOfStayStats?.AverageNights.ToString("F1") ?? "0") nights
                    </MudText>
                    break;
                case 3: <!-- Guest Countries (Pillar chart - single series) -->
                    <MudChart ChartType="ChartType.Bar" ChartSeries="@_countryChartSeries" XAxisLabels="@_countryXAxisLabels"
                              Width="100%" Height="400px" ChartOptions="@_chartOptions" />
                    <MudText Typo="Typo.body2" Class="mt-2" Color="Color.Secondary">
                        Total guests: @_countryStats?.TotalGuests.ToString("N0")
                    </MudText>
                    break;
                case 4: <!-- New Users -->
                    <MudChart ChartType="ChartType.Bar" ChartSeries="@_newUserChartSeries" XAxisLabels="@_chartXAxisLabels"
                              Width="100%" Height="400px" ChartOptions="@_chartOptions" />
                    <MudText Typo="Typo.body2" Class="mt-2" Color="Color.Secondary">
                        Total: @_newUserStats?.TotalNewUsers.ToString("N0") new users
                    </MudText>
                    break;
            }
        }
    </MudPaper>
</MudContainer>

@code {
    private bool _isLoading = true;
    private int _activeTab = 0;

    // Filter options
    private List<CampsiteInfo> _availableCampsites = new();
    private List<int> _availableYears = new();
    private List<string> _availableSeasons = new();

    // Selected filters
    private IEnumerable<int> _selectedCampsiteIds = new List<int>();
    private IEnumerable<int> _selectedYears = new List<int>();
    private IEnumerable<string> _selectedSeasons = new List<string>();

    // Stats data
    private BookingStats? _bookingStats;
    private RevenueStats? _revenueStats;
    private LengthOfStayStats? _lengthOfStayStats;
    private CountryStats? _countryStats;
    private NewUserStats? _newUserStats;

    // Chart data
    private List<ChartSeries> _bookingChartSeries = new();
    private List<ChartSeries> _revenueChartSeries = new();
    private List<ChartSeries> _lengthOfStayChartSeries = new();
    private List<ChartSeries> _countryChartSeries = new();
    private List<ChartSeries> _newUserChartSeries = new();

    private string[] _chartXAxisLabels = Array.Empty<string>();
    private string[] _lengthOfStayXAxisLabels = Array.Empty<string>();
    private string[] _countryXAxisLabels = Array.Empty<string>();

    private static readonly string[] MonthLabels = { "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec" };

    private ChartOptions _chartOptions = new() { YAxisTicks = 5, MaxNumYAxisTicks = 10, YAxisLines = true, XAxisLines = false };

    protected override async Task OnInitializedAsync()
    {
        await LoadFilterOptionsAsync();
        await LoadDashboardDataAsync();
    }

    private async Task LoadFilterOptionsAsync()
    {
        try
        {
            _availableCampsites = await DashboardService.GetCampsitesAsync();
            _availableYears = await DashboardService.GetAvailableYearsAsync();
            _availableSeasons = await DashboardService.GetAvailableSeasonsAsync();

            // Default to current year
            var currentYear = DateTime.Now.Year;
            if (_availableYears.Contains(currentYear))
                _selectedYears = new List<int> { currentYear };
            else if (_availableYears.Any())
                _selectedYears = new List<int> { _availableYears.First() };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading filters: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadDashboardDataAsync()
    {
        try
        {
            _isLoading = true;
            StateHasChanged();

            var filter = new DashboardFilter
            {
                CampsiteIds = _selectedCampsiteIds.ToList(),
                Years = _selectedYears.ToList(),
                Seasons = _selectedSeasons.ToList()
            };

            // Load all data in parallel using separate task variables
            var bookingTask = DashboardService.GetBookingStatsAsync(filter);
            var revenueTask = DashboardService.GetRevenueStatsAsync(filter);
            var lengthOfStayTask = DashboardService.GetLengthOfStayStatsAsync(filter);
            var countryTask = DashboardService.GetCountryStatsAsync(filter);
            var newUserTask = DashboardService.GetNewUserStatsAsync(filter);

            await Task.WhenAll(bookingTask, revenueTask, lengthOfStayTask, countryTask, newUserTask);

            _bookingStats = bookingTask.Result;
            _revenueStats = revenueTask.Result;
            _lengthOfStayStats = lengthOfStayTask.Result;
            _countryStats = countryTask.Result;
            _newUserStats = newUserTask.Result;

            PrepareCharts();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void PrepareCharts()
    {
        _chartXAxisLabels = MonthLabels;

        // Bookings - comparative by year
        _bookingChartSeries = _selectedYears.OrderBy(y => y).Select(year => new ChartSeries
        {
            Name = year.ToString(),
            Data = MonthLabels.Select((_, i) => (double)(_bookingStats?.MonthlyData
                .Where(d => d.Year == year && d.Month == i + 1)
                .Sum(d => d.BookingCount) ?? 0)).ToArray()
        }).ToList();

        // Revenue - comparative by year
        _revenueChartSeries = _selectedYears.OrderBy(y => y).Select(year => new ChartSeries
        {
            Name = year.ToString(),
            Data = MonthLabels.Select((_, i) => (double)(_revenueStats?.MonthlyData
                .Where(d => d.Year == year && d.Month == i + 1)
                .Sum(d => d.Revenue) ?? 0)).ToArray()
        }).ToList();

        // Length of Stay - non-comparative
        _lengthOfStayXAxisLabels = _lengthOfStayStats?.Distribution.Select(d => d.Category).ToArray() ?? Array.Empty<string>();
        _lengthOfStayChartSeries = new List<ChartSeries>
        {
            new() { Name = "Bookings", Data = _lengthOfStayStats?.Distribution.Select(d => (double)d.Count).ToArray() ?? Array.Empty<double>() }
        };

        // Countries - pillar chart (single series, not comparative)
        _countryXAxisLabels = _countryStats?.Distribution.Select(d => d.Country).ToArray() ?? Array.Empty<string>();
        _countryChartSeries = new List<ChartSeries>
        {
            new() { Name = "Guests", Data = _countryStats?.Distribution.Select(d => (double)d.Count).ToArray() ?? Array.Empty<double>() }
        };

        // New Users - comparative by year
        _newUserChartSeries = _selectedYears.OrderBy(y => y).Select(year => new ChartSeries
        {
            Name = year.ToString(),
            Data = MonthLabels.Select((_, i) => (double)(_newUserStats?.MonthlyData
                .Where(d => d.Year == year && d.Month == i + 1)
                .Sum(d => d.NewUserCount) ?? 0)).ToArray()
        }).ToList();
    }

    private async Task ApplyFilters() => await LoadDashboardDataAsync();

    private string GetCurrentTabTitle() => _activeTab switch
    {
        0 => "Bookings by Month",
        1 => "Revenue by Month",
        2 => "Length of Stay Distribution",
        3 => "Guest Countries",
        4 => "New User Registrations",
        _ => "Analytics"
    };

    private async Task DownloadExcel()
    {
        try
        {
            using var workbook = new XLWorkbook();
            var filterDesc = $"Years: {string.Join(", ", _selectedYears)}";

            switch (_activeTab)
            {
                case 0: AddBookingsSheet(workbook); break;
                case 1: AddRevenueSheet(workbook); break;
                case 2: AddLengthOfStaySheet(workbook); break;
                case 3: AddCountrySheet(workbook); break;
                case 4: AddNewUsersSheet(workbook); break;
            }

            using var stream = new MemoryStream();
            workbook.SaveAs(stream);
            var fileName = $"Dashboard_{GetCurrentTabTitle().Replace(" ", "_")}_{DateTime.Now:yyyyMMdd}.xlsx";

            await JS.InvokeVoidAsync("downloadFileFromStream", fileName, Convert.ToBase64String(stream.ToArray()));
            Snackbar.Add("Excel file downloaded!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating Excel: {ex.Message}", Severity.Error);
        }
    }

    private void AddBookingsSheet(XLWorkbook wb)
    {
        var ws = wb.Worksheets.Add("Bookings");
        ws.Cell(1, 1).Value = "Year"; ws.Cell(1, 2).Value = "Month"; ws.Cell(1, 3).Value = "Bookings";
        var row = 2;
        foreach (var d in _bookingStats?.MonthlyData ?? new())
        {
            ws.Cell(row, 1).Value = d.Year; ws.Cell(row, 2).Value = d.MonthName; ws.Cell(row, 3).Value = d.BookingCount;
            row++;
        }
        ws.Columns().AdjustToContents();
    }

    private void AddRevenueSheet(XLWorkbook wb)
    {
        var ws = wb.Worksheets.Add("Revenue");
        ws.Cell(1, 1).Value = "Year"; ws.Cell(1, 2).Value = "Month"; ws.Cell(1, 3).Value = "Revenue";
        var row = 2;
        foreach (var d in _revenueStats?.MonthlyData ?? new())
        {
            ws.Cell(row, 1).Value = d.Year; ws.Cell(row, 2).Value = d.MonthName; ws.Cell(row, 3).Value = d.Revenue;
            row++;
        }
        ws.Columns().AdjustToContents();
    }

    private void AddLengthOfStaySheet(XLWorkbook wb)
    {
        var ws = wb.Worksheets.Add("Length of Stay");
        ws.Cell(1, 1).Value = "Category"; ws.Cell(1, 2).Value = "Count";
        var row = 2;
        foreach (var d in _lengthOfStayStats?.Distribution ?? new())
        {
            ws.Cell(row, 1).Value = d.Category; ws.Cell(row, 2).Value = d.Count;
            row++;
        }
        ws.Columns().AdjustToContents();
    }

    private void AddCountrySheet(XLWorkbook wb)
    {
        var ws = wb.Worksheets.Add("Countries");
        ws.Cell(1, 1).Value = "Country"; ws.Cell(1, 2).Value = "Guests"; ws.Cell(1, 3).Value = "Percentage";
        var row = 2;
        foreach (var d in _countryStats?.Distribution ?? new())
        {
            ws.Cell(row, 1).Value = d.Country; ws.Cell(row, 2).Value = d.Count; ws.Cell(row, 3).Value = $"{d.Percentage:F1}%";
            row++;
        }
        ws.Columns().AdjustToContents();
    }

    private void AddNewUsersSheet(XLWorkbook wb)
    {
        var ws = wb.Worksheets.Add("New Users");
        ws.Cell(1, 1).Value = "Year"; ws.Cell(1, 2).Value = "Month"; ws.Cell(1, 3).Value = "New Users";
        var row = 2;
        foreach (var d in _newUserStats?.MonthlyData ?? new())
        {
            ws.Cell(row, 1).Value = d.Year; ws.Cell(row, 2).Value = d.MonthName; ws.Cell(row, 3).Value = d.NewUserCount;
            row++;
        }
        ws.Columns().AdjustToContents();
    }
}
