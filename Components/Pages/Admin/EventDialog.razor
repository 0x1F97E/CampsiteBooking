@rendermode InteractiveServer
@using CampsiteBooking.Data
@using CampsiteBooking.Models
@using CampsiteBooking.Models.Common
@using CampsiteBooking.Models.ValueObjects
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<CampsiteBookingDbContext> DbContextFactory
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudGrid>
            <MudItem xs="12">
                <MudTextField @bind-Value="_name" 
                             Label="Event Name" 
                             Variant="Variant.Outlined"
                             Required="true" />
            </MudItem>

            <MudItem xs="12">
                <MudTextField @bind-Value="_description" 
                             Label="Description" 
                             Variant="Variant.Outlined"
                             Lines="3"
                             Required="true" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudSelect T="int"
                          @bind-Value="_selectedCampsiteId"
                          Label="Campsite"
                          Variant="Variant.Outlined"
                          Required="true">
                    @foreach (var campsite in _campsites)
                    {
                        <MudSelectItem T="int" Value="@campsite.Id">@campsite.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudSelect T="string" 
                          @bind-Value="_category" 
                          Label="Category" 
                          Variant="Variant.Outlined"
                          Required="true">
                    <MudSelectItem T="string" Value="@("Sports")">Sports</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Kids")">Kids</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Entertainment")">Entertainment</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Nature")">Nature</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Wellness")">Wellness</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Food & Dining")">Food & Dining</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Workshop")">Workshop</MudSelectItem>
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudDatePicker @bind-Date="_eventDate" 
                              Label="Event Date" 
                              Variant="Variant.Outlined"
                              MinDate="DateTime.Today"
                              Required="true" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTimePicker @bind-Time="_eventTime" 
                              Label="Event Time" 
                              Variant="Variant.Outlined"
                              Required="true" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudNumericField @bind-Value="_maxCapacity" 
                                Label="Max Capacity" 
                                Variant="Variant.Outlined"
                                Min="0"
                                HelperText="Set to 0 for unlimited capacity" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudSelect T="string" 
                          @bind-Value="_status" 
                          Label="Status" 
                          Variant="Variant.Outlined"
                          Required="true">
                    <MudSelectItem T="string" Value="@("Open")">Open</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Full")">Full</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Cancelled")">Cancelled</MudSelectItem>
                </MudSelect>
            </MudItem>

            <MudItem xs="12">
                <MudTextField @bind-Value="_eventLink"
                             Label="Event Link (Optional)"
                             Variant="Variant.Outlined"
                             Placeholder="e.g., https://facebook.com/events/123456"
                             HelperText="Link to Facebook event or external registration page" />
            </MudItem>

            <MudItem xs="12">
                <MudTextField @bind-Value="_location"
                             Label="Location (Optional)"
                             Variant="Variant.Outlined"
                             Placeholder="e.g., Main Beach Area, Activity Center" />
            </MudItem>

            <MudItem xs="12">
                <MudTextField @bind-Value="_notes"
                             Label="Additional Notes (Optional)"
                             Variant="Variant.Outlined"
                             Lines="2"
                             Placeholder="Any special requirements or information" />
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Color="Color.Default">Cancel</MudButton>
        <MudButton OnClick="Submit" Color="Color.Primary" Variant="Variant.Filled">Save Event</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public object? Event { get; set; }
    [Parameter] public int PreSelectedCampsiteId { get; set; } = -1;

    private string _name = "";
    private string _description = "";
    private int _selectedCampsiteId = 0;
    private string _category = "Sports";
    private DateTime? _eventDate = DateTime.Today.AddDays(1);
    private TimeSpan? _eventTime = new TimeSpan(10, 0, 0);
    private int _maxCapacity = 100;
    private string _status = "Open";
    private string _location = "";
    private string _notes = "";
    private string _eventLink = "";

    private List<CampsiteDto> _campsites = new();
    private int? _editingEventId = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadCampsites();

        if (Event != null && Event is EventDto eventDto)
        {
            // Load existing event data for editing
            _editingEventId = eventDto.Id;
            _name = eventDto.Name;
            _description = eventDto.Description;
            _selectedCampsiteId = eventDto.CampsiteId;
            _category = eventDto.Category;
            _eventDate = eventDto.EventDate.Date;
            _eventTime = eventDto.EventDate.TimeOfDay;
            _maxCapacity = eventDto.MaxCapacity;
            _status = eventDto.Status;
            _eventLink = eventDto.EventLink;
        }
        else if (PreSelectedCampsiteId >= 0)
        {
            // Use pre-selected campsite from dialog parameters
            _selectedCampsiteId = PreSelectedCampsiteId;
        }
        else if (_campsites.Any())
        {
            // Set default campsite for new events
            _selectedCampsiteId = _campsites.First().Id;
        }
    }

    private async Task LoadCampsites()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            var dbCampsites = await context.Campsites.ToListAsync();
            _campsites = dbCampsites.Select(c => new CampsiteDto
            {
                Id = c.Id?.Value ?? 0,
                Name = c.Name ?? ""
            }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error loading campsites: {ex.Message}");
            Snackbar.Add("Error loading campsites", Severity.Error);
        }
    }

    private async Task Submit()
    {
        // Validate
        if (string.IsNullOrWhiteSpace(_name))
        {
            Snackbar.Add("Event name is required", Severity.Warning);
            return;
        }

        if (_selectedCampsiteId == 0)
        {
            Snackbar.Add("Please select a campsite", Severity.Warning);
            return;
        }

        if (!_eventDate.HasValue || !_eventTime.HasValue)
        {
            Snackbar.Add("Event date and time are required", Severity.Warning);
            return;
        }

        if (_maxCapacity <= 0)
        {
            Snackbar.Add("Max capacity must be greater than 0", Severity.Warning);
            return;
        }

        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            var eventDateTime = _eventDate.Value.Date + _eventTime.Value;
            var campsiteId = CampsiteId.Create(_selectedCampsiteId);

            if (_editingEventId.HasValue)
            {
                // Update existing event
                var eventId = EventId.Create(_editingEventId.Value);
                var existingEvent = await context.Events.FirstOrDefaultAsync(e => e.Id == eventId);

                if (existingEvent == null)
                {
                    Snackbar.Add("Event not found", Severity.Error);
                    return;
                }

                existingEvent.Update(_name, _description, eventDateTime, _maxCapacity, _eventLink);

                // Handle status changes
                if (_status == "Cancelled" || _status == "Closed")
                {
                    existingEvent.Deactivate();
                }
                else if (_status == "Open" && !existingEvent.IsActive)
                {
                    existingEvent.Activate();
                }

                context.Events.Update(existingEvent);
                await context.SaveChangesAsync();

                Console.WriteLine($"✅ Event '{_name}' updated successfully");
                Snackbar.Add("Event updated successfully", Severity.Success);
            }
            else
            {
                // Create new event
                var newEvent = Models.Event.Create(
                    campsiteId,
                    _name,
                    _description,
                    eventDateTime,
                    _maxCapacity,
                    Money.Create(0m, "DKK"), // Free event by default
                    _eventLink
                );

                context.Events.Add(newEvent);
                await context.SaveChangesAsync();

                Console.WriteLine($"✅ Event '{_name}' created successfully");
                Snackbar.Add("Event created successfully", Severity.Success);
            }

            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (DomainException ex)
        {
            Console.WriteLine($"❌ Domain validation error: {ex.Message}");
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error saving event: {ex.Message}");
            Snackbar.Add($"Error saving event: {ex.Message}", Severity.Error);
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private class CampsiteDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
    }

    private class EventDto
    {
        public int Id { get; set; }
        public int CampsiteId { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public DateTime EventDate { get; set; }
        public string Category { get; set; } = string.Empty;
        public int MaxCapacity { get; set; }
        public string Status { get; set; } = string.Empty;
        public string EventLink { get; set; } = string.Empty;
    }
}

