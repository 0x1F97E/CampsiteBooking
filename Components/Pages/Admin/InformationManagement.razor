@page "/admin/information"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin,Staff")]
@using CampsiteBooking.Data
@using CampsiteBooking.Models
@using CampsiteBooking.Models.ValueObjects
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IDbContextFactory<CampsiteBookingDbContext> DbContextFactory

<PageTitle>Information & Newsletter Management - Campsite Booking</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-6">
        <div>
            <MudText Typo="Typo.h3" GutterBottom="true">
                <MudIcon Icon="@Icons.Material.Filled.Newspaper" Class="mr-2" />
                Information & Newsletter Management
            </MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary">
                Manage campsite information, events, activities, and send newsletters to subscribers (@_events.Count events, @_newsletterHistory.Count newsletters)
            </MudText>
        </div>
        <MudButton Variant="Variant.Outlined"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Refresh"
                   OnClick="RefreshData"
                   Disabled="@_loading">
            @if (_loading)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Loading...</span>
            }
            else
            {
                <span>Refresh</span>
            }
        </MudButton>
    </div>

    <MudGrid>
        <!-- Newsletter Composer -->
        <MudItem xs="12" lg="8">
            <MudPaper Elevation="3" Class="pa-4">
                <MudText Typo="Typo.h5" GutterBottom="true">
                    <MudIcon Icon="@Icons.Material.Filled.Email" Class="mr-2" />
                    Daily Newsletter Composer
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                    Create and send daily news about events and activities to campsite subscribers
                </MudText>

                <MudGrid>
                    <MudItem xs="12">
                        <MudSelect T="int" 
                                  @bind-Value="_selectedCampsiteId" 
                                  Label="Select Campsite" 
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  HelperText="Choose which campsite this newsletter is for">
                            <MudSelectItem T="int" Value="0">All Campsites</MudSelectItem>
                            @foreach (var campsite in _campsites)
                            {
                                <MudSelectItem T="int" Value="@campsite.Id">@campsite.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField @bind-Value="_newsletterSubject" 
                                     Label="Email Subject" 
                                     Variant="Variant.Outlined"
                                     Required="true"
                                     Placeholder="e.g., Today's Events & Activities at Copenhagen Beach Camp" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField @bind-Value="_newsletterContent" 
                                     Label="Newsletter Content" 
                                     Variant="Variant.Outlined"
                                     Lines="12"
                                     Required="true"
                                     Placeholder="Write your newsletter content here...&#10;&#10;Example:&#10;üéâ Today's Events:&#10;- 10:00 AM: Beach Volleyball Tournament&#10;- 2:00 PM: Kids' Craft Workshop&#10;- 7:00 PM: Campfire Stories & S'mores&#10;&#10;üèä Activities Available:&#10;- Swimming Pool (Open 8 AM - 8 PM)&#10;- Kayak Rentals&#10;- Guided Nature Walk (3 PM)" />
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudDatePicker @bind-Date="_scheduledDate" 
                                      Label="Schedule Date" 
                                      Variant="Variant.Outlined"
                                      MinDate="DateTime.Today"
                                      HelperText="Leave empty to send immediately" />
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudTimePicker @bind-Time="_scheduledTime" 
                                      Label="Schedule Time" 
                                      Variant="Variant.Outlined"
                                      HelperText="Time to send the newsletter" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudCheckBox @bind-Value="_sendTestEmail" 
                                    Label="Send test email to myself first" 
                                    Color="Color.Primary" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudStack Row="true" Spacing="2">
                            <MudButton Variant="Variant.Outlined" 
                                      Color="Color.Default"
                                      StartIcon="@Icons.Material.Filled.Preview"
                                      OnClick="PreviewNewsletter">
                                Preview
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" 
                                      Color="Color.Secondary"
                                      StartIcon="@Icons.Material.Filled.Save"
                                      OnClick="SaveDraft">
                                Save as Draft
                            </MudButton>
                            <MudSpacer />
                            @if (_sendTestEmail)
                            {
                                <MudButton Variant="Variant.Filled" 
                                          Color="Color.Info"
                                          StartIcon="@Icons.Material.Filled.Send"
                                          OnClick="SendTestNewsletter">
                                    Send Test Email
                                </MudButton>
                            }
                            <MudButton Variant="Variant.Filled" 
                                      Color="Color.Primary"
                                      StartIcon="@Icons.Material.Filled.Send"
                                      OnClick="SendNewsletter"
                                      Disabled="@(!IsNewsletterValid())">
                                @(_scheduledDate.HasValue ? "Schedule Newsletter" : "Send Now")
                            </MudButton>
                        </MudStack>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <!-- Subscriber Statistics -->
        <MudItem xs="12" lg="4">
            <MudStack Spacing="3">
                <!-- Subscriber Count Card -->
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" GutterBottom="true">
                        <MudIcon Icon="@Icons.Material.Filled.People" Class="mr-2" />
                        Subscribers
                    </MudText>
                    <MudText Typo="Typo.h3" Color="Color.Primary">@_totalSubscribers</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Total newsletter subscribers</MudText>
                    <MudDivider Class="my-3" />
                    <MudText Typo="Typo.body2">
                        <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Small" Color="Color.Success" />
                        +@_newSubscribersThisWeek new this week
                    </MudText>
                </MudPaper>

                <!-- Campsite Breakdown -->
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" GutterBottom="true">Subscribers by Campsite</MudText>
                    <MudList T="string" Dense="true">
                        @foreach (var campsite in _campsites.Take(5))
                        {
                            <MudListItem T="string">
                                <div class="d-flex justify-space-between align-center" style="width: 100%;">
                                    <MudText Typo="Typo.body2">@campsite.Name</MudText>
                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary">@campsite.SubscriberCount</MudChip>
                                </div>
                            </MudListItem>
                        }
                    </MudList>
                </MudPaper>

                <!-- Recent Activity -->
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" GutterBottom="true">Recent Newsletters</MudText>
                    <MudList T="string" Dense="true">
                        @foreach (var newsletter in _recentNewsletters)
                        {
                            <MudListItem T="string">
                                <div>
                                    <MudText Typo="Typo.body2"><strong>@newsletter.Subject</strong></MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @newsletter.SentDate.ToString("MMM dd, yyyy") ‚Ä¢ @newsletter.RecipientCount recipients
                                    </MudText>
                                </div>
                            </MudListItem>
                        }
                    </MudList>
                </MudPaper>
            </MudStack>
        </MudItem>

        <!-- Events & Activities Management -->
        <MudItem xs="12">
            <MudPaper Elevation="3" Class="pa-4">
                <div class="d-flex justify-space-between align-center mb-4">
                    <MudText Typo="Typo.h5">
                        <MudIcon Icon="@Icons.Material.Filled.Event" Class="mr-2" />
                        Events & Activities
                    </MudText>
                    <MudButton Variant="Variant.Filled"
                              Color="Color.Primary"
                              StartIcon="@Icons.Material.Filled.Add"
                              OnClick="OpenAddEventDialog">
                        Add Event
                    </MudButton>
                </div>

                <MudTable Items="@_events" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true">
                    <HeaderContent>
                        <MudTh>Event Name</MudTh>
                        <MudTh>Campsite</MudTh>
                        <MudTh>Date & Time</MudTh>
                        <MudTh>Category</MudTh>
                        <MudTh>Capacity</MudTh>
                        <MudTh>Registered</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Event Name">
                            <div>
                                <MudText Typo="Typo.body2"><strong>@context.Name</strong></MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Description</MudText>
                            </div>
                        </MudTd>
                        <MudTd DataLabel="Campsite">
                            <MudChip T="string" Size="Size.Small" Color="Color.Info">@context.CampsiteName</MudChip>
                        </MudTd>
                        <MudTd DataLabel="Date & Time">
                            <MudText Typo="Typo.body2">@context.EventDate.ToString("MMM dd, yyyy")</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@context.EventTime</MudText>
                        </MudTd>
                        <MudTd DataLabel="Category">
                            <MudChip T="string" Size="Size.Small" Icon="@GetCategoryIcon(context.Category)">
                                @context.Category
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Capacity">
                            @if (context.MaxCapacity > 0)
                            {
                                <MudText Typo="Typo.body2">@context.MaxCapacity</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Unlimited</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="Registered">
                            <MudText Typo="Typo.body2" Color="@(context.RegisteredCount >= context.MaxCapacity && context.MaxCapacity > 0 ? Color.Error : Color.Default)">
                                @context.RegisteredCount
                            </MudText>
                        </MudTd>
                        <MudTd DataLabel="Status">
                            <MudChip T="string" Size="Size.Small" Color="@GetEventStatusColor(context.Status)">
                                @context.Status
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Actions">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                          Color="Color.Primary"
                                          Size="Size.Small"
                                          OnClick="@(() => EditEvent(context))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                          Color="Color.Error"
                                          Size="Size.Small"
                                          OnClick="@(() => DeleteEvent(context))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        </MudItem>

        <!-- Photo Gallery Management - Organized by Campsite -->
        <MudItem xs="12">
            <MudPaper Elevation="3" Class="pa-4">
                <div class="d-flex justify-space-between align-center mb-4">
                    <MudText Typo="Typo.h5">
                        <MudIcon Icon="@Icons.Material.Filled.PhotoLibrary" Class="mr-2" />
                        Photo Gallery Management
                    </MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        @_photos.Count total photos across @_photosByCampsite.Count campsites
                    </MudText>
                </div>

                @if (!_photosByCampsite.Any())
                {
                    <MudAlert Severity="Severity.Info" Class="mb-4">
                        No photos found. Add photos to your campsites using the "Add Photo" button in each section below.
                    </MudAlert>
                }

                <!-- General Photos (All Campsites) Section -->
                <MudExpansionPanels MultiExpansion="true" Class="mb-4">
                    <MudExpansionPanel @bind-Expanded="_generalPhotosExpanded">
                        <TitleContent>
                            <div class="d-flex align-center gap-2">
                                <MudIcon Icon="@Icons.Material.Filled.Public" Color="Color.Primary" />
                                <MudText Typo="Typo.subtitle1"><strong>General Photos (All Campsites)</strong></MudText>
                                <MudChip T="string" Size="Size.Small" Color="Color.Info" Class="ml-2">
                                    @(_photosByCampsite.ContainsKey(0) ? _photosByCampsite[0].Count : 0) photos
                                </MudChip>
                                <MudSpacer />
                                <span @onclick:stopPropagation="true">
                                    <MudButton Variant="Variant.Filled"
                                              Color="Color.Primary"
                                              Size="Size.Small"
                                              StartIcon="@Icons.Material.Filled.Add"
                                              OnClick="@(() => OpenAddPhotoDialogForCampsite(0))">
                                        Add Photo
                                    </MudButton>
                                </span>
                            </div>
                        </TitleContent>
                        <ChildContent>
                            @if (_photosByCampsite.ContainsKey(0) && _photosByCampsite[0].Any())
                            {
                                <MudGrid Class="pa-2">
                                    @foreach (var photo in _photosByCampsite[0])
                                    {
                                        <MudItem xs="12" sm="6" md="4" lg="3">
                                            <MudCard Elevation="2" Class="photo-card">
                                                <MudCardMedia Image="@photo.ImageUrl" Height="150" />
                                                <MudCardContent Class="pa-2">
                                                    <MudText Typo="Typo.subtitle2" Class="text-truncate"><strong>@photo.Title</strong></MudText>
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="text-truncate">@photo.Description</MudText>
                                                </MudCardContent>
                                                <MudCardActions Class="pa-1 justify-end">
                                                    @{ var generalPhoto = photo; }
                                                    <span @onclick:stopPropagation="true">
                                                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                                      Color="Color.Primary"
                                                                      Size="Size.Small"
                                                                      OnClick="@(() => EditPhoto(generalPhoto))" />
                                                    </span>
                                                    <span @onclick:stopPropagation="true">
                                                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                                      Color="Color.Error"
                                                                      Size="Size.Small"
                                                                      OnClick="@(() => DeletePhoto(generalPhoto))" />
                                                    </span>
                                                </MudCardActions>
                                            </MudCard>
                                        </MudItem>
                                    }
                                </MudGrid>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Info" Dense="true" Class="ma-2">
                                    No general photos. Click "Add Photo" to add photos that appear across all campsites.
                                </MudAlert>
                            }
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>

                <!-- Per-Campsite Photo Sections -->
                <MudExpansionPanels MultiExpansion="true">
                    @foreach (var campsite in _campsites)
                    {
                        var campsitePhotos = _photosByCampsite.ContainsKey(campsite.Id) ? _photosByCampsite[campsite.Id] : new List<PhotoDto>();
                        var photoCount = campsitePhotos.Count;
                        <MudExpansionPanel @bind-Expanded="_campsiteExpansionStates[campsite.Id]">
                            <TitleContent>
                                <div class="d-flex align-center gap-2">
                                    <MudIcon Icon="@Icons.Material.Filled.Terrain" Color="Color.Success" />
                                    <MudText Typo="Typo.subtitle1"><strong>@campsite.Name</strong></MudText>
                                    <MudChip T="string" Size="Size.Small" Color="@(photoCount > 0 ? Color.Success : Color.Default)" Class="ml-2">
                                        @photoCount photos
                                    </MudChip>
                                    <MudSpacer />
                                    <span @onclick:stopPropagation="true">
                                        <MudButton Variant="Variant.Filled"
                                                  Color="Color.Primary"
                                                  Size="Size.Small"
                                                  StartIcon="@Icons.Material.Filled.Add"
                                                  OnClick="@(() => OpenAddPhotoDialogForCampsite(campsite.Id))">
                                            Add Photo
                                        </MudButton>
                                    </span>
                                </div>
                            </TitleContent>
                            <ChildContent>
                                @if (campsitePhotos.Any())
                                {
                                    <MudGrid Class="pa-2">
                                        @foreach (var photo in campsitePhotos)
                                        {
                                            <MudItem xs="12" sm="6" md="4" lg="3">
                                                <MudCard Elevation="2" Class="photo-card">
                                                    <MudCardMedia Image="@photo.ImageUrl" Height="150" />
                                                    <MudCardContent Class="pa-2">
                                                        <MudText Typo="Typo.subtitle2" Class="text-truncate"><strong>@photo.Title</strong></MudText>
                                                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="text-truncate">@photo.Description</MudText>
                                                    </MudCardContent>
                                                    <MudCardActions Class="pa-1 justify-end">
                                                        @{ var campsitePhoto = photo; }
                                                        <span @onclick:stopPropagation="true">
                                                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                                          Color="Color.Primary"
                                                                          Size="Size.Small"
                                                                          OnClick="@(() => EditPhoto(campsitePhoto))" />
                                                        </span>
                                                        <span @onclick:stopPropagation="true">
                                                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                                          Color="Color.Error"
                                                                          Size="Size.Small"
                                                                          OnClick="@(() => DeletePhoto(campsitePhoto))" />
                                                        </span>
                                                    </MudCardActions>
                                                </MudCard>
                                            </MudItem>
                                        }
                                    </MudGrid>
                                }
                                else
                                {
                                    <MudAlert Severity="Severity.Info" Dense="true" Class="ma-2">
                                        No photos for this campsite yet. Click "Add Photo" to add images.
                                    </MudAlert>
                                }
                            </ChildContent>
                        </MudExpansionPanel>
                    }
                </MudExpansionPanels>
            </MudPaper>
        </MudItem>

        <!-- Newsletter History -->
        <MudItem xs="12">
            <MudPaper Elevation="3" Class="pa-4">
                <MudText Typo="Typo.h5" GutterBottom="true">
                    <MudIcon Icon="@Icons.Material.Filled.History" Class="mr-2" />
                    Newsletter History
                </MudText>

                <MudTable Items="@_newsletterHistory" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true">
                    <HeaderContent>
                        <MudTh>Subject</MudTh>
                        <MudTh>Campsite</MudTh>
                        <MudTh>Sent Date</MudTh>
                        <MudTh>Recipients</MudTh>
                        <MudTh>Opened</MudTh>
                        <MudTh>Clicked</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Subject">
                            <MudText Typo="Typo.body2"><strong>@context.Subject</strong></MudText>
                        </MudTd>
                        <MudTd DataLabel="Campsite">
                            <MudChip T="string" Size="Size.Small" Color="Color.Info">@context.CampsiteName</MudChip>
                        </MudTd>
                        <MudTd DataLabel="Sent Date">
                            <MudText Typo="Typo.body2">@context.SentDate.ToString("MMM dd, yyyy HH:mm")</MudText>
                        </MudTd>
                        <MudTd DataLabel="Recipients">
                            <MudText Typo="Typo.body2">@context.RecipientCount</MudText>
                        </MudTd>
                        <MudTd DataLabel="Opened">
                            <MudText Typo="Typo.body2">@context.OpenedCount (@context.OpenRate%)</MudText>
                        </MudTd>
                        <MudTd DataLabel="Clicked">
                            <MudText Typo="Typo.body2">@context.ClickedCount (@context.ClickRate%)</MudText>
                        </MudTd>
                        <MudTd DataLabel="Status">
                            <MudChip T="string" Size="Size.Small" Color="@(context.Status == "Sent" ? Color.Success : Color.Warning)">
                                @context.Status
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Actions">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                          Color="Color.Primary"
                                          Size="Size.Small"
                                          OnClick="@(() => ViewNewsletter(context))" />
                            <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                          Color="Color.Secondary"
                                          Size="Size.Small"
                                          OnClick="@(() => DuplicateNewsletter(context))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    // Newsletter fields
    private int _selectedCampsiteId = 0;
    private string _newsletterSubject = "";
    private string _newsletterContent = "";
    private DateTime? _scheduledDate = null;
    private TimeSpan? _scheduledTime = null;
    private bool _sendTestEmail = false;

    // Statistics
    private int _totalSubscribers = 0;
    private int _newSubscribersThisWeek = 0;
    private bool _loading = false;

    // Data lists
    private List<CampsiteSubscriberDto> _campsites = new();
    private List<NewsletterDto> _recentNewsletters = new();
    private List<EventDto> _events = new();
    private List<NewsletterHistoryDto> _newsletterHistory = new();
    private List<PhotoDto> _photos = new();

    // Photo gallery organized by campsite (key: CampsiteId, 0 = All Campsites/General)
    private Dictionary<int, List<PhotoDto>> _photosByCampsite = new();
    private Dictionary<int, bool> _campsiteExpansionStates = new();
    private bool _generalPhotosExpanded = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        await LoadPhotosAsync();
    }

    private async Task RefreshData()
    {
        Console.WriteLine("üîÑ Admin manually refreshing information management data...");
        await LoadData();
        await LoadPhotosAsync();
        Snackbar.Add($"Refreshed! Found {_events.Count} events and {_newsletterHistory.Count} newsletters", Severity.Success);
        StateHasChanged();
    }

    private async Task LoadData()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            Console.WriteLine("\n" + new string('=', 80));
            Console.WriteLine("üì∞ ADMIN INFORMATION MANAGEMENT - Loading data from database...");
            Console.WriteLine(new string('=', 80));

            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load campsites from database
            var campsites = await context.Campsites.ToListAsync();
            _campsites = campsites.Select(c => new CampsiteSubscriberDto
            {
                Id = c.Id?.Value ?? 0,
                Name = c.Name ?? "",
                SubscriberCount = 0 // Will be calculated from subscriptions
            }).ToList();
            Console.WriteLine($"   ‚úÖ Loaded {_campsites.Count} campsites");

            // Initialize expansion states for each campsite (must be done here before render)
            foreach (var campsite in _campsites)
            {
                if (!_campsiteExpansionStates.ContainsKey(campsite.Id))
                {
                    _campsiteExpansionStates[campsite.Id] = false; // Collapsed by default, updated in LoadPhotosAsync
                }
            }

            // Load newsletter subscriptions and calculate statistics
            var subscriptions = await context.NewsletterSubscriptions.ToListAsync();
            var activeSubscriptions = subscriptions.Where(s => s.IsActive).ToList();
            _totalSubscribers = activeSubscriptions.Count;

            var oneWeekAgo = DateTime.UtcNow.AddDays(-7);
            _newSubscribersThisWeek = activeSubscriptions.Count(s => s.SubscribedDate >= oneWeekAgo);
            Console.WriteLine($"   ‚úÖ Loaded {_totalSubscribers} active newsletter subscribers ({_newSubscribersThisWeek} new this week)");

            // Load events from database
            var dbEvents = await context.Events.ToListAsync();
            _events = dbEvents.Select(e => new EventDto
            {
                Id = e.EventId,
                CampsiteId = e.CampsiteId?.Value ?? 0,
                Name = e.Title ?? string.Empty,
                Description = e.Description ?? string.Empty,
                CampsiteName = GetCampsiteName(e.CampsiteId?.Value ?? 0),
                EventDate = e.EventDate,
                EventTime = e.EventDate.ToString("h:mm tt"),
                Category = "Event", // Default category since Event model doesn't have category field
                MaxCapacity = e.MaxParticipants,
                RegisteredCount = e.CurrentParticipants,
                Status = e.IsActive ? (e.IsFull() ? "Full" : "Open") : "Closed"
            }).OrderBy(e => e.EventDate).ToList();
            Console.WriteLine($"   ‚úÖ Loaded {_events.Count} events from Events table");

            // Load newsletters from database
            var dbNewsletters = await context.Newsletters.ToListAsync();

            // Recent newsletters (for sidebar)
            _recentNewsletters = dbNewsletters
                .Where(n => n.Status == "Sent")
                .OrderByDescending(n => n.SentDate)
                .Take(5)
                .Select(n => new NewsletterDto
                {
                    Subject = n.Subject,
                    SentDate = n.SentDate ?? DateTime.Now,
                    RecipientCount = n.RecipientCount
                }).ToList();
            Console.WriteLine($"   ‚úÖ Loaded {_recentNewsletters.Count} recent newsletters");

            // Newsletter history (for table)
            var newsletterAnalytics = await context.NewsletterAnalytics.ToListAsync();
            _newsletterHistory = dbNewsletters
                .OrderByDescending(n => n.SentDate ?? n.ScheduledDate)
                .Select(n =>
                {
                    var analytics = newsletterAnalytics.FirstOrDefault(a => a.NewsletterId.Value == n.NewsletterId);
                    return new NewsletterHistoryDto
                    {
                        Id = n.NewsletterId,
                        Subject = n.Subject,
                        CampsiteName = "All Campsites", // Newsletters don't have campsite association in current model
                        SentDate = n.SentDate ?? n.ScheduledDate ?? DateTime.Now,
                        RecipientCount = n.RecipientCount,
                        OpenedCount = analytics?.TotalOpened ?? 0,
                        ClickedCount = analytics?.TotalClicked ?? 0,
                        OpenRate = analytics != null ? (int)(analytics.OpenRate * 100) : 0,
                        ClickRate = analytics != null ? (int)(analytics.ClickRate * 100) : 0,
                        Status = n.Status
                    };
                }).ToList();
            Console.WriteLine($"   ‚úÖ Loaded {_newsletterHistory.Count} newsletters for history table");

            if (_events.Any())
            {
                Console.WriteLine($"\n   üìã Recent events (last 3):");
                foreach (var evt in _events.Take(3))
                {
                    Console.WriteLine($"      - {evt.Name} at {evt.CampsiteName} on {evt.EventDate:MMM dd, yyyy}");
                }
            }
            else
            {
                Console.WriteLine($"\n   ‚ö†Ô∏è  NO EVENTS FOUND! Events should be seeded in the database.");
            }

            if (_newsletterHistory.Any())
            {
                Console.WriteLine($"\n   üìã Recent newsletters (last 3):");
                foreach (var newsletter in _newsletterHistory.Take(3))
                {
                    Console.WriteLine($"      - {newsletter.Subject} ({newsletter.Status}) - {newsletter.RecipientCount} recipients");
                }
            }
            else
            {
                Console.WriteLine($"\n   ‚ö†Ô∏è  NO NEWSLETTERS FOUND! Newsletters should be seeded in the database.");
            }

            Console.WriteLine(new string('=', 80) + "\n");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error loading data: {ex.Message}");
            Console.WriteLine($"   Stack trace: {ex.StackTrace}");
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task LoadPhotosAsync()
    {
        try
        {
            await using var context = await DbContextFactory.CreateDbContextAsync();
            var dbPhotos = await context.Photos.ToListAsync();
            Console.WriteLine($"   üì∑ Loaded {dbPhotos.Count} photos from database");

            _photos = dbPhotos.Select(p => new PhotoDto
            {
                Id = p.Id?.Value ?? 0,
                Title = p.Caption ?? string.Empty,
                CampsiteName = (p.CampsiteId?.Value ?? 0) == 0 ? "All Campsites" : GetCampsiteName(p.CampsiteId?.Value ?? 0),
                Description = p.AltText ?? string.Empty,
                ImageUrl = p.Url ?? string.Empty,
                CampsiteId = p.CampsiteId?.Value ?? 0
            }).Where(p => p.Id > 0).ToList(); // Filter out any photos with invalid IDs

            Console.WriteLine($"   üì∑ Mapped {_photos.Count} valid photos");

            // Group photos by campsite for organized display
            _photosByCampsite = _photos.GroupBy(p => p.CampsiteId)
                .ToDictionary(g => g.Key, g => g.ToList());

            // Initialize expansion states for each campsite (collapsed by default, expanded if has photos)
            foreach (var campsite in _campsites)
            {
                if (!_campsiteExpansionStates.ContainsKey(campsite.Id))
                {
                    _campsiteExpansionStates[campsite.Id] = _photosByCampsite.ContainsKey(campsite.Id) && _photosByCampsite[campsite.Id].Any();
                }
            }

            // Also expand general photos section if it has photos
            _generalPhotosExpanded = _photosByCampsite.ContainsKey(0) && _photosByCampsite[0].Any();

            Console.WriteLine($"   üì∑ Photo groups: General={(_photosByCampsite.ContainsKey(0) ? _photosByCampsite[0].Count : 0)}, Campsite-specific={_photosByCampsite.Where(kvp => kvp.Key > 0).Sum(kvp => kvp.Value.Count)}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"   ‚ùå Error loading photos: {ex.Message}");
            Console.WriteLine($"   Stack trace: {ex.StackTrace}");
            _photos = new List<PhotoDto>();
            _photosByCampsite = new Dictionary<int, List<PhotoDto>>();
        }
    }

    private bool IsNewsletterValid()
    {
        return !string.IsNullOrWhiteSpace(_newsletterSubject) &&
               !string.IsNullOrWhiteSpace(_newsletterContent);
    }

    private async Task PreviewNewsletter()
    {
        var parameters = new DialogParameters
        {
            { "Subject", _newsletterSubject },
            { "Content", _newsletterContent },
            { "CampsiteName", GetCampsiteName(_selectedCampsiteId) }
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        await DialogService.ShowAsync<NewsletterPreviewDialog>("Newsletter Preview", parameters, options);
    }

    private async Task SaveDraft()
    {
        // TODO: Save newsletter as draft
        Snackbar.Add("Newsletter saved as draft", Severity.Success);
        await Task.CompletedTask;
    }

    private async Task SendTestNewsletter()
    {
        // TODO: Send test email to admin
        Snackbar.Add("Test email sent to your inbox", Severity.Info);
        await Task.CompletedTask;
    }

    private async Task SendNewsletter()
    {
        if (!IsNewsletterValid())
        {
            Snackbar.Add("Please fill in all required fields", Severity.Warning);
            return;
        }

        var recipientCount = _selectedCampsiteId == 0 ? _totalSubscribers : _campsites.FirstOrDefault(c => c.Id == _selectedCampsiteId)?.SubscriberCount ?? 0;

        var message = _scheduledDate.HasValue
            ? $"Newsletter scheduled for {_scheduledDate.Value:MMM dd, yyyy} at {_scheduledTime?.ToString(@"hh\:mm")} to {recipientCount} subscribers"
            : $"Newsletter sent to {recipientCount} subscribers";

        bool? result = await DialogService.ShowMessageBox(
            "Confirm Send",
            message,
            yesText: "Confirm", cancelText: "Cancel");

        if (result == true)
        {
            // TODO: Send newsletter via email service
            Snackbar.Add(_scheduledDate.HasValue ? "Newsletter scheduled successfully" : "Newsletter sent successfully", Severity.Success);

            // Clear form
            _newsletterSubject = "";
            _newsletterContent = "";
            _scheduledDate = null;
            _scheduledTime = null;
            _sendTestEmail = false;

            await LoadData(); // Refresh history
        }
    }

    private string GetCampsiteName(int campsiteId)
    {
        if (campsiteId == 0) return "All Campsites";
        return _campsites.FirstOrDefault(c => c.Id == campsiteId)?.Name ?? "Unknown";
    }

    private async Task OpenAddEventDialog()
    {
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<EventDialog>("Add New Event", options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            Snackbar.Add("Event added successfully", Severity.Success);
        }
    }

    private async Task EditEvent(EventDto eventDto)
    {
        var parameters = new DialogParameters { { "Event", eventDto } };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<EventDialog>("Edit Event", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            Snackbar.Add("Event updated successfully", Severity.Success);
        }
    }

    private async Task DeleteEvent(EventDto eventDto)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirm Delete",
            $"Are you sure you want to delete '{eventDto.Name}'?",
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                using var context = await DbContextFactory.CreateDbContextAsync();

                var eventId = EventId.Create(eventDto.Id);
                var dbEvent = await context.Events.FirstOrDefaultAsync(e => e.Id == eventId);

                if (dbEvent == null)
                {
                    Snackbar.Add("Event not found", Severity.Error);
                    return;
                }

                // Remove from database
                context.Events.Remove(dbEvent);
                await context.SaveChangesAsync();

                // Remove from in-memory list
                _events.Remove(eventDto);

                Console.WriteLine($"‚úÖ Event '{eventDto.Name}' deleted successfully");
                Snackbar.Add("Event deleted successfully", Severity.Success);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå Error deleting event: {ex.Message}");
                Snackbar.Add($"Error deleting event: {ex.Message}", Severity.Error);
            }
        }
    }

    // Photo Gallery Management Methods
    private async Task OpenAddPhotoDialogForCampsite(int preSelectedCampsiteId)
    {
        var campsiteName = preSelectedCampsiteId == 0
            ? "General (All Campsites)"
            : GetCampsiteName(preSelectedCampsiteId);

        var parameters = new DialogParameters
        {
            ["Campsites"] = _campsites,
            ["PreSelectedCampsiteId"] = preSelectedCampsiteId
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<AddPhotoDialog>($"Add Photo to {campsiteName}", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is PhotoDto newPhoto)
        {
            await using var context = await DbContextFactory.CreateDbContextAsync();

            var campsiteId = newPhoto.CampsiteId == 0
                ? CampsiteId.CreateNew()
                : CampsiteId.Create(newPhoto.CampsiteId);

            var photo = Photo.Create(
                campsiteId,
                newPhoto.ImageUrl,
                newPhoto.Title,
                newPhoto.Description,
                0, // displayOrder
                null, // accommodationTypeId
                "Information" // category
            );

            context.Photos.Add(photo);
            await context.SaveChangesAsync();

            newPhoto.Id = photo.Id.Value;
            _photos.Add(newPhoto);

            Snackbar.Add("Photo added successfully!", Severity.Success);
            await LoadPhotosAsync();
            StateHasChanged();
        }
    }

    private async Task EditPhoto(PhotoDto photo)
    {
        try
        {
            Console.WriteLine($"üîµ EditPhoto called for photo ID: {photo.Id}, Title: {photo.Title}");

            // Validate photo ID before proceeding
            if (photo.Id <= 0)
            {
                Console.WriteLine($"   ‚ùå Invalid photo ID: {photo.Id}");
                Snackbar.Add("Cannot edit photo: Invalid photo ID", Severity.Error);
                return;
            }

            Console.WriteLine($"   üìã Creating dialog parameters...");

            // Create a fresh copy of the photo DTO to avoid any reference issues
            var photoCopy = new PhotoDto
            {
                Id = photo.Id,
                Title = photo.Title ?? string.Empty,
                CampsiteId = photo.CampsiteId,
                CampsiteName = photo.CampsiteName ?? string.Empty,
                Description = photo.Description ?? string.Empty,
                ImageUrl = photo.ImageUrl ?? string.Empty
            };

            var parameters = new DialogParameters
            {
                ["Photo"] = photoCopy,
                ["Campsites"] = _campsites
            };

            var options = new DialogOptions
            {
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                CloseButton = true
            };

            Console.WriteLine($"   üìã Opening dialog...");
            var dialog = await DialogService.ShowAsync<AddPhotoDialog>("Edit Photo", parameters, options);
            Console.WriteLine($"   üìã Waiting for dialog result...");
            var result = await dialog.Result;
            Console.WriteLine($"   üìã Dialog result received: Canceled={result?.Canceled}");

            if (!result.Canceled && result.Data is PhotoDto updatedPhoto)
            {
                await using var context = await DbContextFactory.CreateDbContextAsync();

                // Query by Id.Value to find the photo
                var photoIdToFind = PhotoId.Create(photoCopy.Id);
                var dbPhoto = await context.Photos.FirstOrDefaultAsync(p => p.Id == photoIdToFind);
                if (dbPhoto != null)
                {
                    // Remove old photo and create new one (since Photo is immutable)
                    context.Photos.Remove(dbPhoto);

                    var campsiteId = updatedPhoto.CampsiteId == 0
                        ? CampsiteId.CreateNew()
                        : CampsiteId.Create(updatedPhoto.CampsiteId);

                    var newPhoto = Photo.Create(
                        campsiteId,
                        updatedPhoto.ImageUrl,
                        updatedPhoto.Title,
                        updatedPhoto.Description,
                        dbPhoto.DisplayOrder,
                        dbPhoto.AccommodationTypeId,
                        dbPhoto.Category
                    );

                    // Preserve the ID by setting the Id property directly
                    typeof(Photo).GetProperty("Id")!.SetValue(newPhoto, PhotoId.Create(photoCopy.Id));
                    context.Photos.Add(newPhoto);

                    await context.SaveChangesAsync();

                    Snackbar.Add("Photo updated successfully!", Severity.Success);
                    await LoadPhotosAsync();
                    StateHasChanged();
                }
                else
                {
                    Snackbar.Add("Photo not found in database", Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"   ‚ùå Error in EditPhoto: {ex.Message}");
            Console.WriteLine($"   Stack trace: {ex.StackTrace}");
            Snackbar.Add($"Error editing photo: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeletePhoto(PhotoDto photo)
    {
        try
        {
            Console.WriteLine($"üîµ DeletePhoto called for photo ID: {photo.Id}, Title: {photo.Title}");

            // Validate photo ID before proceeding
            if (photo.Id <= 0)
            {
                Console.WriteLine($"   ‚ùå Invalid photo ID: {photo.Id}");
                Snackbar.Add("Cannot delete photo: Invalid photo ID", Severity.Error);
                return;
            }

            // Store values locally to avoid any reference issues
            var photoId = photo.Id;
            var photoTitle = photo.Title ?? "Untitled";

            Console.WriteLine($"   üìã Showing confirmation dialog...");
            bool? result = await DialogService.ShowMessageBox(
                "Confirm Delete",
                $"Are you sure you want to delete '{photoTitle}'?",
                yesText: "Delete", cancelText: "Cancel");
            Console.WriteLine($"   üìã Confirmation result: {result}");

            if (result == true)
            {
                Console.WriteLine($"   üìã User confirmed deletion, proceeding...");
                await using var context = await DbContextFactory.CreateDbContextAsync();

                // Query by Id.Value to find the photo
                var photoIdToFind = PhotoId.Create(photoId);
                var dbPhoto = await context.Photos.FirstOrDefaultAsync(p => p.Id == photoIdToFind);
                if (dbPhoto != null)
                {
                    context.Photos.Remove(dbPhoto);
                    await context.SaveChangesAsync();

                    Snackbar.Add($"Photo '{photoTitle}' deleted successfully!", Severity.Success);
                    await LoadPhotosAsync(); // Reload to update the organized view
                    StateHasChanged();
                }
                else
                {
                    Snackbar.Add("Photo not found in database", Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"   ‚ùå Error in DeletePhoto: {ex.Message}");
            Console.WriteLine($"   Stack trace: {ex.StackTrace}");
            Snackbar.Add($"Error deleting photo: {ex.Message}", Severity.Error);
        }
    }

    private void ViewNewsletter(NewsletterHistoryDto newsletter)
    {
        // TODO: Show newsletter details/preview
        Snackbar.Add($"Viewing newsletter: {newsletter.Subject}", Severity.Info);
    }

    private void DuplicateNewsletter(NewsletterHistoryDto newsletter)
    {
        _newsletterSubject = newsletter.Subject + " (Copy)";
        // TODO: Load content from history
        Snackbar.Add("Newsletter duplicated to composer", Severity.Success);
    }

    private string GetCategoryIcon(string category) => category switch
    {
        "Sports" => Icons.Material.Filled.SportsBasketball,
        "Kids" => Icons.Material.Filled.ChildFriendly,
        "Entertainment" => Icons.Material.Filled.MusicNote,
        "Nature" => Icons.Material.Filled.Nature,
        "Wellness" => Icons.Material.Filled.SelfImprovement,
        _ => Icons.Material.Filled.Event
    };

    private Color GetEventStatusColor(string status) => status switch
    {
        "Open" => Color.Success,
        "Full" => Color.Error,
        "Cancelled" => Color.Default,
        _ => Color.Info
    };

    // DTOs
    public class CampsiteSubscriberDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public int SubscriberCount { get; set; }
    }

    private class NewsletterDto
    {
        public string Subject { get; set; } = string.Empty;
        public DateTime SentDate { get; set; }
        public int RecipientCount { get; set; }
    }

    private class EventDto
    {
        public int Id { get; set; }
        public int CampsiteId { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string CampsiteName { get; set; } = string.Empty;
        public DateTime EventDate { get; set; }
        public string EventTime { get; set; } = string.Empty;
        public string Category { get; set; } = string.Empty;
        public int MaxCapacity { get; set; }
        public int RegisteredCount { get; set; }
        public string Status { get; set; } = string.Empty;
    }

    private class NewsletterHistoryDto
    {
        public int Id { get; set; }
        public string Subject { get; set; } = string.Empty;
        public string CampsiteName { get; set; } = string.Empty;
        public DateTime SentDate { get; set; }
        public int RecipientCount { get; set; }
        public int OpenedCount { get; set; }
        public int ClickedCount { get; set; }
        public int OpenRate { get; set; }
        public int ClickRate { get; set; }
        public string Status { get; set; } = string.Empty;
    }

    public class PhotoDto
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string CampsiteName { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string ImageUrl { get; set; } = string.Empty;
        public int CampsiteId { get; set; }
    }
}

