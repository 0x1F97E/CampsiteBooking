@page "/"
@page "/search"
@rendermode InteractiveServer
@inject IDbContextFactory<CampsiteBookingDbContext> DbContextFactory
@inject ISnackbar Snackbar
@using CampsiteBooking.Data
@using CampsiteBooking.Models
@using CampsiteBooking.Models.ValueObjects
@using Microsoft.EntityFrameworkCore

<PageTitle>Search Campsites - Campsite Booking</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Available Accommodations</MudText>
    
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="3">
                <MudDateRangePicker Label="Check-in / Check-out"
                                   @bind-DateRange="_dateRange"
                                   MinDate="DateTime.Today"
                                   Editable="true" />
            </MudItem>

            <MudItem xs="6" md="2">
                <MudNumericField @bind-Value="_adults"
                                Label="Adults"
                                Variant="Variant.Outlined"
                                Min="1"
                                Max="20"
                                Adornment="Adornment.Start"
                                AdornmentIcon="@Icons.Material.Filled.Person" />
            </MudItem>

            <MudItem xs="6" md="2">
                <MudNumericField @bind-Value="_children"
                                Label="Children"
                                Variant="Variant.Outlined"
                                Min="0"
                                Max="20"
                                Adornment="Adornment.Start"
                                AdornmentIcon="@Icons.Material.Filled.ChildCare" />
            </MudItem>

            <MudItem xs="12" md="3">
                <MudSelect T="string"
                           Label="Campsites"
                           Variant="Variant.Outlined"
                           MultiSelection="true"
                           @bind-SelectedValues="_selectedCampsiteIds"
                           MultiSelectionTextFunc="@GetCampsiteSelectionText"
                           Adornment="Adornment.Start"
                           AdornmentIcon="@Icons.Material.Filled.Landscape">
                    @foreach (var campsite in _availableCampsites)
                    {
                        <MudSelectItem T="string" Value="@campsite.Id.ToString()">@campsite.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="2">
                <MudSelect T="string" Label="Accommodation" @bind-Value="_accommodationType" Variant="Variant.Outlined">
                    <MudSelectItem Value="@("All")">All Types</MudSelectItem>
                    <MudSelectItem Value="@("Cabin")">Cabin</MudSelectItem>
                    <MudSelectItem Value="@("Tent Site")">Tent Site</MudSelectItem>
                    <MudSelectItem Value="@("Glamping")">Glamping</MudSelectItem>
                    <MudSelectItem Value="@("RV Spot")">RV Spot</MudSelectItem>
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="3">
                <MudSelect T="string"
                           Label="Amenities"
                           Variant="Variant.Outlined"
                           MultiSelection="true"
                           @bind-SelectedValues="_selectedAmenities"
                           MultiSelectionTextFunc="@GetAmenitySelectionText"
                           Adornment="Adornment.Start"
                           AdornmentIcon="@Icons.Material.Filled.CheckCircle">
                    <MudSelectItem T="string" Value="@("Pool")">
                        <MudIcon Icon="@Icons.Material.Filled.Pool" Size="Size.Small" Class="mr-2" />
                        Pool
                    </MudSelectItem>
                    <MudSelectItem T="string" Value="@("Dog-Friendly")">
                        <MudIcon Icon="@Icons.Material.Filled.Pets" Size="Size.Small" Class="mr-2" />
                        Dog-Friendly
                    </MudSelectItem>
                    <MudSelectItem T="string" Value="@("Campingvan-Friendly")">
                        <MudIcon Icon="@Icons.Material.Filled.RvHookup" Size="Size.Small" Class="mr-2" />
                        Campingvan-Friendly
                    </MudSelectItem>
                    <MudSelectItem T="string" Value="@("Near-Beach")">
                        <MudIcon Icon="@Icons.Material.Filled.BeachAccess" Size="Size.Small" Class="mr-2" />
                        Near Beach
                    </MudSelectItem>
                    <MudSelectItem T="string" Value="@("WiFi")">
                        <MudIcon Icon="@Icons.Material.Filled.Wifi" Size="Size.Small" Class="mr-2" />
                        WiFi
                    </MudSelectItem>
                    <MudSelectItem T="string" Value="@("Electric-Hookup")">
                        <MudIcon Icon="@Icons.Material.Filled.ElectricBolt" Size="Size.Small" Class="mr-2" />
                        Electric Hookup
                    </MudSelectItem>
                    <MudSelectItem T="string" Value="@("Water-Access")">
                        <MudIcon Icon="@Icons.Material.Filled.Water" Size="Size.Small" Class="mr-2" />
                        Water Access
                    </MudSelectItem>
                    <MudSelectItem T="string" Value="@("Playground")">
                        <MudIcon Icon="@Icons.Material.Filled.ChildFriendly" Size="Size.Small" Class="mr-2" />
                        Playground
                    </MudSelectItem>
                    <MudSelectItem T="string" Value="@("Restaurant")">
                        <MudIcon Icon="@Icons.Material.Filled.Restaurant" Size="Size.Small" Class="mr-2" />
                        Restaurant
                    </MudSelectItem>
                    <MudSelectItem T="string" Value="@("Fire-Pit")">
                        <MudIcon Icon="@Icons.Material.Filled.LocalFireDepartment" Size="Size.Small" Class="mr-2" />
                        Fire Pit
                    </MudSelectItem>
                    <MudSelectItem T="string" Value="@("Picnic-Table")">
                        <MudIcon Icon="@Icons.Material.Filled.TableRestaurant" Size="Size.Small" Class="mr-2" />
                        Picnic Table
                    </MudSelectItem>
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="2" Class="d-flex align-center">
                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          FullWidth="true"
                          OnClick="SearchAvailability"
                          StartIcon="@Icons.Material.Filled.Search">
                    Search
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
    }
    else if (_accommodations.Any())
    {
        <MudGrid>
            @foreach (var accommodation in _accommodations)
            {
                <MudItem xs="12" md="6" lg="4">
                    <MudCard Elevation="3">
                        <MudCardMedia Image="@accommodation.ImageUrl" Height="200" />
                        <MudCardContent>
                            <MudText Typo="Typo.h6">@accommodation.Name</MudText>
                            <MudStack Row="true" Spacing="1" Class="mb-2">
                                <MudChip T="string" Size="Size.Small" Color="Color.Info">@accommodation.Type</MudChip>
                                <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Icon="@Icons.Material.Filled.LocationOn">@accommodation.CampsiteName</MudChip>
                            </MudStack>
                            <MudText Typo="Typo.body2" Class="mt-2">@accommodation.Description</MudText>

                            @if (accommodation.Amenities.Any())
                            {
                                <MudStack Row="true" Spacing="1" Class="mt-2" Wrap="Wrap.Wrap">
                                    @foreach (var amenity in accommodation.Amenities)
                                    {
                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Icon="@GetAmenityIcon(amenity)">
                                            @amenity
                                        </MudChip>
                                    }
                                </MudStack>
                            }

                            <MudDivider Class="my-2" />

                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <div>
                                    <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" />
                                    <MudText Typo="Typo.body2" Inline="true">Up to @accommodation.Capacity guests</MudText>
                                </div>
                                <MudText Typo="Typo.h6" Color="Color.Primary">$@accommodation.PricePerNight/night</MudText>
                            </MudStack>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Filled"
                                      Color="Color.Primary"
                                      FullWidth="true"
                                      Href="@($"/booking?campsiteId={accommodation.Id}")">
                                Book Now
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
    else
    {
        <MudAlert Severity="Severity.Info" Class="mt-4">
            No accommodations found. Try adjusting your search criteria.
        </MudAlert>
    }
</MudContainer>

@code {
    private MudBlazor.DateRange? _dateRange = new MudBlazor.DateRange(DateTime.Today.AddDays(1), DateTime.Today.AddDays(3));
    private int _adults = 2;
    private int _children = 0;
    private string _accommodationType = "All";
    private IEnumerable<string> _selectedAmenities = new HashSet<string>();
    private IEnumerable<string> _selectedCampsiteIds = new HashSet<string>();
    private bool _isLoading = false;
    private List<AccommodationDto> _accommodations = new();
    private List<CampsiteFilterDto> _availableCampsites = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCampsites();
        await SearchAvailability();
    }

    private async Task LoadCampsites()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            var campsites = await context.Campsites.ToListAsync();

            _availableCampsites = campsites.Select(c => new CampsiteFilterDto
            {
                Id = c.Id?.Value ?? 0,
                Name = c.Name ?? "",
                Region = c.Region ?? ""
            }).ToList();

            Console.WriteLine($"‚úÖ Loaded {_availableCampsites.Count} campsites for search filter");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error loading campsites: {ex.Message}");
            Snackbar.Add($"Error loading campsites: {ex.Message}", Severity.Error);
            _availableCampsites = new List<CampsiteFilterDto>();
        }
    }

    private async Task SearchAvailability()
    {
        _isLoading = true;

        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load all accommodation types from database
            var allAccommodationTypes = await context.AccommodationTypes.ToListAsync();

            Console.WriteLine($"üìä Loaded {allAccommodationTypes.Count} accommodation types from database");

            // Convert to DTOs with campsite information
            var allAccommodations = new List<AccommodationDto>();

            foreach (var accType in allAccommodationTypes)
            {
                // Get campsite name
                var campsite = await context.Campsites
                    .FirstOrDefaultAsync(c => c.Id == accType.CampsiteId);

                if (campsite != null)
                {
                    allAccommodations.Add(new AccommodationDto
                    {
                        Id = accType.Id?.Value ?? 0,
                        CampsiteId = accType.CampsiteId?.Value ?? 0,
                        CampsiteName = campsite.Name ?? "",
                        Name = accType.Type ?? "",
                        Type = accType.Type ?? "",
                        Description = accType.Description ?? "",
                        Capacity = accType.MaxCapacity,
                        PricePerNight = accType.BasePrice?.Amount ?? 0m,
                        ImageUrl = accType.ImageUrl ?? "https://images.unsplash.com/photo-1478131143081-80f7f84ca84d?w=400",
                        Amenities = new List<string>() // TODO: Load amenities from database if stored
                    });
                }
            }

            _accommodations = allAccommodations;

            // Filter by campsite
            if (_selectedCampsiteIds.Any())
            {
                var selectedIds = _selectedCampsiteIds.Select(id => int.Parse(id)).ToList();
                _accommodations = _accommodations.Where(a => selectedIds.Contains(a.CampsiteId)).ToList();
            }

            // Filter by accommodation type
            if (_accommodationType != "All")
            {
                _accommodations = _accommodations.Where(a => a.Type == _accommodationType).ToList();
            }

            // Filter by amenities (accommodation must have ALL selected amenities)
            if (_selectedAmenities.Any())
            {
                _accommodations = _accommodations
                    .Where(a => _selectedAmenities.All(amenity => a.Amenities.Contains(amenity)))
                    .ToList();
            }

            Console.WriteLine($"‚úÖ Displaying {_accommodations.Count} accommodations after filtering");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error loading accommodations: {ex.Message}");
            Snackbar.Add($"Error loading accommodations: {ex.Message}", Severity.Error);
            _accommodations = new List<AccommodationDto>();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string GetCampsiteSelectionText(List<string> selectedValues)
    {
        if (!selectedValues.Any())
            return "All Campsites";

        if (selectedValues.Count == 1)
        {
            if (int.TryParse(selectedValues[0], out int campsiteId))
            {
                var campsite = _availableCampsites.FirstOrDefault(c => c.Id == campsiteId);
                return campsite?.Name ?? "1 selected";
            }
            return "1 selected";
        }

        return $"{selectedValues.Count} selected";
    }

    private string GetAmenitySelectionText(List<string> selectedValues)
    {
        if (!selectedValues.Any())
            return "All Amenities";

        if (selectedValues.Count == 1)
            return selectedValues[0];

        return $"{selectedValues.Count} selected";
    }

    private string GetAmenityIcon(string amenity) => amenity switch
    {
        "Pool" => Icons.Material.Filled.Pool,
        "Dog-Friendly" => Icons.Material.Filled.Pets,
        "Campingvan-Friendly" => Icons.Material.Filled.RvHookup,
        "Near-Beach" => Icons.Material.Filled.BeachAccess,
        "WiFi" => Icons.Material.Filled.Wifi,
        "Electric-Hookup" => Icons.Material.Filled.ElectricBolt,
        "Water-Access" => Icons.Material.Filled.Water,
        "Playground" => Icons.Material.Filled.ChildFriendly,
        "Restaurant" => Icons.Material.Filled.Restaurant,
        "Fire-Pit" => Icons.Material.Filled.LocalFireDepartment,
        "Picnic-Table" => Icons.Material.Filled.TableRestaurant,
        _ => Icons.Material.Filled.Check
    };

    public class AccommodationDto
    {
        public int Id { get; set; }
        public int CampsiteId { get; set; }
        public string CampsiteName { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public int Capacity { get; set; }
        public decimal PricePerNight { get; set; }
        public string ImageUrl { get; set; } = string.Empty;
        public List<string> Amenities { get; set; } = new();
    }

    public class CampsiteFilterDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Region { get; set; } = string.Empty;
    }
}

