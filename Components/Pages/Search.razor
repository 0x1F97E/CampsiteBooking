@page "/"
@page "/search"
@rendermode InteractiveServer
@inject IDbContextFactory<CampsiteBookingDbContext> DbContextFactory
@inject ISnackbar Snackbar
@using CampsiteBooking.Data
@using CampsiteBooking.Models
@using CampsiteBooking.Models.DTOs
@using CampsiteBooking.Models.ValueObjects
@using Microsoft.EntityFrameworkCore

<PageTitle>Search Campsites - Campsite Booking</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Available Accommodations</MudText>
    
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="3">
                <MudDateRangePicker Label="Check-in / Check-out"
                                   @bind-DateRange="_dateRange"
                                   MinDate="DateTime.Today"
                                   Editable="true" />
            </MudItem>

            <MudItem xs="12" md="2">
                <MudSelect T="string"
                           Label="Campsites"
                           Variant="Variant.Outlined"
                           MultiSelection="true"
                           SelectedValues="_selectedCampsiteIds"
                           SelectedValuesChanged="OnCampsiteSelectionChanged"
                           MultiSelectionTextFunc="@GetCampsiteSelectionText"
                           Adornment="Adornment.Start"
                           AdornmentIcon="@Icons.Material.Filled.Landscape"
                           CheckMark="true">
                    @foreach (var campsite in _availableCampsites)
                    {
                        <MudSelectItem T="string" Value="@campsite.Id.ToString()">@campsite.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="2">
                <MudSelect T="string" Label="Accommodation" @bind-Value="_accommodationType" Variant="Variant.Outlined">
                    <MudSelectItem Value="@("All")">All Types</MudSelectItem>
                    @foreach (var accType in _availableAccommodationTypes)
                    {
                        <MudSelectItem Value="@accType">@accType</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="2">
                <MudSelect T="string"
                           Label="Amenities"
                           Variant="Variant.Outlined"
                           MultiSelection="true"
                           @bind-SelectedValues="_selectedAmenities"
                           MultiSelectionTextFunc="@GetAmenitySelectionText"
                           Adornment="Adornment.Start"
                           AdornmentIcon="@Icons.Material.Filled.CheckCircle">
                    @foreach (var amenity in _availableAmenities)
                    {
                        <MudSelectItem T="string" Value="@amenity.Name">
                            <MudIcon Icon="@GetAmenityIcon(amenity.Name)" Size="Size.Small" Class="mr-2" />
                            @amenity.Name
                        </MudSelectItem>
                    }
                    @if (!_availableAmenities.Any())
                    {
                        <MudSelectItem T="string" Value="@("Pool")">
                            <MudIcon Icon="@Icons.Material.Filled.Pool" Size="Size.Small" Class="mr-2" />
                            Pool
                        </MudSelectItem>
                        <MudSelectItem T="string" Value="@("Dog-Friendly")">
                            <MudIcon Icon="@Icons.Material.Filled.Pets" Size="Size.Small" Class="mr-2" />
                            Dog-Friendly
                        </MudSelectItem>
                        <MudSelectItem T="string" Value="@("WiFi")">
                            <MudIcon Icon="@Icons.Material.Filled.Wifi" Size="Size.Small" Class="mr-2" />
                            WiFi
                        </MudSelectItem>
                        <MudSelectItem T="string" Value="@("Playground")">
                            <MudIcon Icon="@Icons.Material.Filled.ChildFriendly" Size="Size.Small" Class="mr-2" />
                            Playground
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="2" Class="d-flex align-center">
                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          FullWidth="true"
                          OnClick="SearchAvailability"
                          StartIcon="@Icons.Material.Filled.Search">
                    Search
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
    }
    else if (_accommodations.Any())
    {
        <MudGrid>
            @foreach (var accommodation in _accommodations)
            {
                <MudItem xs="12" md="6" lg="4">
                    <MudCard Elevation="3">
                        <MudCardMedia Image="@accommodation.ImageUrl" Height="200" />
                        <MudCardContent>
                            <MudText Typo="Typo.h6">@accommodation.Name</MudText>
                            <MudStack Row="true" Spacing="1" Class="mb-2">
                                <MudChip T="string" Size="Size.Small" Color="Color.Info">@accommodation.Type</MudChip>
                                <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Icon="@Icons.Material.Filled.LocationOn">@accommodation.CampsiteName</MudChip>
                            </MudStack>
                            <MudText Typo="Typo.body2" Class="mt-2">@accommodation.Description</MudText>

                            @if (accommodation.Amenities.Any())
                            {
                                <MudStack Row="true" Spacing="1" Class="mt-2" Wrap="Wrap.Wrap">
                                    @foreach (var amenity in accommodation.Amenities)
                                    {
                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Icon="@GetAmenityIcon(amenity)">
                                            @amenity
                                        </MudChip>
                                    }
                                </MudStack>
                            }

                            <MudDivider Class="my-2" />

                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <div>
                                    <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" />
                                    <MudText Typo="Typo.body2" Inline="true">Up to @accommodation.Capacity guests</MudText>
                                    @if (accommodation.AreaSquareMeters.HasValue)
                                    {
                                        <MudText Typo="Typo.body2" Inline="true" Class="ml-3">
                                            <MudIcon Icon="@Icons.Material.Filled.SquareFoot" Size="Size.Small" />
                                            @accommodation.AreaSquareMeters.Value.ToString("N1") m¬≤
                                        </MudText>
                                    }
                                </div>
                                <MudText Typo="Typo.h6" Color="Color.Primary">$@accommodation.PricePerNight/night</MudText>
                            </MudStack>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Filled"
                                      Color="Color.Primary"
                                      FullWidth="true"
                                      Href="@($"/booking?campsiteId={accommodation.CampsiteId}&accommodationId={accommodation.Id}")">
                                Book Now
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
    else
    {
        <MudAlert Severity="Severity.Info" Class="mt-4">
            No accommodations found. Try adjusting your search criteria.
        </MudAlert>
    }
</MudContainer>

@code {
    private MudBlazor.DateRange? _dateRange = new MudBlazor.DateRange(DateTime.Today.AddDays(1), DateTime.Today.AddDays(3));
    private string _accommodationType = "All";
    private IEnumerable<string> _selectedAmenities = new HashSet<string>();
    private IEnumerable<string> _selectedCampsiteIds = new HashSet<string>();
    private bool _isLoading = false;
    private List<AccommodationDto> _accommodations = new();
    private List<CampsiteFilterDto> _availableCampsites = new();
    private List<AmenityFilterDto> _availableAmenities = new();
    private List<string> _availableAccommodationTypes = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCampsites();
        await LoadAmenities();
        await LoadAccommodationTypes();
        await SearchAvailability();
    }

    private async Task LoadCampsites()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load all campsites from the database
            var allCampsites = await context.Campsites.ToListAsync();

            // Filter for active campsites in memory (EF Core can't translate IsActive property directly)
            // and order by name for better user experience
            _availableCampsites = allCampsites
                .Where(c => c.IsActive)
                .OrderBy(c => c.Name)
                .Select(c => new CampsiteFilterDto
                {
                    Id = c.Id?.Value ?? 0,
                    Name = c.Name ?? "",
                    City = c.City ?? ""
                })
                .ToList();

            Console.WriteLine($"‚úÖ Loaded {_availableCampsites.Count} active campsites for search filter");
            foreach (var campsite in _availableCampsites)
            {
                Console.WriteLine($"   Campsite: ID={campsite.Id}, Name={campsite.Name}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error loading campsites: {ex.Message}");
            Snackbar.Add($"Error loading campsites: {ex.Message}", Severity.Error);
            _availableCampsites = new List<CampsiteFilterDto>();
        }
    }

    private async Task LoadAmenities()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load amenities from the global AmenityLookup table
            var amenityLookups = await context.AmenityLookups
                .Where(a => a.IsActive)
                .OrderBy(a => a.SortOrder)
                .ToListAsync();

            _availableAmenities = amenityLookups
                .Select(a => new AmenityFilterDto
                {
                    Name = a.Name,
                    Category = a.Category
                })
                .ToList();

            Console.WriteLine($"‚úÖ Loaded {_availableAmenities.Count} amenities for search filter from AmenityLookup table");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error loading amenities: {ex.Message}");
            Snackbar.Add($"Error loading amenities: {ex.Message}", Severity.Error);
            _availableAmenities = new List<AmenityFilterDto>();
        }
    }

    private async Task LoadAccommodationTypes()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load all accommodation types and campsites from database first (EF Core can't translate IsActive property)
            var allAccommodationTypes = await context.AccommodationTypes.ToListAsync();
            var allCampsites = await context.Campsites.ToListAsync();

            // Create a set of active campsite IDs for efficient lookup
            var activeCampsiteIds = allCampsites
                .Where(c => c.IsActive)
                .Select(c => c.Id?.Value ?? 0)
                .ToHashSet();

            // Filter active types in memory and get distinct type names, ordered alphabetically
            // IMPORTANT: Also filter out accommodation types whose campsites are inactive
            _availableAccommodationTypes = allAccommodationTypes
                .Where(a => a.IsActive && activeCampsiteIds.Contains(a.CampsiteId?.Value ?? 0))
                .Select(a => a.Type)
                .Where(t => !string.IsNullOrWhiteSpace(t))
                .Distinct()
                .OrderBy(t => t)
                .ToList();

            Console.WriteLine($"‚úÖ Loaded {_availableAccommodationTypes.Count} accommodation types for search filter (from active campsites only)");
            foreach (var accType in _availableAccommodationTypes)
            {
                Console.WriteLine($"   Accommodation Type: {accType}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error loading accommodation types: {ex.Message}");
            Snackbar.Add($"Error loading accommodation types: {ex.Message}", Severity.Error);
            _availableAccommodationTypes = new List<string>();
        }
    }

    private string GetAmenityIcon(string amenityName)
    {
        return amenityName.ToLower() switch
        {
            var name when name.Contains("pool") => Icons.Material.Filled.Pool,
            var name when name.Contains("dog") || name.Contains("pet") => Icons.Material.Filled.Pets,
            var name when name.Contains("wifi") => Icons.Material.Filled.Wifi,
            var name when name.Contains("beach") => Icons.Material.Filled.BeachAccess,
            var name when name.Contains("electric") => Icons.Material.Filled.ElectricBolt,
            var name when name.Contains("water") => Icons.Material.Filled.Water,
            var name when name.Contains("playground") || name.Contains("child") => Icons.Material.Filled.ChildFriendly,
            var name when name.Contains("restaurant") || name.Contains("food") => Icons.Material.Filled.Restaurant,
            var name when name.Contains("fire") => Icons.Material.Filled.LocalFireDepartment,
            var name when name.Contains("picnic") || name.Contains("table") => Icons.Material.Filled.TableRestaurant,
            var name when name.Contains("rv") || name.Contains("campingvan") => Icons.Material.Filled.RvHookup,
            _ => Icons.Material.Filled.CheckCircle
        };
    }

    private async Task SearchAvailability()
    {
        _isLoading = true;

        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load all accommodation types from database
            var allAccommodationTypes = await context.AccommodationTypes.ToListAsync();

            // Filter to only include active accommodation types
            var activeAccommodationTypes = allAccommodationTypes.Where(a => a.IsActive).ToList();

            // Load all accommodation spots to check maintenance status
            var allSpots = await context.AccommodationSpots.ToListAsync();

            Console.WriteLine($"üìä Loaded {allAccommodationTypes.Count} accommodation types from database, {activeAccommodationTypes.Count} are active");

            // Convert to DTOs with campsite information and amenities
            var allAccommodations = new List<AccommodationDto>();

            foreach (var accType in activeAccommodationTypes)
            {
                // Get campsite - only include if campsite is active
                var campsite = await context.Campsites
                    .FirstOrDefaultAsync(c => c.Id == accType.CampsiteId);

                // Skip if campsite doesn't exist or is inactive
                if (campsite == null || !campsite.IsActive)
                {
                    Console.WriteLine($"‚è≠Ô∏è Skipping {accType.Type} - campsite is null or inactive");
                    continue;
                }

                // Get spots for this accommodation type and check maintenance status
                var typeSpots = allSpots.Where(s => s.AccommodationTypeId?.Value == accType.Id?.Value).ToList();
                var availableSpots = typeSpots.Where(s => !s.IsUnderMaintenance).ToList();

                // Skip if there are spots defined but ALL of them are under maintenance
                if (typeSpots.Any() && !availableSpots.Any())
                {
                    Console.WriteLine($"‚è≠Ô∏è Skipping {accType.Type} - all {typeSpots.Count} spots are under maintenance");
                    continue;
                }

                // Get amenities directly from the accommodation type
                var accommodationAmenities = accType.GetAmenitiesList();

                // DEBUG: Log amenities for each accommodation type
                Console.WriteLine($"üè† Search - Loading {accType.Type} (ID: {accType.Id?.Value})");
                Console.WriteLine($"   Campsite: {campsite.Name} (Active: {campsite.IsActive})");
                Console.WriteLine($"   Available spots: {availableSpots.Count}/{typeSpots.Count} (excluding maintenance)");
                Console.WriteLine($"   Amenities ({accommodationAmenities.Count}): [{string.Join(", ", accommodationAmenities)}]");
                if (accommodationAmenities.Count == 0)
                {
                    Console.WriteLine($"   ‚ö†Ô∏è  NO AMENITIES FOUND FOR THIS ACCOMMODATION TYPE!");
                }

                allAccommodations.Add(new AccommodationDto
                {
                    Id = accType.Id?.Value ?? 0,
                    CampsiteId = accType.CampsiteId?.Value ?? 0,
                    CampsiteName = campsite.Name ?? "",
                    Name = accType.Type ?? "",
                    Type = accType.Type ?? "",
                    Description = accType.Description ?? "",
                    Capacity = accType.MaxCapacity,
                    PricePerNight = accType.BasePrice?.Amount ?? 0m,
                    ImageUrl = accType.ImageUrl ?? "https://images.unsplash.com/photo-1478131143081-80f7f84ca84d?w=400",
                    Amenities = accommodationAmenities,
                    AreaSquareMeters = accType.AreaSquareMeters,
                    AvailableSpotCount = availableSpots.Count
                });
            }

            _accommodations = allAccommodations;

            // Filter by campsite
            if (_selectedCampsiteIds.Any())
            {
                var selectedIds = _selectedCampsiteIds.Select(id => int.Parse(id)).ToList();
                _accommodations = _accommodations.Where(a => selectedIds.Contains(a.CampsiteId)).ToList();
            }

            // Filter by accommodation type
            if (_accommodationType != "All")
            {
                _accommodations = _accommodations.Where(a => a.Type == _accommodationType).ToList();
            }

            // Filter by amenities (accommodation must have ALL selected amenities)
            if (_selectedAmenities.Any())
            {
                _accommodations = _accommodations
                    .Where(a => _selectedAmenities.All(amenity => a.Amenities.Contains(amenity)))
                    .ToList();
            }

            Console.WriteLine($"‚úÖ Displaying {_accommodations.Count} accommodations after filtering");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error loading accommodations: {ex.Message}");
            Snackbar.Add($"Error loading accommodations: {ex.Message}", Severity.Error);
            _accommodations = new List<AccommodationDto>();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OnCampsiteSelectionChanged(IEnumerable<string> selectedValues)
    {
        Console.WriteLine($"üîç OnCampsiteSelectionChanged called with {selectedValues?.Count() ?? 0} values");
        if (selectedValues != null)
        {
            foreach (var val in selectedValues)
            {
                Console.WriteLine($"   Selected value: '{val}'");
            }
        }

        _selectedCampsiteIds = selectedValues != null ? new HashSet<string>(selectedValues) : new HashSet<string>();
        Console.WriteLine($"üîç _selectedCampsiteIds now has {_selectedCampsiteIds.Count()} items");

        await SearchAvailability();
    }

    private async Task OnAmenitySelectionChanged(IEnumerable<string> selectedValues)
    {
        _selectedAmenities = selectedValues ?? new HashSet<string>();
        Console.WriteLine($"üîç Amenity selection changed: {string.Join(", ", _selectedAmenities)}");
        await SearchAvailability();
    }

    private string GetCampsiteSelectionText(List<string> selectedValues)
    {
        if (!selectedValues.Any())
            return "All Campsites";

        if (selectedValues.Count == 1)
        {
            if (int.TryParse(selectedValues[0], out int campsiteId))
            {
                var campsite = _availableCampsites.FirstOrDefault(c => c.Id == campsiteId);
                return campsite?.Name ?? "1 selected";
            }
            return "1 selected";
        }

        return $"{selectedValues.Count} selected";
    }

    private string GetAmenitySelectionText(List<string> selectedValues)
    {
        if (!selectedValues.Any())
            return "All Amenities";

        if (selectedValues.Count == 1)
            return selectedValues[0];

        return $"{selectedValues.Count} selected";
    }

    public class AccommodationDto
    {
        public int Id { get; set; }
        public int CampsiteId { get; set; }
        public string CampsiteName { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public int Capacity { get; set; }
        public decimal PricePerNight { get; set; }
        public string ImageUrl { get; set; } = string.Empty;
        public List<string> Amenities { get; set; } = new();
        public decimal? AreaSquareMeters { get; set; }
        public int AvailableSpotCount { get; set; } // Number of spots not under maintenance
    }

    public class CampsiteFilterDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string City { get; set; } = string.Empty;
    }

    public class StringEqualityComparer : IEqualityComparer<string>
    {
        public bool Equals(string? x, string? y)
        {
            return string.Equals(x, y, StringComparison.Ordinal);
        }

        public int GetHashCode(string obj)
        {
            return obj?.GetHashCode() ?? 0;
        }
    }
}

