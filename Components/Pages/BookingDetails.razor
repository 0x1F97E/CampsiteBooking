@page "/booking-details/{bookingId}"
@rendermode InteractiveServer
@inject NavigationManager Navigation
@inject IDbContextFactory<CampsiteBookingDbContext> DbContextFactory
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider
@using CampsiteBooking.Data
@using CampsiteBooking.Models
@using CampsiteBooking.Models.ValueObjects
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims

<PageTitle>Booking Details - Campsite Booking</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudButton StartIcon="@Icons.Material.Filled.ArrowBack"
               Variant="Variant.Text"
               Color="Color.Primary"
               OnClick="@GoBack"
               Class="mb-4">
        @_backButtonText
    </MudButton>
    
    @if (_booking != null)
    {
        <MudPaper Elevation="3" Class="pa-6">
            <MudGrid>
                <MudItem xs="12">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.h4">Booking Details</MudText>
                        <MudChip T="string" Color="@GetStatusColor(_booking.Status)" Size="Size.Large">@_booking.Status</MudChip>
                    </MudStack>
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">Booking ID: @_booking.Id</MudText>
                </MudItem>
                
                <MudItem xs="12" Class="mt-4">
                    <MudDivider />
                </MudItem>
                
                <MudItem xs="12" md="6">
                    <MudImage Src="@_booking.AccommodationImageUrl" Alt="@_booking.AccommodationName" Elevation="2" Class="rounded" />
                </MudItem>
                
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.h5" GutterBottom="true">@_booking.AccommodationName</MudText>
                    <MudChip T="string" Size="Size.Small" Color="Color.Info">@_booking.AccommodationType</MudChip>
                    
                    <MudStack Spacing="3" Class="mt-4">
                        <div>
                            <MudText Typo="Typo.subtitle2" Class="mud-text-secondary">Check-in</MudText>
                            <MudText Typo="Typo.body1">
                                <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" />
                                @_booking.CheckInDate.ToString("dddd, MMMM dd, yyyy")
                            </MudText>
                        </div>
                        
                        <div>
                            <MudText Typo="Typo.subtitle2" Class="mud-text-secondary">Check-out</MudText>
                            <MudText Typo="Typo.body1">
                                <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" />
                                @_booking.CheckOutDate.ToString("dddd, MMMM dd, yyyy")
                            </MudText>
                        </div>
                        
                        <div>
                            <MudText Typo="Typo.subtitle2" Class="mud-text-secondary">Number of Guests</MudText>
                            <MudText Typo="Typo.body1">
                                <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" />
                                @_booking.NumberOfGuests guests
                            </MudText>
                        </div>
                        
                        <div>
                            <MudText Typo="Typo.subtitle2" Class="mud-text-secondary">Duration</MudText>
                            <MudText Typo="Typo.body1">@_numberOfNights nights</MudText>
                        </div>
                    </MudStack>
                </MudItem>
                
                <MudItem xs="12" Class="mt-4">
                    <MudDivider />
                </MudItem>
                
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" GutterBottom="true">Guest Information</MudText>
                    <MudSimpleTable Dense="true" Hover="true">
                        <tbody>
                            <tr>
                                <td><b>Name:</b></td>
                                <td>@_booking.GuestName</td>
                            </tr>
                            <tr>
                                <td><b>Email:</b></td>
                                <td>@_booking.GuestEmail</td>
                            </tr>
                            <tr>
                                <td><b>Phone:</b></td>
                                <td>@_booking.GuestPhone</td>
                            </tr>
                        </tbody>
                    </MudSimpleTable>
                </MudItem>
                
                @if (!string.IsNullOrEmpty(_booking.SpecialRequests))
                {
                    <MudItem xs="12" Class="mt-2">
                        <MudText Typo="Typo.subtitle2" Class="mud-text-secondary">Special Requests</MudText>
                        <MudText Typo="Typo.body2">@_booking.SpecialRequests</MudText>
                    </MudItem>
                }
                
                <MudItem xs="12" Class="mt-4">
                    <MudDivider />
                </MudItem>
                
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" GutterBottom="true">Payment Summary</MudText>
                    <MudSimpleTable Dense="true">
                        <tbody>
                            <tr>
                                <td>Price per night:</td>
                                <td class="text-right">$@_booking.PricePerNight</td>
                            </tr>
                            <tr>
                                <td>Number of nights:</td>
                                <td class="text-right">@_numberOfNights</td>
                            </tr>
                            <tr>
                                <td><b>Total:</b></td>
                                <td class="text-right"><b>$@_booking.TotalPrice</b></td>
                            </tr>
                        </tbody>
                    </MudSimpleTable>
                </MudItem>
                
                <MudItem xs="12" Class="mt-4">
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">
                        Booked on: @_booking.BookedDate.ToString("MMMM dd, yyyy 'at' hh:mm tt")
                    </MudText>
                </MudItem>
            </MudGrid>
        </MudPaper>
    }
    else
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
</MudContainer>

@code {
    [Parameter]
    public string BookingId { get; set; } = string.Empty;

    private BookingDetailsDto? _booking;
    private bool _isAdmin = false;
    private string _backButtonText = "Back to My Bookings";
    private string _backUrl = "/bookings";

    private int _numberOfNights => _booking != null
        ? (_booking.CheckOutDate - _booking.CheckInDate).Days
        : 0;

    protected override async Task OnInitializedAsync()
    {
        await CheckUserRole();
        await LoadBookingDetails();
    }

    private async Task CheckUserRole()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            _isAdmin = user.IsInRole("Admin") || user.IsInRole("Staff");

            if (_isAdmin)
            {
                _backButtonText = "Back to Booking Management";
                _backUrl = "/admin/bookings";
            }
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo(_backUrl);
    }

    private async Task LoadBookingDetails()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Parse booking ID
            if (!int.TryParse(BookingId, out int bookingIdInt))
            {
                Console.WriteLine($"❌ Invalid booking ID: {BookingId}");
                Snackbar.Add("Invalid booking ID", Severity.Error);
                return;
            }

            // Load booking from database
            var bookingId = CampsiteBooking.Models.ValueObjects.BookingId.Create(bookingIdInt);
            var booking = await context.Bookings
                .FirstOrDefaultAsync(b => b.Id == bookingId);

            if (booking == null)
            {
                Console.WriteLine($"❌ Booking not found: {BookingId}");
                Snackbar.Add("Booking not found", Severity.Error);
                return;
            }

            // Load related entities separately
            var guest = await context.Users
                .OfType<Guest>()
                .FirstOrDefaultAsync(g => g.Id == booking.GuestId);

            var accommodationType = await context.AccommodationTypes
                .FirstOrDefaultAsync(at => at.Id == booking.AccommodationTypeId);

            var campsite = accommodationType != null
                ? await context.Campsites.FirstOrDefaultAsync(c => c.Id == accommodationType.CampsiteId)
                : null;

            var nights = booking.Period != null
                ? (booking.Period.EndDate - booking.Period.StartDate).Days
                : 0;

            var pricePerNight = nights > 0 && booking.TotalPrice != null
                ? booking.TotalPrice.Amount / nights
                : 0m;

            _booking = new BookingDetailsDto
            {
                Id = BookingId,
                AccommodationName = $"{accommodationType?.Type ?? "Unknown"} at {campsite?.Name ?? "Unknown Campsite"}",
                AccommodationType = accommodationType?.Type ?? "Unknown",
                AccommodationImageUrl = accommodationType?.ImageUrl ?? "https://images.unsplash.com/photo-1478131143081-80f7f84ca84d?w=600",
                CheckInDate = booking.Period?.StartDate ?? DateTime.Today,
                CheckOutDate = booking.Period?.EndDate ?? DateTime.Today,
                NumberOfGuests = booking.NumberOfAdults + booking.NumberOfChildren,
                PricePerNight = pricePerNight,
                TotalPrice = booking.TotalPrice?.Amount ?? 0m,
                Status = booking.Status.ToString(),
                GuestName = $"{guest?.FirstName ?? ""} {guest?.LastName ?? ""}".Trim(),
                GuestEmail = guest?.Email?.Value ?? "",
                GuestPhone = guest?.Phone ?? "",
                SpecialRequests = booking.SpecialRequests ?? "",
                BookedDate = booking.CreatedDate
            };

            Console.WriteLine($"✅ Loaded booking details for ID: {BookingId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error loading booking details: {ex.Message}");
            Snackbar.Add($"Error loading booking details: {ex.Message}", Severity.Error);
        }
    }
    
    private Color GetStatusColor(string status) => status switch
    {
        "Confirmed" => Color.Success,
        "Pending" => Color.Warning,
        "Cancelled" => Color.Error,
        "Completed" => Color.Default,
        _ => Color.Default
    };

    public class BookingDetailsDto
    {
        public string Id { get; set; } = string.Empty;
        public string AccommodationName { get; set; } = string.Empty;
        public string AccommodationType { get; set; } = string.Empty;
        public string AccommodationImageUrl { get; set; } = string.Empty;
        public DateTime CheckInDate { get; set; }
        public DateTime CheckOutDate { get; set; }
        public int NumberOfGuests { get; set; }
        public decimal PricePerNight { get; set; }
        public decimal TotalPrice { get; set; }
        public string Status { get; set; } = string.Empty;
        public string GuestName { get; set; } = string.Empty;
        public string GuestEmail { get; set; } = string.Empty;
        public string GuestPhone { get; set; } = string.Empty;
        public string SpecialRequests { get; set; } = string.Empty;
        public DateTime BookedDate { get; set; }
    }
}

