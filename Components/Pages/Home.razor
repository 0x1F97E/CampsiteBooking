@page "/home"
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject IDbContextFactory<CampsiteBookingDbContext> DbContextFactory
@using CampsiteBooking.Data
@using Microsoft.EntityFrameworkCore

<PageTitle>Quick Search - Campsite Booking</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h3" Align="Align.Center" GutterBottom="true">
        Find Your Perfect Campsite in Denmark
    </MudText>
    <MudText Typo="Typo.h6" Align="Align.Center" Class="mb-6 mud-text-secondary">
        Book cabins, tent sites, and more at beautiful locations across Denmark
    </MudText>

    <!-- Filters Bar -->
    <MudPaper Elevation="3" Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="3">
                <MudTextField Label="Check-in / Check-out"
                             Variant="Variant.Outlined"
                             ReadOnly="true"
                             Value="@(_dateRange?.Start?.ToString("dd/MM/yyyy") + " - " + _dateRange?.End?.ToString("dd/MM/yyyy"))" />
            </MudItem>

            <MudItem xs="6" md="2">
                <MudNumericField @bind-Value="_adults"
                                Label="Adults"
                                Variant="Variant.Outlined"
                                Min="1"
                                Max="20"
                                Adornment="Adornment.Start"
                                AdornmentIcon="@Icons.Material.Filled.Person" />
            </MudItem>

            <MudItem xs="6" md="2">
                <MudNumericField @bind-Value="_children"
                                Label="Children"
                                Variant="Variant.Outlined"
                                Min="0"
                                Max="20"
                                Adornment="Adornment.Start"
                                AdornmentIcon="@Icons.Material.Filled.ChildCare" />
            </MudItem>

            <MudItem xs="12" md="3">
                <MudSelect T="string"
                          Label="Amenities"
                          Variant="Variant.Outlined"
                          MultiSelection="true"
                          @bind-SelectedValues="_selectedAmenities"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.CheckCircle">
                    @foreach (var amenity in _availableAmenities)
                    {
                        <MudSelectItem T="string" Value="@amenity">@amenity.Replace("-", " ")</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="2">
                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          FullWidth="true"
                          Size="Size.Large"
                          StartIcon="@Icons.Material.Filled.Search"
                          OnClick="SearchCampsites">
                    Search
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>
</MudContainer>


@code {
    private DateRange? _dateRange = new DateRange(DateTime.Today.AddDays(1), DateTime.Today.AddDays(3));
    private int _adults = 2;
    private int _children = 0;

    private IEnumerable<string> _selectedAmenities = new HashSet<string>();
    private List<string> _availableAmenities = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadAmenities();
    }

    private async Task LoadAmenities()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load amenities from the global AmenityLookup table
            var amenityLookups = await context.AmenityLookups
                .Where(a => a.IsActive)
                .OrderBy(a => a.SortOrder)
                .ToListAsync();

            _availableAmenities = amenityLookups
                .Select(a => a.Name)
                .ToList();

            Console.WriteLine($"✅ Loaded {_availableAmenities.Count} amenities for home page filter from AmenityLookup table");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error loading amenities: {ex.Message}");
            // Fallback to empty list
            _availableAmenities = new List<string>();
        }
    }

    private void SearchCampsites()
    {
        var queryParams = new Dictionary<string, string>
        {
            ["checkIn"] = _dateRange?.Start?.ToString("yyyy-MM-dd") ?? "",
            ["checkOut"] = _dateRange?.End?.ToString("yyyy-MM-dd") ?? "",
            ["adults"] = _adults.ToString(),
            ["children"] = _children.ToString()
        };

        if (_selectedAmenities.Any())
        {
            queryParams["amenities"] = string.Join(",", _selectedAmenities);
        }

        var queryString = string.Join("&", queryParams.Select(kvp => $"{kvp.Key}={Uri.EscapeDataString(kvp.Value)}"));
        Navigation.NavigateTo($"/search?{queryString}");
    }
}