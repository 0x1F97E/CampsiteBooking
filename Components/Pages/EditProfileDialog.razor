@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar
@using CampsiteBooking.Helpers

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_isFormValid">
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_firstName"
                                  Label="First Name"
                                  Required="true"
                                  RequiredError="First name is required"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense" />
                </MudItem>
                
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_lastName"
                                  Label="Last Name"
                                  Required="true"
                                  RequiredError="Last name is required"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense" />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @bind-Value="_email"
                                  Label="Email"
                                  Required="true"
                                  RequiredError="Email is required"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  InputType="InputType.Email"
                                  Validation="@(new Func<string, string?>(ValidateEmail))" />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @bind-Value="_phone"
                                  Label="Phone"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  HelperText="Optional" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudAutocomplete T="string"
                                     @bind-Value="_country"
                                     Label="Country"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Dense"
                                     SearchFunc="@SearchCountries"
                                     MaxItems="20"
                                     Dense="true"
                                     CoerceText="true"
                                     CoerceValue="true"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Filled.Public"
                                     HelperText="Optional" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudSelect @bind-Value="_preferredCommunication"
                               Label="Preferred Communication"
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense"
                               HelperText="How would you like to receive notifications?">
                        <MudSelectItem Value="@("Email")">Email</MudSelectItem>
                        <MudSelectItem Value="@("SMS")">SMS</MudSelectItem>
                        <MudSelectItem Value="@("Both")">Both</MudSelectItem>
                    </MudSelect>
                </MudItem>
            </MudGrid>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mt-4">@_errorMessage</MudAlert>
            }
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Color="Color.Default">Cancel</MudButton>
        <MudButton OnClick="SaveProfile" 
                   Color="Color.Primary" 
                   Variant="Variant.Filled"
                   Disabled="@(!_isFormValid || _isProcessing)">
            @if (_isProcessing)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Saving...</span>
            }
            else
            {
                <span>Save Changes</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public string FirstName { get; set; } = "";

    [Parameter]
    public string LastName { get; set; } = "";

    [Parameter]
    public string Email { get; set; } = "";

    [Parameter]
    public string Phone { get; set; } = "";

    [Parameter]
    public string Country { get; set; } = "";

    [Parameter]
    public string PreferredCommunication { get; set; } = "Email";

    private MudForm _form = null!;
    private bool _isFormValid;
    private bool _isProcessing;
    private string _firstName = "";
    private string _lastName = "";
    private string _email = "";
    private string _phone = "";
    private string _country = "";
    private string _preferredCommunication = "Email";
    private string _errorMessage = "";

    protected override void OnInitialized()
    {
        // Initialize with current values
        _firstName = FirstName;
        _lastName = LastName;
        _email = Email;
        _phone = Phone;
        _country = Country;
        _preferredCommunication = PreferredCommunication;
    }

    private async Task SaveProfile()
    {
        _errorMessage = "";
        _isProcessing = true;

        try
        {
            // Validate form
            await _form.Validate();
            if (!_isFormValid)
            {
                _isProcessing = false;
                return;
            }

            // Call API using JavaScript interop
            var result = await JSRuntime.InvokeAsync<UpdateProfileResult>("authHelper.updateProfile",
                _firstName, _lastName, _email, _phone, _country, _preferredCommunication);

            if (result?.Success == true)
            {
                Snackbar.Add("Profile updated successfully!", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                _errorMessage = result?.Error ?? "Failed to update profile. Please try again.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error updating profile: {ex.Message}");
            _errorMessage = "An error occurred while updating your profile. Please try again.";
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private string? ValidateEmail(string email)
    {
        if (string.IsNullOrWhiteSpace(email))
            return "Email is required";

        // Basic email validation
        if (!email.Contains("@") || !email.Contains("."))
            return "Please enter a valid email address";

        // Check for valid email format
        var emailParts = email.Split('@');
        if (emailParts.Length != 2 || string.IsNullOrWhiteSpace(emailParts[0]) || string.IsNullOrWhiteSpace(emailParts[1]))
            return "Please enter a valid email address";

        if (!emailParts[1].Contains("."))
            return "Please enter a valid email address";

        return null;
    }

    private Task<IEnumerable<string>> SearchCountries(string value, CancellationToken cancellationToken)
    {
        // If the text is empty, return all countries
        if (string.IsNullOrEmpty(value))
            return Task.FromResult<IEnumerable<string>>(CountryList.Countries);

        // Return countries that contain the search text (case-insensitive)
        return Task.FromResult(CountryList.Search(value));
    }

    // DTO for update profile result
    private class UpdateProfileResult
    {
        public bool Success { get; set; }
        public string? Error { get; set; }
    }
}

