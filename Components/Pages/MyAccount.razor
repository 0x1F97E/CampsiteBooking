@page "/my-account"
@rendermode InteractiveServer
@attribute [Authorize]
@inject IDialogService DialogService
@inject IDbContextFactory<CampsiteBookingDbContext> DbContextFactory
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@using CampsiteBooking.Data
@using CampsiteBooking.Models
@using CampsiteBooking.Models.ValueObjects
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims

<PageTitle>My Account - Campsite Booking</PageTitle>

@if (_isLoading)
{
    <MudContainer MaxWidth="MaxWidth.Large" Class="mt-8 text-center">
        <MudProgressCircular Size="Size.Large" Indeterminate="true" />
        <MudText Typo="Typo.h6" Class="mt-4">Loading your account...</MudText>
    </MudContainer>
}
else if (!_isAuthenticated)
{
    <MudContainer MaxWidth="MaxWidth.Large" Class="mt-8 text-center">
        <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Color="Color.Error" />
        <MudText Typo="Typo.h5" Class="mt-4">Please Log In</MudText>
        <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
            You need to be logged in to view your account information.
        </MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/login" StartIcon="@Icons.Material.Filled.Login">
            Go to Login
        </MudButton>
    </MudContainer>
}
else
{
<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">
        <MudIcon Icon="@Icons.Material.Filled.AccountCircle" Class="mr-2" />
        My Account
    </MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-6">
        Manage your personal information and account settings
    </MudText>

    <MudGrid>
        <!-- Profile Information Card -->
        <MudItem xs="12" md="8">
            <MudCard Elevation="3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Profile Information</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudButton Variant="Variant.Text" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Edit" OnClick="EditProfile">
                            Edit
                        </MudButton>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">First Name</MudText>
                            <MudText Typo="Typo.body1" Class="mb-4">@_firstName</MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Last Name</MudText>
                            <MudText Typo="Typo.body1" Class="mb-4">@_lastName</MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Email</MudText>
                            <MudText Typo="Typo.body1" Class="mb-4">@_email</MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Phone</MudText>
                            <MudText Typo="Typo.body1" Class="mb-4">@_phone</MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Country</MudText>
                            <MudText Typo="Typo.body1" Class="mb-4">@_country</MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Member Since</MudText>
                            <MudText Typo="Typo.body1" Class="mb-4">@_memberSince.ToString("MMMM dd, yyyy")</MudText>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            <!-- Password & Security Card -->
            <MudCard Elevation="3" Class="mt-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Password & Security</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Lock" OnClick="ChangePassword">
                        Change Password
                    </MudButton>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                        Last changed: @_lastPasswordChange.ToString("MMMM dd, yyyy")
                    </MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Account Summary Sidebar -->
        <MudItem xs="12" md="4">
            <MudCard Elevation="3">
                <MudCardContent>
                    <div class="text-center mb-4">
                        <MudAvatar Color="Color.Primary" Size="Size.Large" Class="mx-auto mb-3">
                            @_firstName.Substring(0, 1)@_lastName.Substring(0, 1)
                        </MudAvatar>
                        <MudText Typo="Typo.h6">@_firstName @_lastName</MudText>
                    </div>
                    <MudDivider Class="my-4" />
                    <MudText Typo="Typo.h6" Class="mb-3">Account Statistics</MudText>
                    <div class="mb-3">
                        <div class="d-flex justify-space-between align-center mb-2">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Total Bookings</MudText>
                            <MudText Typo="Typo.body1"><strong>@_totalBookings</strong></MudText>
                        </div>
                        <div class="d-flex justify-space-between align-center mb-2">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Upcoming Trips</MudText>
                            <MudText Typo="Typo.body1"><strong>@_upcomingTrips</strong></MudText>
                        </div>
                        <div class="d-flex justify-space-between align-center mb-2">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Favorite Campsite</MudText>
                            <MudText Typo="Typo.body2">@_favoriteCampsite</MudText>
                        </div>
                    </div>
                </MudCardContent>
            </MudCard>

            <!-- Preferences Card -->
            <MudCard Elevation="3" Class="mt-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Communication Preferences</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudSwitch T="bool"
                               Value="_emailNotifications"
                               ValueChanged="@(async (bool value) => { _emailNotifications = value; await SavePreferences(); })"
                               Color="Color.Primary"
                               Label="Email Notifications" />
                    <MudSwitch T="bool"
                               Value="_smsNotifications"
                               ValueChanged="@(async (bool value) => { _smsNotifications = value; await SavePreferences(); })"
                               Color="Color.Primary"
                               Label="SMS Notifications"
                               Class="mt-2" />
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-3">
                        Current preference: @_preferredCommunication
                    </MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Purchase History Section -->
        <MudItem xs="12">
            <MudCard Elevation="3" Class="mt-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.Receipt" Class="mr-2" />
                            Purchase History
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (_purchaseHistory == null || !_purchaseHistory.Any())
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="text-center py-4">
                            No purchase history available
                        </MudText>
                    }
                    else
                    {
                        <MudTable Items="_purchaseHistory" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true">
                            <HeaderContent>
                                <MudTh>Booking ID</MudTh>
                                <MudTh>Date</MudTh>
                                <MudTh>Campsite</MudTh>
                                <MudTh>Accommodation</MudTh>
                                <MudTh>Check-in</MudTh>
                                <MudTh>Check-out</MudTh>
                                <MudTh>Status</MudTh>
                                <MudTh>Total</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Booking ID">@context.BookingId</MudTd>
                                <MudTd DataLabel="Date">@context.BookingDate.ToString("MMM dd, yyyy")</MudTd>
                                <MudTd DataLabel="Campsite">@context.CampsiteName</MudTd>
                                <MudTd DataLabel="Accommodation">@context.AccommodationType</MudTd>
                                <MudTd DataLabel="Check-in">@context.CheckInDate.ToString("MMM dd, yyyy")</MudTd>
                                <MudTd DataLabel="Check-out">@context.CheckOutDate.ToString("MMM dd, yyyy")</MudTd>
                                <MudTd DataLabel="Status">
                                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                                        @context.Status
                                    </MudChip>
                                </MudTd>
                                <MudTd DataLabel="Total">
                                    <strong>@context.TotalPrice.ToString("C")</strong>
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>
}

@code {
    private bool _isLoading = true;
    private bool _isAuthenticated = false;
    private int _currentUserId = 0;

    // User profile data from database
    private string _firstName = "";
    private string _lastName = "";
    private string _email = "";
    private string _phone = "";
    private string _country = "";
    private DateTime _memberSince = DateTime.Today;
    private DateTime _lastPasswordChange = DateTime.Today;

    // Account statistics from database
    private int _totalBookings = 0;
    private int _upcomingTrips = 0;
    private string _favoriteCampsite = "None";

    // Preferences from database
    private bool _emailNotifications = true;
    private bool _smsNotifications = false;
    private string _preferredCommunication = "Email";

    // Purchase history
    private List<PurchaseHistoryDto> _purchaseHistory = new();

    protected override async Task OnInitializedAsync()
    {
        await CheckAuthentication();

        if (_isAuthenticated)
        {
            await LoadUserData();
            await LoadAccountStatistics();
            await LoadPurchaseHistory();
        }

        _isLoading = false;
    }

    private async Task CheckAuthentication()
    {
        try
        {
            // Get authentication state from the AuthenticationStateProvider
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user?.Identity?.IsAuthenticated == true)
            {
                // Get user ID from claims
                var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier);
                if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
                {
                    _currentUserId = userId;
                    _isAuthenticated = true;
                    Console.WriteLine($"✅ MyAccount: User authenticated - UserId = {_currentUserId}, Name = {user.FindFirst(ClaimTypes.Name)?.Value}");
                }
                else
                {
                    _isAuthenticated = false;
                    Console.WriteLine("❌ MyAccount: User ID claim not found or invalid");
                }
            }
            else
            {
                _isAuthenticated = false;
                Console.WriteLine("⚠️ MyAccount: User not authenticated");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ MyAccount: Error checking authentication: {ex.Message}");
            _isAuthenticated = false;
        }
    }

    private async Task LoadUserData()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load user from database
            var userId = UserId.Create(_currentUserId);
            var user = await context.Users
                .FirstOrDefaultAsync(u => u.Id == userId);

            if (user != null)
            {
                _firstName = user.FirstName ?? "";
                _lastName = user.LastName ?? "";
                _email = user.Email?.Value ?? "";
                _phone = user.Phone ?? "";
                _country = user.Country ?? "";
                _memberSince = user.JoinedDate;
                _lastPasswordChange = user.JoinedDate; // TODO: Add LastPasswordChange to User model

                // Load preferences if user is a Guest
                if (user is Guest guest)
                {
                    _preferredCommunication = guest.PreferredCommunication;
                    _emailNotifications = guest.PreferredCommunication == "Email" || guest.PreferredCommunication == "Both";
                    _smsNotifications = guest.PreferredCommunication == "SMS" || guest.PreferredCommunication == "Both";
                }

                Console.WriteLine($"✅ Loaded user data for {_firstName} {_lastName}");
            }
            else
            {
                Console.WriteLine($"❌ User with ID {_currentUserId} not found in database");
                Snackbar.Add("User not found. Please log in again.", Severity.Error);
                _isAuthenticated = false;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error loading user data: {ex.Message}");
            Snackbar.Add($"Error loading user data: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadAccountStatistics()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load bookings for this user
            var guestId = GuestId.Create(_currentUserId);
            var bookings = await context.Bookings
                .Where(b => b.GuestId == guestId)
                .ToListAsync();

            // Calculate statistics
            _totalBookings = bookings.Count;
            _upcomingTrips = bookings.Count(b =>
                (b.Status == BookingStatus.Confirmed || b.Status == BookingStatus.Pending) &&
                b.CheckInDate >= DateTime.Today);

            // Find favorite campsite (most booked) - load campsites separately
            var campsiteIds = bookings.Select(b => b.CampsiteId).Distinct().ToList();
            var campsites = await context.Campsites
                .Where(c => campsiteIds.Contains(c.Id))
                .ToListAsync();

            var campsiteBookingCounts = bookings
                .GroupBy(b => b.CampsiteId)
                .Select(g => new { CampsiteId = g.Key, Count = g.Count() })
                .OrderByDescending(x => x.Count)
                .FirstOrDefault();

            if (campsiteBookingCounts != null)
            {
                var favoriteCampsite = campsites.FirstOrDefault(c => c.Id == campsiteBookingCounts.CampsiteId);
                _favoriteCampsite = favoriteCampsite?.Name ?? "None";
            }
            else
            {
                _favoriteCampsite = "None";
            }

            Console.WriteLine($"✅ Statistics: {_totalBookings} total, {_upcomingTrips} upcoming, favorite: {_favoriteCampsite}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error loading statistics: {ex.Message}");
            // Don't show error to user - statistics are not critical
        }
    }

    private async Task EditProfile()
    {
        var parameters = new DialogParameters
        {
            { "FirstName", _firstName },
            { "LastName", _lastName },
            { "Phone", _phone },
            { "Country", _country },
            { "PreferredCommunication", _preferredCommunication }
        };

        var dialog = await DialogService.ShowAsync<EditProfileDialog>("Edit Profile", parameters, new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseButton = true
        });

        var result = await dialog.Result;

        if (!result.Canceled)
        {
            Console.WriteLine("✅ Profile updated successfully from MyAccount page");
            // Reload user data to show updated information
            await LoadUserData();
        }
    }

    private async Task ChangePassword()
    {
        var dialog = await DialogService.ShowAsync<ChangePasswordDialog>("Change Password", new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseButton = true
        });

        var result = await dialog.Result;

        if (!result.Canceled)
        {
            Console.WriteLine("✅ Password changed successfully from MyAccount page");
        }
    }

    private async Task LoadPurchaseHistory()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load all bookings for this user
            var guestId = GuestId.Create(_currentUserId);
            var bookings = await context.Bookings
                .Where(b => b.GuestId == guestId)
                .ToListAsync();

            // Load related entities
            var accommodationTypeIds = bookings.Select(b => b.AccommodationTypeId).Distinct().ToList();
            var accommodationTypes = await context.AccommodationTypes
                .Where(at => accommodationTypeIds.Contains(at.Id))
                .ToListAsync();

            var campsiteIds = accommodationTypes.Select(at => at.CampsiteId).Distinct().ToList();
            var campsites = await context.Campsites
                .Where(c => campsiteIds.Contains(c.Id))
                .ToListAsync();

            // Convert to DTOs
            _purchaseHistory = bookings.Select(b =>
            {
                var accommodationType = accommodationTypes.FirstOrDefault(at => at.Id == b.AccommodationTypeId);
                var campsite = accommodationType != null
                    ? campsites.FirstOrDefault(c => c.Id == accommodationType.CampsiteId)
                    : null;

                return new PurchaseHistoryDto
                {
                    BookingId = b.Id?.Value.ToString() ?? "0",
                    BookingDate = b.CreatedDate,
                    CampsiteName = campsite?.Name ?? "Unknown",
                    AccommodationType = accommodationType?.Type ?? "Unknown",
                    CheckInDate = b.Period?.StartDate ?? DateTime.Today,
                    CheckOutDate = b.Period?.EndDate ?? DateTime.Today,
                    Status = b.Status.ToString(),
                    TotalPrice = b.TotalPrice?.Amount ?? 0m
                };
            }).OrderByDescending(p => p.BookingDate).ToList();

            Console.WriteLine($"✅ Loaded {_purchaseHistory.Count} purchase history records");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error loading purchase history: {ex.Message}");
            _purchaseHistory = new List<PurchaseHistoryDto>();
        }
    }

    private async Task SavePreferences()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load user from database
            var userId = UserId.Create(_currentUserId);
            var user = await context.Users.OfType<Guest>()
                .FirstOrDefaultAsync(u => u.Id == userId);

            if (user != null)
            {
                // Determine preferred communication based on toggles
                string newPreference;
                if (_emailNotifications && _smsNotifications)
                {
                    newPreference = "Both";
                }
                else if (_emailNotifications)
                {
                    newPreference = "Email";
                }
                else if (_smsNotifications)
                {
                    newPreference = "SMS";
                }
                else
                {
                    newPreference = "Email"; // Default to Email if both are off
                    _emailNotifications = true; // Force at least one to be on
                }

                // Update preference
                user.UpdatePreferredCommunication(newPreference);
                await context.SaveChangesAsync();

                _preferredCommunication = newPreference;
                Snackbar.Add("Preferences saved successfully!", Severity.Success);
                Console.WriteLine($"✅ Updated communication preference to: {newPreference}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error saving preferences: {ex.Message}");
            Snackbar.Add($"Error saving preferences: {ex.Message}", Severity.Error);
        }
    }

    private Color GetStatusColor(string status)
    {
        return status switch
        {
            "Confirmed" => Color.Success,
            "Pending" => Color.Warning,
            "Cancelled" => Color.Error,
            "Completed" => Color.Info,
            _ => Color.Default
        };
    }

    // DTO for purchase history
    private class PurchaseHistoryDto
    {
        public string BookingId { get; set; } = "";
        public DateTime BookingDate { get; set; }
        public string CampsiteName { get; set; } = "";
        public string AccommodationType { get; set; } = "";
        public DateTime CheckInDate { get; set; }
        public DateTime CheckOutDate { get; set; }
        public string Status { get; set; } = "";
        public decimal TotalPrice { get; set; }
    }
}

